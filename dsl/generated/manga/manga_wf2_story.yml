app:
  description: "WF2: Story Details - ã‚¹ãƒˆãƒ¼ãƒªãƒ¼è©³ç´°åŒ– + emphasis_pointæ±ºå®š"
  icon: "ğŸ“–"
  icon_background: '#FEF3C7'
  mode: workflow
  name: "Manga WF2 - Story Details"
  use_icon_as_answer_icon: false
kind: app
version: 0.1.2

workflow:
  conversation_variables: []
  environment_variables: []
  features:
    file_upload:
      image:
        enabled: false
        number_limits: 3
        transfer_methods:
        - local_file
        - remote_url
    opening_statement: ''
    retriever_resource:
      enabled: false
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    suggested_questions: []
    suggested_questions_after_answer:
      enabled: false
    text_to_speech:
      enabled: false
      language: ''
      voice: ''

  graph:
    edges:
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: start
        targetType: code
      id: edge-start-to-emphasis
      source: '1000000001'
      sourceHandle: source
      target: '1000000002'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: llm
      id: edge-emphasis-to-llm
      source: '1000000002'
      sourceHandle: source
      target: '1000000003'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: code
      id: edge-llm-to-prep
      source: '1000000003'
      sourceHandle: source
      target: '1000000004'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: end
      id: edge-prep-to-end
      source: '1000000004'
      sourceHandle: source
      target: '1000000005'
      targetHandle: target
      type: custom
      zIndex: 0

    nodes:
    - data:
        desc: 'WF1ã‹ã‚‰ã®å…¥åŠ›ã‚’å—ã‘å–ã‚‹'
        selected: false
        title: Start
        type: start
        variables:
        - label: design_json
          max_length: 10000
          options: []
          required: true
          type: paragraph
          variable: design_json
        - label: rag_context
          max_length: 5000
          options: []
          required: false
          type: paragraph
          variable: rag_context
        - label: characters
          max_length: 200
          options: []
          required: true
          type: text-input
          variable: characters
        - label: theme
          max_length: 500
          options: []
          required: true
          type: paragraph
          variable: theme
        - label: setting_location
          max_length: 200
          options: []
          required: true
          type: text-input
          variable: setting_location
        - label: setting_time
          max_length: 100
          options: []
          required: true
          type: text-input
          variable: setting_time
        - default: 'modern realistic'
          label: art_style
          max_length: 100
          options: []
          required: false
          type: text-input
          variable: art_style
      height: 280
      id: '1000000001'
      position:
        x: 80
        y: 200
      positionAbsolute:
        x: 80
        y: 200
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244

    - data:
        code: |
          import json

          def main(design_json: str) -> dict:
              """
              design_jsonã‹ã‚‰pagesé…åˆ—ã‚’æŠ½å‡ºã—ã€å„ãƒšãƒ¼ã‚¸ã«emphasis_pointã‚’å‰²ã‚Šå½“ã¦ã‚‹ã€‚
              emphasis_pointã¯ãƒšãƒ¼ã‚¸ã®å­¦ç¿’ç„¦ç‚¹ã«åŸºã¥ã„ã¦æ±ºå®šã€‚
              """
              EMPHASIS_MAPPING = {
                  "ki": "situation_setup",
                  "sho": "learning_content",
                  "ten": "key_insight",
                  "ketsu": "resolution"
              }

              try:
                  data = json.loads(design_json)
                  pages = data.get("pages", [])

                  enriched_pages = []
                  for page in pages:
                      arc_phase = page.get("arc_phase", "sho")
                      emphasis = EMPHASIS_MAPPING.get(arc_phase, "learning_content")

                      enriched_page = {
                          **page,
                          "emphasis_point": emphasis
                      }
                      enriched_pages.append(enriched_page)

                  return {
                      "pages_with_emphasis": enriched_pages,
                      "page_count": len(enriched_pages),
                      "story_overview": data.get("story_overview", {})
                  }
              except (json.JSONDecodeError, TypeError) as e:
                  return {
                      "pages_with_emphasis": [],
                      "page_count": 0,
                      "story_overview": {},
                      "error": str(e)
                  }
        code_language: python3
        outputs:
          pages_with_emphasis:
            children: null
            type: array[object]
          page_count:
            children: null
            type: number
          story_overview:
            children: null
            type: object
        selected: false
        title: 'CODE: Emphasis Point'
        type: code
        variables:
        - value_selector:
          - '1000000001'
          - design_json
          value_type: string
          variable: design_json
      height: 54
      id: '1000000002'
      position:
        x: 380
        y: 200
      positionAbsolute:
        x: 380
        y: 200
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244

    - data:
        context:
          enabled: false
          variable_selector: []
        desc: 'ã‚¹ãƒˆãƒ¼ãƒªãƒ¼è©³ç´°ã‚’ç”Ÿæˆ'
        edition_type: basic
        model:
          completion_params:
            temperature: 0.7
          mode: chat
          name: gpt-4o
          provider: langgenius/openai/openai
        prompt_template:
        - id: sys-002
          role: system
          text: |
            ã‚ãªãŸã¯å»ºè¨­æ¥­ç•Œå‘ã‘æ•™è‚²ãƒãƒ³ã‚¬ã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼è©³ç´°åŒ–ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚

            å„ãƒšãƒ¼ã‚¸ã«ã¤ã„ã¦ä»¥ä¸‹ã®è©³ç´°ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š
            - key_scene: ã‚·ãƒ¼ãƒ³ã®èª¬æ˜
            - dialogue: ç™»å ´äººç‰©ã®å°è©ï¼ˆé…åˆ—å½¢å¼ï¼‰
            - panels: ãƒ‘ãƒãƒ«æ§‹æˆï¼ˆé…åˆ—å½¢å¼ï¼‰

            å‡ºåŠ›ã¯å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š
            {
              "pages": [
                {
                  "page_number": 1,
                  "arc_phase": "ki",
                  "emphasis_point": "situation_setup",
                  "learning_focus": "å­¦ç¿’ç„¦ç‚¹",
                  "key_message": "ã‚­ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸",
                  "key_scene": "ã‚·ãƒ¼ãƒ³ã®è©³ç´°èª¬æ˜",
                  "dialogue": [
                    {"character": "takeru", "text": "å°è©å†…å®¹"},
                    {"character": "kazusan", "text": "å°è©å†…å®¹"}
                  ],
                  "panels": [
                    {
                      "panel_number": 1,
                      "layout": "full_width",
                      "description": "ãƒ‘ãƒãƒ«ã®èª¬æ˜",
                      "characters": ["takeru", "kazusan"]
                    }
                  ]
                }
              ]
            }
        - id: user-002
          role: user
          text: |
            ãƒ†ãƒ¼ãƒ: {{#1000000001.theme#}}
            ç™»å ´äººç‰©: {{#1000000001.characters#}}
            å ´æ‰€è¨­å®š: {{#1000000001.setting_location#}}
            æ™‚é–“è¨­å®š: {{#1000000001.setting_time#}}
            ã‚¢ãƒ¼ãƒˆã‚¹ã‚¿ã‚¤ãƒ«: {{#1000000001.art_style#}}

            ã‚¹ãƒˆãƒ¼ãƒªãƒ¼æ¦‚è¦:
            {{#1000000002.story_overview#}}

            ãƒšãƒ¼ã‚¸æƒ…å ±ï¼ˆemphasis_pointä»˜ãï¼‰:
            {{#1000000002.pages_with_emphasis#}}

            å‚è€ƒçŸ¥è­˜:
            {{#1000000001.rag_context#}}

            ä¸Šè¨˜ã®æƒ…å ±ã‚’ã‚‚ã¨ã«ã€å„ãƒšãƒ¼ã‚¸ã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼è©³ç´°JSONã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
            å‡ºåŠ›ã¯JSONã®ã¿ã§ã€ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã¯ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚
        selected: false
        structured_output_enabled: false
        title: 'LLM: Story Details'
        type: llm
        variables: []
        vision:
          enabled: false
      height: 98
      id: '1000000003'
      position:
        x: 680
        y: 200
      positionAbsolute:
        x: 680
        y: 200
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244

    - data:
        code: |
          import json

          def main(story_details: str) -> dict:
              """
              LLMã®å‡ºåŠ›ã‹ã‚‰pagesé…åˆ—ã‚’æŠ½å‡ºã—ã€ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã«æº–å‚™ã™ã‚‹ã€‚
              """
              try:
                  data = json.loads(story_details)
                  pages = data.get("pages", [])

                  # å„ãƒšãƒ¼ã‚¸ã‚’JSONæ–‡å­—åˆ—ã¨ã—ã¦é…åˆ—ã«æ ¼ç´
                  pages_array = []
                  for page in pages:
                      pages_array.append(json.dumps(page, ensure_ascii=False))

                  return {
                      "pages_array": pages_array,
                      "story_json": story_details,
                      "page_count": len(pages)
                  }
              except (json.JSONDecodeError, TypeError) as e:
                  return {
                      "pages_array": [],
                      "story_json": story_details,
                      "page_count": 0,
                      "error": str(e)
                  }
        code_language: python3
        outputs:
          pages_array:
            children: null
            type: array[string]
          story_json:
            children: null
            type: string
          page_count:
            children: null
            type: number
        selected: false
        title: 'CODE: Prepare Iteration'
        type: code
        variables:
        - value_selector:
          - '1000000003'
          - text
          value_type: string
          variable: story_details
      height: 54
      id: '1000000004'
      position:
        x: 980
        y: 200
      positionAbsolute:
        x: 980
        y: 200
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244

    - data:
        desc: ''
        outputs:
        - value_selector:
          - '1000000004'
          - story_json
          variable: story_json
        - value_selector:
          - '1000000004'
          - pages_array
          variable: pages_array
        - value_selector:
          - '1000000004'
          - page_count
          variable: page_count
        selected: false
        title: End
        type: end
      height: 148
      id: '1000000005'
      position:
        x: 1280
        y: 200
      positionAbsolute:
        x: 1280
        y: 200
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244

    viewport:
      x: 0
      y: 0
      zoom: 1

  rag_pipeline_variables: []
