app:
  description: 'v3.0: Per-page character reference images for style consistency'
  icon: ğŸ¤–
  icon_background: '#E4FBCC'
  mode: advanced-chat
  name: Manga Complete Pipeline v3.0
  use_icon_as_answer_icon: false
dependencies:
- current_identifier: null
  type: marketplace
  value:
    marketplace_plugin_unique_identifier: langgenius/openai:0.2.8@aae2be0913b8c6f0b80cff58e08d7a8b4c214569b41778413fcaea204561ff16
    version: null
kind: app
version: 0.5.0
workflow:
  conversation_variables:
  - description: Current workflow phase
    id: 70badabf-224a-4261-b3d4-e86865cbf836
    name: current_phase
    selector:
    - conversation
    - current_phase
    value: init
    value_type: string
  - description: 'WF1 output: Learning design JSON'
    id: b8d89a00-971c-44b7-86fc-109d283d1f2b
    name: design_json
    selector:
    - conversation
    - design_json
    value: ''
    value_type: string
  - description: 'WF2 output: Story details JSON'
    id: 941b7411-5acf-4a75-aea7-b77b4e6dfe86
    name: story_json
    selector:
    - conversation
    - story_json
    value: ''
    value_type: string
  - description: 'WF2 output: Pages array for iteration'
    id: 5398e09a-2e4f-4762-9216-79b65ac7e514
    name: pages_array
    selector:
    - conversation
    - pages_array
    value: ''
    value_type: string
  - description: 'WF3 output: Generated YAML'
    id: 2988339d-e27f-4cea-b730-a0423a2b4e21
    name: yaml_content
    selector:
    - conversation
    - yaml_content
    value: ''
    value_type: string
  - description: 'User input: Theme'
    id: f47ebaad-a04b-43ac-9297-0d9655889307
    name: theme
    selector:
    - conversation
    - theme
    value: ''
    value_type: string
  - description: 'User input: Characters'
    id: 6f593528-c8c2-4a62-8a04-d3e44f86b696
    name: characters
    selector:
    - conversation
    - characters
    value: ''
    value_type: string
  - description: Total page count
    id: d335ac72-2e61-432b-a1e7-7bc7a500f211
    name: total_pages
    selector:
    - conversation
    - total_pages
    value: 4
    value_type: integer
  environment_variables:
  - description: Google AI Studio APIã‚­ãƒ¼ (gemini-2.0-flash-expç”¨)
    id: 06517ac6-7b95-44a4-b8ca-3ce5d3ccfe8e
    name: GOOGLE_AI_API_KEY
    selector:
    - env
    - GOOGLE_AI_API_KEY
    value: ''
    value_type: secret
  - description: '[TODO] Dify UIã®ç’°å¢ƒå¤‰æ•°è¨­å®šã§å®Ÿéš›ã®GAS URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'
    id: 6bc45ca7-04bc-42d5-946d-bb3a362c76d9
    name: GAS_GEMINI_PROXY_URL
    selector:
    - env
    - GAS_GEMINI_PROXY_URL
    value: https://script.google.com/macros/s/AKfycbwqTRs8AP5Z9SBvp07PhGbOYbKCrnimRsWtJSZq_tbGX_-CqUBpb-AK1241oc4_U5kd/exec
    value_type: string
  features:
    file_upload:
      allowed_file_extensions:
      - .JPG
      - .JPEG
      - .PNG
      - .GIF
      - .WEBP
      - .SVG
      allowed_file_types:
      - image
      allowed_file_upload_methods:
      - local_file
      - remote_url
      enabled: false
      fileUploadConfig:
        audio_file_size_limit: 50
        batch_count_limit: 5
        file_size_limit: 15
        image_file_batch_limit: 10
        image_file_size_limit: 10
        single_chunk_attachment_limit: 10
        video_file_size_limit: 100
        workflow_file_upload_limit: 10
      image:
        enabled: false
        number_limits: 3
        transfer_methods:
        - local_file
        - remote_url
      number_limits: 3
    opening_statement: 'ãƒãƒ³ã‚¬ç”Ÿæˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¸ã‚ˆã†ã“ãã€‚


      ãƒ†ãƒ¼ãƒã¨ç™»å ´äººç‰©ã‚’å«ã‚ã¦ãƒãƒ³ã‚¬ã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚

      ä¾‹: ã€Œè¶³å ´ã®å®‰å…¨ç‚¹æ¤œã«ã¤ã„ã¦ã€ã‚¿ã‚±ãƒ«ã¨ã‚«ã‚ºã•ã‚“ã§4ãƒšãƒ¼ã‚¸ã®ãƒãƒ³ã‚¬ã‚’ä½œæˆã—ã¦ã€

      '
    retriever_resource:
      enabled: true
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    suggested_questions:
    - è¶³å ´ã®å®‰å…¨ç‚¹æ¤œã«ã¤ã„ã¦ã€ã‚¿ã‚±ãƒ«ã¨ã‚«ã‚ºã•ã‚“ã§4ãƒšãƒ¼ã‚¸ã®ãƒãƒ³ã‚¬ã‚’ä½œæˆã—ã¦
    - KYæ´»å‹•ã®é‡è¦æ€§ã‚’æ–°äººå‘ã‘ã«èª¬æ˜ã™ã‚‹ãƒãƒ³ã‚¬ã‚’ä½œæˆã—ã¦
    - ç†±ä¸­ç—‡å¯¾ç­–ã«ã¤ã„ã¦ã€å»ºè¨­ç¾å ´ã§ã®äºˆé˜²æ–¹æ³•ã‚’å­¦ã¶ãƒãƒ³ã‚¬ã‚’ä½œæˆã—ã¦
    suggested_questions_after_answer:
      enabled: true
    text_to_speech:
      enabled: false
      language: ''
      voice: ''
  graph:
    edges:
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: start
        targetType: if-else
      id: edge-start-ifelse
      source: '1000000001'
      sourceHandle: source
      target: '1000000099'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: if-else
        targetType: code
      id: edge-phase-init
      source: '1000000099'
      sourceHandle: case-init
      target: '1000000003'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: if-else
        targetType: llm
      id: edge-phase-design
      source: '1000000099'
      sourceHandle: case-design_done
      target: '1000000008'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: if-else
        targetType: code
      id: edge-phase-story
      source: '1000000099'
      sourceHandle: case-story_done
      target: '1000000011'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: if-else
        targetType: code
      id: edge-phase-yaml
      source: '1000000099'
      sourceHandle: case-yaml_done
      target: '1000000013'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: if-else
        targetType: code
      id: edge-phase-quality
      source: '1000000099'
      sourceHandle: case-quality_done
      target: '1000000020'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: if-else
        targetType: answer
      id: edge-phase-default
      source: '1000000099'
      sourceHandle: 'false'
      target: '1000000017'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: knowledge-retrieval
      id: edge-parse-rag
      source: '1000000003'
      sourceHandle: source
      target: '1000000004'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: knowledge-retrieval
        targetType: llm
      id: edge-rag-design
      source: '1000000004'
      sourceHandle: source
      target: '1000000005'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: code
      id: edge-design-format
      source: '1000000005'
      sourceHandle: source
      target: '1000000018'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: assigner
      id: edge-format-save
      source: '1000000018'
      sourceHandle: source
      target: '1000000006'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: assigner
        targetType: answer
      id: edge-save-showdesign
      source: '1000000006'
      sourceHandle: source
      target: '1000000007'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: code
      id: edge-story-format
      source: '1000000008'
      sourceHandle: source
      target: '1000000019'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: assigner
      id: edge-format-story-save
      source: '1000000019'
      sourceHandle: source
      target: '1000000009'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: assigner
        targetType: answer
      id: edge-save-showstory
      source: '1000000009'
      sourceHandle: source
      target: '1000000010'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: assigner
      id: edge-yaml-save
      source: '1000000011'
      sourceHandle: source
      target: '1000000016'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: assigner
        targetType: answer
      id: edge-save-show
      source: '1000000016'
      sourceHandle: source
      target: '1000000012'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: if-else
      id: edge-check-ifelse
      source: '1000000013'
      sourceHandle: source
      target: '1000000030'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: if-else
        targetType: llm
      id: edge-ifelse-consistency
      source: '1000000030'
      sourceHandle: 'false'
      target: '1000000014'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: if-else
        targetType: llm
      id: edge-ifelse-enhance
      source: '1000000030'
      sourceHandle: 'true'
      target: '1000000031'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: code
      id: edge-enhance-merge
      source: '1000000031'
      sourceHandle: source
      target: '1000000032'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: assigner
      id: edge-merge-assigner
      source: '1000000032'
      sourceHandle: source
      target: '1000000033'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: assigner
        targetType: llm
      id: edge-assigner-consistency
      source: '1000000033'
      sourceHandle: source
      target: '1000000014'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: assigner
      id: edge-consistency-assigner
      source: '1000000014'
      sourceHandle: source
      target: '1000000034'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: assigner
        targetType: answer
      id: edge-assigner-report
      source: '1000000034'
      sourceHandle: source
      target: '1000000015'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: true
        isInLoop: false
        iteration_id: '1000000021'
        sourceType: iteration-start
        targetType: code
      id: edge-iter-start-build
      source: 1000000021start
      sourceHandle: source
      target: '1000000022'
      targetHandle: target
      type: custom
      zIndex: 1002
    - data:
        isInIteration: true
        isInLoop: false
        iteration_id: '1000000021'
        sourceType: code
        targetType: http-request
      id: edge-iter-build-http
      source: '1000000022'
      sourceHandle: source
      target: '1000000023'
      targetHandle: target
      type: custom
      zIndex: 1002
    - data:
        isInIteration: true
        isInLoop: false
        iteration_id: '1000000021'
        sourceType: http-request
        targetType: code
      id: edge-iter-http-extract
      source: '1000000023'
      sourceHandle: source
      target: '1000000024'
      targetHandle: target
      type: custom
      zIndex: 1002
    - data:
        isInIteration: true
        isInLoop: false
        iteration_id: '1000000021'
        sourceType: code
        targetType: code
      id: edge-iter-parse-result
      source: '1000000024'
      sourceHandle: source
      target: '1000000025'
      targetHandle: target
      type: custom
      zIndex: 1002
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: code
      id: edge-parse-sessionid
      source: '1000000020'
      sourceHandle: source
      target: '1000000028'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: code
        targetType: iteration
      id: edge-sessionid-iteration
      source: '1000000028'
      sourceHandle: source
      target: '1000000021'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: iteration
        targetType: template-transform
      id: edge-iteration-template
      source: '1000000021'
      sourceHandle: source
      target: '1000000026'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: template-transform
        targetType: answer
      id: edge-template-answer
      source: '1000000026'
      sourceHandle: source
      target: '1000000027'
      targetHandle: target
      type: custom
      zIndex: 0
    nodes:
    - data:
        desc: User input receiver - current_phaseã§è‡ªå‹•åˆ†å²
        selected: false
        title: Start
        type: start
        variables: []
      height: 117
      id: '1000000001'
      position:
        x: 80
        y: 350
      positionAbsolute:
        x: 80
        y: 350
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        cases:
        - case_id: case-init
          conditions:
          - comparison_operator: is
            id: cond-init
            value: init
            variable_selector:
            - conversation
            - current_phase
          logical_operator: and
        - case_id: case-design_done
          conditions:
          - comparison_operator: is
            id: cond-design
            value: design_done
            variable_selector:
            - conversation
            - current_phase
          logical_operator: and
        - case_id: case-story_done
          conditions:
          - comparison_operator: is
            id: cond-story
            value: story_done
            variable_selector:
            - conversation
            - current_phase
          logical_operator: and
        - case_id: case-yaml_done
          conditions:
          - comparison_operator: is
            id: cond-yaml
            value: yaml_done
            variable_selector:
            - conversation
            - current_phase
          logical_operator: and
        - case_id: case-quality_done
          conditions:
          - comparison_operator: is
            id: cond-quality
            value: quality_done
            variable_selector:
            - conversation
            - current_phase
          logical_operator: and
        desc: current_phaseä¼šè©±å¤‰æ•°ã§ãƒ•ã‚§ãƒ¼ã‚ºåˆ†å²ã€‚LLMåˆ¤å®šã‚’ä½¿ã‚ãªã„ç¢ºå®ŸãªçŠ¶æ…‹ãƒã‚·ãƒ³
        selected: false
        title: Phase Router
        type: if-else
      height: 360
      id: '1000000099'
      position:
        x: 220
        y: 350
      positionAbsolute:
        x: 220
        y: 350
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nimport re\n\n# Protected compound words (domain-specific\
          \ terms)\nCOMPOUND_WORDS = [\n    \"çŸ³å·¥äº‹\", \"è¶³å ´\", \"ç†±ä¸­ç—‡\", \"KYæ´»å‹•\", \"\
          å®‰å…¨ç‚¹æ¤œ\",\n    \"æ–½å·¥è¨ˆç”»\", \"å“è³ªç®¡ç†\", \"å®‰å…¨ç®¡ç†\", \"å»ºè¨­ç¾å ´\",\n    \"ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ\", \"\
          é‰„ç­‹\", \"å‹æ \", \"ã‚¯ãƒ¬ãƒ¼ãƒ³\"\n]\n\ndef extract_search_keywords(user_input: str)\
          \ -> str:\n    \"\"\"\n    [FIX v2] Extract search keywords from user input\
          \ for RAG optimization.\n    - Preserves compound words by extracting them\
          \ first (no placeholder)\n    - Uses extended Unicode regex for complete\
          \ CJK coverage\n    - Prioritizes domain-specific compound words at the\
          \ beginning\n    \"\"\"\n    text = user_input\n    preserved_keywords =\
          \ []\n\n    # Step 1: Extract compound words first (preserve them in list)\n\
          \    for word in COMPOUND_WORDS:\n        if word in text:\n           \
          \ preserved_keywords.append(word)\n\n    # Step 2: Patterns to remove (non-search\
          \ intent)\n    remove_patterns = [\n        r'\\d+\\s*[ãƒšãƒ¼ã‚¸ãƒš]',\n       \
          \ r'ãƒãƒ³ã‚¬|æ¼«ç”»|ã¾ã‚“ãŒ',\n        r'ä½œã‚ŠãŸã„|ä½œæˆã—ã¦|ä½œã£ã¦',\n        r'ã‚’ä¼ãˆã‚‹|ã§ä¼ãˆã‚‹',\n   \
          \     r'ã«ã¤ã„ã¦å­¦ã¶|ã‚’å­¦ã¶',\n        r'ãƒã‚¤ãƒ³ãƒˆ',\n        r'æ°—ã‚’?ä»˜ã‘',\n    ]\n\n   \
          \ for pattern in remove_patterns:\n        text = re.sub(pattern, '', text)\n\
          \n    # Step 3: Extended Unicode regex for keyword extraction\n    keywords\
          \ = re.findall(r'[\\u4E00-\\u9FFF\\u3040-\\u309F\\u30A0-\\u30FFa-zA-Z0-9]+',\
          \ text)\n\n    # Step 4: Filter stopwords\n    stopwords = {\"ã®\", \"ã¯\"\
          , \"ãŒ\", \"ã‚’\", \"ã«\", \"ã§\", \"ã¨\", \"ã‚‚\", \"ã‚„\", \"ã¦\", \"ã—ãŸ\", \"ã™ã‚‹\"\
          }\n    keywords = [k for k in keywords if k not in stopwords and len(k)\
          \ >= 1]\n\n    # Step 5: Prioritize preserved compound words at the beginning\n\
          \    final_keywords = []\n    for word in preserved_keywords:\n        if\
          \ word not in final_keywords:\n            final_keywords.append(word)\n\
          \n    for k in keywords:\n        is_substring = any(k in cw and k != cw\
          \ for cw in preserved_keywords)\n        if k not in final_keywords and\
          \ not is_substring:\n            final_keywords.append(k)\n\n    return\
          \ ' '.join(final_keywords[:8])\n\ndef main(user_input: str, current_phase:\
          \ str, design_json: str) -> dict:\n    \"\"\"\n    Parse user input to extract\
          \ theme, characters, pages.\n    Also detects modification requests and\
          \ generates optimized search_query for RAG.\n    \"\"\"\n    # Initialize\
          \ default values\n    is_modification = False\n    modification_instruction\
          \ = \"\"\n    existing_design = \"\"\n\n    # Safely handle design_json\n\
          \    design_json_str = \"\"\n    if design_json is not None and design_json\
          \ != \"\":\n        design_json_str = str(design_json)\n\n        # Check\
          \ for modification patterns only if design exists\n        modification_patterns\
          \ = [\n            r'å¤‰æ›´ã—ã¦|å¤‰æ›´|ä¿®æ­£ã—ã¦|ä¿®æ­£',\n            r'å¤‰ãˆã¦|ã«ã—ã¦|ã«ã—ã¦ã»ã—ã„',\n\
          \            r'å¯¾è±¡.*ã‚’.*ã«|å¯¾è±¡è€….*ã‚’.*ã«',\n            r'é›£æ˜“åº¦.*ã‚’.*ã«|ãƒšãƒ¼ã‚¸æ•°.*ã‚’.*ã«',\n\
          \            r'ä»Šã®.*ã§|è¨­è¨ˆ.*ãã®ã¾ã¾|ãƒ†ãƒ¼ãƒ.*å¤‰ãˆãšã«',\n            r'å¢—ã‚„ã—ã¦|æ¸›ã‚‰ã—ã¦|ä¸Šã’ã¦|ä¸‹ã’ã¦',\n\
          \            r'è©³ã—ã|ç°¡æ½”ã«|ã‚‚ã£ã¨',\n        ]\n\n        for pattern in modification_patterns:\n\
          \            if re.search(pattern, user_input):\n                is_modification\
          \ = True\n                modification_instruction = user_input\n      \
          \          existing_design = design_json_str\n                break\n\n\
          \    # Initialize with defaults or preserve from existing design in modification\
          \ mode\n    theme = user_input\n    characters = \"\"  # Empty default,\
          \ will be set by extraction or existing design\n    total_pages = 4\n\n\
          \    # In modification mode, preserve existing design values\n    if is_modification\
          \ and design_json_str:\n        try:\n            existing = json.loads(design_json_str)\n\
          \            # Preserve theme from existing design\n            theme =\
          \ existing.get(\"story_overview\", {}).get(\"theme\", user_input)\n    \
          \        # Preserve characters from existing design\n            existing_chars\
          \ = existing.get(\"characters\", [])\n            if existing_chars:\n \
          \               characters = \", \".join([c.get(\"id\", \"\") for c in existing_chars\
          \ if c.get(\"id\")])\n            # Preserve total_pages from existing design\n\
          \            total_pages = existing.get(\"story_overview\", {}).get(\"total_pages\"\
          , 4)\n        except (json.JSONDecodeError, TypeError, AttributeError):\n\
          \            pass  # Fall back to defaults if parsing fails\n\n    # Extract\
          \ optimized search query for RAG\n    search_query = extract_search_keywords(user_input)\n\
          \n    # Extract page count if specified\n    page_match = re.search(r'(\\\
          d+)\\s*[ãƒšãƒ¼ã‚¸ãƒš]', user_input)\n    if page_match:\n        total_pages = int(page_match.group(1))\n\
          \n    # Extract characters if mentioned (supports both katakana and kanji)\n\
          \    char_patterns = [\n        (r'ã‚¿ã‚±ãƒ«|ãŸã‘ã‚‹', 'takeru'),\n        (r'ã‚«ã‚º(?:ã•ã‚“)?|ã‹ãš(?:ã•ã‚“)?',\
          \ 'kazusan'),\n        (r'ãƒªãƒ¥ã‚¦(?:ã•ã‚“)?|ã‚Šã‚…ã†(?:ã•ã‚“)?|ç«œ(?:ã•ã‚“)?', 'ryusan'),\n\
          \        (r'æ‰€é•·|ã—ã‚‡ã¡ã‚‡ã†', 'shochou')\n    ]\n    found_chars = []\n    for\
          \ pattern, char_id in char_patterns:\n        if re.search(pattern, user_input):\n\
          \            found_chars.append(char_id)\n\n    # Only override characters\
          \ if explicitly mentioned in input\n    if found_chars:\n        characters\
          \ = \", \".join(found_chars)\n    elif not characters:\n        # No characters\
          \ found and no existing design: use default\n        characters = \"takeru,\
          \ kazusan\"\n\n    return {\n        \"theme\": theme,\n        \"search_query\"\
          : search_query,\n        \"characters\": characters,\n        \"total_pages\"\
          : total_pages,\n        \"learning_goal\": theme + \"ã«ã¤ã„ã¦å­¦ã¶\",\n       \
          \ \"setting_location\": \"å»ºè¨­ç¾å ´\",\n        \"setting_time\": \"æ—¥ä¸­\",\n \
          \       \"art_style\": \"modern realistic\",\n        \"difficulty\": \"\
          beginner\",\n        \"is_modification\": \"true\" if is_modification else\
          \ \"false\",\n        \"modification_instruction\": modification_instruction,\n\
          \        \"existing_design\": existing_design\n    }\n"
        code_language: python3
        outputs:
          art_style:
            children: null
            type: string
          characters:
            children: null
            type: string
          difficulty:
            children: null
            type: string
          existing_design:
            children: null
            type: string
          is_modification:
            children: null
            type: string
          learning_goal:
            children: null
            type: string
          modification_instruction:
            children: null
            type: string
          search_query:
            children: null
            type: string
          setting_location:
            children: null
            type: string
          setting_time:
            children: null
            type: string
          theme:
            children: null
            type: string
          total_pages:
            children: null
            type: number
        selected: false
        title: 'CODE: Parse Input'
        type: code
        variables:
        - value_selector:
          - '1000000001'
          - sys.query
          value_type: string
          variable: user_input
        - value_selector:
          - conversation
          - current_phase
          value_type: string
          variable: current_phase
        - value_selector:
          - conversation
          - design_json
          value_type: string
          variable: design_json
      height: 52
      id: '1000000003'
      position:
        x: 680
        y: 150
      positionAbsolute:
        x: 680
        y: 150
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        dataset_ids:
        - KhqY3/pLuw/5nCFaUyaWHQLsDo0HI3WqaDHLOvaKW397RixQ8W78g/YdA3GtgS8K
        multiple_retrieval_config:
          reranking_enable: true
          reranking_mode: weighted_score
          score_threshold: 0.35
          top_k: 8
          weights:
            keyword_setting:
              keyword_weight: 0.5
            vector_setting:
              embedding_model_name: text-embedding-3-large
              embedding_provider_name: langgenius/openai/openai
              vector_weight: 0.5
            weight_type: customized
        query_variable_selector:
        - '1000000003'
        - search_query
        retrieval_mode: multiple
        selected: false
        title: Knowledge Retrieval
        type: knowledge-retrieval
      height: 90
      id: '1000000004'
      position:
        x: 960
        y: 150
      positionAbsolute:
        x: 960
        y: 150
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: true
          variable_selector:
          - '1000000004'
          - result
        desc: Generate learning design JSON
        edition_type: basic
        memory:
          role_prefix:
            assistant: ''
            user: ''
          window:
            enabled: false
            size: 50
        model:
          completion_params:
            frequency_penalty: 0
            max_tokens: 2048
            presence_penalty: 0
            temperature: 0.7
            top_p: 1
          mode: chat
          name: gpt-4o
          provider: langgenius/openai/openai
        prompt_template:
        - role: system
          text: "ã‚ãªãŸã¯å»ºè¨­æ¥­ç•Œå‘ã‘æ•™è‚²ãƒãƒ³ã‚¬ã®æ•™è‚²è¨­è¨ˆã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚\n\næ—¥æœ¬ã®ç‰©èªæ§‹é€ ï¼ˆèµ·æ‰¿è»¢çµï¼‰ã«å¾“ã£ã¦æ•™è‚²æ§‹é€ ã‚’è¨­è¨ˆã—ã¦ãã ã•ã„ï¼š\n\
            - èµ·ï¼ˆå°å…¥ï¼‰: çŠ¶æ³è¨­å®š\n- æ‰¿ï¼ˆå±•é–‹ï¼‰: å­¦ç¿’å†…å®¹ã®å±•é–‹\n- è»¢ï¼ˆè»¢æ›ï¼‰: èª²é¡Œã¾ãŸã¯é‡è¦ãªæ°—ã¥ã\n- çµï¼ˆçµæœ«ï¼‰: è§£æ±ºã¨å­¦ã³\n\
            \nå‡ºåŠ›ã¯å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š\n{\n  \"story_overview\": {\n    \"title\"\
            : \"ãƒãƒ³ã‚¬ã®ã‚¿ã‚¤ãƒˆãƒ«\",\n    \"theme\": \"ãƒ†ãƒ¼ãƒ\",\n    \"learning_goal\": \"å­¦ç¿’ç›®æ¨™\"\
            ,\n    \"target_audience\": \"å¯¾è±¡è€…\",\n    \"total_pages\": 4,\n    \"\
            story_arc\": {\n      \"ki\": \"èµ·ã®èª¬æ˜\",\n      \"sho\": \"æ‰¿ã®èª¬æ˜\",\n  \
            \    \"ten\": \"è»¢ã®èª¬æ˜\",\n      \"ketsu\": \"çµã®èª¬æ˜\"\n    }\n  },\n  \"\
            learning_objectives\": [\"ç›®æ¨™1\", \"ç›®æ¨™2\", \"ç›®æ¨™3\"],\n  \"educational_points\"\
            : [\n    {\"point_number\": 1, \"content\": \"å†…å®¹\", \"category\": \"ki\"\
            }\n  ],\n  \"pages\": [\n    {\n      \"page_number\": 1,\n      \"arc_phase\"\
            : \"ki\",\n      \"learning_focus\": \"ã“ã®ãƒšãƒ¼ã‚¸ã®å­¦ç¿’ç„¦ç‚¹\",\n      \"key_message\"\
            : \"ã‚­ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸\"\n    }\n  ]\n}\n"
        - role: user
          text: '{% if 1000000003.is_modification == "true" %}

            ã€è¨­è¨ˆä¿®æ­£ãƒ¢ãƒ¼ãƒ‰ã€‘


            æ—¢å­˜ã®è¨­è¨ˆ:

            {{#1000000003.existing_design#}}


            ä¿®æ­£æŒ‡ç¤º:

            {{#1000000003.modification_instruction#}}


            ä¸Šè¨˜ã®ä¿®æ­£æŒ‡ç¤ºã«åŸºã¥ã„ã¦ã€æ—¢å­˜è¨­è¨ˆã‚’éƒ¨åˆ†æ›´æ–°ã—ã¦ãã ã•ã„ã€‚

            - å¤‰æ›´ãŒå¿…è¦ãªéƒ¨åˆ†ã®ã¿ä¿®æ­£ã—ã¦ãã ã•ã„

            - ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯æ—¢å­˜è¨­è¨ˆã®å€¤ã‚’ç¶­æŒã—ã¦ãã ã•ã„

            - JSONå½¢å¼ã§å®Œå…¨ãªè¨­è¨ˆJSONã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„

            - ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã¯ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„


            {% else %}

            ã€æ–°è¦è¨­è¨ˆãƒ¢ãƒ¼ãƒ‰ã€‘


            ãƒ†ãƒ¼ãƒ: {{#1000000003.theme#}}

            å­¦ç¿’ç›®æ¨™: {{#1000000003.learning_goal#}}

            ãƒšãƒ¼ã‚¸æ•°: {{#1000000003.total_pages#}}

            ç™»å ´äººç‰©: {{#1000000003.characters#}}

            å ´æ‰€è¨­å®š: {{#1000000003.setting_location#}}

            æ™‚é–“è¨­å®š: {{#1000000003.setting_time#}}

            ã‚¢ãƒ¼ãƒˆã‚¹ã‚¿ã‚¤ãƒ«: {{#1000000003.art_style#}}

            é›£æ˜“åº¦: {{#1000000003.difficulty#}}


            å‚è€ƒçŸ¥è­˜:

            {{#context#}}


            ä¸Šè¨˜ã®æƒ…å ±ã‚’ã‚‚ã¨ã«ã€æ•™è‚²ãƒãƒ³ã‚¬ã®è¨­è¨ˆJSONã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

            å‡ºåŠ›ã¯JSONã®ã¿ã§ã€ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã¯ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚

            {% endif %}

            '
        selected: false
        structured_output_enabled: false
        title: 'LLM: Learning Design'
        type: llm
        variables: []
        vision:
          enabled: false
      height: 116
      id: '1000000005'
      position:
        x: 1240
        y: 150
      positionAbsolute:
        x: 1240
        y: 150
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        desc: ''
        items:
        - input_type: variable
          operation: over-write
          value:
          - '1000000005'
          - text
          variable_selector:
          - conversation
          - design_json
          write_mode: over-write
        - input_type: constant
          operation: over-write
          value: design_done
          variable_selector:
          - conversation
          - current_phase
          write_mode: over-write
        - input_type: variable
          operation: over-write
          value:
          - '1000000003'
          - theme
          variable_selector:
          - conversation
          - theme
          write_mode: over-write
        - input_type: variable
          operation: over-write
          value:
          - '1000000003'
          - characters
          variable_selector:
          - conversation
          - characters
          write_mode: over-write
        - input_type: variable
          operation: over-write
          value:
          - '1000000003'
          - total_pages
          variable_selector:
          - conversation
          - total_pages
          write_mode: over-write
        selected: false
        title: 'ASSIGNER: Save Design'
        type: assigner
        version: '2'
      height: 188
      id: '1000000006'
      position:
        x: 1800
        y: 150
      positionAbsolute:
        x: 1800
        y: 150
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        answer: '## æ•™è‚²è¨­è¨ˆãŒå®Œæˆã—ã¾ã—ãŸ


          {{#1000000018.formatted_output#}}


          ---


          <details>

          <summary>è©³ç´°JSONï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</summary>


          ```json

          {{#1000000018.raw_json#}}

          ```

          </details>


          ---


          è¨­è¨ˆå†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

          - OKãªã‚‰ã€Œæ‰¿èªã€ã¾ãŸã¯ã€Œæ¬¡ã¸ã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„

          - ä¿®æ­£ãŒå¿…è¦ãªå ´åˆã¯ã€ä¿®æ­£å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„

          '
        desc: ''
        selected: false
        title: 'Answer: Design'
        type: answer
        variables:
        - value_selector:
          - '1000000018'
          - formatted_output
          variable: design_output
      height: 232
      id: '1000000007'
      position:
        x: 2080
        y: 150
      positionAbsolute:
        x: 2080
        y: 150
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        desc: Generate story details from design JSON
        edition_type: basic
        memory:
          role_prefix:
            assistant: ''
            user: ''
          window:
            enabled: false
            size: 50
        model:
          completion_params:
            frequency_penalty: 0
            max_tokens: 4096
            presence_penalty: 0
            temperature: 0.7
            top_p: 1
          mode: chat
          name: gpt-4o
          provider: langgenius/openai/openai
        prompt_template:
        - role: system
          text: "ã‚ãªãŸã¯å»ºè¨­æ¥­ç•Œå‘ã‘æ•™è‚²ãƒãƒ³ã‚¬ã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼è©³ç´°åŒ–ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚\n\n## 5ã‚³ãƒãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä»•æ§˜\n\nå„ãƒšãƒ¼ã‚¸ã¯5ã‚³ãƒã§æ§‹æˆã—ã¾ã™ã€‚1ã‚³ãƒãŒæ¨ªé•·ã«ãªã‚Šã€ãã®ä½ç½®ã¯emphasis_pointã§æ±ºå®šã—ã¾ã™ã€‚\n\
            \n### emphasis_point ã¨æ¨ªé•·ã‚³ãƒä½ç½®\n- opening: ä¸Šæ®µæ¨ªé•·ï¼ˆãƒ‘ãƒãƒ«1ãŒæ¨ªé•·ï¼‰- èª­è€…ã‚’å¼•ãè¾¼ã‚€å°å…¥ã‚·ãƒ¼ãƒ³å‘ã‘\n\
            - turning: ä¸­æ®µæ¨ªé•·ï¼ˆãƒ‘ãƒãƒ«3ãŒæ¨ªé•·ï¼‰- æ ¸å¿ƒãƒ»æ°—ã¥ããƒ»é‡è¦æ¦‚å¿µã®å¼·èª¿å‘ã‘\n- conclusion: ä¸‹æ®µæ¨ªé•·ï¼ˆãƒ‘ãƒãƒ«5ãŒæ¨ªé•·ï¼‰-\
            \ ä½™éŸ»ãƒ»è§£æ±ºãƒ»ã¾ã¨ã‚å‘ã‘\n\n### 5ã‚³ãƒã®åŸºæœ¬é…ç½®ï¼ˆconclusionã®å ´åˆï¼‰\n- ãƒ‘ãƒãƒ«1: top_right, large\
            \ - çŠ¶æ³è¨­å®š\n- ãƒ‘ãƒãƒ«2: top_left, medium - å•é¡Œæèµ·\n- ãƒ‘ãƒãƒ«3: middle_right, medium\
            \ - æŒ‡å°ãƒ»èª¬æ˜\n- ãƒ‘ãƒãƒ«4: middle_left, large - å®Ÿè·µãƒ»æŒ‘æˆ¦\n- ãƒ‘ãƒãƒ«5: bottom_center,\
            \ wideï¼ˆæ¨ªé•·ï¼‰- è§£æ±ºãƒ»å­¦ã³\n\n## emphasis_point æ±ºå®šåŸºæº–ï¼ˆå„ªå…ˆé †ä½é †ï¼‰\n\n1. æ„Ÿæƒ…ã®é ‚ç‚¹ï¼ˆæœ€å„ªå…ˆï¼‰\n\
            \   - ã€Œãƒãƒƒã¨æ°—ã¥ãã€ç¬é–“ â†’ turning\n   - å±é™ºã‹ã‚‰ã®è§£æ”¾ â†’ conclusion\n   - é©šãã®ç™ºè¦‹ â†’ opening\
            \ ã¾ãŸã¯ turning\n\n2. å­¦ç¿’ã®æ ¸å¿ƒ\n   - é‡è¦æ¦‚å¿µã®æç¤º â†’ turning\n   - æ­£ã—ã„æ‰‹é †ã®ãƒ‡ãƒ¢ â†’ turning\n\
            \   - é–“é•ã„ã¨æ­£è§£ã®å¯¾æ¯” â†’ turning\n\n3. è¦–è¦šçš„ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ\n   - åºƒã„ç¾å ´ã®å…¨æ™¯ â†’ opening\n   -\
            \ ã‚¯ãƒ­ãƒ¼ã‚ºã‚¢ãƒƒãƒ—è©³ç´° â†’ turning\n   - å®Œæˆã—ãŸæˆæœç‰© â†’ conclusion\n\n4. ç‰©èªæ§‹é€ ï¼ˆæœ€ã‚‚ä½ã„å„ªå…ˆåº¦ï¼‰\n\
            \   - å°å…¥ â†’ opening\n   - ç™ºå±• â†’ turning ã¾ãŸã¯ conclusion\n   - è»¢æ› â†’ turning\n\
            \   - è§£æ±º â†’ conclusion\n\n## æ±ç”¨ãƒ«ãƒ¼ãƒ«\n- æœ€åˆã®ãƒšãƒ¼ã‚¸: åŸå‰‡ opening\n- æœ€å¾Œã®ãƒšãƒ¼ã‚¸: åŸå‰‡\
            \ conclusion\n- turning ã¯å…¨ä½“ã®1/3ä»¥ä¸‹\n- åŒã˜emphasis_pointã¯é€£ç¶š2ãƒšãƒ¼ã‚¸ã¾ã§\n\n## çµï¼ˆketsuï¼‰ãƒ•ã‚§ãƒ¼ã‚ºã®ç‰¹åˆ¥ãƒ«ãƒ¼ãƒ«ã€é‡è¦ã€‘\n\
            æœ€çµ‚ãƒšãƒ¼ã‚¸ï¼ˆarc_phase: ketsuï¼‰ã§ã¯ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã‚»ãƒªãƒ•ã¨ã—ã¦æ•™è¨“ã‚’3ã¤å¿…ãšè¿°ã¹ã¦ãã ã•ã„:\n\
            - å½¢å¼: ãƒ¡ã‚¤ãƒ³ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼ˆé€šå¸¸takeruï¼‰ãŒã€Œä»Šæ—¥å­¦ã‚“ã ã“ã¨ã¯3ã¤ã‚ã‚Šã¾ã™ã€ã¨åˆ‡ã‚Šå‡ºã™\n\
            - 1ã¤ç›®: å®‰å…¨ãƒ»åŸºæœ¬ã«é–¢ã™ã‚‹æ•™è¨“\n\
            - 2ã¤ç›®: æŠ€è¡“ãƒ»ã‚¹ã‚­ãƒ«ã«é–¢ã™ã‚‹æ•™è¨“\n\
            - 3ã¤ç›®: ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãƒ»å¿ƒæ§‹ãˆã«é–¢ã™ã‚‹æ•™è¨“\n\
            - ä¾‹: \"ä»Šæ—¥å­¦ã‚“ã ã“ã¨ã¯3ã¤ã€‚1ã¤ç›®ã¯ã€ä½œæ¥­å‰ã®å®‰å…¨ç¢ºèªã¯å‘½ã‚’å®ˆã‚‹ç¬¬ä¸€æ­©ã€‚2ã¤ç›®ã¯ã€é“å…·ã®æ­£ã—ã„ä½¿ã„æ–¹ãŒå“è³ªã‚’æ±ºã‚ã‚‹ã€‚3ã¤ç›®ã¯ã€ä»²é–“ã¨ã®å£°æ›ã‘ãŒäº‹æ•…ã‚’é˜²ãã€‚\"\n\n## å‡ºåŠ›JSONå½¢å¼\n\
            {\n  \"pages\": [\n    {\n      \"page_number\": 1,\n      \"arc_phase\"\
            : \"ki\",\n      \"emphasis_point\": \"opening\",\n      \"emphasis_reason\"\
            : \"èª­è€…ã‚’ç¾å ´ã«å¼•ãè¾¼ã‚€å°å…¥ã‚·ãƒ¼ãƒ³ã®ãŸã‚\",\n      \"learning_focus\": \"å­¦ç¿’ç„¦ç‚¹\",\n     \
            \ \"key_message\": \"ã‚­ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸\",\n      \"key_scene\": \"ã‚·ãƒ¼ãƒ³ã®è©³ç´°èª¬æ˜\",\n\
            \      \"dialogue\": [\n        {\"character\": \"takeru\", \"text\":\
            \ \"å°è©1\", \"panel\": 1},\n        {\"character\": \"kazusan\", \"text\"\
            : \"å°è©2\", \"panel\": 2}\n      ],\n      \"panels\": [\n        {\n \
            \         \"panel_number\": 1,\n          \"position\": \"top_center\"\
            ,\n          \"size\": \"wide\",\n          \"section_mapping\": \"ki\"\
            ,\n          \"description\": \"ãƒ‘ãƒãƒ«ã®èª¬æ˜\",\n          \"camera\": {\n \
            \           \"angle\": \"low_angle\",\n            \"shot_type\": \"wide_shot\"\
            ,\n            \"focus\": \"ç¾å ´å…¨æ™¯\"\n          },\n          \"characters\"\
            : [\"takeru\", \"kazusan\"]\n        },\n        {\n          \"panel_number\"\
            : 2,\n          \"position\": \"middle_left\",\n          \"size\": \"\
            medium\",\n          \"section_mapping\": \"ki\",\n          \"description\"\
            : \"ãƒ‘ãƒãƒ«ã®èª¬æ˜\",\n          \"camera\": {\n            \"angle\": \"eye_level\"\
            ,\n            \"shot_type\": \"medium_shot\",\n            \"focus\"\
            : \"ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼\"\n          },\n          \"characters\": [\"takeru\"]\n \
            \       }\n      ]\n    }\n  ]\n}\n\né‡è¦: å„ãƒšãƒ¼ã‚¸ã«å¿…ãš5ã¤ã®ãƒ‘ãƒãƒ«ã‚’å«ã‚ã¦ãã ã•ã„ã€‚\n"
        - role: user
          text: 'ãƒ†ãƒ¼ãƒ: {{#conversation.theme#}}

            ç™»å ´äººç‰©: {{#conversation.characters#}}

            ãƒšãƒ¼ã‚¸æ•°: {{#conversation.total_pages#}}


            è¨­è¨ˆJSON:

            {{#conversation.design_json#}}


            ä¸Šè¨˜ã®è¨­è¨ˆã«åŸºã¥ã„ã¦ã€å„ãƒšãƒ¼ã‚¸ã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼è©³ç´°JSONã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

            å„ãƒšãƒ¼ã‚¸ã¯5ã‚³ãƒã§æ§‹æˆã—ã€emphasis_pointã¯ã‚¹ãƒˆãƒ¼ãƒªãƒ¼å†…å®¹ã‚’åˆ†æã—ã¦å‹•çš„ã«æ±ºå®šã—ã¦ãã ã•ã„ã€‚

            å‡ºåŠ›ã¯JSONã®ã¿ã§ã€ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã¯ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚

            '
        selected: false
        structured_output_enabled: false
        title: 'LLM: Story Details'
        type: llm
        variables: []
        vision:
          enabled: false
      height: 132
      id: '1000000008'
      position:
        x: 680
        y: 350
      positionAbsolute:
        x: 680
        y: 350
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        desc: ''
        items:
        - input_type: variable
          operation: over-write
          value:
          - '1000000008'
          - text
          variable_selector:
          - conversation
          - story_json
          write_mode: over-write
        - input_type: variable
          operation: over-write
          value:
          - '1000000008'
          - text
          variable_selector:
          - conversation
          - pages_array
          write_mode: over-write
        - input_type: constant
          operation: over-write
          value: story_done
          variable_selector:
          - conversation
          - current_phase
          write_mode: over-write
        selected: false
        title: 'ASSIGNER: Save Story'
        type: assigner
        version: '2'
      height: 136
      id: '1000000009'
      position:
        x: 1240
        y: 350
      positionAbsolute:
        x: 1240
        y: 350
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        answer: '## ã‚¹ãƒˆãƒ¼ãƒªãƒ¼è©³ç´°ãŒå®Œæˆã—ã¾ã—ãŸ


          {{#1000000019.formatted_output#}}


          ---


          <details>

          <summary>è©³ç´°JSONï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹ï¼‰</summary>


          ```json

          {{#1000000019.raw_json#}}

          ```

          </details>


          ---


          ã‚¹ãƒˆãƒ¼ãƒªãƒ¼è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

          - OKãªã‚‰ã€Œç”Ÿæˆé–‹å§‹ã€ã¨å…¥åŠ›ã—ã¦YAMLç”Ÿæˆã‚’é–‹å§‹ã—ã¦ãã ã•ã„

          - ä¿®æ­£ãŒå¿…è¦ãªå ´åˆã¯ã€ä¿®æ­£å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„

          '
        desc: ''
        selected: false
        title: 'Answer: Story'
        type: answer
        variables:
        - value_selector:
          - '1000000019'
          - formatted_output
          variable: story_output
      height: 232
      id: '1000000010'
      position:
        x: 1520
        y: 350
      positionAbsolute:
        x: 1520
        y: 350
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nimport re\n\ndef extract_json(text: str) -> str:\n   \
          \ \"\"\"Extract JSON from markdown code block or raw text.\"\"\"\n    match\
          \ = re.search(r'```json\\s*([\\s\\S]*?)\\s*```', text)\n    if match:\n\
          \        return match.group(1).strip()\n    match = re.search(r'```\\s*([\\\
          s\\S]*?)\\s*```', text)\n    if match:\n        return match.group(1).strip()\n\
          \    match = re.search(r'\\{[\\s\\S]*\\}', text)\n    if match:\n      \
          \  return match.group(0)\n    return text\n\n# 5ã‚³ãƒãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå®šç¾©ï¼ˆemphasis_pointåˆ¥ï¼‰\n\
          PANEL_LAYOUT_5 = {\n    \"opening\": [\n        {\"id\": 1, \"position\"\
          : \"top_center\", \"size\": \"wide\", \"story_phase\": \"èµ·\"},\n        {\"id\": 2, \"position\"\
          : \"middle_left\", \"size\": \"medium\", \"story_phase\": \"èµ·\"},\n        {\"id\"\
          : 3, \"position\": \"middle_right\", \"size\": \"medium\", \"story_phase\": \"æ‰¿\"},\n\
          \        {\"id\": 4, \"position\": \"bottom_right\", \"size\": \"large\", \"story_phase\": \"æ‰¿\"},\n\
          \        {\"id\": 5, \"position\": \"bottom_left\", \"size\": \"medium\", \"story_phase\": \"æ‰¿\"}\n    ],\n\
          \    \"turning\": [\n        {\"id\": 1, \"position\": \"top_right\", \"size\": \"medium\", \"story_phase\": \"æ‰¿\"},\n\
          \        {\"id\": 2, \"position\": \"top_left\", \"size\": \"medium\", \"story_phase\": \"æ‰¿\"},\n\
          \        {\"id\": 3, \"position\": \"middle_center\", \"size\": \"wide\", \"story_phase\": \"è»¢\"},\n\
          \        {\"id\": 4, \"position\": \"bottom_right\", \"size\": \"medium\", \"story_phase\": \"è»¢\"},\n\
          \        {\"id\": 5, \"position\": \"bottom_left\", \"size\": \"medium\", \"story_phase\": \"çµ\"}\n    ],\n\
          \    \"conclusion\": [\n        {\"id\": 1, \"position\": \"top_right\", \"size\": \"large\", \"story_phase\": \"è»¢\"},\n\
          \        {\"id\": 2, \"position\": \"top_left\", \"size\": \"medium\", \"story_phase\": \"è»¢\"},\n\
          \        {\"id\": 3, \"position\": \"middle_right\", \"size\": \"medium\", \"story_phase\": \"çµ\"},\n\
          \        {\"id\": 4, \"position\": \"middle_left\", \"size\": \"large\", \"story_phase\": \"çµ\"},\n\
          \        {\"id\": 5, \"position\": \"bottom_center\", \"size\": \"wide\", \"story_phase\": \"çµ\"}\n    ]\n}\n\n\
          # èµ·æ‰¿è»¢çµãƒãƒƒãƒ”ãƒ³ã‚°\nARC_PHASE_JP = {\"ki\": \"èµ·\", \"sho\": \"æ‰¿\", \"ten\": \"è»¢\", \"ketsu\": \"çµ\"}\n\n\
          def main(story_json: str, characters: str) -> dict:\n    \"\"\"\n\
          \    Generate YAML from story JSON - v4.0 full rewrite.\n\
          \    No URLs, complete manga specification format.\n\
          \    \"\"\"\n    try:\n        json_str = extract_json(story_json)\n   \
          \     data = json.loads(json_str)\n        pages = data.get(\"pages\", [])\n\
          \        total_pages = len(pages)\n\n        # Get active character names (no URLs)\n\
          \        active_chars = []\n        for char_id in [\"takeru\", \"kazusan\", \"ryusan\", \"shochou\"]:\n\
          \            if char_id in characters.lower():\n                active_chars.append(char_id)\n\n\
          \        if not active_chars:\n            active_chars = [\"takeru\", \"kazusan\"]\n\n\
          \        yaml_parts = []\n        for page in pages:\n            page_num = page.get(\"page_number\", 1)\n\
          \            arc_phase = page.get(\"arc_phase\", \"sho\")\n            arc_phase_jp = ARC_PHASE_JP.get(arc_phase, \"æ‰¿\")\n\
          \            emphasis = page.get(\"emphasis_point\", \"conclusion\")\n\
          \            key_scene = page.get(\"key_scene\", \"\")\n            key_message = page.get(\"key_message\", \"\")\n\
          \            learning_focus = page.get(\"learning_focus\", \"\")\n\
          \            story_panels = page.get(\"panels\", [])\n            dialogues = page.get(\"dialogue\", [])\n\n\
          \            # Select layout based on emphasis_point\n\
          \            layout_def = PANEL_LAYOUT_5.get(emphasis, PANEL_LAYOUT_5[\"conclusion\"])\n\n\
          \            # Build YAML with complete specification\n\
          \            yaml_content = f\"\"\"# ============================================================\\n\
          # Page {page_num} of {total_pages}\\n\
          # ============================================================\\n\\n\
          format:\\n\
            aspect_ratio: \\\"2:3\\\"\\n\
            orientation: portrait\\n\
            color: true\\n\
            reading_order: right_to_left\\n\
            panel_count: 5\\n\
            panel_borders: \\\"clean black, 2-3px\\\"\\n\
            style: \\\"Gekiga manga with 4-head SD proportions\\\"\\n\\n\
          story:\\n\
            arc_phase: {arc_phase} ({arc_phase_jp})\\n\
            emphasis_point: {emphasis}\\n\
            key_scene: \\\"{key_scene}\\\"\\n\
            key_message: \\\"{key_message}\\\"\\n\
            learning_focus: \\\"{learning_focus}\\\"\\n\\n\
          characters:\"\"\"\n\n\
          \            # Add characters with pose/expression from panels\n\
          \            char_info = {}\n            for panel in story_panels:\n\
          \                for char in panel.get(\"characters\", []):\n\
          \                    if isinstance(char, str):\n                        char_info[char] = {\"pose\": \"standing\", \"expression\": \"neutral\"}\n\
          \                    elif isinstance(char, dict):\n                        name = char.get(\"name\", \"\")\n\
          \                        if name:\n                            char_info[name] = {\n\
          \                                \"pose\": char.get(\"pose\", \"standing\"),\n\
          \                                \"expression\": char.get(\"expression\", \"neutral\")\n                            }\n\n\
          \            for char_name in active_chars:\n                info = char_info.get(char_name, {\"pose\": \"standing\", \"expression\": \"neutral\"})\n\
          \                yaml_content += f\"\"\"\\n  - name: {char_name}\\n    pose: {info['pose']}\\n    expression: {info['expression']}\"\"\"\n\n\
          \            yaml_content += \"\\n\\npanels:\"\n\n\
          \            # Generate 5 panels with full details\n\
          \            for i, layout_panel in enumerate(layout_def):\n\
          \                panel_id = layout_panel[\"id\"]\n                story_panel = story_panels[i] if i < len(story_panels) else {}\n\
          \                desc = story_panel.get(\"description\", key_scene)\n                camera = story_panel.get(\"camera\", {})\n\
          \                panel_chars = story_panel.get(\"characters\", active_chars[:2])\n\
          \                background = story_panel.get(\"background\", \"å»ºè¨­ç¾å ´\")\n\
          \                effects = story_panel.get(\"effects\", [])\n\n\
          \                yaml_content += f\"\"\"\\n  - number: {panel_id}\\n\
              position: {layout_panel['position']}\\n\
              size: {layout_panel['size']}\\n\
              story_phase: \\\"{layout_panel['story_phase']}\\\"\\n\
              scene: \\\"{desc}\\\"\\n\
              camera:\\n\
                angle: {camera.get('angle', 'eye_level')}\\n\
                shot_type: {camera.get('shot_type', 'medium_shot')}\\n\
                focus: \\\"{camera.get('focus', 'ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼')}\\\"\\n\
              background: \\\"{background}\\\"\\n\
              characters:\"\"\"\n\n\
          \                for char in panel_chars:\n\
          \                    char_name = char if isinstance(char, str) else char.get(\"name\", \"\")\n\
          \                    if char_name:\n\
          \                        pose = \"standing\"\n                        expression = \"neutral\"\n\
          \                        action = \"\"\n                        if isinstance(char, dict):\n\
          \                            pose = char.get(\"pose\", \"standing\")\n\
          \                            expression = char.get(\"expression\", \"neutral\")\n\
          \                            action = char.get(\"action\", \"\")\n\
          \                        yaml_content += f\"\"\"\\n        - name: {char_name}\\n          pose: {pose}\\n          expression: {expression}\"\"\"\n\
          \                        if action:\n                            yaml_content += f\"\\n          action: \\\"{action}\\\"\"\n\n\
          \                # Add dialogues for this panel\n\
          \                panel_dialogues = [d for d in dialogues if d.get(\"panel\") == panel_id]\n\
          \                if panel_dialogues:\n                    yaml_content += \"\\n      dialogue:\"\n\
          \                    for d in panel_dialogues:\n\
          \                        speaker = d.get(\"character\", \"\")\n                        text = d.get(\"text\", \"\")\n\
          \                        emotion = d.get(\"emotion\", \"\")\n\
          \                        yaml_content += f\"\"\"\\n        - speaker: {speaker}\\n          text: \\\"{text}\\\"\"\"\"\n\
          \                        if emotion:\n                            yaml_content += f\"\\n          emotion: {emotion}\"\n\n\
          \                # Add effects\n                if effects:\n                    if isinstance(effects, list):\n\
          \                        yaml_content += f\"\\n      effects: {effects}\"\n\
          \                    else:\n                        yaml_content += f\"\\n      effects: [\\\"{effects}\\\"]\"\n\n\
          \            # Add lessons for ketsu phase\n            if arc_phase == \"ketsu\":\n\
          \                yaml_content += \"\"\"\\n\\nlessons:\\n  - \\\"å®‰å…¨: ä½œæ¥­å‰ã®ç¢ºèªã¯å‘½ã‚’å®ˆã‚‹ç¬¬ä¸€æ­©\\\"\\n  - \\\"æŠ€è¡“: æ­£ã—ã„æ‰‹é †ãŒå“è³ªã‚’æ±ºã‚ã‚‹\\\"\\n  - \\\"å¿ƒæ§‹ãˆ: ä»²é–“ã¨ã®å£°æ›ã‘ãŒäº‹æ•…ã‚’é˜²ã\\\"\"\"\"\n\n\
          \            yaml_parts.append(yaml_content)\n\n\
          \        full_yaml = \"\\n\\n---\\n\\n\".join(yaml_parts)\n\n\
          \        return {\n            \"yaml_content\": full_yaml,\n            \"page_count\": len(pages),\n\
          \            \"status\": \"success\"\n        }\n    except Exception as e:\n\
          \        return {\n            \"yaml_content\": f\"Error: {str(e)}\",\n\
          \            \"page_count\": 0,\n            \"status\": \"error\"\n        }\n"
        code_language: python3
        outputs:
          page_count:
            children: null
            type: number
          status:
            children: null
            type: string
          yaml_content:
            children: null
            type: string
        selected: false
        title: 'CODE: Generate YAML'
        type: code
        variables:
        - value_selector:
          - conversation
          - story_json
          value_type: string
          variable: story_json
        - value_selector:
          - conversation
          - characters
          value_type: string
          variable: characters
      height: 52
      id: '1000000011'
      position:
        x: 680
        y: 550
      positionAbsolute:
        x: 680
        y: 550
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        desc: ''
        items:
        - input_type: variable
          operation: over-write
          value:
          - '1000000011'
          - yaml_content
          variable_selector:
          - conversation
          - yaml_content
          write_mode: over-write
        - input_type: constant
          operation: over-write
          value: yaml_done
          variable_selector:
          - conversation
          - current_phase
          write_mode: over-write
        selected: false
        title: 'ASSIGNER: Save YAML'
        type: assigner
        version: '2'
      height: 110
      id: '1000000016'
      position:
        x: 960
        y: 550
      positionAbsolute:
        x: 960
        y: 550
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        answer: '## YAMLç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸ


          ```yaml

          {{#1000000011.yaml_content#}}

          ```


          ---


          ç”Ÿæˆã•ã‚ŒãŸYAMLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

          - å“è³ªãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€Œå“è³ªãƒã‚§ãƒƒã‚¯ã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„

          - æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™å ´åˆã¯ã€æ–°ã—ã„ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„

          '
        desc: ''
        selected: false
        title: 'Answer: YAML'
        type: answer
        variables:
        - value_selector:
          - '1000000011'
          - yaml_content
          variable: yaml_output
      height: 182
      id: '1000000012'
      position:
        x: 1240
        y: 550
      positionAbsolute:
        x: 1240
        y: 550
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nimport re\nfrom typing import List, Tuple\n\ndef count_descriptive_words(text:\
          \ str) -> int:\n    \"\"\"Count Japanese adjectives and descriptive words\"\
          \"\"\n    adj_patterns = [\n        r'[ã„ãã—ã¡ã«ã²ã¿ã‚Šãˆã‘ã›ã¦ã­ã¸ã‚ã‚Œ]ã„',\n        r'ãª\\\
          b',\n        r'çš„ãª?',\n        r'ã‚‰ã—ã„',\n    ]\n    count = 0\n    for pattern\
          \ in adj_patterns:\n        count += len(re.findall(pattern, text))\n  \
          \  return count\n\ndef evaluate_character_detail(design_json_str: str) ->\
          \ Tuple[int, List[str]]:\n    \"\"\"Evaluate character detail level (0-30\
          \ points)\"\"\"\n    score = 0\n    missing = []\n    try:\n        design\
          \ = json.loads(design_json_str) if design_json_str else {}\n    except json.JSONDecodeError:\n\
          \        return 0, [\"JSON parse error\"]\n\n    characters = design.get(\"\
          characters\", [])\n    if not characters:\n        return 15, []  # No characters\
          \ defined, give default score\n\n    per_char_score = 30 // max(len(characters),\
          \ 1)\n    for char in characters:\n        char_id = char.get(\"id\", \"\
          unknown\")\n        appearance = char.get(\"appearance\", \"\")\n      \
          \  personality = char.get(\"personality\", \"\")\n        role = char.get(\"\
          role\", \"\")\n\n        char_score = 0\n        if len(appearance) >= 10:\n\
          \            char_score += per_char_score // 3\n        elif appearance:\n\
          \            char_score += per_char_score // 6\n        else:\n        \
          \    missing.append(f\"{char_id}: appearance missing\")\n\n        if len(personality)\
          \ >= 10:\n            char_score += per_char_score // 3\n        elif personality:\n\
          \            char_score += per_char_score // 6\n        else:\n        \
          \    missing.append(f\"{char_id}: personality missing\")\n\n        if role:\n\
          \            char_score += per_char_score // 3\n        else:\n        \
          \    missing.append(f\"{char_id}: role missing\")\n\n        score += char_score\n\
          \n    return min(score, 30), missing\n\ndef evaluate_background_detail(yaml_content:\
          \ str, design_json_str: str) -> Tuple[int, List[str]]:\n    \"\"\"Evaluate\
          \ background detail level (0-30 points)\"\"\"\n    score = 0\n    missing\
          \ = []\n    content = yaml_content + design_json_str\n\n    location_keywords\
          \ = [\"ç¾å ´\", \"å·¥äº‹\", \"äº‹å‹™æ‰€\", \"è¶³å ´\", \"å±‹å¤–\", \"å±‹å†…\", \"å€‰åº«\", \"é“è·¯\"]\n\
          \    time_keywords = [\"æœ\", \"æ˜¼\", \"å¤•\", \"å¤œ\", \"åˆå‰\", \"åˆå¾Œ\", \"æ—©æœ\"\
          , \"æ—¥ä¸­\"]\n    weather_keywords = [\"æ™´\", \"æ›‡\", \"é›¨\", \"é›ª\", \"æš‘\", \"\
          å¯’\", \"é¢¨\"]\n\n    if any(kw in content for kw in location_keywords):\n\
          \        score += 10\n    else:\n        missing.append(\"Location detail\
          \ missing\")\n\n    if any(kw in content for kw in time_keywords):\n   \
          \     score += 10\n    else:\n        missing.append(\"Time setting missing\"\
          )\n\n    if any(kw in content for kw in weather_keywords):\n        score\
          \ += 10\n    else:\n        missing.append(\"Environment description missing\"\
          )\n\n    return score, missing\n\ndef main(yaml_content: str, design_json:\
          \ str, story_json: str) -> dict:\n    \"\"\"\n    [FIX v2] Enhanced quality\
          \ check with character/background scoring\n    \"\"\"\n    all_issues =\
          \ []\n\n    # 1. Structure check (40 points)\n    structure_score = 40\n\
          \    pages = yaml_content.split(\"---\")\n    page_count = len([p for p\
          \ in pages if p.strip()])\n\n    if page_count == 0:\n        all_issues.append(\"\
          No pages found\")\n        structure_score -= 20\n\n    required_fields\
          \ = [\"page:\", \"layout:\", \"scene:\", \"panels:\"]\n    for field in\
          \ required_fields:\n        if field not in yaml_content:\n            all_issues.append(f\"\
          Missing: {field}\")\n            structure_score -= 5\n\n    url_pattern\
          \ = r\"image_url:\\s*https?://\"\n    if not re.search(url_pattern, yaml_content):\n\
          \        all_issues.append(\"No character image URLs\")\n        structure_score\
          \ -= 10\n\n    structure_score = max(0, structure_score)\n\n    # 2. Character\
          \ detail (30 points)\n    char_score, char_missing = evaluate_character_detail(design_json)\n\
          \    all_issues.extend(char_missing)\n\n    # 3. Background detail (30 points)\n\
          \    bg_score, bg_missing = evaluate_background_detail(yaml_content, design_json)\n\
          \    all_issues.extend(bg_missing)\n\n    # Total score\n    total_score\
          \ = structure_score + char_score + bg_score\n\n    # Enhancement detection\n\
          \    needs_enhancement = total_score < 70 or char_score < 15 or bg_score\
          \ < 15\n    enhancement_targets = []\n    if char_score < 15:\n        enhancement_targets.append(\"\
          character\")\n    if bg_score < 15:\n        enhancement_targets.append(\"\
          background\")\n\n    return {\n        \"total_score\": total_score,\n \
          \       \"structure_score\": structure_score,\n        \"character_score\"\
          : char_score,\n        \"background_score\": bg_score,\n        \"page_count\"\
          : page_count,\n        \"issues\": all_issues,\n        \"needs_enhancement\"\
          : \"true\" if needs_enhancement else \"false\",\n        \"enhancement_targets\"\
          : json.dumps(enhancement_targets, ensure_ascii=False),\n        \"report\"\
          : json.dumps({\n            \"total_score\": total_score,\n            \"\
          breakdown\": {\"structure\": structure_score, \"character\": char_score,\
          \ \"background\": bg_score},\n            \"issues\": all_issues,\n    \
          \        \"needs_enhancement\": needs_enhancement\n        }, ensure_ascii=False,\
          \ indent=2)\n    }\n"
        code_language: python3
        outputs:
          background_score:
            children: null
            type: number
          character_score:
            children: null
            type: number
          enhancement_targets:
            children: null
            type: string
          issues:
            children: null
            type: array[string]
          needs_enhancement:
            children: null
            type: string
          page_count:
            children: null
            type: number
          report:
            children: null
            type: string
          structure_score:
            children: null
            type: number
          total_score:
            children: null
            type: number
        selected: false
        title: 'CODE: Quality Check Enhanced'
        type: code
        variables:
        - value_selector:
          - conversation
          - yaml_content
          value_type: string
          variable: yaml_content
        - value_selector:
          - conversation
          - design_json
          value_type: string
          variable: design_json
        - value_selector:
          - conversation
          - story_json
          value_type: string
          variable: story_json
      height: 52
      id: '1000000013'
      position:
        x: 680
        y: 750
      positionAbsolute:
        x: 680
        y: 750
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        desc: Content consistency check
        edition_type: basic
        memory:
          role_prefix:
            assistant: ''
            user: ''
          window:
            enabled: false
            size: 50
        model:
          completion_params:
            frequency_penalty: 0
            max_tokens: 1024
            presence_penalty: 0
            temperature: 0.3
            top_p: 1
          mode: chat
          name: gpt-4o
          provider: langgenius/openai/openai
        prompt_template:
        - role: system
          text: 'ã‚ãªãŸã¯æ•™è‚²ãƒãƒ³ã‚¬ã®å“è³ªç®¡ç†ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚


            ä»¥ä¸‹ã®è¦³ç‚¹ã§YAMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è©•ä¾¡ã—ã¦ãã ã•ã„ï¼š

            1. ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã®ä¸€è²«æ€§ï¼ˆèµ·æ‰¿è»¢çµã®æµã‚Œï¼‰

            2. æ•™è‚²å†…å®¹ã®å¦¥å½“æ€§

            3. ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®è¡Œå‹•ãƒ»å°è©ã®è‡ªç„¶ã•

            4. è¦–è¦šçš„ãªèª¬æ˜ã®é©åˆ‡æ€§


            ç°¡æ½”ãªæ—¥æœ¬èªã§è©•ä¾¡çµæœã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚æœ€å¾Œã«ç·åˆã‚¹ã‚³ã‚¢ï¼ˆ0-100ï¼‰ã‚’å‡ºåŠ›ã€‚

            '
        - role: user
          text: 'æ§‹é€ ãƒã‚§ãƒƒã‚¯çµæœ:

            {{#1000000013.report#}}


            è¨­è¨ˆJSON:

            {{#conversation.design_json#}}


            ã‚¹ãƒˆãƒ¼ãƒªãƒ¼JSON:

            {{#conversation.story_json#}}


            ä¸Šè¨˜ã®å†…å®¹ã‚’è©•ä¾¡ã—ã€å“è³ªãƒ¬ãƒãƒ¼ãƒˆã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

            '
        selected: false
        structured_output_enabled: false
        title: 'LLM: Consistency'
        type: llm
        variables: []
        vision:
          enabled: false
      height: 116
      id: '1000000014'
      position:
        x: 960
        y: 750
      positionAbsolute:
        x: 960
        y: 750
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        answer: '## å“è³ªãƒã‚§ãƒƒã‚¯çµæœ


          ### æ§‹é€ ã‚¹ã‚³ã‚¢: {{#1000000013.structure_score#}}ç‚¹


          {{#1000000014.text#}}


          ---


          **ç”»åƒç”Ÿæˆã®æº–å‚™ãŒã§ãã¾ã—ãŸã€‚**


          ã€ŒOKã€ã¾ãŸã¯ã€Œæ¬¡ã¸ã€ã¨å…¥åŠ›ã™ã‚‹ã¨ã€Nano Banana Pro ã§ãƒãƒ³ã‚¬ç”»åƒã‚’ç”Ÿæˆã—ã¾ã™ã€‚

          '
        desc: ''
        selected: false
        title: 'Answer: Report'
        type: answer
        variables:
        - value_selector:
          - '1000000013'
          - structure_score
          variable: score
        - value_selector:
          - '1000000014'
          - text
          variable: report
      height: 184
      id: '1000000015'
      position:
        x: 1240
        y: 750
      positionAbsolute:
        x: 1240
        y: 750
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        answer: "## ãƒãƒ³ã‚¬ç”Ÿæˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ä½¿ã„æ–¹\n\nã“ã®ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã¯ã€å»ºè¨­æ¥­ç•Œå‘ã‘æ•™è‚²ãƒãƒ³ã‚¬ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚\n\n### åŸºæœ¬çš„ãªæµã‚Œ\n\
          \n1. **ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›**: ãƒãƒ³ã‚¬ã«ã—ãŸã„å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\n   ä¾‹: ã€Œè¶³å ´ã®å®‰å…¨ç‚¹æ¤œã«ã¤ã„ã¦ã€ã‚¿ã‚±ãƒ«ã¨ã‚«ã‚ºã•ã‚“ã§4ãƒšãƒ¼ã‚¸ã®ãƒãƒ³ã‚¬ã‚’ä½œæˆã—ã¦ã€\n\
          \n2. **è¨­è¨ˆã‚’ç¢ºèª**: ç”Ÿæˆã•ã‚ŒãŸæ•™è‚²è¨­è¨ˆã‚’ç¢ºèªã—ã€ã€Œæ‰¿èªã€ã¨å…¥åŠ›\n\n3. **ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’ç¢ºèª**: è©³ç´°ãªã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’ç¢ºèªã—ã€ã€Œç”Ÿæˆé–‹å§‹ã€ã¨å…¥åŠ›\n\
          \n4. **YAMLã‚’ç¢ºèª**: ç”Ÿæˆã•ã‚ŒãŸYAMLã‚’ç¢ºèªã—ã€ã€Œå“è³ªãƒã‚§ãƒƒã‚¯ã€ã¨å…¥åŠ›\n\n### åˆ©ç”¨å¯èƒ½ãªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼\n\n- ã‚¿ã‚±ãƒ«\
          \ (takeru): è‹¥æ‰‹ä½œæ¥­å“¡\n- ã‚«ã‚ºã•ã‚“ (kazusan): ãƒ™ãƒ†ãƒ©ãƒ³ä½œæ¥­å“¡\n- ãƒªãƒ¥ã‚¦ã•ã‚“ (ryusan): ç›£ç£\n- æ‰€é•·\
          \ (shochou): ç¾å ´æ‰€é•·\n\n### ã‚³ãƒãƒ³ãƒ‰\n\n- ã€Œæ‰¿èªã€ã€Œæ¬¡ã¸ã€ã€ŒOKã€: æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸é€²ã‚€\n- ã€Œç”Ÿæˆé–‹å§‹ã€: YAMLç”Ÿæˆã‚’é–‹å§‹\n\
          - ã€Œå“è³ªãƒã‚§ãƒƒã‚¯ã€: å“è³ªæ¤œè¨¼ã‚’å®Ÿè¡Œ\n- æ–°ã—ã„ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›: æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—\n\nä½•ã‹ã”è³ªå•ãŒã‚ã‚Œã°ãŠæ°—è»½ã«ã©ã†ãã€‚\n"
        desc: ''
        selected: false
        title: 'Answer: Help'
        type: answer
        variables: []
      height: 404
      id: '1000000017'
      position:
        x: 680
        y: 950
      positionAbsolute:
        x: 680
        y: 950
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\n\ndef main(design_json: str) -> dict:\n    \"\"\"\n  \
          \  Parse design JSON and create formatted summary for display.\n    \"\"\
          \"\n    try:\n        data = json.loads(design_json)\n        overview =\
          \ data.get(\"story_overview\", {})\n        pages = data.get(\"pages\",\
          \ [])\n        objectives = data.get(\"learning_objectives\", [])\n    \
          \    arc = overview.get(\"story_arc\", {})\n\n        # Build formatted\
          \ output\n        lines = []\n        lines.append(f\"### {overview.get('title',\
          \ 'Untitled')}\")\n        lines.append(\"\")\n        lines.append(\"|\
          \ é …ç›® | å€¤ |\")\n        lines.append(\"|------|-----|\")\n        lines.append(f\"\
          | ãƒ†ãƒ¼ãƒ | {overview.get('theme', '-')} |\")\n        lines.append(f\"| å­¦ç¿’ç›®æ¨™\
          \ | {overview.get('learning_goal', '-')} |\")\n        lines.append(f\"\
          | å¯¾è±¡è€… | {overview.get('target_audience', '-')} |\")\n        lines.append(f\"\
          | ãƒšãƒ¼ã‚¸æ•° | {overview.get('total_pages', '-')} |\")\n        lines.append(\"\
          \")\n        lines.append(\"### èµ·æ‰¿è»¢çµ\")\n        lines.append(f\"- **èµ·**:\
          \ {arc.get('ki', '-')}\")\n        lines.append(f\"- **æ‰¿**: {arc.get('sho',\
          \ '-')}\")\n        lines.append(f\"- **è»¢**: {arc.get('ten', '-')}\")\n\
          \        lines.append(f\"- **çµ**: {arc.get('ketsu', '-')}\")\n        lines.append(\"\
          \")\n        lines.append(\"### å­¦ç¿’ç›®æ¨™\")\n        for i, obj in enumerate(objectives,\
          \ 1):\n            lines.append(f\"{i}. {obj}\")\n        lines.append(\"\
          \")\n        lines.append(\"### ãƒšãƒ¼ã‚¸æ§‹æˆ\")\n        for p in pages:\n    \
          \        pn = p.get('page_number', '?')\n            phase = p.get('arc_phase',\
          \ '?')\n            focus = p.get('learning_focus', '-')\n            lines.append(f\"\
          - P{pn} ({phase}): {focus}\")\n\n        formatted = \"\\n\".join(lines)\n\
          \        return {\n            \"formatted_output\": formatted,\n      \
          \      \"raw_json\": design_json,\n            \"page_count\": len(pages)\n\
          \        }\n    except Exception as e:\n        return {\n            \"\
          formatted_output\": f\"JSONè§£æã‚¨ãƒ©ãƒ¼: {str(e)}\",\n            \"raw_json\"\
          : design_json,\n            \"page_count\": 0\n        }\n"
        code_language: python3
        outputs:
          formatted_output:
            children: null
            type: string
          page_count:
            children: null
            type: number
          raw_json:
            children: null
            type: string
        selected: false
        title: 'CODE: Format Design'
        type: code
        variables:
        - value_selector:
          - '1000000005'
          - text
          value_type: string
          variable: design_json
      height: 52
      id: '1000000018'
      position:
        x: 1520
        y: 150
      positionAbsolute:
        x: 1520
        y: 150
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nimport re\n\ndef extract_json(text: str) -> str:\n   \
          \ \"\"\"Extract JSON from markdown code block or raw text.\"\"\"\n    match\
          \ = re.search(r'```json\\s*([\\s\\S]*?)\\s*```', text)\n    if match:\n\
          \        return match.group(1).strip()\n    match = re.search(r'```\\s*([\\\
          s\\S]*?)\\s*```', text)\n    if match:\n        return match.group(1).strip()\n\
          \    match = re.search(r'\\{[\\s\\S]*\\}', text)\n    if match:\n      \
          \  return match.group(0)\n    return text\n\n# Character ID normalization\
          \ map\nCHARACTER_ID_MAP = {\n    \"takeru\": \"takeru\",\n    \"kazusan\"\
          : \"kazu\",\n    \"kazu\": \"kazu\",\n    \"ryusan\": \"ryu\",\n    \"ryu\"\
          : \"ryu\",\n    \"shochou\": \"director\",\n    \"director\": \"director\"\
          \n}\n\n# Character display names for prompt\nCHARACTER_DISPLAY = {\n   \
          \ \"takeru\": \"Takeru\",\n    \"kazu\": \"Kazu-san\",\n    \"ryu\": \"\
          Ryu-san\",\n    \"director\": \"Director\"\n}\n\n# 5-panel layout patterns\
          \ based on emphasis_point\nLAYOUT_PATTERNS = {\n    \"opening\": \"\"\"\n\
          +-------------------------+\n|      Panel 1 (wide)      |  <- EMPHASIS:\
          \ Introduction\n+------------+------------+\n|  Panel 3   |  Panel 2   |\
          \  <- Row 2 (RIGHT to LEFT)\n+------------+------------+\n|  Panel 5   |\
          \  Panel 4   |  <- Row 3 (RIGHT to LEFT)\n+------------+------------+\n\
          Reading order: 1 -> 2 -> 3 -> 4 -> 5\"\"\",\n\n    \"turning\": \"\"\"\n\
          +------------+------------+\n|  Panel 2   |  Panel 1   |  <- Row 1 (RIGHT\
          \ to LEFT)\n+------------+------------+\n|      Panel 3 (wide)      |  <-\
          \ EMPHASIS: Turning Point\n+------------+------------+\n|  Panel 5   | \
          \ Panel 4   |  <- Row 3 (RIGHT to LEFT)\n+------------+------------+\nReading\
          \ order: 1 -> 2 -> 3 -> 4 -> 5\"\"\",\n\n    \"conclusion\": \"\"\"\n+------------+------------+\n\
          |  Panel 2   |  Panel 1   |  <- Row 1 (RIGHT to LEFT)\n+------------+------------+\n\
          |  Panel 4   |  Panel 3   |  <- Row 2 (RIGHT to LEFT)\n+------------+------------+\n\
          |      Panel 5 (wide)      |  <- EMPHASIS: Conclusion\n+-------------------------+\n\
          Reading order: 1 -> 2 -> 3 -> 4 -> 5\"\"\"\n}\n\ndef normalize_character_names(characters_str:\
          \ str) -> list:\n    \"\"\"Normalize character names to standard IDs.\"\"\
          \"\n    normalized = []\n    for char in characters_str.lower().replace(\"\
          \ \", \"\").split(\",\"):\n        char = char.strip()\n        if char\
          \ in CHARACTER_ID_MAP:\n            char_id = CHARACTER_ID_MAP[char]\n \
          \           if char_id not in normalized:\n                normalized.append(char_id)\n\
          \    # Default characters if none found\n    if not normalized:\n      \
          \  normalized = [\"takeru\", \"kazu\"]\n    return normalized[:4]  # Max\
          \ 4 characters\n\ndef build_character_binding_section(char_ids: list) ->\
          \ str:\n    \"\"\"Build CHARACTER IMAGE BINDING section.\"\"\"\n    section\
          \ = \"\"\"\n============================================================\n\
          [CRITICAL: CHARACTER IMAGE BINDING]\n============================================================\n\
          \nUPLOADED IMAGES (YOU MUST USE THESE):\n\"\"\"\n    for i, char_id in enumerate(char_ids):\n\
          \        display = CHARACTER_DISPLAY.get(char_id, char_id)\n        section\
          \ += f\"- Image {i+1}: {display}_reference.png\\n\"\n\n    section += \"\
          \"\"\nCHARACTER BINDING TABLE:\n+-----------+------------------------------+\n\
          | Character | Reference Image              |\n+-----------+------------------------------+\n\
          \"\"\"\n    for i, char_id in enumerate(char_ids):\n        display = CHARACTER_DISPLAY.get(char_id,\
          \ char_id)\n        section += f\"| {display:9} | Image {i+1} - TRACE THIS\
          \ IMAGE   |\\n\"\n\n    section += \"\"\"+-----------+------------------------------+\n\
          \nTRACE INSTRUCTION:\n\"\"\"\n    for i, char_id in enumerate(char_ids):\n\
          \        display = CHARACTER_DISPLAY.get(char_id, char_id)\n        section\
          \ += f\"- When drawing {display} -> LOOK at Image {i+1} and TRACE it\\n\"\
          \n\n    section += \"\"\"\n- DO NOT create new character designs\n- COPY\
          \ the face, clothes, and colors EXACTLY from the images\n\"\"\"\n    return\
          \ section\n\ndef build_art_style_section() -> str:\n    \"\"\"Build ART\
          \ STYLE section.\"\"\"\n    return \"\"\"\n============================================================\n\
          [ART STYLE: KUNIO-KUN / Hot-blooded Deformed Style]\n============================================================\n\
          \nStyle Reference:\n- Kunio-kun series (Nekketsu Kouha Kunio-kun)\n- Downtown\
          \ Nekketsu Monogatari\n- 4-5 head proportions with hot-blooded expressions\n\
          \nREQUIRED Elements:\n- 4-5 head proportion deformed body style\n- Bold\
          \ outlines (thick, clear lines)\n- Speed lines (for surprise/determination\
          \ scenes)\n- Sound effects (DOON, GAAN, KIRAAN in Japanese style)\n- Exaggerated\
          \ expressions (dot eyes, sweat drops, tears, anger marks)\n- Hot-blooded\
          \ poses (fist pump, salute, pointing)\n- Comical movements (stumbling, jumping\
          \ in surprise)\n\nColor Palette:\n- Vivid colors (primary colors)\n- Healthy\
          \ tan skin tone\n- Bright backgrounds\n\nNOT ALLOWED:\n- Moe/cute girl style\n\
          - Realistic 8-head proportions\n- Dark atmosphere only\n\"\"\"\n\ndef build_panel_layout_section(emphasis_point:\
          \ str, panel_count: int) -> str:\n    \"\"\"Build PANEL LAYOUT section based\
          \ on emphasis_point.\"\"\"\n    layout = LAYOUT_PATTERNS.get(emphasis_point,\
          \ LAYOUT_PATTERNS[\"conclusion\"])\n\n    return f\"\"\"\n============================================================\n\
          [PANEL LAYOUT: {panel_count} PANELS / EMPHASIS: {emphasis_point.upper()}]\n\
          ============================================================\n\nPAGE FORMAT:\
          \ 2:3 vertical (portrait)\nMAX LAYOUT: 2 columns x 3 rows (Japanese manga\
          \ standard)\n\nCRITICAL RULES:\n- Fill 100% of the page with panels\n- NO\
          \ blank areas\n- NO decorative elements outside panels\n- NO standalone\
          \ character portraits\n- EVERY pixel must be inside a panel\n- Reading order:\
          \ RIGHT to LEFT (Japanese style)\n\nTHIS PAGE LAYOUT ({emphasis_point.upper()}):\n\
          {layout}\n\nPanel borders: 2-3px black solid lines\nGutter: 4-6px white\
          \ space\n\"\"\"\n\ndef build_panel_details_section(page: dict, char_ids:\
          \ list) -> str:\n    \"\"\"Build PANEL DETAILS section with background,\
          \ emotion, effects.\"\"\"\n    panels = page.get(\"panels\", [])\n    dialogues\
          \ = page.get(\"dialogue\", [])\n    # Page-level background (fallback)\n\
          \    page_background = page.get(\"background\", page.get(\"scene\", {}).get(\"\
          background\", \"Construction site\"))\n\n    section = \"\"\"\n============================================================\n\
          [PANEL DETAILS]\n============================================================\n\
          \"\"\"\n    for panel in panels:\n        pnum = panel.get(\"panel_number\"\
          , 1)\n        desc = panel.get(\"description\", \"\")\n        position\
          \ = panel.get(\"position\", \"\")\n        size = panel.get(\"size\", \"\
          medium\")\n        panel_chars = panel.get(\"characters\", [])\n       \
          \ camera = panel.get(\"camera\", {})\n        # v4.0: Extract emotion, effects,\
          \ background\n        emotion = panel.get(\"emotion\", \"\")\n        effects\
          \ = panel.get(\"effects\", [])\n        background = panel.get(\"background\"\
          , page_background)\n\n        section += f\"\"\"\nPanel {pnum} ({position},\
          \ {size}):\n- Scene: {desc}\n- Background: {background}\n- Camera: {camera.get('shot_type',\
          \ 'medium_shot')}, {camera.get('angle', 'eye_level')}\n\"\"\"\n        #\
          \ v4.0: Add emotion if present\n        if emotion:\n            section\
          \ += f\"- Emotion: {emotion}\\n\"\n        # v4.0: Add effects if present\n\
          \        if effects:\n            if isinstance(effects, list):\n      \
          \          section += f\"- Visual Effects: {', '.join(effects)}\\n\"\n \
          \           else:\n                section += f\"- Visual Effects: {effects}\\\
          n\"\n\n        # Character references\n        for char_name in panel_chars:\n\
          \            char_id = CHARACTER_ID_MAP.get(char_name.lower(), char_name.lower())\n\
          \            if char_id in char_ids:\n                idx = char_ids.index(char_id)\
          \ + 1\n                display = CHARACTER_DISPLAY.get(char_id, char_id)\n\
          \                section += f\"- Character: {display} (TRACE Image {idx})\\\
          n\"\n\n        # Dialogues for this panel\n        panel_dialogues = [d\
          \ for d in dialogues if d.get(\"panel\") == pnum]\n        for d in panel_dialogues:\n\
          \            speaker = d.get(\"character\", \"\")\n            text = d.get(\"\
          text\", \"\")\n            section += f\"- Dialogue: {speaker}: [{text}]\\\
          n\"\n\n    return section\n\ndef main(story_json: str, yaml_content: str,\
          \ characters: str) -> dict:\n    \"\"\"\n    Parse story JSON to extract\
          \ pages for image generation.\n    v2.0: Full prompt with CHARACTER IMAGE\
          \ BINDING, KUNIO-KUN style, 5-panel layout.\n    v3.3: Include per-page YAML for GAS saving.\n    \"\"\"\n    try:\n    \
          \    json_str = extract_json(story_json)\n        data = json.loads(json_str)\n\
          \        pages = data.get(\"pages\", [])\n\n        # v3.3: Split YAML by page separator\n\
          \        yaml_pages = yaml_content.split(\"---\") if yaml_content else []\n\
          \        yaml_pages = [y.strip() for y in yaml_pages if y.strip()]\n\n        # Normalize character\
          \ names\n        char_ids = normalize_character_names(characters)\n\n  \
          \      page_prompts = []\n        total_pages = len(pages)\n\n        for\
          \ page in pages:\n            pn = page.get(\"page_number\", 1)\n      \
          \      emphasis = page.get(\"emphasis_point\", \"conclusion\")\n       \
          \     key_scene = page.get(\"key_scene\", \"\")\n            key_msg = page.get(\"\
          key_message\", \"\")\n            arc_phase = page.get(\"arc_phase\", \"\
          sho\")\n            panels = page.get(\"panels\", [])\n            panel_count\
          \ = len(panels) if panels else 5\n\n            # Build full prompt with\
          \ all sections\n            prompt = f\"\"\"Create page {pn} of {total_pages}\
          \ of a Japanese educational manga about construction safety.\n\n{build_character_binding_section(char_ids)}\n\
          {build_art_style_section()}\n{build_panel_layout_section(emphasis, panel_count)}\n\
          {build_panel_details_section(page, char_ids)}\n\n============================================================\n\
          [STORY CONTEXT]\n============================================================\n\
          \nPage: {pn} of {total_pages}\nArc Phase: {arc_phase}\nScene: {key_scene}\n\
          Key Message: {key_msg}\n\n============================================================\n\
          [QUALITY CHECKLIST]\n============================================================\n\
          \nBefore generating, verify:\n- [ ] Characters MATCH reference images (Image\
          \ 1-2)\n- [ ] Kunio-kun style (4-5 head proportions, hot-blooded, effects)\n\
          - [ ] Panel layout matches emphasis_point: {emphasis}\n- [ ] Reading order:\
          \ RIGHT to LEFT within rows\n- [ ] Clear panel borders (2-3px black)\n-\
          \ [ ] Readable Japanese text in speech bubbles\n- [ ] Speed lines and sound\
          \ effects included where appropriate\n- [ ] No empty space outside panels\n\
          - [ ] Background matches scene description (v4.0)\n- [ ] Character emotions\
          \ correctly depicted (v4.0)\n- [ ] Visual effects (sweat drops, question\
          \ marks, impact lines) where specified (v4.0)\n\n============================================================\n\
          [IDENTITY LOCK]\n============================================================\n\
          This page contains ONLY: {', '.join(char_ids)}\n\
          {chr(10).join([f'- {name} = Reference Image {i+1} (COPY EXACTLY)' for i, name in enumerate(char_ids)])}\n\
          - DO NOT create any other characters\n\"\"\"\n            # v3.3: Get YAML for this page (index = page_number - 1)\n\
          \            page_yaml = yaml_pages[pn - 1] if (pn - 1) < len(yaml_pages) else \"\"\n\n\
          \            page_prompts.append({\n\
          \                \"page_number\": pn,\n                \"prompt\": prompt,\n\
          \                \"scene\": key_scene,\n                \"emphasis_point\"\
          : emphasis,\n                \"character_names\": char_ids,\n                \"yaml_content\"\
          : page_yaml\n           \
          \ })\n\n        return {\n            \"pages\": page_prompts,\n       \
          \     \"page_count\": len(page_prompts),\n            \"character_names_json\"\
          : json.dumps(char_ids)\n        }\n    except Exception as e:\n        return\
          \ {\n            \"pages\": [],\n            \"page_count\": 0,\n      \
          \      \"error\": str(e),\n            \"character_names_json\": \"[]\"\n\
          \        }\n"
        code_language: python3
        outputs:
          character_names_json:
            children: null
            type: string
          page_count:
            children: null
            type: number
          pages:
            children: null
            type: array[object]
        selected: false
        title: 'CODE: Parse Pages for Image'
        type: code
        variables:
        - value_selector:
          - conversation
          - story_json
          value_type: string
          variable: story_json
        - value_selector:
          - conversation
          - yaml_content
          value_type: string
          variable: yaml_content
        - value_selector:
          - conversation
          - characters
          value_type: string
          variable: characters
      height: 52
      id: '1000000020'
      position:
        x: 680
        y: 1150
      positionAbsolute:
        x: 680
        y: 1150
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        error_handle_mode: terminated
        flatten_output: false
        height: 225
        is_parallel: false
        iterator_input_type: array[object]
        iterator_selector:
        - '1000000020'
        - pages
        output_selector:
        - '1000000025'
        - result
        output_type: array[object]
        parallel_nums: 1
        selected: false
        start_node_id: 1000000021start
        title: 'Iteration: Image Generation'
        type: iteration
        width: 1100
      height: 225
      id: '1000000021'
      position:
        x: 1260
        y: 1100
      positionAbsolute:
        x: 1260
        y: 1100
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 1100
      zIndex: 1
    - data:
        desc: ''
        isInIteration: true
        selected: false
        title: ''
        type: iteration-start
      draggable: false
      height: 48
      id: 1000000021start
      parentId: '1000000021'
      position:
        x: 24
        y: 100
      positionAbsolute:
        x: 1284
        y: 1200
      selectable: false
      sourcePosition: right
      targetPosition: left
      type: custom-iteration-start
      width: 44
      zIndex: 1002
    - data:
        code: "import json\n\ndef main(page_data: dict) -> dict:\n    \"\"\"\n   \
          \ Build prompt for Gemini image generation.\n    v3.0: Builds reference_image_ids\
          \ based on characters in this page.\n    \"\"\"\n    # Character fileId mapping\
          \ (Google Drive)\n    CHAR_FILEID_MAP = {\n        \"kazusan\": \"1aBahLtJpy0DnoKJ6f0ObQnTDMM5y-L4y\",\n\
          \        \"ryusan\": \"1umU2L6J0wJdoVd2fHmjMUP4cMJP4HgGV\",\n        \"shochou\"\
          : \"1VdRytA2MTc5WiYyvPOiJ9iGFnwxQARXu\",\n        \"takeru\": \"1PBP3aeoc_zYEIP93AnbMyLZ84iGuxc3T\"\
          \n    }\n    \n    # Character name aliases\n    CHAR_ALIASES = {\n       \
          \ \"kazusan\": [\"kazusan\", \"kazu\", \"kazu-san\", \"kazuki\"],\n        \"ryusan\": [\"ryusan\", \"\
          ryujin\", \"ryu\", \"ryu-san\", \"dragon\"],\n        \"shochou\": [\"shochou\", \"sato\", \"director\", \"\
          boss\", \"chief\"],\n        \"takeru\": [\"takeru\", \"take\", \"protagonist\", \"main\"]\n    }\n    \n    prompt = page_data.get(\"prompt\"\
          , \"\")\n    page_number = page_data.get(\"page_number\", 1)\n    character_names\
          \ = page_data.get(\"character_names\", [])\n    emphasis_point = page_data.get(\"\
          emphasis_point\", \"conclusion\")\n    yaml_content = page_data.get(\"yaml_content\"\
          , \"\")  # v3.3: Per-page YAML\n    \n    # Build reference image IDs based\
          \ on characters in this page\n    reference_image_ids = []\n    for char_name\
          \ in character_names:\n        char_lower = char_name.lower()\n        for\
          \ char_key, aliases in CHAR_ALIASES.items():\n            if any(alias in\
          \ char_lower for alias in aliases):\n                file_id = CHAR_FILEID_MAP.get(char_key)\n\
          \                if file_id and file_id not in reference_image_ids:\n     \
          \               reference_image_ids.append(file_id)\n                break\n\
          \n    return {\n        \"prompt\": prompt,\n        \"page_number\": page_number,\n\
          \        \"character_names\": character_names,\n        \"character_names_json\"\
          : json.dumps(character_names),\n        \"emphasis_point\": emphasis_point,\n\
          \        \"reference_image_ids_json\": json.dumps(reference_image_ids),\n\
          \        \"yaml_content\": yaml_content\n \
          \   }\n"
        code_language: python3
        isInIteration: true
        isInLoop: false
        iteration_id: '1000000021'
        outputs:
          character_names:
            children: null
            type: array[string]
          character_names_json:
            children: null
            type: string
          emphasis_point:
            children: null
            type: string
          page_number:
            children: null
            type: number
          prompt:
            children: null
            type: string
          reference_image_ids_json:
            children: null
            type: string
          yaml_content:
            children: null
            type: string
        selected: false
        title: 'CODE: Build Prompt'
        type: code
        variables:
        - value_selector:
          - '1000000021'
          - item
          value_type: object
          variable: page_data
      height: 52
      id: '1000000022'
      parentId: '1000000021'
      position:
        x: 120
        y: 80
      positionAbsolute:
        x: 1380
        y: 1180
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
      zIndex: 1002
    - data:
        authorization:
          config: null
          type: no-auth
        body:
          data:
          - type: text
            value: "{\n  \"prompt\": \"Using the reference images as style guide, maintain\
              \ exact character appearance and art style.\\n\\n{{#1000000022.prompt#}}\"\
              ,\n  \"sessionId\": \"{{#1000000028.session_id#}}\",\n  \"pageNumber\"\
              : {{#1000000022.page_number#}},\n  \"character_names\": {{#1000000022.character_names_json#}},\n\
              \  \"referenceImageIds\": {{#1000000022.reference_image_ids_json#}},\n\
              \  \"yamlContent\": \"{{#1000000022.yaml_content#}}\"\n}\n"
          type: json
        headers: ''
        isInIteration: true
        isInLoop: false
        iteration_id: '1000000021'
        method: post
        params: ''
        retry_config:
          max_retries: 3
          retry_enabled: true
          retry_interval: 100
        selected: true
        ssl_verify: true
        timeout:
          connect: 60
          read: 300
          write: 60
        title: 'HTTP: GAS Gemini Proxy'
        type: http-request
        url: '{{#env.GAS_GEMINI_PROXY_URL#}}'
        variables: []
      height: 125
      id: '1000000023'
      parentId: '1000000021'
      position:
        x: 340
        y: 80
      positionAbsolute:
        x: 1600
        y: 1180
      selected: true
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
      zIndex: 1002
    - data:
        code: "import json\n\ndef main(gas_response: str, page_number: int) -> dict:\n\
          \    \"\"\"\n    Parse GAS Gemini Proxy response to extract Drive URLs and debug info.\n\
          \    \"\"\"\n    try:\n        data = json.loads(gas_response)\n       \
          \ debug = data.get(\"debug\", {})\n        debug_str = json.dumps(debug, ensure_ascii=False)\n       \
          \ if data.get(\"success\"):\n            return {\n                \"page_number\"\
          : data.get(\"page_number\", page_number),\n                \"status\": \"\
          saved\",\n                \"url\": data.get(\"url\", \"\"),\n          \
          \      \"downloadUrl\": data.get(\"downloadUrl\", \"\"),\n             \
          \   \"folder\": data.get(\"folder\", \"\"),\n                \"fileId\"\
          : data.get(\"fileId\", \"\"),\n                \"debug_info\": debug_str\n            }\n        else:\n           \
          \ return {\n                \"page_number\": page_number,\n            \
          \    \"status\": f\"error: {data.get('message', 'Unknown error')}\",\n \
          \               \"url\": \"\",\n                \"downloadUrl\": \"\",\n\
          \                \"folder\": \"\",\n                \"fileId\": \"\",\n                \"debug_info\": debug_str\n \
          \           }\n    except Exception as e:\n        return {\n          \
          \  \"page_number\": page_number,\n            \"status\": f\"parse_error:\
          \ {str(e)}\",\n            \"url\": \"\",\n            \"downloadUrl\":\
          \ \"\",\n            \"folder\": \"\",\n            \"fileId\": \"\",\n            \"debug_info\": \"{}\"\n \
          \       }\n"
        code_language: python3
        isInIteration: true
        isInLoop: false
        iteration_id: '1000000021'
        outputs:
          debug_info:
            children: null
            type: string
          downloadUrl:
            children: null
            type: string
          fileId:
            children: null
            type: string
          folder:
            children: null
            type: string
          page_number:
            children: null
            type: number
          status:
            children: null
            type: string
          url:
            children: null
            type: string
        selected: false
        title: 'CODE: Parse GAS Response'
        type: code
        variables:
        - value_selector:
          - '1000000023'
          - body
          value_type: string
          variable: gas_response
        - value_selector:
          - '1000000022'
          - page_number
          value_type: number
          variable: page_number
      height: 52
      id: '1000000024'
      parentId: '1000000021'
      position:
        x: 560
        y: 80
      positionAbsolute:
        x: 1820
        y: 1180
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
      zIndex: 1002
    - data:
        code: "def main(page_number: int, status: str, url: str, downloadUrl: str,\
          \ folder: str, debug_info: str) -> dict:\n    \"\"\"\n    Build result object for iteration\
          \ output.\n    \"\"\"\n    return {\n        \"result\": {\n           \
          \ \"page_number\": page_number,\n            \"status\": status,\n     \
          \       \"url\": url,\n            \"downloadUrl\": downloadUrl,\n     \
          \       \"folder\": folder,\n            \"debug_info\": debug_info\n        }\n    }\n"
        code_language: python3
        isInIteration: true
        isInLoop: false
        iteration_id: '1000000021'
        outputs:
          result:
            children: null
            type: object
        selected: false
        title: 'CODE: Build Result'
        type: code
        variables:
        - value_selector:
          - '1000000024'
          - page_number
          value_type: number
          variable: page_number
        - value_selector:
          - '1000000024'
          - status
          value_type: string
          variable: status
        - value_selector:
          - '1000000024'
          - url
          value_type: string
          variable: url
        - value_selector:
          - '1000000024'
          - downloadUrl
          value_type: string
          variable: downloadUrl
        - value_selector:
          - '1000000024'
          - folder
          value_type: string
          variable: folder
        - value_selector:
          - '1000000024'
          - debug_info
          value_type: string
          variable: debug_info
      height: 52
      id: '1000000025'
      parentId: '1000000021'
      position:
        x: 780
        y: 80
      positionAbsolute:
        x: 2040
        y: 1180
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
      zIndex: 1002
    - data:
        selected: false
        template: "## ç”»åƒç”Ÿæˆçµæœ\n\n{% for result in results %}\n- ãƒšãƒ¼ã‚¸ {{ result.page_number\
          \ }}: {{ result.status }}\n{% if result.url %}\n  [Google Driveã§é–‹ã]({{ result.url\
          \ }})\n{% endif %}\n{% endfor %}\n\n{% if results[0].folder %}\n---\nä¿å­˜ãƒ•ã‚©ãƒ«ãƒ€:\
          \ {{ results[0].folder }}\n{% endif %}\n"
        title: 'Template: Collect Results'
        type: template-transform
        variables:
        - value_selector:
          - '1000000021'
          - output
          value_type: array[object]
          variable: results
      height: 52
      id: '1000000026'
      position:
        x: 2420
        y: 1150
      positionAbsolute:
        x: 2420
        y: 1150
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        answer: '## ç”»åƒç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸ


          {{#1000000026.output#}}


          ---


          ç”Ÿæˆã•ã‚ŒãŸç”»åƒã¯Google Driveã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚

          ä¸Šè¨˜ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç¢ºèªã§ãã¾ã™ã€‚


          æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:

          - æ–°ã—ã„ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›ã—ã¦æœ€åˆã‹ã‚‰ä½œæˆ

          - ã€Œãƒ˜ãƒ«ãƒ—ã€ã§ä½¿ã„æ–¹ã‚’ç¢ºèª

          '
        desc: ''
        selected: false
        title: 'Answer: Image Complete'
        type: answer
        variables:
        - value_selector:
          - '1000000026'
          - output
          variable: image_results
      height: 198
      id: '1000000027'
      position:
        x: 2700
        y: 1150
      positionAbsolute:
        x: 2700
        y: 1150
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "from datetime import datetime\n\ndef main() -> dict:\n    \"\"\"\n\
          \    Generate session ID for folder naming.\n    Format: YYYYMMDD_HHmm\n\
          \    \"\"\"\n    now = datetime.now()\n    session_id = now.strftime(\"\
          %Y%m%d_%H%M\")\n    return {\"session_id\": session_id}\n"
        code_language: python3
        outputs:
          session_id:
            children: null
            type: string
        selected: false
        title: 'CODE: Generate Session ID'
        type: code
        variables: []
      height: 52
      id: '1000000028'
      position:
        x: 960
        y: 1150
      positionAbsolute:
        x: 960
        y: 1150
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\nimport re\n\ndef extract_json(text: str) -> str:\n   \
          \ \"\"\"Extract JSON from markdown code block or raw text.\"\"\"\n    #\
          \ Try to extract from ```json ... ``` block\n    match = re.search(r'```json\\\
          s*([\\s\\S]*?)\\s*```', text)\n    if match:\n        return match.group(1).strip()\n\
          \    # Try to extract from ``` ... ``` block\n    match = re.search(r'```\\\
          s*([\\s\\S]*?)\\s*```', text)\n    if match:\n        return match.group(1).strip()\n\
          \    # Try to find JSON object directly\n    match = re.search(r'\\{[\\\
          s\\S]*\\}', text)\n    if match:\n        return match.group(0)\n    return\
          \ text\n\nEMPHASIS_LABELS = {\n    \"opening\": \"ä¸Šæ®µæ¨ªé•·\",\n    \"turning\"\
          : \"ä¸­æ®µæ¨ªé•·\",\n    \"conclusion\": \"ä¸‹æ®µæ¨ªé•·\"\n}\n\ndef validate_emphasis(pages:\
          \ list) -> list:\n    \"\"\"Validate and adjust emphasis_point distribution.\"\
          \"\"\n    warnings = []\n    total = len(pages)\n\n    # Check turning count\
          \ (should be <= 1/3)\n    turning_count = sum(1 for p in pages if p.get(\"\
          emphasis_point\") == \"turning\")\n    if turning_count > total // 3 + 1:\n\
          \        warnings.append(f\"turningãŒå¤šã™ãã¾ã™ ({turning_count}/{total})\")\n\
          \n    # Check consecutive same emphasis\n    prev = None\n    consecutive\
          \ = 0\n    for i, page in enumerate(pages):\n        current = page.get(\"\
          emphasis_point\", \"conclusion\")\n        if current == prev:\n       \
          \     consecutive += 1\n            if consecutive >= 2:\n             \
          \   warnings.append(f\"P{i}: é€£ç¶š3å›ä»¥ä¸Šã®{current}\")\n        else:\n      \
          \      consecutive = 0\n        prev = current\n\n    # Check first and\
          \ last\n    if total >= 2:\n        first = pages[0].get(\"emphasis_point\"\
          , \"\")\n        last = pages[-1].get(\"emphasis_point\", \"\")\n      \
          \  if first != \"opening\":\n            warnings.append(f\"P1: openingãŒæ¨å¥¨\
          \ (ç¾åœ¨: {first})\")\n        if last != \"conclusion\":\n            warnings.append(f\"\
          P{total}: conclusionãŒæ¨å¥¨ (ç¾åœ¨: {last})\")\n\n    return warnings\n\ndef main(story_json:\
          \ str) -> dict:\n    \"\"\"\n    Parse story JSON, validate emphasis, and\
          \ create formatted summary.\n    \"\"\"\n    try:\n        # Extract JSON\
          \ from markdown code block if present\n        json_str = extract_json(story_json)\n\
          \        data = json.loads(json_str)\n        pages = data.get(\"pages\"\
          , [])\n\n        # Validate emphasis distribution\n        warnings = validate_emphasis(pages)\n\
          \n        lines = []\n        lines.append(\"### ã‚¹ãƒˆãƒ¼ãƒªãƒ¼è©³ç´°\")\n        lines.append(\"\
          \")\n\n        # Show emphasis distribution\n        lines.append(\"**ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ§‹æˆ**:\"\
          )\n        for page in pages:\n            pn = page.get(\"page_number\"\
          , \"?\")\n            emp = page.get(\"emphasis_point\", \"conclusion\"\
          )\n            label = EMPHASIS_LABELS.get(emp, emp)\n            reason\
          \ = page.get(\"emphasis_reason\", \"\")\n            lines.append(f\"- P{pn}:\
          \ {emp} ({label}) - {reason}\")\n        lines.append(\"\")\n\n        if\
          \ warnings:\n            lines.append(\"**æ¤œè¨¼è­¦å‘Š**:\")\n            for w\
          \ in warnings:\n                lines.append(f\"- {w}\")\n            lines.append(\"\
          \")\n\n        for page in pages:\n            pn = page.get(\"page_number\"\
          , \"?\")\n            phase = page.get(\"arc_phase\", \"?\")\n         \
          \   emphasis = page.get(\"emphasis_point\", \"-\")\n            key_msg\
          \ = page.get(\"key_message\", \"-\")\n            key_scene = page.get(\"\
          key_scene\", \"-\")\n\n            lines.append(f\"#### ãƒšãƒ¼ã‚¸ {pn} ({phase})\
          \ - {emphasis}\")\n            lines.append(f\"**ã‚­ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: {key_msg}\"\
          )\n            lines.append(f\"**ã‚·ãƒ¼ãƒ³**: {key_scene}\")\n            lines.append(\"\
          \")\n\n            # Dialogue\n            dialogues = page.get(\"dialogue\"\
          , [])\n            if dialogues:\n                lines.append(\"**å°è©**:\"\
          )\n                for d in dialogues:\n                    char = d.get(\"\
          character\", \"?\")\n                    text = d.get(\"text\", \"\")\n\
          \                    panel = d.get(\"panel\", \"?\")\n                 \
          \   lines.append(f\"- P{panel} {char}: ã€Œ{text}ã€\")\n                lines.append(\"\
          \")\n\n            # Panels summary with layout info\n            panels\
          \ = page.get(\"panels\", [])\n            if panels:\n                lines.append(f\"\
          **ãƒ‘ãƒãƒ«æ•°**: {len(panels)}ã‚³ãƒ\")\n                for panel in panels:\n   \
          \                 pnum = panel.get(\"panel_number\", \"?\")\n          \
          \          pos = panel.get(\"position\", \"?\")\n                    size\
          \ = panel.get(\"size\", \"?\")\n                    lines.append(f\"  -\
          \ ãƒ‘ãƒãƒ«{pnum}: {pos} ({size})\")\n                lines.append(\"\")\n\n \
          \       formatted = \"\\n\".join(lines)\n        return {\n            \"\
          formatted_output\": formatted,\n            \"raw_json\": story_json,\n\
          \            \"page_count\": len(pages),\n            \"validation_warnings\"\
          : len(warnings)\n        }\n    except Exception as e:\n        return {\n\
          \            \"formatted_output\": f\"JSONè§£æã‚¨ãƒ©ãƒ¼: {str(e)}\",\n         \
          \   \"raw_json\": story_json,\n            \"page_count\": 0,\n        \
          \    \"validation_warnings\": 0\n        }\n"
        code_language: python3
        outputs:
          formatted_output:
            children: null
            type: string
          page_count:
            children: null
            type: number
          raw_json:
            children: null
            type: string
          validation_warnings:
            children: null
            type: number
        selected: false
        title: 'CODE: Format Story'
        type: code
        variables:
        - value_selector:
          - '1000000008'
          - text
          value_type: string
          variable: story_json
      height: 52
      id: '1000000019'
      position:
        x: 960
        y: 350
      positionAbsolute:
        x: 960
        y: 350
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        cases:
        - case_id: 'true'
          conditions:
          - comparison_operator: is
            value: 'true'
            variable_selector:
            - '1000000013'
            - needs_enhancement
          logical_operator: and
        desc: Check if character/background enhancement is needed
        selected: false
        title: 'IF-ELSE: Need Enhancement'
        type: if-else
      height: 168
      id: '1000000030'
      position:
        x: 960
        y: 900
      positionAbsolute:
        x: 960
        y: 900
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        context:
          enabled: false
          variable_selector: []
        desc: Auto-enhance character and background details
        edition_type: basic
        memory:
          role_prefix:
            assistant: ''
            user: ''
          window:
            enabled: false
            size: 50
        model:
          completion_params:
            frequency_penalty: 0
            max_tokens: 2048
            presence_penalty: 0
            temperature: 0.5
            top_p: 1
          mode: chat
          name: gpt-4o
          provider: langgenius/openai/openai
        prompt_template:
        - role: system
          text: "You are a construction industry educational manga content enhancement\
            \ expert.\n\n## Task\nEnhance missing details for characters and backgrounds\
            \ based on quality check results.\nRespect existing settings while adding\
            \ specific details.\n\n## Character Enhancement Rules\n- appearance: Add\
            \ clothing, physique, distinctive accessories, typical expressions\n-\
            \ personality: Add behavior patterns, catchphrases, relationships with\
            \ other characters\n- role: Clarify function in story, expertise\n\n##\
            \ Background Enhancement Rules\n- location: Add specific facility names,\
            \ surroundings, scale\n- time_setting: Be specific (after morning meeting,\
            \ lunch break, end of work)\n- environment: Add weather, temperature,\
            \ seasonal feel, sensory descriptions\n\n## Output Format\nOutput ONLY\
            \ JSON with enhancement information:\n{\n  \"character_enhancements\"\
            : [\n    {\n      \"id\": \"character_id\",\n      \"appearance\": \"\
            additional appearance description\",\n      \"personality\": \"additional\
            \ personality description\",\n      \"role\": \"additional role description\"\
            \n    }\n  ],\n  \"background_enhancements\": {\n    \"location_detail\"\
            : \"specific location description\",\n    \"time_setting\": \"time setting\
            \ description\",\n    \"environment\": \"environment description\"\n \
            \ }\n}\n"
        - role: user
          text: 'Enhancement targets: {{#1000000013.enhancement_targets#}}


            Current issues:

            {{#1000000013.report#}}


            Current design JSON:

            {{#conversation.design_json#}}


            Please generate enhancement JSON. Output JSON only, no markdown code blocks.

            '
        selected: false
        structured_output_enabled: false
        title: 'LLM: Auto Enhance'
        type: llm
        variables: []
        vision:
          enabled: false
      height: 132
      id: '1000000031'
      position:
        x: 400
        y: 1100
      positionAbsolute:
        x: 400
        y: 1100
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        code: "import json\n\ndef main(design_json: str, enhancement_text: str) ->\
          \ dict:\n    \"\"\"Merge enhancement data into existing design JSON\"\"\"\
          \n    try:\n        design = json.loads(design_json) if design_json else\
          \ {}\n        enhancements = json.loads(enhancement_text) if enhancement_text\
          \ else {}\n    except json.JSONDecodeError as e:\n        return {\n   \
          \         \"merged_design\": design_json,\n            \"merge_status\"\
          : f\"JSON parse error: {str(e)}\"\n        }\n\n    # Merge character enhancements\n\
          \    char_enhancements = enhancements.get(\"character_enhancements\", [])\n\
          \    for enh in char_enhancements:\n        char_id = enh.get(\"id\")\n\
          \        for char in design.get(\"characters\", []):\n            if char.get(\"\
          id\") == char_id:\n                if enh.get(\"appearance\"):\n       \
          \             existing = char.get(\"appearance\", \"\")\n              \
          \      char[\"appearance\"] = (existing + \" \" + enh[\"appearance\"]).strip()\n\
          \                if enh.get(\"personality\"):\n                    existing\
          \ = char.get(\"personality\", \"\")\n                    char[\"personality\"\
          ] = (existing + \" \" + enh[\"personality\"]).strip()\n                if\
          \ enh.get(\"role\"):\n                    existing = char.get(\"role\",\
          \ \"\")\n                    char[\"role\"] = (existing + \" \" + enh[\"\
          role\"]).strip()\n                break\n\n    # Merge background enhancements\n\
          \    bg_enhancements = enhancements.get(\"background_enhancements\", {})\n\
          \    if bg_enhancements:\n        if \"story_overview\" not in design:\n\
          \            design[\"story_overview\"] = {}\n        if bg_enhancements.get(\"\
          location_detail\"):\n            design[\"story_overview\"][\"location_detail\"\
          ] = bg_enhancements[\"location_detail\"]\n        if bg_enhancements.get(\"\
          time_setting\"):\n            design[\"story_overview\"][\"time_setting\"\
          ] = bg_enhancements[\"time_setting\"]\n        if bg_enhancements.get(\"\
          environment\"):\n            design[\"story_overview\"][\"environment\"\
          ] = bg_enhancements[\"environment\"]\n\n    return {\n        \"merged_design\"\
          : json.dumps(design, ensure_ascii=False),\n        \"merge_status\": \"\
          success\"\n    }\n"
        code_language: python3
        outputs:
          merge_status:
            children: null
            type: string
          merged_design:
            children: null
            type: string
        selected: false
        title: 'CODE: Merge Enhanced'
        type: code
        variables:
        - value_selector:
          - conversation
          - design_json
          value_type: string
          variable: design_json
        - value_selector:
          - '1000000031'
          - text
          value_type: string
          variable: enhancement_text
      height: 52
      id: '1000000032'
      position:
        x: 680
        y: 1100
      positionAbsolute:
        x: 680
        y: 1100
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        desc: Save enhanced design_json to conversation
        items:
        - input_type: variable
          operation: over-write
          value:
          - '1000000032'
          - merged_design
          variable_selector:
          - conversation
          - design_json
          write_mode: over-write
        selected: false
        title: 'ASSIGNER: Update Enhanced'
        type: assigner
        version: '2'
      height: 128
      id: '1000000033'
      position:
        x: 960
        y: 1100
      positionAbsolute:
        x: 960
        y: 1100
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    - data:
        desc: Set current_phase to quality_done for image generation
        items:
        - input_type: constant
          operation: over-write
          value: quality_done
          variable_selector:
          - conversation
          - current_phase
          write_mode: over-write
        selected: false
        title: 'ASSIGNER: Set Quality Done'
        type: assigner
        version: '2'
      height: 128
      id: '1000000034'
      position:
        x: 1800
        y: 900
      positionAbsolute:
        x: 1800
        y: 900
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 242
    viewport:
      x: -820.0999999999999
      y: -304.20000000000005
      zoom: 0.6
  rag_pipeline_variables: []
