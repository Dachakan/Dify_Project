# Dify DSL - 施工計画爆速作成システム v1.0
# Generated from plan.md Section 5.4
# Note: dataset_ids (QUALITY_CRITERIA_DB_ID, CONSTRUCTION_KNOWHOW_DB_ID) need to be replaced with actual UUIDs

app:
  description: "施工計画書を完全自動生成するAIシステム"
  icon: "building_construction"
  icon_background: "#2196F3"
  mode: workflow
  name: "施工計画爆速作成システム v1.0"

kind: app
version: 0.5.0

workflow:
  conversation_variables: []
  environment_variables:
    - variable: felo_api_key
      name: "Felo API Key"
      type: secret
      required: false

  features:
    file_upload:
      enabled: true
    retrieval_resources:
      enabled: true

  graph:
    edges:
      # Phase 0-1: Start -> Design Doc Analyzer
      - id: edge-start-to-analyzer
        source: start-1
        target: llm-design-analyzer

      # Phase 1-3: 並列実行（3ブランチ）
      - id: edge-analyzer-to-quality
        source: llm-design-analyzer
        target: kr-quality-criteria
      - id: edge-analyzer-to-method
        source: llm-design-analyzer
        target: kr-construction-method
      - id: edge-analyzer-to-emergency
        source: llm-design-analyzer
        target: http-emergency-hospital

      # Quality criteria -> formatter
      - id: edge-quality-to-formatter
        source: kr-quality-criteria
        target: llm-quality-formatter

      # Merge to aggregator
      - id: edge-formatter-to-aggregator
        source: llm-quality-formatter
        target: variable-aggregator-1
      - id: edge-method-to-aggregator
        source: kr-construction-method
        target: variable-aggregator-1
      - id: edge-emergency-to-aggregator
        source: http-emergency-hospital
        target: variable-aggregator-1

      # Phase 4: 品質検証
      - id: edge-aggregator-to-placeholder
        source: variable-aggregator-1
        target: code-placeholder-detector
      - id: edge-placeholder-to-fact
        source: code-placeholder-detector
        target: code-fact-checker

      # Phase 5-6: 図表生成
      - id: edge-fact-to-chart
        source: code-fact-checker
        target: code-chart-generator

      # Phase 7: 統合
      - id: edge-chart-to-final
        source: code-chart-generator
        target: llm-document-integrator

      # End
      - id: edge-final-to-end
        source: llm-document-integrator
        target: end-1

    nodes:
      # ========== Phase 0: 開始 ==========
      - id: start-1
        type: start
        title: "設計図書入力"
        position: { x: 0, y: 200 }
        data:
          outputs:
            - type: string
              variable: design_document
              label: "設計図書（Markdown）"
            - type: string
              variable: project_location
              label: "工事場所（市区町村）"
        display: true

      # ========== Phase 1: 設計図書分析 ==========
      - id: llm-design-analyzer
        type: llm
        title: "Skill1: 設計図書分析"
        position: { x: 250, y: 200 }
        data:
          model:
            provider: anthropic
            name: claude-3-5-sonnet-20241022
            mode: chat
          temperature: 0.3
          max_tokens: 4000
          prompt_template:
            - type: system
              text: |
                あなたは土木工事の設計図書を分析するエキスパートです。
                以下のルールに従って、設計図書からJSON形式で情報を抽出してください。

                【絶対ルール】
                - プレースホルダー禁止（○○、XXX、UNKNOWN等）
                - 設計図書に記載がない情報は "データなし" と記載
                - 数値は必ず整数または小数で記載

                【出力形式】
                {
                  "basic_info": {
                    "project_name": "工事名",
                    "location": "工事場所",
                    "purpose": "施工理由",
                    "duration": {
                      "start": "YYYY-MM-DD",
                      "end": "YYYY-MM-DD",
                      "total_days": 数値
                    },
                    "client": "発注者名",
                    "contract_amount": 数値
                  },
                  "work_categories": [
                    {
                      "category": "工種名",
                      "items": [
                        {
                          "name": "項目名",
                          "quantity": 数値,
                          "unit": "単位",
                          "unit_price": 数値,
                          "total_cost": 数値
                        }
                      ]
                    }
                  ],
                  "materials": [...],
                  "equipment": [...],
                  "constraints": [...]
                }
            - type: user
              text: |
                以下の設計図書を分析してください：

                {{ start-1.design_document }}
          output:
            type: string
            variable: project_json
        display: true

      # ========== Phase 2: 品質基準抽出 ==========
      - id: kr-quality-criteria
        type: knowledge-retrieval
        title: "Skill2: 品質基準検索"
        position: { x: 500, y: 100 }
        data:
          dataset_ids:
            - "QUALITY_CRITERIA_DB_ID"  # TODO: Replace with actual UUID
          retrieval_mode: hybrid
          top_k: 10
          score_threshold: 0.6
          query: "{{ llm-design-analyzer.project_json }}"
        display: true

      - id: llm-quality-formatter
        type: llm
        title: "品質基準表作成"
        position: { x: 750, y: 100 }
        data:
          model:
            provider: anthropic
            name: claude-3-5-sonnet-20241022
            mode: chat
          temperature: 0.3
          prompt_template:
            - type: user
              text: |
                以下の品質基準情報をMarkdown表形式に整形してください：

                工事データ：{{ llm-design-analyzer.project_json }}

                品質基準情報：{{ kr-quality-criteria.result }}

                出力形式：
                ## {工種名}
                | 試験項目 | 試験方法 | 試験頻度 | 規格値 |
                |---------|---------|---------|--------|
        display: true

      # ========== Phase 3: 施工方法調査 ==========
      - id: kr-construction-method
        type: knowledge-retrieval
        title: "Skill3: 施工ノウハウ検索"
        position: { x: 500, y: 200 }
        data:
          dataset_ids:
            - "CONSTRUCTION_KNOWHOW_DB_ID"  # TODO: Replace with actual UUID
          retrieval_mode: semantic
          top_k: 5
          query: "{{ llm-design-analyzer.project_json }} 施工方法 安全管理"
        display: true

      # ========== 緊急連絡先調査（HTTP Request） ==========
      - id: http-emergency-hospital
        type: http-request
        title: "Skill7: 病院検索"
        position: { x: 500, y: 300 }
        data:
          method: GET
          url: "https://api.felo.ai/search"
          headers:
            - key: Authorization
              value: "Bearer {{ env.felo_api_key }}"
          body:
            type: json
            data:
              query: "{{ start-1.project_location }} 救急病院 24時間 電話番号"
          timeout: 30
        display: true

      # ========== 変数集約 ==========
      - id: variable-aggregator-1
        type: variable-aggregator
        title: "Phase1-3結果統合"
        position: { x: 750, y: 200 }
        data:
          variables:
            - "{{ llm-design-analyzer.project_json }}"
            - "{{ llm-quality-formatter.answer }}"
            - "{{ kr-construction-method.result }}"
            - "{{ http-emergency-hospital.body }}"
        display: true

      # ========== Phase 4: 品質検証 ==========
      - id: code-placeholder-detector
        type: code
        title: "Skill4: プレースホルダー検出"
        position: { x: 1000, y: 200 }
        data:
          language: python
          input_variables:
            - variable_name: document_text
              type: string
          code: |
            import re
            import json

            patterns = [
                r'○○', r'△△', r'□□', r'XXX', r'YYY', r'ZZZ',
                r'000-0000-0000', r'\d{2,4}-XXX-\d{4}',
                r'UNKNOWN', r'TBD', r'TODO', r'未定', r'検討中', r'仮'
            ]

            findings = []
            for pattern in patterns:
                matches = re.findall(pattern, document_text)
                findings.extend(matches)

            result = {
                "placeholder_count": len(findings),
                "placeholders": list(set(findings)),
                "is_clean": len(findings) == 0
            }
          output_variables:
            - variable_name: result
              type: object
        display: true

      - id: code-fact-checker
        type: code
        title: "Skill5: 数値整合性チェック"
        position: { x: 1250, y: 200 }
        data:
          language: python
          input_variables:
            - variable_name: json_data
              type: string
          code: |
            import json

            try:
                data = json.loads(json_data)
                errors = []

                # 金額整合性チェック
                if 'work_categories' in data and 'basic_info' in data:
                    sum_cost = sum(
                        item.get('total_cost', 0)
                        for cat in data.get('work_categories', [])
                        for item in cat.get('items', [])
                    )
                    contract = data['basic_info'].get('contract_amount', 0)
                    if contract > 0 and abs(sum_cost - contract) > 100000:
                        errors.append(f"金額不一致: 合計{sum_cost} vs 契約{contract}")

                # 項目金額チェック
                for cat in data.get('work_categories', []):
                    for item in cat.get('items', []):
                        qty = item.get('quantity', 0)
                        price = item.get('unit_price', 0)
                        total = item.get('total_cost', 0)
                        if qty > 0 and price > 0:
                            calc = qty * price
                            if abs(calc - total) > 100:
                                errors.append(f"{item['name']}: {qty}x{price}={calc} vs {total}")

                result = {
                    "is_valid": len(errors) == 0,
                    "error_count": len(errors),
                    "errors": errors
                }
            except Exception as e:
                result = {
                    "is_valid": False,
                    "error_count": 1,
                    "errors": [str(e)]
                }
          output_variables:
            - variable_name: result
              type: object
        display: true

      # ========== Phase 5: 図表生成 ==========
      - id: code-chart-generator
        type: code
        title: "Skill6: 図表生成"
        position: { x: 1500, y: 200 }
        data:
          language: python
          input_variables:
            - variable_name: project_data
              type: string
          code: |
            import json
            import base64
            from io import BytesIO

            # matplotlibは Dify Cloud では制限あり
            # 代替: Mermaid.js コードを生成

            data = json.loads(project_data)
            basic = data.get('basic_info', {})

            # ガントチャート用Mermaid
            gantt_mermaid = f"""
            gantt
                title {basic.get('project_name', '工事')}
                dateFormat YYYY-MM-DD
                section 準備工
                準備作業 :a1, {basic.get('duration', {}).get('start', '2024-01-01')}, 7d
                section 本体工
                本体工事 :a2, after a1, 60d
                section 仕上工
                仕上作業 :a3, after a2, 14d
            """

            # 組織図用Mermaid
            org_mermaid = """
            flowchart TB
                A[発注者] --> B[元請会社]
                B --> C[現場代理人]
                C --> D[主任技術者]
                C --> E[安全管理者]
                D --> F[協力会社A]
                D --> G[協力会社B]
            """

            result = {
                "gantt_chart": gantt_mermaid,
                "organization_chart": org_mermaid,
                "charts_generated": 2
            }
          output_variables:
            - variable_name: result
              type: object
        display: true

      # ========== Phase 7: 文書統合 ==========
      - id: llm-document-integrator
        type: llm
        title: "施工計画書統合"
        position: { x: 1750, y: 200 }
        data:
          model:
            provider: anthropic
            name: claude-3-5-sonnet-20241022
            mode: chat
          temperature: 0.5
          max_tokens: 8000
          prompt_template:
            - type: system
              text: |
                あなたは施工計画書を作成するエキスパートです。
                以下の情報を統合して、完全な施工計画書（Markdown形式）を作成してください。

                【構成】
                1. 工事概要
                2. 施工体制
                3. 施工方法
                4. 品質管理計画
                5. 安全管理計画
                6. 環境保全計画
                7. 緊急時対応
                8. 工程表
            - type: user
              text: |
                【工事データ】
                {{ llm-design-analyzer.project_json }}

                【品質基準】
                {{ llm-quality-formatter.answer }}

                【施工ノウハウ】
                {{ kr-construction-method.result }}

                【緊急連絡先】
                {{ http-emergency-hospital.body }}

                【品質検証結果】
                プレースホルダー: {{ code-placeholder-detector.result }}
                数値整合性: {{ code-fact-checker.result }}

                【図表（Mermaid）】
                {{ code-chart-generator.result }}
        display: true

      # ========== 終了 ==========
      - id: end-1
        type: end
        title: "施工計画書出力"
        position: { x: 2000, y: 200 }
        data:
          output_type: object
          output_selector:
            - variable: "{{ llm-document-integrator.answer }}"
              label: "施工計画書（Markdown）"
            - variable: "{{ code-chart-generator.result }}"
              label: "図表データ（Mermaid）"
            - variable: "{{ code-placeholder-detector.result }}"
              label: "品質検証結果"
        display: true
