# PoC構築手順書 -- 海潟漁港R7-1 テストスプレッドシート

**対象**: (株)森組 工事予算管理システム Phase A PoC
**作成日**: 2026年2月19日

---

## 概要

GAS 6ファイル（約125KB）をテストスプレッドシートにデプロイし、海潟漁港の実データで動作確認する。
「32シートのExcelが、9シートのスプレッドシートになった」を実証する。

---

## 前提条件

- Googleアカウント（Google Workspace推奨）
- gas_templates/budget_management/ ディレクトリの6ファイル（hub.gs除く）にアクセスできること
- 海潟漁港R7-1のExcel月報（10月-12月の支払データ）

---

## Step 1: テストスプレッドシート作成

### 1-1. スプレッドシート新規作成

[ ] 1. Google Driveで新規スプレッドシートを作成
     名前: 「海潟漁港_テスト_YYYYMMDD」
     成功時: 空のスプレッドシートが開く

### 1-2. GASプロジェクトにコードをコピー

[ ] 2. メニュー「拡張機能」→「Apps Script」でエディタを開く
     成功時: Apps Scriptエディタが新しいタブで開く

[ ] 3. 以下の6ファイルをApps Scriptエディタにコピー（ファイル名を正確に合わせる）

| 順序 | ファイル | コピー元 | 備考 |
|------|---------|---------|------|
| 1 | config.gs | gas_templates/budget_management/config.gs | 最初にコピー（定数定義） |
| 2 | template.gs | gas_templates/budget_management/template.gs | テンプレート生成 |
| 3 | validation_extended.gs | gas_templates/budget_management/validation_extended.gs | カスケードDD |
| 4 | aggregation.gs | gas_templates/budget_management/aggregation.gs | 月次集計 |
| 5 | budget_health.gs | gas_templates/budget_management/budget_health.gs | 予算健康度 |
| 6 | api.gs | gas_templates/budget_management/api.gs | Web App API |

**hub.gsについて**: hub.gsは本社横断管理用で、api.gsとdoGet()が衝突するため同一GASプロジェクトには入れない。PoCでは現場単体テスト（Step 4-4まで）を6ファイルで実施し、hub.gsの横断テストはパイロット導入時に別スプレッドシート（本社管理台帳）にバインドして実施する。

**手順**: エディタ左上の「+」→「スクリプト」で新ファイル追加。各ファイルの内容を全てコピー&ペースト。

     成功時: エディタ左側に6つのファイルが表示される

### 1-3. スクリプトプロパティの設定

[ ] 4. Apps Scriptエディタ → 歯車アイコン（プロジェクトの設定） → スクリプトプロパティ

| プロパティ名 | 値 | 説明 |
|------------|---|------|
| API_KEY | 任意の文字列（例: test_key_20260219） | API認証キー |
| ALERT_EMAIL | テスト用メールアドレス | 予算超過時の通知先 |

     成功時: 「プロパティが正常に保存されました」と表示される

---

## Step 2: テンプレート生成テスト

### 2-1. initProjectTemplate の実行

[ ] 5. Apps Scriptエディタに戻り、実行する関数として「initProjectTemplate」を選択
[ ] 6. 引数入力のため、以下のテストスクリプトを一時的に追加:

```javascript
// テスト用（動作確認後に削除）
function testInit() {
  initProjectTemplate('P004');
}
```

[ ] 7. testInit を実行
     初回実行時: Googleアカウントの認証許可が求められる → 「許可」をクリック
     成功時: スプレッドシートに以下の9シートが自動生成される

### 2-2. 生成シートの確認

| シート名 | 役割 | 確認ポイント |
|---------|------|-----------|
| _実行予算テーブル | 予算の箱定義 | 工種×費用要素の行が生成されている |
| _実行予算_月別 | 月別配分 | 開始月/終了月の列がある |
| 支払明細入力 | メイン入力画面 | 18列のヘッダーが正しい（A:No. ~ R:備考） |
| 支払明細 | 転記済み明細 | 空のシート |
| _C_予算健康度 | 予算健康度 | ヘッダー行がある |
| _C_月次集計 | 月次集計 | ヘッダー行がある |
| _C_費目別集計 | 費目別集計 | ヘッダー行がある |
| _月次調整 | 出来高率入力 | 年月と出来高率の列がある |
| _M取引先 | 取引先マスタ | 空 or サンプルデータ |

[ ] 8. 上記9シートが全て生成されていることを確認
     成功時: タブバーに9つのシートが並ぶ

### 2-3. available_elementsフィルタの確認

[ ] 9. 支払明細入力シートのB列（カテゴリ）で「直接工事費」を選択
[ ] 10. C列（工事種別）のドロップダウンが連動して絞り込まれることを確認
[ ] 11. D列（工種）でいくつかの工種を選び、E列（費目）の選択肢が変わることを確認

例: K0103 除石工 を選択 → E列は E12(機械経費), E13(機械経費損料), E14(外注費) の3つだけ

     成功時: 工種に応じて費目の選択肢が自動で変わる

---

## Step 3: 実データ入力

### 3-1. 実行予算の入力

[ ] 12. _実行予算テーブルに以下のデータを入力

海潟漁港R7-1の主要予算箱:

| 予算箱ID | カテゴリ | 工種 | 費目 | 実行予算額 | 官積算額 |
|---------|--------|------|------|----------|---------|
| C01-W04-K0401-E14 | 直接工事費 | 護岸工 | 外注費 | 9,800,000 | -- |
| C01-W11-K1101-E14 | 直接工事費 | 排水工 | 外注費 | 5,555,000 | -- |
| C01-W02-K0201-E14 | 直接工事費 | コンクリート工 | 外注費 | 7,228,000 | -- |
| C02-F35 | 共通仮設費 | -- | 安全対策費 | 340,000 | -- |
| C02-F36 | 共通仮設費 | -- | 水道光熱費 | 65,000 | -- |
| C03-F52 | 現場管理費 | -- | 法定福利費 | 690,039 | -- |
| C03-F54 | 現場管理費 | -- | 地代家賃 | 131,910 | -- |
| C03-F56 | 現場管理費 | -- | 従業員給料手当 | 3,100,000 | -- |

     成功時: 予算テーブルに8行以上のデータが入力される

### 3-2. 取引先マスタの登録

[ ] 13. _M取引先シートに以下の主要取引先を登録

| 取引先名 | 主な費目 |
|---------|---------|
| 川越建設 | 外注費 |
| (有)濱畑水道 | 外注費 |
| 桜島生コンクリート | 材料費/外注費 |
| 菱和コンクリート | 外注費 |
| (株)グリーンクロス | 材料費/安全費 |
| (株)ニシケン | 営繕費 |
| (有)大建測量設計 | 準備費 |
| (株)デザインアーク | 営繕費 |
| (株)コマロック | 機械経費 |

     成功時: 支払明細入力のF列DDに上記業者名が表示される

### 3-3. 支払実績の入力（10月-12月）

[ ] 14. Excel月報から10月-12月の支払実績を支払明細入力シートに転記

入力目安:
- 10月度: 約31件
- 11月度: 約26件
- 12月度: 約25件
- 合計: 約82件

**照合用チェックポイント**:

| 月度 | 支払計（税抜） | 相殺計 |
|------|-------------|--------|
| 10月 | 10,933,337円 | 4,119,138円 |
| 11月 | 8,458,604円 | 2,712,148円 |
| 12月 | 4,332,077円 | 0円 |

     成功時: 82件程度のデータが入力完了

---

## Step 4: E2Eテスト

### 4-1. 月次集計の実行

[ ] 15. メニュー → 「工事管理」→「月次集計を実行」（またはApps Scriptからrunを実行）
     成功時: _C_月次集計シートと_C_費目別集計シートにデータが表示される

### 4-2. 集計結果の照合

[ ] 16. _C_費目別集計シートの値をExcel月報と照合

| カテゴリ | 実行予算額 | 集計結果（期待値） | 照合 |
|---------|----------|----------------|------|
| 直接工事費 | 27,095,460円 | 10,789,631円 | [ ] 一致 |
| 共通仮設費（実績） | -- | 907,661円 | [ ] 一致 |
| 現場管理費 | 4,859,949円 | 3,095,040円 | [ ] 一致 |

### 4-3. 予算健康度の確認

[ ] 17. メニュー → 「工事管理」→「予算健康度を更新」（またはApps Scriptから monthlyBudgetHealthCalculation を実行）
     成功時: _C_予算健康度シートに消化率/信号が表示される

[ ] 18. 信号判定の妥当性を確認

| 費目 | 消化率（期待） | 信号（期待） |
|------|-------------|-----------|
| 法定福利費 | 126.2% | 赤 |
| 地代家賃 | 113.7% | 赤 |
| 安全対策費 | 113.0% | 赤 |
| コンクリート工/外注費 | 72.0% | 青 |
| 従業員給料手当 | 56.5% | 青 |

     成功時: 超過費目に赤信号、正常費目に青信号が表示される

### 4-4. API動作確認

[ ] 19. api.gsをWeb Appとしてデプロイ:
     Apps Scriptエディタ → 「デプロイ」→「新しいデプロイ」
     種類: ウェブアプリ
     アクセスできるユーザー: 「自分のみ」（テスト時）

[ ] 20. デプロイURLにアクセスして確認

```
# mode=health のテスト
{デプロイURL}?mode=health&key={API_KEY}

期待: 費目別の消化率/信号を含むJSON

# mode=summary のテスト
{デプロイURL}?mode=summary&key={API_KEY}

期待: 工事価格/消化率/累計支出を含むJSON
```

     成功時: 正しいJSONが返る

---

## Step 5: バグ修正（典型的な問題と対処）

テストで発見される可能性のある典型的な問題:

| 問題 | 原因 | 対処 |
|------|------|------|
| カスケードDDが動かない | onEditトリガーが未設定 | Apps Script → トリガー → onEditHandler を onEdit で設定 |
| 集計結果が0 | 支払明細のQ列（予算箱ID）が空 | validation_extended.gsの予算箱ID解決ロジックを確認 |
| 消化率がNaN | 実行予算テーブルの予算額が未入力 | 予算額を入力 |
| API認証エラー | API_KEYの不一致 | スクリプトプロパティを確認 |
| 相殺計算がおかしい | L列（相殺額）の入力形式 | 数値のみ（カンマなし）で入力 |

---

## 成果物チェックリスト

[ ] 動作するテストスプレッドシート（URL共有可能）
[ ] カスケードDD（4段連鎖）の動作スクリーンショット
[ ] 集計結果とExcel月報の照合結果
[ ] 予算健康度の信号判定スクリーンショット
[ ] API（mode=health, mode=summary）のレスポンスJSON

---

## 次のステップ

PoC成功後:
1. **提案デモの準備**: スクリーンショットを提案資料に追加
2. **森組への提案**: テストスプレッドシートを使ったライブデモ
3. **パイロット導入**: 森組のGoogle Workspaceに本番スプレッドシートを構築

---

**文書バージョン**: 1.0
**作成日**: 2026-02-19
