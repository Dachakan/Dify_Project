# 工事予実管理システム 設計書（提案資料）

**対象工事**: 海潟漁港海岸海岸保全施設整備連携工事(R7-1工区)
**施工会社**: (株)森組
**作成日**: 2026年2月16日

---

## 第1章: 概要 -- 「何が変わるのか」

### 現在の課題

現在の予実管理は、2つのExcelファイル（合計32シート）を手作業で運用しています。月末のたびに各シートを手で集計し、前月のシートをコピーして翌月分を作成するため、計算ミスや更新漏れが繰り返し発生しています。

実際に品質検査を行った結果、**11件の問題**が検出されました。そのうち4件は数値の信頼性に直接関わる深刻な問題です。

### 導入するとどうなるか

- **入力はたった3画面だけ**。現在の28枚の入力シートが3枚に
- **集計は全自動**。月末の手作業がゼロに
- **全社員がスマホで確認可能**。Excelファイルの回覧が不要に
- **AIが分析をサポート**。「今月の利益率は?」と聞くだけで即回答

### Before / After 対比

| 項目 | 現在（手作業） | 導入後（自動化） |
|------|--------------|----------------|
| 入力シート数 | 28枚 | 3枚（89%削減） |
| 入力セル数 | 約3,255 | 約800（75%削減） |
| 月末集計作業 | 各シートを手で合算 | 全自動（作業時間ゼロ） |
| 品質問題 | 11件（うち深刻4件） | 8件を自動化で根絶 |
| 情報共有 | Excelファイルを回覧 | 全社員がリアルタイムで閲覧 |
| 予算超過の把握 | 月末に手で確認 | 80%超過で自動メール通知 |

---

## 第2章: 所長が毎日見る画面 -- 入力シートの完成イメージ

### 2.1 月次支出の入力画面（18列・2段階入力）

入力は2段階で行います。**所長は緑色のセル（A-K列の11項目）**を入力します。**事務員は青色のセル（L-M列の2項目）**を請求書到着後に追記します。灰色のセル（N-R列）は全て自動計算されます。

```
+--[支払明細入力]-- 18列構成 -----------------------------------------------+
|                                                                            |
|  --- 所長入力（緑セル A-K列）---                                           |
|                                                                            |
|  [No.] [カテゴリ]  [工事種別] [工種]     [費目]   [支払先]                 |
|  ----- ----------  --------- --------   -------  ----------------          |
|  1     直接工事費v  護岸工  v  護岸工  v  外注費v  川越建設          v      |
|  2     直接工事費v  排水工  v  排水工  v  外注費v  (有)濱畑水道      v      |
|  3     直接工事費v  コンクリv  コンクリv  外注費v  桜島生コンクリート v      |
|        ~~~~~~~~~~   ~~~~~~~~   ~~~~~~~~   ~~~~~~   ~~~~~~~~~~~~~~~~~~      |
|        選ぶと次が   自動で     自動で     対応する  登録済みの                |
|        絞り込まれる  絞り込み   絞り込み   ものだけ  業者から選択            |
|                                                                            |
|  [年月]    [数量] [単位] [単価]     [金額]                                  |
|  --------  ------ ------ ---------  -----------                            |
|  2025-10   1      式     5,316,667  5,316,667                              |
|  2025-10   1      式     2,456,554  2,456,554                              |
|  2025-10   50     m3     42,167     2,108,370                              |
|                                                                            |
|  --- 事務員追記（青セル L-M列、請求書到着後）---                            |
|  [相殺額]     [相殺先]                                                     |
|  ----------   ----------------                                             |
|               --                                                           |
|               --                                                           |
|  2,993,670    川越建設                                                     |
|                                                                            |
|  --- 自動計算（灰セル N-R列）---                                           |
|  [課税区分] [消費税]  [税込合計]  [予算箱ID]           [備考]              |
|  --------- --------  ----------  -------------------  ------              |
|  課税      531,667   5,848,334   C01-W04-K0401-E14                        |
|  課税      245,655   2,702,209   C01-W11-K1101-E14                        |
|  相殺      --        --          C01-W02-K0201-E14   川越建設へ相殺       |
|                                                                            |
|  [前行コピー]  <-- 同じ業者への連続入力時、前行をワンクリックでコピー      |
|                                                                            |
+----------------------------------------------------------------------------+
  緑 = 所長入力セル（A-K列: No./カテゴリ/工事種別/工種/費目/支払先/年月/数量/単位/単価/金額）
  青 = 事務員追記セル（L-M列: 相殺額/相殺先）-- 請求書到着後に入力
  灰 = 自動計算（N-R列: 課税区分/消費税/税込合計/予算箱ID/備考）

  ※ 相殺未入力の行は暫定集計に含まれます
  ※ 予算箱IDはカテゴリ+工種+費目の組み合わせから自動生成されます
```

**カスケードドロップダウン（自動絞り込み）**

4段階のドロップダウンが連動します。上を選ぶと下の選択肢が自動で絞り込まれるため、入力ミスが構造的に発生しません。

```
カテゴリ（B列）: 直接工事費 / 共通仮設費 / 現場管理費
    ↓ 選ぶと
工事種別（C列）: カテゴリに対応する種別だけ表示
    ↓ 選ぶと
工種（D列）: 工事種別に対応する工種だけ表示
    ↓ 選ぶと
費目（E列）: その工種で使える費用要素だけ表示（available_elements）
```

**available_elements（入力可能な費目の制限）**

工種ごとに、入力できる費目があらかじめ決まっています。例えば「除石工」では機械経費・機械経費損料・外注費の3つだけが選べます。労務費や材料費は選択肢に出てきません。これにより、ありえない組み合わせでの入力を防ぎます。

| 工種の例 | 選べる費目 |
|---------|----------|
| 護岸工 | 材料費/機械経費/外注費 |
| 除石工 | 機械経費/機械経費損料/外注費 |
| コンクリート工 | 材料費/外注費 |

**2段階入力のルール**

| 段階 | 担当 | 入力列 | セル色 | タイミング |
|------|------|-------|--------|-----------|
| 第1段階 | 所長 | A-K列（No./カテゴリ/工事種別/工種/費目/支払先/年月/数量/単位/単価/金額） | 緑（#E8F5E9） | 支払発生時 |
| 第2段階 | 事務員 | L-M列（相殺額/相殺先） | 青（#E3F2FD） | 請求書到着後 |

- 第1段階のみ入力された行は暫定集計に含まれる
- 第2段階で相殺額・相殺先が入力されると確定ステータスに変わる

**前行コピー機能**

同じ業者への複数明細を連続入力する場合、「前行コピー」ボタンで前行の業者名・費目をワンクリックで次行にコピーできます。

**入力期限通知**

毎月15日までに前月分の入力が完了していなければ、所長にメールで通知が届きます。

### 2.2 入力のポイント

**業者名は一覧から選ぶだけ（手入力不要）**

約20社の取引先があらかじめ登録されています。ドロップダウンから選ぶだけなので、「濵畑」と「濱畑」のような表記揺れが起きません。

| 登録済みの主な業者 | 主な費目 |
|-------------------|---------|
| 川越建設 | 外注費 |
| (有)濱畑水道 | 外注費 |
| 桜島生コンクリート | 材料費/外注費 |
| 菱和コンクリート | 外注費 |
| (株)グリーンクロス | 材料費/安全費 |
| (株)ニシケン | 営繕費/動力用水光熱費 |
| (有)大建測量設計 | 準備費 |

**費目はカスケードDDで自動絞り込み**

カテゴリ→工事種別→工種→費目の4段階で、上を選ぶと下が自動で絞り込まれます。全26費目（共通仮設費9項目+現場管理費17項目）+ 費用要素5項目が登録済みです。

| 大分類 | 費目例 | 費目数 |
|--------|-------|--------|
| 直接工事費（費用要素） | 材料費(E11)、機械経費(E12)、外注費(E14)、労務費(E15) | 5項目 |
| 共通仮設費 | 運搬費(F31)、準備費(F32)、仮設費(F33)、安全費(F35) 等 | 9項目 |
| 現場管理費 | 地代(F54)、保険料(F55)、従業員給料手当(F56)、法定福利費(F52) 等 | 17項目 |

**取引先マスタ（_M取引先シート）**

約20社の取引先があらかじめ登録されています。支払先（F列）のドロップダウンから選ぶだけなので、手入力は不要です。新しい取引先が発生した場合は、_M取引先シートに1行追加するだけで、ドロップダウンに自動反映されます。

**消費税は自動計算**

金額を入力すれば、課税区分の判定・消費税（10%）・税込金額が全て自動で計算されます。端数の丸め処理も自動です。相殺行は自動的に「相殺」区分となり、消費税計算の対象外となります。

### 2.3 入力環境

- **入力操作はPC/タブレットを前提とする。スマートフォンでの入力は想定外**
- ダッシュボード（Google Sites）のみスマートフォン対応（閲覧専用）

### 2.4 入力ミスの自動チェック

入力時に以下のチェックが自動で行われ、ミスがあればその場で警告が表示されます。

| チェック内容 | 具体例 |
|------------|--------|
| 費目コード未選択 | 費目が空欄のまま保存しようとすると警告 |
| 業者名未登録 | 登録されていない業者名を手入力すると警告 |
| 金額の符号チェック | マイナス金額の入力時に確認メッセージ |
| 相殺先の整合性 | 相殺額を入力したのに相殺先が空欄なら警告 |

---

## 第3章: 全社員が見られるダッシュボード -- 社内共有画面の完成イメージ

パソコンでもスマートフォンでも同じ画面が見られます。Excelファイルを探す必要はありません。インターネットに繋がればどこからでも確認できます。

### 3.1 経営者が見る画面（3秒ダッシュボード）

**page1: 3秒ダッシュボード** -- 開いた瞬間に状況が分かるよう設計。KPIカード4枚と信号表示で「今すぐ見るべきこと」だけを表示します。

```
+--[経営ダッシュボード -- page1: 3秒ダッシュボード]----------------------+
|                                                                        |
|  +===[信号表示]=====================================================+  |
|  |  [赤] 2件の予算超過あり（クリックで詳細展開）                    |  |
|  +==================================================================+  |
|                                                                        |
|  +--[工事益率]--+  +--[純工事益率]-+  +--[予算消化率]-+  +--[過不足]---+|
|  |              |  |              |  |              |  |              | |
|  |   58.9%      |  |   45.9%      |  |   47.5%      |  | +○○万円     | |
|  |              |  |              |  |              |  | (見込み)    | |
|  +--------------+  +--------------+  +--------------+  +--------------+|
|                                                                        |
|  [予算超過アラート（赤信号の件数のみ表示、クリックで詳細展開）]         |
|  +------------------------------------------------------------------+  |
|  | [赤] 2件  -- クリックで展開                                      |  |
|  +------------------------------------------------------------------+  |
|                                                                        |
+------------------------------------------------------------------------+
```

**page2: 月別推移** -- 月別支出推移グラフと予算超過の詳細を表示します（page1から移動した内容）。

```
+--[経営ダッシュボード -- page2: 月別推移]-------------------------------+
|                                                                        |
|  [月ごとの支出推移グラフ]                                               |
|                                                                        |
|   金額(万円)                                                            |
|   1,200 |                                                              |
|   1,000 |    *                                                         |
|     800 |   / \                                                        |
|     600 |  /   \                                                       |
|     400 | /     *                                                      |
|     200 |/                                                             |
|       0 +--------+--------+--------                                    |
|         10月     11月     12月                                          |
|                                                                        |
|  [予算超過アラート（詳細）]                                             |
|  +------------------------------------------------------------------+  |
|  | [赤] 法定福利費  -- 予算超過 +26.2%  至急確認が必要です          |  |
|  | [赤] 保険料      -- 予算超過 +13.7%  至急確認が必要です          |  |
|  | [黄] 動力用水光熱費 -- 予算超過 +13.0%  注意が必要です           |  |
|  +------------------------------------------------------------------+  |
|                                                                        |
+------------------------------------------------------------------------+
```

**信号表示の基準**:

| 信号 | 条件 | 表示 |
|------|------|------|
| 青 | 全費目の消化率80%未満 | 「問題なし」 |
| 黄 | 80%超の費目が1件以上 | 「[黄] N件の注意あり」 |
| 赤 | 100%超の費目が1件以上 | 「[赤] N件の予算超過あり」 |

**4枚目のKPIカード変更**: 従来の「累計支出」から「過不足見込み」に変更。実行予算額 - (累計支払額 / 出来高率) で算出。工事完了時に予算が余るか足りないかを1枚で把握可能。正の値は「余り」、負の値は「不足」を示す。

### 3.2 所長が見る画面

```
+--[現場管理ダッシュボード]----------------------------------------------+
|                                                                        |
|  [今月の入力状況]                                                       |
|  10月: 31件入力済み  /  11月: 26件入力済み  /  12月: 25件入力済み       |
|                                                                        |
|  [費目別の構成]            [業者別の支払い構成]                          |
|                                                                        |
|    外注費 66%              川越建設      9,667,000円                    |
|    材料費 12%              桜島生コンクリート  5,205,650円              |
|    共通仮設費 6%           (有)濱畑水道   4,839,554円                   |
|    現場管理費 16%          菱和コンクリート   1,910,000円               |
|                            その他          2,101,814円                  |
|                                                                        |
|  +--------------------------------------------------------------+      |
|  |  [ 入力画面を開く ]    [ 月次報告書を出力 ]                   |      |
|  +--------------------------------------------------------------+      |
|                                                                        |
+------------------------------------------------------------------------+
```

### 3.3 スマートフォンでの閲覧

社内共有ダッシュボードは自動でスマートフォン画面に対応します。特別な設定は不要です。外出先や現場からでも、ブラウザを開くだけで最新の数値を確認できます。

### 3.4 色覚多様性への対応

ダッシュボードの全ての色表現には、色だけでなく形（アイコン）とテキストラベルを併記する**二重符号化**を採用します。色の区別が難しい方でも情報を正確に読み取れます。

| 表示 | 色 | アイコン | テキストラベル |
|------|-----|---------|--------------|
| 正常 | 青(#1565C0) | [丸] | 「正常」 |
| 注意 | 黄(#FDD835) | [三角] | 「注意」 |
| 超過 | 赤(#E53935) | [四角] | 「超過」 |
| 改善 | 青(#1565C0) | 上向き矢印 | 「+X.X%」 |
| 悪化 | 赤(#E53935) | 下向き矢印 | 「-X.X%」 |

---

## 第4章: AIチャットボットとの会話例 -- 「こんな質問ができる」

### 4.1 データ分析アシスタント

工事の数字について、日本語で質問するだけで即座に回答が得られます。

**サジェストボタン**: チャット画面を開くと、以下の4つのサジェストボタンが表示されます。ボタンをクリックするだけで質問が送信されるため、入力の手間がありません（Difyのconversation_openerを活用）。

| ボタン | 質問内容 |
|--------|---------|
| 今月の利益率は? | 工事益率・純工事益率の最新値を回答 |
| 予算超過している費目は? | 80%/100%超過の費目一覧を回答 |
| 支払いが多い業者は? | 業者別支払額ランキングを回答 |
| コスト削減の提案 | 改善提案アシスタントへの誘導または直接提案 |

**社長が聞く例:**

```
あなた: 今月の利益率はどうなってる?

AI: 現在の工事益率は58.9%です。

    | 指標         | 金額           |
    |-------------|---------------|
    | 工事価格     | 39,840,000円   |
    | 累計支出     | 16,356,671円   |
    | 工事益       | 23,483,329円   |
    | 工事益率     | 58.9%          |

    工期中盤としては良好な水準です。
    予算消化率は47.5%で、残り工期の予算にも余裕があります。

    -- 経費別の内訳を見ますか?
    -- 予算超過リスクのある費目を確認しますか?
```

```
あなた: 支払いが多い業者はどこ?

AI: 3ヶ月間の支払額上位5社です。

    | 順位 | 業者名                  | 累計支払額      | 割合   |
    |------|------------------------|----------------|--------|
    | 1    | 川越建設                | 9,667,000円    | 40.7%  |
    | 2    | 桜島生コンクリート      | 5,205,650円    | 21.9%  |
    | 3    | (有)濱畑水道           | 4,839,554円    | 20.4%  |
    | 4    | 菱和コンクリート        | 1,910,000円    | 8.1%   |
    | 5    | (株)グリーンクロス      | 432,940円      | 1.8%   |

    上位3社で全体の83%を占めています。
    特に川越建設は外注費の中核を担っており、
    相殺処理（計6,831,286円）も同社向けが中心です。
```

**所長が聞く例:**

```
あなた: 外注費の予算残はいくら?

AI: 外注費の予算状況です。

    | 項目     | 金額          |
    |----------|--------------|
    | 予算額   | (予算設定シートの値) |
    | 累計支出 | 10,789,631円  |
    | 残額     | (自動計算)    |
    | 消化率   | (自動計算)    |

    直接工事費全体の累計は10,789,631円です。
    外注費が最大の構成要素で、川越建設・濱畑水道・
    桜島生コンクリートの3社への支払いが中心です。
```

```
あなた: 相殺の状況を教えて

AI: 3ヶ月間の相殺処理の状況です。

    | 相殺元              | 相殺先   | 10月      | 11月      | 合計      |
    |--------------------|----------|-----------|-----------|-----------|
    | 桜島生コンクリート   | 川越建設 | 2,993,670 | 1,986,480 | 4,980,150 |
    | 菱和コンクリート     | 川越建設 | 1,000,000 |   690,200 | 1,690,200 |
    | (株)コマロック      | 川越建設 |    90,000 |         - |    90,000 |
    | 鹿児島仮設          | 川越建設 |    35,468 |    35,468 |    70,936 |
    | 合計               |          | 4,119,138 | 2,712,148 | 6,831,286 |

    12月度は相殺なしです。
    全ての相殺が川越建設向けの下請精算で発生しています。
```

### 4.2 改善提案アシスタント

数字の分析だけでなく、改善の提案もAIが行います。

```
あなた: コスト削減の優先順位を教えて

AI: 現在のデータに基づく改善提案です。優先度順にまとめました。

    1. 予算超過費目への対応（優先度: 高）
       対象: 法定福利費（+26.2%超過）、保険料（+13.7%超過）
       効果: 予算内に収めれば数十万円の削減余地
       手順: 超過原因の特定 → 来月以降の支出抑制策の検討

    2. 材料調達の見直し（優先度: 中）
       対象: 桜島生コンクリートへの支払い（累計5,205,650円）
       効果: 単価交渉や調達先比較で数%のコスト改善余地
       手順: 現在の単価確認 → 市場単価との比較 → 交渉

    3. 相殺処理の効率化（優先度: 低）
       対象: 川越建設との相殺（累計6,831,286円）
       効果: 資金繰りの改善（コスト削減ではなくキャッシュフロー改善）
       手順: 相殺タイミングの最適化 → 月次精算ルールの明確化
```

```
あなた: 予算超過しそうな費目の対策は?

AI: 現在予算を超過している3費目の分析です。

    [赤] 法定福利費 -- 予算超過 +26.2%
         原因: 作業員の稼働が想定より多い可能性
         対策: 人員配置の見直し、残り工期の稼働計画を再確認

    [赤] 保険料 -- 予算超過 +13.7%
         原因: 工事内容の変更に伴う追加保険の可能性
         対策: 保険内容の見直し、変更契約時の予算調整を検討

    [黄] 動力用水光熱費 -- 予算超過 +13.0%
         原因: 季節変動（冬季の電気使用量増加）の可能性
         対策: 残り工期で自然に平準化される見込み。
               継続して推移を監視

    いずれも工期後半で改善余地があります。
    月次で消化率を確認し、必要に応じて予算流用をご検討ください。
```

---

## 第5章: 自動化される作業 -- 「もう手作業しなくていいこと」

### 5.1 手作業がなくなる7つの業務

| No. | 作業内容 | 現在（手作業） | 導入後（自動） |
|-----|---------|--------------|--------------|
| 1 | 月次集計 | 各シートの数字を手で合算 | 毎月1日に自動集計 |
| 2 | 累計計算 | 前月シートからコピーして加算 | 自動で累計更新 |
| 3 | 相殺処理 | 手計算で相殺額を振替 | 入力するだけで自動処理 |
| 4 | 予算チェック | 月末に手で消化率を確認 | 80%超過で自動メール通知 |
| 5 | 消費税計算 | 電卓で税込金額を計算 | 金額入力で自動算出（端数処理込み） |
| 6 | 月次報告書 | 手作業でシートを作成 | 自動生成 + PDF保存 |
| 7 | 集計ミス確認 | 目視で数字をチェック | 入力時に自動でエラー検知 |

### 5.2 検出された問題と自動化による解決

実際に現在のExcelで見つかった問題を、自動化でどう解決するかを示します。

| 問題の内容 | 影響 | 自動化での解決方法 |
|-----------|------|------------------|
| 累計金額が前月分を含んでいない | 11月の累計が本来19,391,941円のところ8,458,604円と表示 | 累計は自動計算。手動更新が不要になり、この問題が構造的に発生しない |
| 共通仮設費の集計で参照先を間違えている | 1,564,339円の差額が発生 | 集計は入力データから自動生成。手動でのセル参照設定が不要に |
| 純工事費の予算残額の計算が誤っている | 残額が約1,200万円も過大に表示 | 予算残額の計算を自動化。手動の計算式が不要に |
| 小口購入品に費目コードが付いていない | 40,920円分が経費集計から漏れている | 費目コードを必須入力に。未入力では保存できない仕組み |

### 5.3 自動通知の仕組み

システムが自動で知らせてくれるので、確認し忘れがなくなります。

| 状況 | 通知方法 | タイミング |
|------|---------|-----------|
| 予算80%を超過した費目がある | メールで通知 | 入力のたびに自動チェック |
| 予算100%を超過した費目がある | 即時アラート | 入力のたびに自動チェック |
| 月次報告書が完成した | メールでPDFを添付して配信 | 毎月1日の自動集計後 |
| 前月分の入力が未完了 | メールで所長に通知 | 毎月15日に自動チェック |

---

## 第6章: 導入の進め方 -- 段階的に、安全に

### 6.1 基本方針

**いきなり全部を切り替えません。**

既存のExcelと新しいシステムを並行して使い、数字が一致することを確認してから移行します。問題があればいつでも元のExcelに戻せます。

### 6.2 5段階の導入ステップ

| 段階 | 内容 | 目安期間 | 何を確認するか |
|------|------|---------|--------------|
| 第1段階 | 入力シートと業者・費目の一覧表を作成 | 2週間 | 所長が迷わず入力できるか |
| 第2段階 | 自動集計と予算チェック機能を追加 | 2週間 | 既存Excelの数値と一致するか |
| 第3段階 | AIチャットボット（質問回答機能） | 2週間 | 質問に正しく答えるか |
| 第4段階 | ダッシュボードと自動通知 | 2週間 | 全社員が見られるか |
| 第5段階 | テスト運用（既存Excelと並行） | 2週間 | 実際の月次業務で問題ないか |

### 6.3 各段階の詳細

**第1段階: 入力シートの作成（2週間）**

- 支出入力画面の作成（第2章の画面）
- 業者一覧の登録（約20社）
- 費目一覧の登録（26項目）
- 既存3ヶ月分のデータ（82取引）を新システムに移行
- 検証: 10月支払計10,933,337円、11月支払計8,458,604円、12月支払計4,332,077円が一致するか確認

**第2段階: 自動集計の追加（2週間）**

- 費目別の自動集計機能
- 累計計算の自動化
- 相殺処理の自動化
- 予算超過アラート（80%/100%）
- 検証: 既存の工事月報の正しい数値と照合

**第3段階: AIチャットボット（2週間）**

- データ分析アシスタントの構築（第4章の会話例を実現）
- 改善提案アシスタントの構築
- 検証: 第4章の質問を実際に試し、正確な回答が返るか確認

**第4段階: ダッシュボードと通知（2週間）**

- 経営者向けダッシュボード（第3章の画面）
- 所長向けダッシュボード
- メール自動通知の設定
- 検証: 全社員がスマホからアクセスできるか確認

**第5段階: テスト運用（2週間）**

- 既存Excelと新システムを並行で使用
- 1ヶ月分の実際の業務で動作確認
- 問題点の洗い出しと修正
- 問題がなければ新システムに完全移行

---

## 第7章: 期待効果のまとめ

### 7.1 数値での改善効果

| 改善項目 | 現在 | 導入後 | 改善率 |
|---------|------|-------|--------|
| 入力シート数 | 28枚 | 3枚 | 89%削減 |
| 入力セル数 | 約3,255 | 約800 | 75%削減 |
| 品質問題 | 11件（うち深刻4件） | 自動化で8件根絶 | 73%解消 |
| 月末集計作業 | 手作業で数時間 | 全自動（ゼロ時間） | 100%削減 |
| 情報共有方法 | Excelファイルの回覧 | 全社員リアルタイム閲覧 | 即時化 |

### 7.2 この工事での実証データ

本提案は、実際の工事データに基づいて検証済みです。

| 項目 | データ |
|------|-------|
| 工事価格 | 39,840,000円 |
| 分析対象期間 | 令和7年10月-12月度（3ヶ月分） |
| 取引件数 | 82件 |
| 取引先数 | 約20社 |
| 相殺処理額 | 6,831,286円 |
| 工事益率 | 58.9% |
| 純工事益率 | 45.9% |

3ヶ月分・82取引の実データで、自動集計の正確性と入力の効率化を確認しています。

### 7.3 横展開の可能性

この工事で実証した仕組みは、**他の工事にもそのまま展開できます**。

- 業者一覧と費目一覧を入れ替えるだけで別の工事に対応
- 入力画面の操作方法は全く同じ
- ダッシュボードも同じ形式で利用可能
- 将来的には複数工事を一つの画面で横断的に管理することも可能

```
1工事目で実証  -->  2工事目に展開  -->  全工事を一元管理
（本工事）         （同じ仕組み）      （横断ダッシュボード）
```

### 7.4 残る課題（人の判断が必要なもの）

全てを自動化できるわけではありません。以下の2点は引き続き人の判断が必要です。

| 項目 | 理由 | システムでの支援 |
|------|------|----------------|
| 業者名の正式名称確認 | 法人登記簿の名称を人が確認する必要がある | 初回登録後は一覧から選ぶだけで表記揺れなし |
| 予算超過時の対応判断 | 予算流用・変更契約等は経営判断 | 超過を即時通知し、早期発見を支援 |

---

---

# 実装詳細設計書

> 以下は、第1章-第7章の提案内容を実現するための技術実装仕様です。
> 実装担当者向けの資料であり、技術用語を含みます。

---

## 付録A: Google Sheets 設計書

### A.1 全体構成（4層15シート + 経営診断データ4シート）

```
+============================================================+
|  入力層（3シート）-- 人間が操作する唯一の領域               |
|  [支払明細入力] [予算設定] [月次調整]                        |
+============================================================+
         |                    |                |
         v                    v                v
+============================================================+
|  マスター層（4シート）-- 初期設定後は基本変更なし            |
|  [業者マスター] [経費コード] [機械マスター] [労務単価]       |
+============================================================+
         |
         v  (Apps Scriptが自動生成)
+============================================================+
|  計算層（4シート）-- 閲覧のみ。編集禁止                     |
|  [経費コード別月別集計] [業者別月別集計]                     |
|  [相殺処理結果]         [予実対比]                          |
+============================================================+
         |
         v  (Apps Scriptが自動生成)
+============================================================+
|  出力層（4シート）-- レポート・ダッシュボード                |
|  [工事月報レポート]     [支払明細月別レポート]               |
|  [経営者ダッシュボード] [現場代理人ダッシュボード]           |
+============================================================+

+============================================================+
|  経営診断データ層（4シート）-- 全社経営診断用                |
|  前年度vs今年度の2期比較 + 工事月報からの自動集計            |
|  [全社損益] [今年度受注一覧] [工事別比較]                    |
|  [外注単価比較+改善効果試算]                                 |
+============================================================+
```

### A.2 入力層（3シート）

#### A.2.1 支払明細入力

1行 = 1取引。全月分を時系列で入力する。

| 列 | ヘッダー | データ型 | 入力方法 | バリデーション | 例 |
|----|---------|---------|---------|--------------|-----|
| A | 月度 | YYYY-MM | 手入力 | 正規表現 `^\d{4}-(0[1-9]\|1[0-2])$` | 2025-10 |
| B | 支払先 | 文字列 | ドロップダウン（業者マスター参照） | マスター値のみ | 川越建設 |
| C | 経費項目 | 文字列 | ドロップダウン（経費コード参照） | 必須。マスター値のみ | 14.外注費 |
| D | 支払金額（税抜） | 整数 | 手入力 | D > 0 | 5,316,667 |
| E | 相殺額 | 整数 | 手入力 | 0 <= E <= D | 0 |
| F | 相殺先 | 文字列 | ドロップダウン（業者マスター参照） | E > 0 なら必須 | 川越建設 |
| G | 摘要 | 文字列 | 手入力 | 任意 | 舗装工事 |
| H | 消費税（自動） | 整数 | 自動計算 | `ROUND((D-E)*0.1, 0)` | 531,667 |
| I | 税込金額（自動） | 整数 | 自動計算 | `(D-E) + H` | 5,848,334 |
| J | 登録日時（自動） | 日時 | Apps Script自動記入 | onEdit時に自動設定 | 2025-10-15 09:30 |

**セル書式（2段階入力対応）**:
- A-E列（所長入力セル）: 背景色 #E8F5E9（薄緑）
- F-G列（事務員追記セル）: 背景色 #E3F2FD（薄青）
- H-J列（自動計算セル）: 背景色 #EEEEEE（灰色）、セル保護（編集不可）
- D, E, H, I列: 数値書式 `#,##0`（カンマ区切り、小数なし）

**データ量の想定**:
- 月あたり約25-31取引（実績値）
- 年間最大約400行
- Google Sheets上限（1,000万セル）に対し余裕あり

#### A.2.2 予算設定

工事開始時に1回設定。工期中の変更も可能。

| 列 | ヘッダー | データ型 | 入力方法 | 例 |
|----|---------|---------|---------|-----|
| A | 経費コード | 文字列 | ドロップダウン | 14.外注費 |
| B | 費目名 | 文字列 | A列連動で自動表示 | 外注費 |
| C | カテゴリ | 文字列 | A列連動で自動表示 | 直接工事費 |
| D | 年間予算額 | 整数 | 手入力 | 15,000,000 |
| E | 累計実績（自動） | 整数 | 計算層から自動参照 | 10,789,631 |
| F | 残額（自動） | 整数 | `D - E` | 4,210,369 |
| G | 消化率（自動） | % | `E / D` | 71.9% |
| H | アラート（自動） | 文字列 | 80%超: 注意 / 100%超: 超過 | -- |

| I | 月別配分パターン | 文字列 | ドロップダウン | 均等配分 |

**月別配分パターン**（I列）:

| パターン | 説明 | PV生成方法 |
|---------|------|-----------|
| 均等配分（デフォルト） | 予算額を工期月数で均等割り | PV月額 = 予算額 / 工期月数 |
| 前半集中 | 工期前半に60%、後半に40%を配分 | 前半月: 1.2倍、後半月: 0.8倍 |
| 後半集中 | 工期前半に40%、後半に60%を配分 | 前半月: 0.8倍、後半月: 1.2倍 |
| カスタム | 月別配分テーブルで個別設定 | _実行予算_月別シートで手入力 |

**行数**: 28行（経費コード数） + 集計行4行（直接工事費計/共通仮設費計/純工事費計/現場管理費計）= 32行

**簡易モード / 詳細モード**:

予算設定シートは2つの表示モードを切り替えて使用できる。所長の初期設定負担を軽減するため、まず簡易モードで大枠を設定し、必要に応じて詳細モードで細分化する。

| モード | 対象ユーザー | 表示行数 | 設定項目 |
|--------|------------|---------|---------|
| 簡易モード | 所長向け | 8行 | 大分類3カテゴリ + 直接工事費の費用要素5項目 = 計8項目 |
| 詳細モード | 経理向け | 32行 | 26費目全項目 + 集計4行 |

**簡易モードの8項目**:

| No. | 項目 | 説明 |
|-----|------|------|
| 1 | 直接工事費 > 材料費 | E11 |
| 2 | 直接工事費 > 機械経費 | E12 + E13 |
| 3 | 直接工事費 > 外注費 | E14 |
| 4 | 直接工事費 > 労務費 | E15 |
| 5 | 直接工事費 小計 | 上記4項目の合計 |
| 6 | 共通仮設費 一括 | F31-F39の合計 |
| 7 | 現場管理費 一括 | F51-F67の合計 |
| 8 | 工事原価 合計 | 5 + 6 + 7 |

- モード切替はシート上部のドロップダウン（「簡易」/「詳細」）で行う
- 簡易モードで入力した予算額は、詳細モードに切り替えた際に均等配分される（手動調整可能）

#### A.2.3 月次調整

機械稼働・労務人工など、金額以外の数量入力。

**機械稼働セクション（A1:E行）**:

| 列 | ヘッダー | データ型 | 例 |
|----|---------|---------|-----|
| A | 月度 | YYYY-MM | 2025-10 |
| B | 機械名 | ドロップダウン（機械マスター参照） | 0.7BH(CAT320) |
| C | 稼働数量 | 数値 | 20 |
| D | 単位 | 自動（B列連動） | 日 |
| E | 金額（自動） | 整数 | `C * 単価` |

**労務セクション（G1:K行）**:

| 列 | ヘッダー | データ型 | 例 |
|----|---------|---------|-----|
| G | 月度 | YYYY-MM | 2025-10 |
| H | 職種 | ドロップダウン（労務単価マスター参照） | オペレーター |
| I | 延べ人工数 | 数値 | 15 |
| J | 日額（自動） | 整数 | 18,000 |
| K | 金額（自動） | 整数 | `I * J` = 270,000 |

### A.3 マスター層（4シート）

#### A.3.1 業者マスター

| 列 | ヘッダー | 例 |
|----|---------|-----|
| A | 業者ID | V001 |
| B | 正式名称 | 川越建設 |
| C | 表示名 | 川越建設 |
| D | 分類 | 主要外注 |
| E | デフォルト経費コード | 14 |
| F | 備考 | 相殺先として使用 |

**初期データ**: 約20社（フィージビリティレポート第4章参照）

**主要業者一覧**:

| 業者ID | 正式名称 | 分類 | デフォルト経費コード | 3ヶ月累計 |
|--------|---------|------|-------------------|----------|
| V001 | 川越建設 | 主要外注 | 14 | 9,667,000円 |
| V002 | (有)濱畑水道 | 主要外注 | 14 | 4,839,554円 |
| V003 | 桜島生コンクリート | 材料/外注 | 11 | 5,205,650円 |
| V004 | 菱和コンクリート | 外注 | 14 | 1,910,000円 |
| V005 | (株)グリーンクロス | 材料/安全 | 11 | 432,940円 |
| V006 | (株)ニシケン | 仮設 | 33 | 173,175円 |
| V007 | (有)大建測量設計 | 準備 | 31 | 170,000円 |
| V008 | (株)デザインアーク | 仮設 | 33 | 150,000円 |
| V009 | (株)コマロック | 機械 | 12 | 145,440円 |
| V010 | ナフコ | 小口 | -- | 少額 |
| V011 | ダイソー | 小口 | -- | 少額 |
| V012 | アマゾン | 小口 | -- | 少額 |
| V013 | セカンドストリート | 小口 | -- | 少額 |
| V014 | コメリ | 小口 | -- | 少額 |
| V015 | ハンズマン | 小口 | -- | 少額 |
| V016 | 鹿児島仮設 | 仮設 | 33 | 70,936円 |

#### A.3.2 経費コードマスター

| 列 | ヘッダー | 例 |
|----|---------|-----|
| A | コード番号 | 14 |
| B | 費目名 | 外注費 |
| C | 表示名 | 14.外注費 |
| D | カテゴリ | 直接工事費 |
| E | 親コード | 10 |
| F | 集計区分 | 明細 |

**全28項目 + 集計4項目**:

| コード | 費目名 | カテゴリ | 親コード | 集計区分 |
|--------|-------|---------|---------|---------|
| 10 | 直接工事費 | 直接工事費 | -- | 集計 |
| 11 | 材料費 | 直接工事費 | 10 | 明細 |
| 12 | 機械経費 | 直接工事費 | 10 | 明細 |
| 13 | 機械経費(損料) | 直接工事費 | 10 | 明細 |
| 14 | 外注費 | 直接工事費 | 10 | 明細 |
| 15 | 労務費 | 直接工事費 | 10 | 明細 |
| 30 | 共通仮設費 | 共通仮設費 | -- | 集計 |
| 31 | 運搬費 | 共通仮設費 | 30 | 明細 |
| 32 | 準備費 | 共通仮設費 | 30 | 明細 |
| 33 | 仮設費 | 共通仮設費 | 30 | 明細 |
| 34 | 事業損失防止施設費 | 共通仮設費 | 30 | 明細 |
| 35 | 安全費 | 共通仮設費 | 30 | 明細 |
| 36 | 役務費 | 共通仮設費 | 30 | 明細 |
| 37 | 技術管理費 | 共通仮設費 | 30 | 明細 |
| 38 | 営繕費 | 共通仮設費 | 30 | 明細 |
| 39 | 設計費 | 共通仮設費 | 30 | 明細 |
| 40 | 純工事費 | 純工事費 | -- | 集計 |
| 50 | 現場管理費 | 現場管理費 | -- | 集計 |
| 51 | 労務管理費 | 現場管理費 | 50 | 明細 |
| 52 | 租税公課 | 現場管理費 | 50 | 明細 |
| 53 | 地代 | 現場管理費 | 50 | 明細 |
| 54 | 保険料 | 現場管理費 | 50 | 明細 |
| 55 | 従業員給料手当 | 現場管理費 | 50 | 明細 |
| 56 | 法定福利費 | 現場管理費 | 50 | 明細 |
| 57 | 福利厚生費 | 現場管理費 | 50 | 明細 |
| 58 | 事務用品費 | 現場管理費 | 50 | 明細 |
| 59 | 通信交通費 | 現場管理費 | 50 | 明細 |
| 60 | 交際費 | 現場管理費 | 50 | 明細 |
| 61 | 補償費 | 現場管理費 | 50 | 明細 |
| 62 | 水道光熱費 | 現場管理費 | 50 | 明細 |
| 63 | 雑費 | 現場管理費 | 50 | 明細 |

#### A.3.3 機械マスター

| 列 | ヘッダー | 例 |
|----|---------|-----|
| A | 機械ID | M001 |
| B | 機械名 | 0.7BH(CAT320) |
| C | 単位 | 月 |
| D | 単価 | 201,600 |
| E | 経費コード | 12 |

**全11種**: 2tダンプ(日/10,200), 4tダンプ(日/14,500), 6t運搬車(日/24,000), 6t運搬車回送(回/14,000), 10t運搬車(日/48,000), 10t運搬車回送(回/25,000), 25tラフター(日/64,000), 0.7BH CAT320(月/201,600), 0.15BH CAT(日/7,000), 0.18BH MR40(日/8,000), タイヤショベル(月/99,000)

#### A.3.4 労務単価マスター

| 列 | ヘッダー | 例 |
|----|---------|-----|
| A | 職種ID | L001 |
| B | 職種名 | オペレーター |
| C | 日額 | 18,000 |
| D | 経費コード | 15 |

**全2職種**: オペレーター(18,000), 普通作業員(15,000)

### A.4 計算層（4シート + 経営診断データ4シート）

全シート、Apps Scriptが自動生成。セル保護で編集不可に設定。

#### A.4.1 経費コード別月別集計

現行の24シート（費目別月別テーブル）を1シートに集約。

| 列 | ヘッダー | 説明 |
|----|---------|------|
| A | 経費コード | 11, 12, 13, ... 60 |
| B | 費目名 | 材料費, 機械経費, ... |
| C | カテゴリ | 直接工事費 / 共通仮設費 / 現場管理費 |
| D | 予算額 | 予算設定シートから参照 |
| E | 4月 | 当月実績 |
| F | 5月 | 当月実績 |
| ... | ... | ... |
| P | 3月 | 当月実績 |
| Q | 合計 | `SUM(E:P)` |
| R | 消化率 | `Q / D` |

**行構成**:
- 明細行: 28行（経費コード別）
- 小計行: 直接工事費計（コード10相当）、共通仮設費計（コード30相当）
- 集計行: 純工事費（コード40 = 10 + 30）、工事原価（40 + 50）
- 合計: 32行

**検証値（10-12月の3ヶ月分）**:
- 直接工事費合計（コード10）: 10,789,631円
- 共通仮設費合計（コード30、月別計ベース）: 907,661円
- 現場管理費合計（コード50）: 3,095,040円

#### A.4.2 業者別月別集計

現行の月度別支払い内訳・左テーブル相当。

| 列 | ヘッダー | 説明 |
|----|---------|------|
| A | 業者名 | 業者マスターから |
| B | 経費コード | 支払明細から集計 |
| C | 10月（税抜） | 月度別合計 |
| D | 10月（相殺） | 月度別相殺合計 |
| E | 11月（税抜） | 月度別合計 |
| F | 11月（相殺） | 月度別相殺合計 |
| ... | ... | ... |
| 列末 | 累計（税抜） | 全月合計 |
| 列末+1 | 累計（相殺） | 全月相殺合計 |
| 列末+2 | 純支払額 | 税抜 - 相殺 |
| 列末+3 | 税込金額 | `ROUND(純支払額 * 1.1, 0)` |

#### A.4.3 相殺処理結果

| 列 | ヘッダー | 説明 |
|----|---------|------|
| A | 相殺元業者 | 実際の取引先 |
| B | 相殺先業者 | 相殺振替先（川越建設等） |
| C | 月度 | 相殺発生月 |
| D | 相殺額 | 金額 |
| E | 累計相殺額 | 相殺元業者別の累計 |

**サマリーセクション（請求サマリー）**:

| 列 | ヘッダー | 計算式 |
|----|---------|--------|
| G | 請求元 | 業者名 |
| H | 請求金額 | 支払明細の業者別合計 |
| I | 相殺合計 | 業者別相殺合計 |
| J | 支払額（税抜） | `H - I` |
| K | 支払額（税込） | `ROUND(J * 1.1, 0)` |

#### A.4.4 予実対比

| 列 | ヘッダー | 説明 |
|----|---------|------|
| A | 経費コード | 28項目 + 集計4項目 |
| B | 費目名 | マスター参照 |
| C | 予算額 | 予算設定から |
| D | 累計実績 | 経費コード別月別集計のQ列 |
| E | 残額 | `C - D` |
| F | 消化率 | `D / C` |
| G | アラート | 80%超: 黄 / 100%超: 赤 |
| H | 前月比増減 | 今月実績 - 前月実績 |

#### A.4.5 経営診断データ層（4シート）

全社経営診断で使用するデータシート群。設計思想は「前年度 vs 今年度」の2期比較。社長が開いた瞬間に「去年と比べて今どうなっているか」が分かることを最優先とする。工事月報スプレッドシートからGAS API経由で自動集計し、手入力を最小限に抑える。

**データの流れ**:

```
[各工事の月報スプレッドシート]      [全社損益シート（年1回入力）]
  |  （GAS API経由で自動集計）        |  （損益計算書の主要数値のみ）
  v                                   v
[今年度受注一覧 / 工事別比較 / 外注単価比較+改善効果試算]
  |
  v
[Google Sites: 経営診断ページ（ページ5-7）]
```

##### A.4.5.1 全社損益

前年度と今年度の損益計算書データ（2期比較）。年1回、管理者が決算データから7項目を転記する。今年度は期中の速報値を随時更新。増減・増減率はセル計算式で自動算出。

| 列 | ヘッダー | 説明 |
|----|---------|------|
| A | 指標 | 売上高, 売上原価, 粗利, 粗利率, 販管費, 営業利益, 営業利益率 |
| B | 前年度 | 数値（円または%）。管理者が決算データから転記 |
| C | 今年度 | 数値（円または%）。期中は速報値を随時更新 |
| D | 増減 | 自動計算: `=C-B`（率の指標は `=C-B` でポイント差） |
| E | 増減率 | 自動計算: `=D/ABS(B)`（率の指標は空欄） |

**行構成**（7行）:

| 行 | 指標 | 前年度（R6） | 今年度（R7） | 増減 | 増減率 |
|----|------|-------------|-------------|------|--------|
| 1 | 売上高 | -- | -- | `=C1-B1` | `=D1/ABS(B1)` |
| 2 | 売上原価 | -- | -- | `=C2-B2` | `=D2/ABS(B2)` |
| 3 | 粗利 | -- | -- | `=C3-B3` | `=D3/ABS(B3)` |
| 4 | 粗利率 | -- | -- | `=C4-B4` | -- |
| 5 | 販管費 | -- | -- | `=C5-B5` | `=D5/ABS(B5)` |
| 6 | 営業利益 | -- | -- | `=C6-B6` | `=D6/ABS(B6)` |
| 7 | 営業利益率 | -- | -- | `=C7-B7` | -- |

**入力ルール**:
- 前年度: 確定決算データから転記（年1回）
- 今年度: 期中は速報値を随時更新（四半期ごと推奨）
- 金額は円単位（整数）、率はパーセント（小数1桁）

**条件付き書式**:
- D列（増減）: 正値は青(#1565C0)、負値は赤(#E53935)
- E列（増減率）: 正値は青(#1565C0)、負値は赤(#E53935)

##### A.4.5.2 今年度受注一覧

今年度に契約した工事 + 今年度に施工中の工事を対象とする一覧。「現在の粗利率」と「進捗」は各工事の月報スプレッドシートからGAS API経由で自動取得。

| 列 | ヘッダー | 説明 |
|----|---------|------|
| A | 契約日 | 和暦表記（R7.x.x 等） |
| B | 発注者 | 鹿児島県, 国交省, 大隅振興局 等 |
| C | 工事名 | 工事名称 |
| D | 所長 | 担当所長名 |
| E | 契約額 | 円（整数） |
| F | 現在の粗利率 | パーセント（小数1桁）。GAS APIで各工事月報から自動取得 |
| G | 進捗 | パーセント（整数）。GAS APIで各工事月報から自動取得 |
| H | 状態 | 「進行中」または「完了」 |

**データソース**:
- A-E列、H列: 管理者が契約時に入力
- F列（現在の粗利率）: GAS APIが各工事の月報スプレッドシートの予実対比シートから自動取得
- G列（進捗）: GAS APIが各工事の月報スプレッドシートの予実対比シートから自動取得

**条件付き書式**:
- F列（粗利率）: 15%未満は赤(#E53935)背景、15-20%は橙(#EF6C00)背景、20%以上は青(#1565C0)背景
- H列（状態）: 「進行中」は青(#1565C0)文字、「完了」は灰(#9E9E9E)文字

##### A.4.5.3 工事別比較

今年度の進行中工事を対象としたパフォーマンス比較。GAS APIが各工事の月報スプレッドシートから自動集計する。手入力不要。

**テーブル1: 工事別比較**（セルA1起点）

| 列 | ヘッダー | 説明 |
|----|---------|------|
| A | 所長 | 担当所長名（GAS自動取得） |
| B | 工事名 | 工事名称（GAS自動取得） |
| C | 契約額 | 円（整数）（GAS自動取得） |
| D | 累計支出 | 円（整数）（GAS自動取得: 月報の累計支出額） |
| E | 粗利率 | パーセント（自動計算: `=(C-D)/C`） |
| F | 予算消化率 | パーセント（GAS自動取得: 月報の予実対比から算出） |
| G | 外注費率 | パーセント（GAS自動取得: 月報の費目別集計から算出） |
| H | 材料費率 | パーセント（GAS自動取得: 月報の費目別集計から算出） |
| I | 状態 | 「進行中」または「完了」 |

**条件付き書式**:
- E列（粗利率）: 15%未満は赤(#E53935)背景
- F列（予算消化率）: 80%以上は黄(#FDD835)背景、95%以上は赤(#E53935)背景

**テーブル2: 所長別集約**（セルA20起点、同一シート内）

| 列 | ヘッダー | 説明 |
|----|---------|------|
| A | 所長 | 所長名 |
| B | 担当工事数 | 自動計算: `=COUNTIF(A:A, A20)`（テーブル1から集計） |
| C | 合計契約額 | 自動計算: `=SUMIF(A:A, A20, C:C)` |
| D | 平均粗利率 | 自動計算: `=AVERAGEIF(A:A, A20, E:E)` |
| E | 平均予算消化率 | 自動計算: `=AVERAGEIF(A:A, A20, F:F)` |
| F | 外注費率傾向 | 自動計算: `=AVERAGEIF(A:A, A20, G:G)` |

##### A.4.5.4 外注単価比較 + 改善効果試算

今年度の工事月報データから自動抽出した単価比較と、管理者が設定する改善目標値。1シートに2テーブルを格納。

**テーブル1: 外注単価比較**（セルA1起点）

| 列 | ヘッダー | 説明 |
|----|---------|------|
| A | 工種 | 工種名称（今年度の同一工種を施工している複数工事から抽出） |
| B | 最安単価 | 円/単位（GAS自動抽出: 同一工種の最安値） |
| C | 最安所長 | 所長名（GAS自動抽出） |
| D | 最高単価 | 円/単位（GAS自動抽出: 同一工種の最高値） |
| E | 最高所長 | 所長名（GAS自動抽出） |
| F | 格差倍率 | 自動計算: `=D/B` |
| G | 標準単価（目標） | 円/単位。管理者が設定する改善目標値 |

**条件付き書式**:
- F列（格差倍率）: 1.5倍以上は赤(#E53935)背景

**テーブル2: 改善効果試算**（セルA10起点）

| 列 | ヘッダー | 説明 |
|----|---------|------|
| A | 改善項目 | 施策名称 |
| B | 現状コスト | 円（自動計算: 今年度工事の該当コスト合計） |
| C | 改善後見込 | 円（自動計算: 標準単価で再計算した場合のコスト） |
| D | 年間削減額 | 自動計算: `=B-C` |
| E | 実現難易度 | 管理者入力（高/中/低） |

**条件付き書式**:
- D列（年間削減額）: 金額が大きいほど濃い青のグラデーション

### A.5 出力層（4シート）

#### A.5.1 工事月報レポート

現行「工事月報」シート相当の帳票形式。Apps Scriptがフォーマット済みで出力。

**表示内容**:
- 工事名、施工会社、工期
- 工事価格: 39,840,000円
- 積算価格: 43,430,000円
- 月度別の費目別実績表（経費コード別月別集計から自動転記）
- 工事益 / 工事益率 / 純工事益 / 純工事益率
- PDF出力ボタン（Apps Script連携）

#### A.5.2 支払明細月別レポート

現行「月度別支払い内訳」相当。月度選択で表示を切り替え。

**左テーブル**: 業者別月別集計から該当月をフィルタ表示
**右テーブル**: 相殺処理結果の請求サマリーから該当月を表示

#### A.5.3 経営者ダッシュボード

Google Sheets内のグラフ機能 + Google Sites埋め込み用。

**KPIカード4枚**:
- 工事益率（計算式: `(工事価格 - 工事原価累計) / 工事価格`）
- 純工事益率（計算式: `(工事価格 - 工事原価累計 - 共通仮設費累計) / 工事価格`）
- 予算消化率（計算式: `工事原価累計 / 積算価格`）
- 累計支出（工事原価累計の実数値）

**KPIカード実装方法**:

KPIカード4枚はGoogle Sheetsの専用セル（予実対比シート上部）に計算値を配置し、Google Sitesの「スプレッドシート」ウィジェットでセル範囲を直接埋め込む方式とする。Apps ScriptでHTMLを動的生成する方式は過剰なため採用しない。

| KPIカード | 参照セル | 計算式 | 表示形式 |
|-----------|---------|--------|---------|
| 工事益率 | 予実対比!H1 | `(工事価格 - 工事原価累計) / 工事価格` | パーセント（小数1桁） |
| 純工事益率 | 予実対比!H2 | `(工事価格 - 工事原価累計 - 共通仮設費累計) / 工事価格` | パーセント（小数1桁） |
| 予算消化率 | 予実対比!H3 | `工事原価累計 / 積算価格` | パーセント（小数1桁） |
| 過不足見込み | _C_予算健康度!H4 | `実行予算額 - (累計支払額 / 出来高率)` | 通貨（カンマ区切り、円、+/-符号付き） |

**グラフ3本の設定仕様**:

| グラフ | 種別 | データ範囲 | X軸 | Y軸 | 色 |
|--------|------|-----------|-----|-----|-----|
| 月別支出推移 | 折れ線 | 経費コード別月別集計!E末行:P末行（工事原価行） | 月度（4月-3月） | 金額（円） | 青(#1565C0) |
| 予算vs実績 | 横棒（グループ） | 予実対比!A:D（カテゴリ別集計4行） | カテゴリ名 | 金額（円） | 予算:灰(#9E9E9E) / 実績:青(#1565C0) |
| 予算超過アラート | 条件付き書式テーブル | 予実対比!A:G（消化率降順ソート） | -- | -- | 100%超:赤(#E53935) / 80%超:黄(#FDD835) |

**グラフ個別設定**:

**1. 月別支出推移（折れ線グラフ）**
- データ範囲: 経費コード別月別集計シートの「工事原価」行（E列:P列 = 4月-3月の12ヶ月）
- 系列: 1本（工事原価合計の月次推移）
- X軸ラベル: 月度（4月, 5月, ... 3月）
- Y軸: 金額（円）、カンマ区切り、目盛り自動
- 線の太さ: 2px、マーカー: 丸（直径6px）
- グラフタイトル: 「月別支出推移」
- 背景色: 白(#FFFFFF)

**2. 予算vs実績（横棒グループグラフ）**
- データ範囲: 予実対比シートA:D列（直接工事費/共通仮設費/現場管理費/工事原価の4行）
- 系列2本: 予算額（灰 #9E9E9E）、実績額（青 #1565C0）
- カテゴリ軸: 費目カテゴリ名（縦軸）
- 値軸: 金額（円）、カンマ区切り
- データラベル: 各棒の末端に金額表示
- グラフタイトル: 「予算 vs 実績」

**3. 予算超過アラート（条件付き書式テーブル）**
- データ範囲: 予実対比シートA:G列（経費コード、費目名、カテゴリ、予算額、実績額、消化率、超過額）
- ソート: 消化率の降順
- 条件付き書式:
  - 消化率100%超: 行背景 赤(#E53935)、文字色 白(#FFFFFF)
  - 消化率80%超: 行背景 黄(#FDD835)、文字色 黒(#212121)
  - 消化率80%未満: 背景なし
- Google Sitesへはシート範囲を直接埋め込み（グラフではなくテーブル形式）

#### A.5.4 現場代理人ダッシュボード

**グラフ3本の設定仕様**:

| グラフ | 種別 | データ範囲 | 詳細 |
|--------|------|-----------|------|
| 費目別構成 | 円グラフ | 経費コード別月別集計!A:C,Q（カテゴリ別合計3行） | 直接工事費/共通仮設費/現場管理費の3分割 |
| 業者別支払 | 横棒 | 業者別月別集計!A,累計列（上位10社） | 降順、川越建設が最上位 |
| 月次推移 | 積み上げ棒 | 経費コード別月別集計!E:P（カテゴリ別3行） | 3色積み上げ（直接:青/共通:緑/現場:橙） |

**グラフ個別設定**:

**1. 費目別構成（円グラフ）**
- データ範囲: 経費コード別月別集計シートのカテゴリ小計行（直接工事費計/共通仮設費計/現場管理費計）x Q列（合計列）
- スライス3枚:
  - 直接工事費: 青(#1565C0)
  - 共通仮設費: 緑(#2E7D32)
  - 現場管理費: 橙(#EF6C00)
- データラベル: カテゴリ名 + パーセント + 金額
- グラフタイトル: 「費目別構成比」

**2. 業者別支払（横棒グラフ）**
- データ範囲: 業者別月別集計シートのA列（業者名）と累計列（上位10社を抽出）
- ソート: 累計金額の降順
- 棒色: 青(#1565C0)
- データラベル: 棒末端に金額表示（カンマ区切り）
- グラフタイトル: 「業者別支払額（上位10社）」
- dashboard.gsで上位10社を抽出してダッシュボードシートに転記

**3. 月次推移（積み上げ棒グラフ）**
- データ範囲: 経費コード別月別集計シートのカテゴリ小計行（3行）x E:P列（12ヶ月）
- 系列3本:
  - 直接工事費: 青(#1565C0)
  - 共通仮設費: 緑(#2E7D32)
  - 現場管理費: 橙(#EF6C00)
- X軸: 月度（4月-3月）
- Y軸: 金額（円）、カンマ区切り
- グラフタイトル: 「月次支出推移（費目別）」

#### A.5.5 経営診断グラフ（7本）

経営診断ページ（ページ5-7）で使用するグラフ。データソースは全てA.4.5の経営診断データ層シート群。全グラフ共通で背景色は白(#FFFFFF)。

**グラフ一覧**:

| No. | グラフ名 | 種別 | データシート | 対象ページ |
|-----|---------|------|------------|-----------|
| 1 | 売上高・粗利比較 | グループ棒 | 全社損益 | ページ5 |
| 2 | 受注工事の粗利率 | 横棒 | 今年度受注一覧 | ページ5 |
| 3 | 工事別粗利率ランキング | 横棒 | 工事別比較 | ページ6 |
| 4 | 原価構造比較 | 100%積み上げ棒 | 工事別比較 | ページ6 |
| 5 | 予算消化率 | 横棒 | 工事別比較 | ページ6 |
| 6 | 外注単価格差 | グループ棒 | 外注単価比較+改善効果試算 | ページ7 |
| 7 | 改善効果 | 横棒 | 外注単価比較+改善効果試算 | ページ7 |

**個別設定**:

**1. 売上高・粗利比較（グループ棒グラフ）**
- データ範囲: 全社損益!A1:C3（売上高行 + 粗利行、前年度/今年度の2列）
- 系列2本:
  - 前年度: 灰(#9E9E9E)
  - 今年度: 青(#1565C0)
- カテゴリ軸: 指標名（売上高, 粗利）
- 値軸: 金額（円）、カンマ区切り
- データラベル: 棒上部に金額表示（百万円単位）
- グラフタイトル: 「売上高・粗利 前年度 vs 今年度」

**2. 受注工事の粗利率（横棒グラフ）**
- データ範囲: 今年度受注一覧!C:F（工事名とF列粗利率）
- フィルタ: H列「状態」が「進行中」の工事のみ
- ソート: 粗利率の降順
- 条件付き色分け:
  - 粗利率20%以上: 青(#1565C0)
  - 粗利率15-20%: 橙(#EF6C00)
  - 粗利率15%未満: 赤(#E53935)
- データラベル: 棒末端にパーセント表示
- グラフタイトル: 「今年度 工事別粗利率」

**3. 工事別粗利率ランキング（横棒グラフ）**
- データ範囲: 工事別比較!B:E（工事名とE列粗利率）
- ソート: 粗利率の降順
- 条件付き色分け:
  - 粗利率20%以上: 青(#1565C0)
  - 粗利率15-20%: 橙(#EF6C00)
  - 粗利率15%未満: 赤(#E53935)
- データラベル: 棒末端にパーセント表示
- グラフタイトル: 「工事別粗利率ランキング」

**4. 原価構造比較（100%積み上げ棒グラフ）**
- データ範囲: 工事別比較!B:H（工事名とG:H列の費率）
- 系列3本:
  - 外注費率: 青(#1565C0)
  - 材料費率: 緑(#2E7D32)
  - その他（100% - 外注費率 - 材料費率）: 灰(#9E9E9E)
- カテゴリ軸: 工事名（縦軸）
- 値軸: 0-100%
- データラベル: 各セグメント内にパーセント表示（10%未満は非表示）
- グラフタイトル: 「原価構造比較（工事別）」

**5. 予算消化率（横棒グラフ）**
- データ範囲: 工事別比較!B:F（工事名とF列予算消化率）
- ソート: 予算消化率の降順
- 条件付き色分け:
  - 予算消化率70%未満: 青(#1565C0)（正常）
  - 予算消化率70-90%: 黄(#FDD835)（警告）
  - 予算消化率90%以上: 赤(#E53935)（超過リスク）
- データラベル: 棒末端にパーセント表示
- グラフタイトル: 「予算消化状況（全工事）」

**6. 外注単価格差（グループ棒グラフ）**
- データ範囲: 外注単価比較+改善効果試算!A1:E（外注単価比較テーブル）
- 系列2本:
  - 最安単価: 青(#1565C0)
  - 最高単価: 赤(#E53935)
- カテゴリ軸: 工種名（縦軸）
- 値軸: 単価（円/単位）
- データラベル: 棒上部に金額表示 + 所長名
- 注釈: 各工種の格差倍率を表示
- グラフタイトル: 「外注単価: 同じ工種でもこんなに違う」

**7. 改善効果（横棒グラフ）**
- データ範囲: 外注単価比較+改善効果試算!A10:D（改善効果試算テーブル）
- 棒色: 青(#1565C0)
- カテゴリ軸: 改善項目名（縦軸）
- 値軸: 金額（円）、カンマ区切り
- データラベル: 棒末端に年間削減額を表示
- グラフタイトル: 「標準単価に揃えたらいくら浮く？」

### A.6 データバリデーション一覧

| シート | 列 | ルール | エラーメッセージ |
|--------|-----|------|----------------|
| 支払明細入力 | A(月度) | 正規表現 `^\d{4}-(0[1-9]\|1[0-2])$` | 「YYYY-MM形式で入力してください」 |
| 支払明細入力 | B(支払先) | 業者マスターB列の値リスト | 「登録済みの業者名を選択してください」 |
| 支払明細入力 | C(経費項目) | 経費コードマスターC列の値リスト | 「経費項目は必須です」 |
| 支払明細入力 | D(税抜金額) | 整数 > 0 | 「正の整数を入力してください」 |
| 支払明細入力 | E(相殺額) | 0 <= 値 <= D列の値 | 「相殺額は支払金額以下にしてください」 |
| 支払明細入力 | F(相殺先) | E > 0 の場合: 業者マスターB列の値リスト | 「相殺先業者を選択してください」 |
| 支払明細入力 | G(摘要) | 最大50文字、制御文字禁止 | 「摘要は50文字以内で入力してください」 |
| 予算設定 | D(予算額) | 整数 > 0 | 「正の整数を入力してください」 |
| 月次調整 | B(機械名) | 機械マスターB列の値リスト | 「登録済みの機械を選択してください」 |
| 月次調整 | C(稼働数量) | 数値 >= 0 | 「0以上の数値を入力してください」 |

### A.7 Google Sites 構成

#### A.7.1 ページ一覧

**サイト名**: 森組 工事管理 & 経営診断

| ページ | セクション | 内容 | 埋め込み元 | 更新頻度 |
|--------|-----------|------|-----------|---------|
| 1. トップページ（3秒ダッシュボード） | 工事予実管理 | 信号表示 + KPIカード4枚（4枚目は過不足見込み）+ 赤信号件数 | 経営者ダッシュボード | 日次（06:00自動更新） |
| 2. 経営分析 | 工事予実管理 | 月別推移グラフ + 予算vs実績グラフ + 予実対比テーブル + 予算超過詳細 | 経営者ダッシュボード | 日次（06:00自動更新） |
| 3. 現場管理 | 工事予実管理 | 費目別円グラフ + 業者別棒グラフ + 月次推移 | 現場代理人ダッシュボード | 日次（06:00自動更新） |
| 4. AIチャット | 工事予実管理 | Difyチャットボット2本（iframe） | Dify Cloud | リアルタイム |
| 5. 全社経営概況 | 経営診断 | 前年度vs今年度の損益比較 + 今年度受注工事の粗利率 | 経営診断データ層 | 自動集計（日次） + 手動（年1回損益入力） |
| 6. 工事別パフォーマンス | 経営診断 | 今年度進行中工事の粗利率・原価構造・予算消化率 + 所長別まとめ | 経営診断データ層 | 自動集計（日次） |
| 7. コスト改善の見える化 | 経営診断 | 外注単価格差 + 標準単価に揃えた場合の削減効果 | 経営診断データ層 | 自動集計（日次） + 手動（目標設定） |

**ナビゲーション構造**:

```
Google Sites: 森組 工事管理 & 経営診断
|
+-- [工事予実管理]（セクション区切り）
|   +-- Page 1: トップページ（KPI + アラート + 月別推移）
|   +-- Page 2: 経営分析（予算vs実績）
|   +-- Page 3: 現場管理（費目・業者・推移）
|   +-- Page 4: AIチャット（Dify）
|
+-- [経営診断]（セクション区切り）
    +-- Page 5: 全社経営概況（前年度 vs 今年度）
    +-- Page 6: 工事別パフォーマンス（今年度の進行中工事）
    +-- Page 7: コスト改善の見える化（単価比較 + 改善効果）
```

#### A.7.2 ページ1: トップページ（3秒ダッシュボード）

```
+--[海潟漁港海岸 工事予実管理 -- 3秒ダッシュボード]--------------+
|                                                                |
|  +===[信号表示]==============================================+ |
|  |  [赤/三角] 2件の予算超過あり（クリックで詳細 -> page2）    | |
|  +==========================================================+ |
|                                                                |
|  +----------+ +----------+ +----------+ +-----------+          |
|  | 工事益率 | | 純工事益 | | 予算消化 | | 過不足   |          |
|  |  58.3%   | |   率     | |   率     | | +○○万円   |          |
|  |          | |  46.7%   | |  38.2%   | | (見込み) |          |
|  +----------+ +----------+ +----------+ +-----------+          |
|  <-- Sheets埋め込み: 予実対比!H1:K4 セル範囲 -->               |
|                                                                |
|  [赤信号の件数のみ表示、詳細はpage2で確認]                      |
|                                                                |
+----------------------------------------------------------------+
```

**埋め込み要素**:

| 要素 | 埋め込み方法 | ソース |
|------|------------|--------|
| 信号表示 | Sitesの「スプレッドシート」ウィジェット | 経営者ダッシュボード!信号セル（条件付き書式で色+アイコン） |
| KPIカード4枚（4枚目は過不足見込み） | Sitesの「スプレッドシート」ウィジェット | _C_予算健康度!H1:K4（セル範囲） |
| 予算超過件数 | Sitesの「スプレッドシート」ウィジェット | 経営者ダッシュボード!アラート件数セル |

#### A.7.3 ページ2: 経営分析（月別推移 + 予算vs実績）

```
+--[予算と実績]--------------------------------------------------+
|                                                                |
|  +--[月別支出推移（page1から移動）]-------------------------+  |
|  |          /\                                               |  |
|  |         /  \    /\                                        |  |
|  |   /\  /    \  /  \                                        |  |
|  |  /  \/      \/    \                                       |  |
|  | 4月 5月 6月 7月 8月 9月 ...                               |  |
|  +----------------------------------------------------------+  |
|  <-- Sheets埋め込み: 経営者ダッシュボードの折れ線グラフ -->     |
|                                                                |
|  +--[予算超過アラート（詳細）]-------------------------------+  |
|  | [赤/四角] 法定福利費  -- +26.2% 「超過」                  |  |
|  | [赤/四角] 保険料      -- +13.7% 「超過」                  |  |
|  | [黄/三角] 動力用水光熱費 -- +13.0% 「注意」               |  |
|  +----------------------------------------------------------+  |
|                                                                |
|  +--[予算 vs 実績]------------------------------------------+  |
|  | 工事原価      ||||||||||||||||||||||||  / |||||||||||      |  |
|  | 現場管理費    |||||||||||  / ||||||                        |  |
|  | 共通仮設費    |||||  / ||||                                |  |
|  | 直接工事費    ||||||||||||||||||  / |||||||||              |  |
|  |              灰=予算  /  青=実績                           |  |
|  +----------------------------------------------------------+  |
|  <-- Sheets埋め込み: 経営者ダッシュボードの横棒グラフ -->       |
|                                                                |
|  +--[予実対比 詳細テーブル]---------------------------------+  |
|  | 経費コード | 費目名 | カテゴリ | 予算額 | 実績額 | 消化率 | |
|  |    11      | 労務費 | 直接工事 | ...    | ...    | ...    | |
|  |    12      | 材料費 | 直接工事 | ...    | ...    | ...    | |
|  |    ...     | ...    | ...      | ...    | ...    | ...    | |
|  +----------------------------------------------------------+  |
|  <-- Sheets埋め込み: 予実対比シート全体 -->                    |
|                                                                |
+----------------------------------------------------------------+
```

**埋め込み要素**:

| 要素 | 埋め込み方法 | ソース |
|------|------------|--------|
| 月別支出推移グラフ | Sitesの「スプレッドシートのグラフ」ウィジェット | 経営者ダッシュボードシートの折れ線グラフ |
| 予算超過アラート詳細 | Sitesの「スプレッドシート」ウィジェット | 予実対比!A:G（条件付き書式+アイコン付きテーブル） |
| 予算vs実績グラフ | Sitesの「スプレッドシートのグラフ」ウィジェット | 経営者ダッシュボードシートの横棒グラフ |
| 予実対比テーブル | Sitesの「スプレッドシート」ウィジェット | 予実対比シート全体 |

#### A.7.4 ページ3: 現場管理

```
+--[現場データ]--------------------------------------------------+
|                                                                |
|  +--[費目別構成]--------+  +--[業者別支払(上位10社)]--------+  |
|  |       __             |  | 川越建設     ||||||||||||||||  |  |
|  |     /    \  直接工事費|  | 濱畑水道     |||||||||||      |  |
|  |    | 青   | (65%)    |  | 桜島生コン   |||||||||        |  |
|  |    |     /  共通仮設  |  | ...          ||||             |  |
|  |     \__/ 緑 (6%)     |  +--------------------------------+  |
|  |      橙 現場管理(29%)|  <-- Sheets: 横棒グラフ -->          |
|  +----------------------+                                      |
|  <-- Sheets: 円グラフ -->                                      |
|                                                                |
|  +--[月次支出推移（費目別）]--------------------------------+  |
|  |  [橙]  現場管理費                                        |  |
|  |  [緑]  共通仮設費                                        |  |
|  |  [青]  直接工事費                                        |  |
|  |  |||   |||   |||   |||   |||                              |  |
|  |  4月   5月   6月   7月   8月  ...                         |  |
|  +----------------------------------------------------------+  |
|  <-- Sheets: 積み上げ棒グラフ -->                               |
|                                                                |
|  +--------------------+  +--------------------+                |
|  | [入力画面を開く]   |  | [月次報告書を出力] |                |
|  +--------------------+  +--------------------+                |
|  <-- Sitesボタン: Sheetsへのリンク / report.gs呼出し -->        |
|                                                                |
+----------------------------------------------------------------+
```

**埋め込み要素**:

| 要素 | 埋め込み方法 | ソース |
|------|------------|--------|
| 費目別構成 | Sitesの「スプレッドシートのグラフ」ウィジェット | 現場代理人ダッシュボードシートの円グラフ |
| 業者別支払 | Sitesの「スプレッドシートのグラフ」ウィジェット | 現場代理人ダッシュボードシートの横棒グラフ |
| 月次推移 | Sitesの「スプレッドシートのグラフ」ウィジェット | 現場代理人ダッシュボードシートの積み上げ棒グラフ |
| 入力画面リンク | Sitesの「ボタン」ウィジェット | Google Sheetsの支払明細入力シートURL |
| 月次報告書出力 | Sitesの「ボタン」ウィジェット | GAS Web App URL（mode=report） |

#### A.7.5 ページ4: AIチャット

```
+--[AI分析]------------------------------------------------------+
|                                                                |
|  +--[データ分析アシスタント]--------------------------------+  |
|  |                                                          |  |
|  |  「今月の直接工事費の内訳を教えて」                       |  |
|  |                                                          |  |
|  |  直接工事費の内訳は以下のとおりです:                      |  |
|  |  - 外注費: 5,316,667円（48.7%）                          |  |
|  |  - 材料費: 2,108,370円（19.3%）                          |  |
|  |  ...                                                     |  |
|  |                                                          |  |
|  |  [メッセージを入力...]                                   |  |
|  +----------------------------------------------------------+  |
|  <-- iframe: width:100%, height:600px -->                       |
|                                                                |
|  +--[改善提案アシスタント]----------------------------------+  |
|  |                                                          |  |
|  |  「コスト削減の余地がある費目を教えて」                   |  |
|  |                                                          |  |
|  |  分析の結果、以下の費目にコスト削減の余地があります:      |  |
|  |  1. 仮設材料費: 消化率が80%に達しており...                |  |
|  |  ...                                                     |  |
|  |                                                          |  |
|  |  [メッセージを入力...]                                   |  |
|  +----------------------------------------------------------+  |
|  <-- iframe: width:100%, height:600px -->                       |
|                                                                |
+----------------------------------------------------------------+
```

**埋め込み要素**:

| 要素 | 埋め込み方法 | ソース |
|------|------------|--------|
| データ分析チャットボット | Sitesの「HTMLを埋め込む」ウィジェット | Dify Cloud iframe（チャットボット1） |
| 改善提案チャットボット | Sitesの「HTMLを埋め込む」ウィジェット | Dify Cloud iframe（チャットボット2） |

**iframe埋め込みコード**:

```html
<!-- データ分析アシスタント -->
<iframe
  src="https://udify.app/chatbot/{DATA_ANALYSIS_APP_ID}"
  style="width: 100%; height: 600px; border: none;"
  allow="clipboard-write"
></iframe>

<!-- 改善提案アシスタント -->
<iframe
  src="https://udify.app/chatbot/{IMPROVEMENT_APP_ID}"
  style="width: 100%; height: 600px; border: none;"
  allow="clipboard-write"
></iframe>
```

#### A.7.6 ページ5: 全社経営概況（前年度 vs 今年度）

社長が開いた瞬間に「去年と比べて今年はどうか」が分かるページ。KPIカード4枚で増減を一目表示し、その下にグラフ2本で詳細を補足する。

```
+--[全社経営概況: 前年度 vs 今年度]-------------------------------+
|                                                                |
|  [売上高]          [粗利率]        [営業利益]    [受注工事数]    |
|  ¥XXX M           XX.X%           ¥XX M         X件            |
|  前年比 +X.X%     前年比 +X.Xpt   前年比 +X%   前年比 +X件    |
|  (増減に応じて青または赤)                                       |
|  <-- Sheets埋め込み: 全社損益!A:E セル範囲 -->                   |
|                                                                |
|  +--[売上高・粗利 前年度vs今年度]------------------------------+|
|  |  前年度  [売上 ||||||||] [粗利 ||]                          ||
|  |  今年度  [売上 ||||||||||] [粗利 |||]                       ||
|  +------------------------------------------------------------+|
|  <-- Sheets埋め込み: 経営診断グラフNo.1 売上高・粗利比較 -->     |
|                                                                |
|  +--[今年度 工事別粗利率]--------------------------------------+|
|  |  工事A  25.6%  ||||||||||||||||||||||||||||                  ||
|  |  工事B  15.4%  |||||||||||||||                               ||
|  |  工事C  14.0%  ||||||||||||||  <-- 赤（基準以下）            ||
|  +------------------------------------------------------------+|
|  <-- Sheets埋め込み: 経営診断グラフNo.2 受注工事の粗利率 -->     |
|                                                                |
+----------------------------------------------------------------+
```

**埋め込み要素**:

| 要素 | 埋め込み方法 | ソース |
|------|------------|--------|
| KPIカード4枚（売上高/粗利率/営業利益/受注工事数） | Sitesの「スプレッドシート」ウィジェット | 全社損益!A:E（セル範囲指定、条件付き書式で増減を青/赤表示） |
| 売上高・粗利比較グラフ | Sitesの「スプレッドシートのグラフ」ウィジェット | 経営診断グラフNo.1（全社損益シート） |
| 受注工事の粗利率グラフ | Sitesの「スプレッドシートのグラフ」ウィジェット | 経営診断グラフNo.2（今年度受注一覧シート） |

**KPIカードの条件付き書式**:
- 増減が正（改善）: 青(#1565C0)文字 + 上向き矢印記号
- 増減が負（悪化）: 赤(#E53935)文字 + 下向き矢印記号
- 営業利益と粗利率は「増加=改善」、売上原価と販管費は「減少=改善」で判定

#### A.7.7 ページ6: 工事別パフォーマンス（今年度の進行中工事）

今年度の各工事がどんな状態か、所長ごとの傾向が一覧で分かるページ。データは全てGAS APIによる自動集計で手入力不要。

```
+--[工事別パフォーマンス: 今年度]----------------------------------+
|                                                                  |
|  +--[粗利率ランキング]--------+  +--[原価構造の違い]----------+  |
|  | 工事A  25.6% |||||||||||||| |  | 工事A [外注99%]            |  |
|  | 工事B  15.4% ||||||||       |  | 工事B [外注62/材料38]      |  |
|  | 工事C  14.0% |||||||  [赤]  |  | 工事C [外注38/材料30/他]   |  |
|  +-----------------------------+  +----------------------------+  |
|  <-- Sheets: グラフNo.3 -->       <-- Sheets: グラフNo.4 -->      |
|                                                                  |
|  +--[予算消化状況（全工事）]---------------------------------+   |
|  | 工事A  予算消化 47.5%  [青] |||||||||||                    |   |
|  | 工事B  予算消化 72.3%  [黄] ||||||||||||||||||             |   |
|  | 工事C  予算消化 95.1%  [赤] ||||||||||||||||||||||||||     |   |
|  +-----------------------------------------------------------+   |
|  <-- Sheets埋め込み: 経営診断グラフNo.5 予算消化率 -->            |
|                                                                  |
|  +--[所長別まとめ]-------------------------------------------+   |
|  | 所長名 | 担当数 | 平均粗利率 | 特徴                        |   |
|  | 池田   |  X件   |  XX.X%    | 外注中心、高利益率          |   |
|  | 上村   |  X件   |  XX.X%    | 材料+労務型、予算注意        |   |
|  +-----------------------------------------------------------+   |
|  <-- Sheets埋め込み: 工事別比較シートの所長別集約テーブル -->     |
|                                                                  |
+------------------------------------------------------------------+
```

**埋め込み要素**:

| 要素 | 埋め込み方法 | ソース |
|------|------------|--------|
| 粗利率ランキンググラフ | Sitesの「スプレッドシートのグラフ」ウィジェット | 経営診断グラフNo.3（工事別比較シート） |
| 原価構造比較グラフ | Sitesの「スプレッドシートのグラフ」ウィジェット | 経営診断グラフNo.4（工事別比較シート） |
| 予算消化率グラフ | Sitesの「スプレッドシートのグラフ」ウィジェット | 経営診断グラフNo.5（工事別比較シート） |
| 所長別まとめテーブル | Sitesの「スプレッドシート」ウィジェット | 工事別比較シートの所長別集約テーブル（A20起点） |

#### A.7.8 ページ7: コスト改善の見える化

「同じ工種でも所長によって外注単価がこれだけ違う」を可視化し、改善余地を金額で示すページ。

```
+--[コスト改善の見える化]------------------------------------------+
|                                                                  |
|  +--[外注単価: 同じ工種でもこんなに違う]-----------------------+ |
|  |  掘削工:    最安 ¥505/m3（池田）  vs 最高 ¥850/m3（中原）  | |
|  |             格差 1.68倍                                      | |
|  |  土砂運搬:  最安 ¥844/m3（池田）  vs 最高 ¥1,500/m3（中原） | |
|  |             格差 1.78倍                                      | |
|  +-------------------------------------------------------------+ |
|  <-- Sheets埋め込み: 経営診断グラフNo.6 外注単価格差 -->          |
|                                                                  |
|  +--[標準単価に揃えたらいくら浮く？]---------------------------+ |
|  |  外注単価の標準化    |========= ¥XX M/年 =========|         | |
|  |  その他の改善        |=== ¥XX M ===|                         | |
|  |  合計               |============ ¥XX M/年 ============|    | |
|  +-------------------------------------------------------------+ |
|  <-- Sheets埋め込み: 経営診断グラフNo.7 改善効果 -->              |
|                                                                  |
+------------------------------------------------------------------+
```

**埋め込み要素**:

| 要素 | 埋め込み方法 | ソース |
|------|------------|--------|
| 外注単価格差グラフ | Sitesの「スプレッドシートのグラフ」ウィジェット | 経営診断グラフNo.6（外注単価比較+改善効果試算シート） |
| 改善効果グラフ | Sitesの「スプレッドシートのグラフ」ウィジェット | 経営診断グラフNo.7（外注単価比較+改善効果試算シート） |

#### A.7.9 埋め込み方法まとめ

Google Sitesへの埋め込みは3つの方法を使い分ける:

| 埋め込み対象 | 方法 | 手順 |
|-------------|------|------|
| Sheetsのグラフ | 「スプレッドシートのグラフ」ウィジェット | Sheetsでグラフを作成 -> Sitesの挿入メニューから選択 -> グラフを指定 |
| Sheetsのセル範囲 | 「スプレッドシート」ウィジェット | Sitesの挿入メニューからスプレッドシートを選択 -> 表示範囲を指定 |
| Difyチャットボット | 「HTMLを埋め込む」ウィジェット | Dify Cloudで「公開」-> 埋め込みコードをコピー -> Sitesに貼り付け |

**グラフ自動更新の仕組み**:
- Google Sheetsのグラフは、参照元データが更新されると自動的にグラフも更新される
- Google Sitesに埋め込んだグラフも、Sheetsのデータ更新に連動して自動反映される
- dashboard.gsがdailyAggregationトリガー（毎日06:00）でダッシュボードシートのデータを更新すると、Sites上のグラフも自動で最新化される
- 手動でSitesを編集・再公開する必要はない

**アクセス制御**: Google Workspaceの組織内共有。URLを知っている全社員が閲覧可能。

#### A.7.10 シート保護の詳細設計

スプレッドシートのシート保護は3段階で設定する。2段階入力（SITE-02）に対応した列レベル保護を含む。

**シートレベル保護**:

| シート層 | 保護レベル | 編集可能ユーザー |
|---------|-----------|----------------|
| 入力層（3シート） | 列レベル保護（下記参照） | 所長 + 事務員（列ごとに制限） |
| マスター層（4シート） | 管理者のみ | システム管理者 |
| 計算層（4シート） | スクリプトのみ | Apps Scriptの実行アカウントのみ |
| 出力層（4シート） | スクリプトのみ | Apps Scriptの実行アカウントのみ |

**支払明細入力シートの列レベル保護（2段階入力対応）**:

| 列 | 内容 | 編集権限 | セル色 |
|----|------|---------|--------|
| A-E列 | 年月/費目/業者名/摘要/税抜金額 | 所長 | 緑（#E8F5E9） |
| F-G列 | 相殺額/相殺先 | 事務員（所長も可） | 青（#E3F2FD） |
| H-J列 | 消費税/税込金額/登録日時 | 編集不可（自動計算） | 灰色（#EEEEEE） |

**保護設定の実装方法**:
- Google Sheets の「データ > シートと範囲を保護」機能を使用
- 列レベル保護はProtection.setRange()で列単位の範囲を指定
- Apps Scriptの実行アカウントは保護から除外（setDomainEdit(false) + addEditor()）

---

## 付録B: Apps Script 設計書

**注意（2026-02-19改訂）**: 本付録は初期設計（10スクリプト構成）の記述が残っています。Phase A実装で7ファイル構成に統合されました。最新のファイル構成は**付録E.6**を参照してください。以下は参考として残しています。

| 旧スクリプト | 統合先 | 備考 |
|------------|--------|------|
| main.gs | config.gs | エントリーポイントをconfig.gsのメニューに統合 |
| validation.gs | validation_extended.gs | カスケードDD/予算箱ID解決を追加 |
| offset.gs | aggregation.gs | 相殺処理を集計処理に統合 |
| budget.gs | budget_health.gs | 予実管理（消化率/出来高率/信号判定）に拡張 |
| report.gs | （未実装） | Phase B以降で実装予定 |
| dashboard.gs | （未実装） | Google Sites直接埋め込みに変更 |
| notification.gs | config.gs | 入力期限通知をconfig.gsに統合 |

### B.1 ファイル構成（初期設計 -- 参考）

```
プロジェクトルート/（初期設計: 実装では7ファイルに統合済み、付録E.6参照）
├── main.gs              // → config.gsに統合
├── validation.gs        // → validation_extended.gsに統合
├── aggregation.gs       // 月別自動集計・累計計算
├── offset.gs            // → aggregation.gsに統合
├── budget.gs            // → budget_health.gsに統合
├── report.gs            // 月報自動生成・PDF出力（未実装）
├── dashboard.gs         // → Google Sites直接埋め込みに変更（未実装）
├── api.gs               // Web API（Dify連携用）
├── notification.gs      // → config.gsに統合
└── config.gs            // 定数・設定値
```

### B.2 トリガー設計

| トリガー種別 | 関数名 | 発火条件 | 処理内容 |
|------------|--------|---------|---------|
| onEdit | `onEditHandler` | 支払明細入力シートの編集時 | バリデーション実行 + 消費税/税込自動計算 + 登録日時記入 |
| onChange | `onChangeHandler` | シート構造変更時 | データ整合性チェック |
| 時刻トリガー（日次） | `dailyAggregation` | 毎日 06:00 | 計算層4シートの全再計算 |
| 時刻トリガー（月次） | `monthlyReport` | 毎月1日 09:00 | 月次報告書PDF生成 + メール配信 |
| HTTP（doGet/doPost） | `doGet` / `doPost` | Difyからのリクエスト | データ取得API |

### B.3 関数仕様

#### B.3.1 入力バリデーション（validation.gs）

```javascript
/**
 * onEdit時に発火するバリデーション
 * 対象: 支払明細入力シートのA-G列
 */
function validatePaymentEntry(e) {
  // 編集されたシートが「支払明細入力」でなければ終了
  // 編集された列に応じてバリデーション実行:
  //   A列(月度): YYYY-MM形式チェック
  //   B列(支払先): 業者マスター存在チェック
  //   C列(経費項目): 経費コードマスター存在チェック、空欄不可
  //   D列(税抜金額): 正の整数チェック
  //   E列(相殺額): 0以上かつD列以下チェック
  //   F列(相殺先): E>0の場合に業者マスター存在チェック
  //   G列(摘要): 最大50文字制限、制御文字の除去
  // バリデーションエラー時: セル背景を赤(#FFCDD2)、コメントでエラーメッセージ
  // バリデーション成功時: セル背景を緑(#E8F5E9)、コメント削除
}

/**
 * テキストフィールドのサニタイズ
 * 制御文字（改行・タブ・ヌル文字等）を除去し、最大長を制限する
 * @param {string} text - 入力テキスト
 * @param {number} maxLength - 最大文字数（デフォルト50）
 * @return {string} サニタイズ済みテキスト
 */
function sanitizeText(text, maxLength) {
  maxLength = maxLength || 50;
  // 制御文字を除去（U+0000-U+001F, U+007F-U+009F）
  var cleaned = String(text).replace(/[\x00-\x1F\x7F-\x9F]/g, '');
  return cleaned.substring(0, maxLength);
}

/**
 * 自動計算列の更新
 * D列またはE列の編集時に発火
 */
function updateCalculatedColumns(row) {
  // H列(消費税) = ROUND((D - E) * 0.1, 0)
  // I列(税込金額) = (D - E) + H
  // J列(登録日時) = new Date()
  // 相殺がある場合(E > 0): H列とI列は相殺控除後の金額で計算
}
```

#### B.3.2 月別自動集計（aggregation.gs）

```javascript
/**
 * 経費コード別月別集計シートを再生成
 * トリガー: dailyAggregation (毎日06:00)
 */
function generateExpenseByCodeMonthly() {
  // 0. 冒頭でスナップショット取得（集計中のデータ変更を防ぐ）
  //    var sheet = ss.getSheetByName(CONFIG.SHEET_PAYMENT_INPUT);
  //    var snapshot = sheet.getDataRange().getValues();
  //    以降の処理はsnapshotを参照する（シートを直接読まない）
  // 1. 支払明細入力シートの全データを取得（snapshotから）
  // 2. 経費コード x 月度 でクロス集計（SUMIFS相当）
  //    集計キー: C列(経費項目コード) x A列(月度)
  //    集計値: D列(税抜金額) - E列(相殺額) = 純支払額
  // 3. 経費コードマスターの順序で行を生成
  // 4. 小計行を挿入:
  //    - 直接工事費計(10) = SUM(11,12,13,14,15)
  //    - 共通仮設費計(30) = SUM(31-39)
  //    - 純工事費(40) = 10 + 30
  //    - 現場管理費計(50) = SUM(51-60)
  //    - 工事原価 = 40 + 50
  // 5. 合計列 = 各行の月度合計
  // 6. 消化率 = 合計 / 予算額
  // 7. 計算層「経費コード別月別集計」シートに書き込み
}

/**
 * 業者別月別集計シートを再生成
 */
function generateExpenseByVendorMonthly() {
  // 1. 支払明細入力シートの全データを取得
  // 2. 業者名 x 月度 でクロス集計
  //    税抜合計と相殺合計を別列で集計
  // 3. 業者マスターの順序で行を生成
  // 4. 請求サマリー列を計算:
  //    - 純支払額 = 税抜合計 - 相殺合計
  //    - 税込金額 = ROUND(純支払額 * 1.1, 0)
  // 5. 計算層「業者別月別集計」シートに書き込み
}

/**
 * 累計計算
 * 各月の値に前月までの累計を加算
 */
function calculateCumulative(monthlyData) {
  // 月度を昇順ソート
  // 各経費コードについて:
  //   cumulative[month] = cumulative[month-1] + monthly[month]
  // 返り値: {コード: {月度: 累計値}}
}
```

#### B.3.3 相殺自動処理（offset.gs）

```javascript
/**
 * 相殺処理結果シートを再生成
 */
function generateOffsetResults() {
  // 1. 支払明細入力シートからE列(相殺額) > 0 の行を抽出
  // 2. 相殺元業者(B列) x 相殺先業者(F列) x 月度(A列) でグループ化
  // 3. 明細セクションに書き込み:
  //    [相殺元, 相殺先, 月度, 相殺額, 累計相殺額]
  // 4. 請求サマリーセクションを生成:
  //    各業者について:
  //      請求金額 = 業者別月別集計の税抜合計
  //      相殺合計 = 当該業者が相殺先となっている合計
  //      支払額(税抜) = 請求金額 - 相殺合計
  //      支払額(税込) = ROUND(支払額(税抜) * 1.1, 0)
}
```

#### B.3.4 予算超過アラート（budget.gs）

```javascript
/**
 * 予算消化率チェック + アラート送信
 * トリガー: dailyAggregation内で呼び出し
 */
function checkBudgetAlerts() {
  // 1. 予実対比シートから全経費コードの消化率を取得
  // 2. 閾値判定:
  //    - 100%超過: severity = "critical"、背景色 #FFCDD2(赤)
  //    -  80%超過: severity = "warning"、背景色 #FFF9C4(黄)
  //    -  80%未満: severity = "normal"、背景色なし
  // 3. 前回チェック時と比較し、新たに閾値を超えた費目があれば通知
  // 4. critical: Google Chat + メール送信
  //    warning: メール送信のみ
}

/**
 * アラートメール送信
 */
function sendBudgetAlertEmail(alerts) {
  // 宛先: config.gsで定義された通知先メールアドレス
  // 件名: 「[予算超過アラート] {工事名} - {費目名}」
  // 本文: 費目名、予算額、累計実績、消化率、超過額
}
```

#### B.3.5 月報自動生成（report.gs）

```javascript
/**
 * 月次報告書PDF生成
 * トリガー: monthlyReport (毎月1日 09:00)
 */
function generateMonthlyReportPDF() {
  // 1. 出力層「工事月報レポート」シートを最新データで更新
  // 2. 出力層「支払明細月別レポート」シートを前月データで更新
  // 3. 両シートをPDF変換
  //    SpreadsheetApp.getActiveSpreadsheet().getAs('application/pdf')
  // 4. Google Driveの指定フォルダに保存
  //    ファイル名: 「工事月報_{工事名}_{YYYY年MM月度}.pdf」
  // 5. メールでPDFを添付配信
  //    宛先: config.gsで定義された配信先
  //    件名: 「[月次報告書] {工事名} {YYYY年MM月度}」
}
```

#### B.3.6 Web API -- Dify連携用（api.gs）

```javascript
/**
 * GAS Web App エンドポイント
 * DifyのHTTP Requestノードから呼び出される
 *
 * デプロイ設定:
 *   - 実行ユーザー: スクリプト所有者
 *   - アクセス: 全員（URLを知っている人）
 *   - URL: https://script.google.com/macros/s/{DEPLOYMENT_ID}/exec
 *
 * API認証:
 *   - APIキーをリクエストパラメータ（api_key）で送信
 *   - APIキーはGASのPropertiesServiceに格納
 *     PropertiesService.getScriptProperties().setProperty('API_KEY', 'xxx')
 *   - 認証失敗時は401エラーレスポンスを返す
 */

/**
 * APIキー認証
 * @param {Object} e - リクエストパラメータ
 * @return {boolean} 認証成功ならtrue
 */
function authenticateApiKey(e) {
  var providedKey = e.parameter.api_key || '';
  var storedKey = PropertiesService.getScriptProperties().getProperty('API_KEY');
  return providedKey === storedKey;
}

/**
 * 認証失敗レスポンス生成
 * @return {TextOutput} 401エラーJSON
 */
function createUnauthorizedResponse() {
  return ContentService.createTextOutput(
    JSON.stringify({error: 'Unauthorized', message: 'APIキーが無効です', status: 401})
  ).setMimeType(ContentService.MimeType.JSON);
}

/**
 * GET リクエストハンドラ
 * @param {Object} e - リクエストパラメータ
 *   e.parameter.api_key: APIキー（必須）
 *   e.parameter.mode: 取得モード
 *     "summary"    - 工事全体のサマリー指標
 *     "monthly"    - 月別集計データ
 *     "vendor"     - 業者別集計データ
 *     "budget"     - 予実対比データ
 *     "offset"     - 相殺処理状況
 *     "alerts"     - 予算超過アラート一覧
 *     "detail"     - 支払明細（フィルタ可能）
 *     "master"     - マスタデータ取得（CSV動的読み込み、ハードコードなし）
 *   e.parameter.type: マスタ種別（vendor/expense_code/machine/labor。mode=master時に使用）
 *   e.parameter.month: 対象月度（YYYY-MM形式、省略時は全期間）
 *   e.parameter.code: 経費コード（省略時は全コード）
 *   e.parameter.vendor: 業者名（省略時は全業者）
 * @return {TextOutput} JSON形式のレスポンス
 */
function doGet(e) {
  // APIキー認証
  if (!authenticateApiKey(e)) {
    return createUnauthorizedResponse();
  }

  var mode = e.parameter.mode || "summary";
  var result = {};

  switch(mode) {
    case "summary":
      result = getSummaryData();
      break;
    case "monthly":
      result = getMonthlyData(e.parameter.month, e.parameter.code);
      break;
    case "vendor":
      result = getVendorData(e.parameter.month, e.parameter.vendor);
      break;
    case "budget":
      result = getBudgetData(e.parameter.code);
      break;
    case "offset":
      result = getOffsetData(e.parameter.month);
      break;
    case "alerts":
      result = getAlertData();
      break;
    case "detail":
      result = getDetailData(e.parameter.month, e.parameter.code, e.parameter.vendor);
      break;
    case "master":
      result = getMasterData(e.parameter.type);
      break;
  }

  // テキストフィールドのサニタイズ（制御文字除去）
  // api.gsでもレスポンス生成前にサニタイズを実施
  result = sanitizeResponseText(result);

  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}

/**
 * レスポンスオブジェクト内のテキストフィールドから制御文字を除去
 * @param {Object} obj - レスポンスオブジェクト
 * @return {Object} サニタイズ済みオブジェクト
 */
function sanitizeResponseText(obj) {
  if (typeof obj === 'string') {
    return obj.replace(/[\x00-\x1F\x7F-\x9F]/g, '');
  }
  if (Array.isArray(obj)) {
    return obj.map(sanitizeResponseText);
  }
  if (obj && typeof obj === 'object') {
    var cleaned = {};
    for (var key in obj) {
      if (obj.hasOwnProperty(key)) {
        cleaned[key] = sanitizeResponseText(obj[key]);
      }
    }
    return cleaned;
  }
  return obj;
}

/**
 * 工事サマリー取得
 * @return {Object} 主要KPI
 */
function getSummaryData() {
  return {
    construction_price: 39840000,       // 工事価格
    estimated_price: 43430000,          // 積算価格
    cumulative_cost: /* 計算層から取得 */,
    profit: /* 工事価格 - 累計支出 */,
    profit_rate: /* profit / 工事価格 */,
    net_profit: /* 純工事益 */,
    net_profit_rate: /* 純工事益率 */,
    budget_consumption_rate: /* 累計支出 / 積算価格 */,
    total_offset: /* 相殺合計 */,
    transaction_count: /* 支払明細の行数 */,
    months_covered: /* 入力済み月度のリスト */,
    alerts: /* 予算超過アラート配列 */
  };
}

/**
 * 月別集計取得
 * @return {Array} 経費コード別月別の配列
 */
function getMonthlyData(month, code) {
  // 経費コード別月別集計シートからデータ取得
  // month指定時: 該当月のみフィルタ
  // code指定時: 該当コードのみフィルタ
  // 返り値: [{code, name, category, month, amount, cumulative}, ...]
}

/**
 * 業者別集計取得
 * @return {Array} 業者別月別の配列
 */
function getVendorData(month, vendor) {
  // 業者別月別集計シートからデータ取得
  // 返り値: [{vendor, month, gross_amount, offset_amount, net_amount, tax_included}, ...]
}

/**
 * マスタデータ取得
 * マスタシートからCSV動的読み込み（ハードコードフォールバックは使用しない）
 * @param {string} type - マスタ種別（vendor/expense_code/machine/labor）
 * @return {Array} マスタデータの配列
 */
function getMasterData(type) {
  // マスタシートからgetDataRange().getValues()で動的に読み込む
  // ハードコードされたフォールバック値は使用しない（削除方針）
  // シートが存在しない場合はエラーレスポンスを返す
  var sheetName = {
    'vendor': CONFIG.SHEET_VENDOR_MASTER,
    'expense_code': CONFIG.SHEET_EXPENSE_CODE,
    'machine': CONFIG.SHEET_MACHINE_MASTER,
    'labor': CONFIG.SHEET_LABOR_MASTER
  }[type];
  if (!sheetName) return {error: '不明なマスタ種別: ' + type};
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
  if (!sheet) return {error: 'シート未検出: ' + sheetName};
  var data = sheet.getDataRange().getValues();
  // ヘッダー行を含む全データを返却
  return {type: type, data: data};
}
```

#### B.3.7 ダッシュボード更新（dashboard.gs）

```javascript
/**
 * 経営者ダッシュボード更新
 * KPIセルと出力層シートを最新データで更新
 *
 * 呼び出し元: dailyAggregation（毎日06:00）の最終ステップ
 * 依存: aggregation.gs、budget.gsの処理完了後に実行
 */
function updateExecutiveDashboard() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var budgetActual = ss.getSheetByName(CONFIG.SHEET_BUDGET_ACTUAL);
  var dashboard = ss.getSheetByName("経営者ダッシュボード");

  // 1. KPI4値を予実対比シートから取得
  var cumulativeCost = budgetActual.getRange("実績合計セル").getValue();
  var constructionPrice = CONFIG.CONSTRUCTION_PRICE;
  var estimatedPrice = CONFIG.ESTIMATED_PRICE;

  // 共通仮設費累計を経費コード別月別集計から取得
  var expenseMonthly = ss.getSheetByName(CONFIG.SHEET_EXPENSE_MONTHLY);
  // 共通仮設費計(30)行の合計列を参照
  var commonTempCost = /* 共通仮設費計行のQ列（合計）*/;

  // 2. KPIセルに書き込み
  dashboard.getRange("H1").setValue(
    (constructionPrice - cumulativeCost) / constructionPrice  // 工事益率
  );
  dashboard.getRange("H2").setValue(
    (constructionPrice - cumulativeCost - commonTempCost) / constructionPrice  // 純工事益率
  );
  dashboard.getRange("H3").setValue(
    cumulativeCost / estimatedPrice  // 予算消化率
  );
  dashboard.getRange("H4").setValue(cumulativeCost);  // 累計支出

  // 3. グラフのデータ範囲を更新（月度が増えた場合）
  //    経費コード別月別集計の列数を確認し、
  //    折れ線グラフのデータ範囲を最新月まで拡張
  var charts = dashboard.getCharts();
  for (var i = 0; i < charts.length; i++) {
    var chart = charts[i];
    // グラフのデータ範囲を現在のデータ列数に合わせて更新
    // EmbeddedChartBuilder.modifyで範囲を再設定
  }

  // 4. 予算超過アラートテーブルを消化率降順で再ソート
  //    予実対比シートのA:G列を消化率（F列）の降順でソートし、
  //    ダッシュボードシートのアラート領域に転記
  var alertData = budgetActual.getRange("A:G").getValues();
  // 消化率列でソート（降順）
  alertData.sort(function(a, b) { return b[5] - a[5]; });
  // ダッシュボードのアラート領域に書き込み
}

/**
 * 現場代理人ダッシュボード更新
 *
 * 呼び出し元: dailyAggregation（毎日06:00）の最終ステップ
 * 依存: aggregation.gsの処理完了後に実行
 */
function updateSiteManagerDashboard() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var expenseMonthly = ss.getSheetByName(CONFIG.SHEET_EXPENSE_MONTHLY);
  var vendorMonthly = ss.getSheetByName(CONFIG.SHEET_VENDOR_MONTHLY);
  var dashboard = ss.getSheetByName("現場代理人ダッシュボード");

  // 1. 業者別集計の上位10社を抽出
  var vendorData = vendorMonthly.getDataRange().getValues();
  var header = vendorData.shift();
  // 累計列（最終列）でソート（降順）
  var cumulativeCol = header.length - 1;
  vendorData.sort(function(a, b) { return b[cumulativeCol] - a[cumulativeCol]; });
  var top10 = vendorData.slice(0, 10);

  // 2. 費目別カテゴリ合計を算出
  //    経費コード別月別集計から小計行を取得:
  //    - 直接工事費計(10): 合計列の値
  //    - 共通仮設費計(30): 合計列の値
  //    - 現場管理費計(50): 合計列の値
  var expenseData = expenseMonthly.getDataRange().getValues();
  var categoryTotals = [];
  for (var i = 0; i < expenseData.length; i++) {
    var code = String(expenseData[i][0]);
    if (code === "10" || code === "30" || code === "50") {
      categoryTotals.push(expenseData[i]);
    }
  }

  // 3. 現場代理人ダッシュボードシートに書き込み
  //    業者別上位10社の領域に転記
  var vendorRange = dashboard.getRange("A20:B29");  // 業者別グラフ用データ領域
  for (var j = 0; j < top10.length; j++) {
    vendorRange.getCell(j + 1, 1).setValue(top10[j][0]);  // 業者名
    vendorRange.getCell(j + 1, 2).setValue(top10[j][cumulativeCol]);  // 累計金額
  }

  //    カテゴリ別合計の領域に転記（円グラフ用）
  //    月別カテゴリ推移の領域に転記（積み上げ棒グラフ用）

  // 4. グラフのデータ範囲を更新（月度が増えた場合）
  var charts = dashboard.getCharts();
  for (var k = 0; k < charts.length; k++) {
    var chart = charts[k];
    // グラフのデータ範囲を現在のデータ列数に合わせて更新
  }
}
```

**dailyAggregationトリガーとの統合**:

dailyAggregation（main.gs内）の処理フローにおいて、dashboard.gsの2関数は最終ステップとして実行される:

```javascript
// main.gs 内の dailyAggregation 関数（抜粋）
function dailyAggregation() {
  // Step 1: 経費コード別月別集計を再生成
  generateExpenseByCodeMonthly();
  // Step 2: 業者別月別集計を再生成
  generateExpenseByVendorMonthly();
  // Step 3: 相殺処理結果を再生成
  generateOffsetResults();
  // Step 4: 予実対比を再計算
  checkBudgetAlerts();
  // Step 5: ダッシュボード更新（追加）
  updateExecutiveDashboard();
  updateSiteManagerDashboard();
}
```

### B.4 データフロー

```
[入力]                    [処理]                      [出力]

支払明細入力  --onEdit-->  validation.gs               エラー表示 or 自動計算
     |                         |
     |                         v
     +------dailyAggregation-->  aggregation.gs  -----> 経費コード別月別集計
     |                         |                -----> 業者別月別集計
     |                         v
     +---------------------->  offset.gs         -----> 相殺処理結果
     |                         |
     |                         v
予算設定 ------------------->  budget.gs         -----> 予実対比
     |                         |                -----> アラートメール
     |                         v
     +------monthlyReport--->  report.gs         -----> PDF月次報告書
     |                         |                -----> 配信メール
     |                         v
     +---------------------->  dashboard.gs      -----> 経営者ダッシュボード
                               |                -----> 現場代理人ダッシュボード
                               v
                           api.gs (doGet)  <--------- Dify HTTP Request
                               |
                               v
                           JSON レスポンス  ---------> Dify LLMノード
```

### B.5 設定値（config.gs）

```javascript
var CONFIG = {
  // 工事基本情報
  CONSTRUCTION_NAME: "海潟漁港海岸海岸保全施設整備連携工事(R7-1工区)",
  COMPANY_NAME: "(株)森組",
  CONSTRUCTION_PRICE: 39840000,
  ESTIMATED_PRICE: 43430000,

  // シート名定数
  SHEET_PAYMENT_INPUT: "支払明細入力",
  SHEET_BUDGET: "予算設定",
  SHEET_MONTHLY_ADJ: "月次調整",
  SHEET_VENDOR_MASTER: "業者マスター",
  SHEET_EXPENSE_CODE: "経費コードマスター",
  SHEET_MACHINE_MASTER: "機械マスター",
  SHEET_LABOR_MASTER: "労務単価マスター",
  SHEET_EXPENSE_MONTHLY: "経費コード別月別集計",
  SHEET_VENDOR_MONTHLY: "業者別月別集計",
  SHEET_OFFSET_RESULT: "相殺処理結果",
  SHEET_BUDGET_ACTUAL: "予実対比",

  // アラート閾値
  ALERT_WARNING_THRESHOLD: 0.8,     // 80%
  ALERT_CRITICAL_THRESHOLD: 1.0,    // 100%

  // 通知設定
  NOTIFICATION_EMAILS: ["owner@example.com"],
  GOOGLE_CHAT_WEBHOOK: "https://chat.googleapis.com/v1/spaces/.../messages?key=...",

  // PDF保存先
  REPORT_FOLDER_ID: "Google DriveのフォルダID",

  // 消費税率
  TAX_RATE: 0.1,

  // 入力期限通知（SITE-01）
  INPUT_DEADLINE_DAY: 15,           // 毎月15日までに前月分入力
  INPUT_DEADLINE_NOTIFY_TO: ["site-manager@example.com"],

  // API認証（SEC-01）
  // APIキーはPropertiesServiceに格納（コードにハードコードしない）
  // PropertiesService.getScriptProperties().setProperty('API_KEY', '...')

  // 摘要欄の最大文字数（SEC-04）
  MEMO_MAX_LENGTH: 50
};
```

---

## 付録C: Dify ワークフロー設計書

### C.1 全体構成

2つのチャットボットを構築する。いずれもDify Cloud上のChatbot（チャットフロー）として実装。

| No. | チャットボット名 | 種別 | 用途 |
|-----|----------------|------|------|
| 1 | 工事データ分析アシスタント | Chatflow | 数値の照会・分析 |
| 2 | コスト改善提案アシスタント | Chatflow | 改善策の提案 |

**共通のデータ取得方式**:

```
ユーザー質問
    |
    v
[Question Classifier] -- 質問を分類
    |
    v
[HTTP Request] -- GAS Web App からデータ取得
    |               URL: https://script.google.com/macros/s/{ID}/exec?mode=xxx
    v
[LLM] -- データを分析して回答生成
    |
    v
回答表示
```

### C.2 チャットボット1: 工事データ分析アシスタント

#### C.2.1 ワークフロー構成

```
Start('1000000001')
  |
  v
Question Classifier('1000000002')
  |
  +--[class-1: 全体サマリー]--> HTTP Request('1000000003') ?mode=summary
  |                                    |
  |                                    v
  |                              LLM('1000000007') --> End('1000000011')
  |
  +--[class-2: 月別分析]------> HTTP Request('1000000004') ?mode=monthly
  |                                    |
  |                                    v
  |                              LLM('1000000008') --> End('1000000011')
  |
  +--[class-3: 業者別分析]----> HTTP Request('1000000005') ?mode=vendor
  |                                    |
  |                                    v
  |                              LLM('1000000009') --> End('1000000011')
  |
  +--[class-4: 予算/相殺]----> HTTP Request('1000000006') ?mode=budget
                                       |
                                       v
                                 LLM('1000000010') --> End('1000000011')
```

**ノード数**: 11ノード（Start 1 + QuestionClassifier 1 + HTTP Request 4 + LLM 4 + End 1）

#### C.2.2 ノード仕様

**Start ノード（'1000000001'）**:

```yaml
- data:
    desc: 'ユーザーからの質問を受け付ける'
    selected: false
    title: 開始
    type: start
    variables: []
  id: '1000000001'
  position: {x: 80, y: 282}
```

**conversation_opener（サジェストボタン）設定**:

```yaml
opening_statement: '工事データについて質問できます。下のボタンから選ぶか、自由に質問してください。'
suggested_questions:
  - '今月の利益率は?'
  - '予算超過している費目は?'
  - '支払いが多い業者は?'
  - 'コスト削減の提案'
```

**Question Classifier ノード（'1000000002'）**:

```yaml
- data:
    classes:
    - id: 'class-summary'
      name: '全体サマリー・利益率・工事概要'
    - id: 'class-monthly'
      name: '月別分析・推移・特定月の詳細'
    - id: 'class-vendor'
      name: '業者別分析・支払先・取引先'
    - id: 'class-budget'
      name: '予算・消化率・相殺・アラート'
    desc: 'ユーザーの質問を4カテゴリに分類'
    instructions: |
      建設工事の予実管理データについての質問を分類してください。

      - 全体サマリー: 利益率、工事益、工事概要、全体状況に関する質問
      - 月別分析: 特定月の数値、月ごとの推移、前月比較に関する質問
      - 業者別分析: 特定業者への支払い、業者ランキング、取引先に関する質問
      - 予算・相殺: 予算消化率、予算残、予算超過、相殺処理に関する質問
    model:
      completion_params:
        temperature: 0.3
      mode: chat
      name: gpt-4o-mini
      provider: openai
    query_variable_selector:
    - '1000000001'
    - sys.query
    title: 質問分類
    type: question-classifier
  id: '1000000002'
  position: {x: 380, y: 282}
```

**HTTP Request ノード（'1000000003' -- サマリー取得例）**:

```yaml
- data:
    authorization:
      config: null
      type: no-auth
    body:
      data: ''
      type: none
    desc: 'GAS Web Appから工事サマリーデータを取得'
    headers: ''
    method: get
    params: 'mode:summary'
    retry_config:
      max_retries: 3
      retry_enabled: true
      retry_interval: 100
    selected: false
    ssl_verify: true
    timeout:
      connect: 60
      read: 60
      write: 60
    title: サマリーデータ取得
    type: http-request
    url: '{{#env.gas_webapp_url#}}?mode=summary&api_key={{#env.gas_api_key#}}'
    variables: []
  id: '1000000003'
  position: {x: 680, y: 82}
```

他の3つのHTTP Requestノードも同構造。`mode`パラメータのみ異なる（全てapi_keyを付与）:
- `'1000000004'`: `?mode=monthly&api_key={{#env.gas_api_key#}}`
- `'1000000005'`: `?mode=vendor&api_key={{#env.gas_api_key#}}`
- `'1000000006'`: `?mode=budget&api_key={{#env.gas_api_key#}}`

#### C.2.3 プロンプト設計

**LLM ノード（'1000000007' -- サマリー分析）**:

```yaml
- data:
    context:
      enabled: false
      variable_selector: []
    desc: 'サマリーデータを分析して回答生成'
    edition_type: basic
    model:
      completion_params:
        temperature: 0.5
      mode: chat
      name: gpt-4o
      provider: openai
    prompt_template:
    - id: 'sys-summary-001'
      role: system
      text: |
        あなたは建設工事の予実管理データを分析する専門アシスタントです。

        ## 対象工事
        - 工事名: 海潟漁港海岸海岸保全施設整備連携工事(R7-1工区)
        - 施工会社: (株)森組
        - 工事価格: 39,840,000円
        - 積算価格: 43,430,000円

        ## 回答ルール
        - 金額はカンマ区切りで表示（例: 39,840,000円）
        - パーセントは小数第1位まで表示（例: 58.9%）
        - 必ず表形式で数値を整理して提示すること
        - 分析コメントを1-2文で添えること
        - 経営判断に役立つ示唆を含めること
        - 回答末尾に関連する追加質問を2つ提案すること（「--」で始める）

        ## 注意
        - データにない情報は推測しないこと
        - 「データがありません」と正直に回答すること
    - id: 'user-summary-001'
      role: user
      text: |
        以下の工事データに基づいて、ユーザーの質問に回答してください。

        ## 取得データ
        {{#1000000003.body#}}

        ## ユーザーの質問
        {{#1000000001.sys.query#}}
    structured_output_enabled: false
    title: サマリー分析
    type: llm
    variables: []
    vision:
      enabled: false
  id: '1000000007'
  position: {x: 980, y: 82}
```

**LLM ノード（'1000000008' -- 月別分析）のsystemプロンプト差分**:

```
（共通部分は同一）

## 追加ルール（月別分析用）
- 月ごとの推移を比較する場合は増減額と増減率を両方示すこと
- 季節変動の可能性がある場合はその旨をコメントすること
- 累計値と単月値を明確に区別して表示すること
```

**LLM ノード（'1000000009' -- 業者別分析）のsystemプロンプト差分**:

```
（共通部分は同一）

## 追加ルール（業者別分析用）
- 業者名は正式名称で表示すること
- 支払額の多い順（降順）で表示すること
- 全体に占めるシェア（%）を併記すること
- 相殺処理がある業者はその旨を注記すること
```

**LLM ノード（'1000000010' -- 予算/相殺分析）のsystemプロンプト差分**:

```
（共通部分は同一）

## 追加ルール（予算・相殺分析用）
- 予算超過費目は赤色相当の表記 [超過] で示すこと
- 消化率80%超の費目は黄色相当の表記 [注意] で示すこと
- 相殺データは相殺元・相殺先・金額を明確に表示すること
- 予算残額がマイナスの場合は「予算超過」と明記すること
```

#### C.2.4 Edge定義

```yaml
edges:
# Start -> Question Classifier
- data:
    isInIteration: false
    isInLoop: false
    sourceType: start
    targetType: question-classifier
  id: edge-001
  source: '1000000001'
  sourceHandle: source
  target: '1000000002'
  targetHandle: target
  type: custom
  zIndex: 0

# Question Classifier -> HTTP Request (サマリー)
- data:
    isInIteration: false
    isInLoop: false
    sourceType: question-classifier
    targetType: http-request
  id: edge-002
  source: '1000000002'
  sourceHandle: 'class-summary'
  target: '1000000003'
  targetHandle: target
  type: custom
  zIndex: 0

# Question Classifier -> HTTP Request (月別)
- data:
    isInIteration: false
    isInLoop: false
    sourceType: question-classifier
    targetType: http-request
  id: edge-003
  source: '1000000002'
  sourceHandle: 'class-monthly'
  target: '1000000004'
  targetHandle: target
  type: custom
  zIndex: 0

# Question Classifier -> HTTP Request (業者別)
- data:
    isInIteration: false
    isInLoop: false
    sourceType: question-classifier
    targetType: http-request
  id: edge-004
  source: '1000000002'
  sourceHandle: 'class-vendor'
  target: '1000000005'
  targetHandle: target
  type: custom
  zIndex: 0

# Question Classifier -> HTTP Request (予算/相殺)
- data:
    isInIteration: false
    isInLoop: false
    sourceType: question-classifier
    targetType: http-request
  id: edge-005
  source: '1000000002'
  sourceHandle: 'class-budget'
  target: '1000000006'
  targetHandle: target
  type: custom
  zIndex: 0

# HTTP Request -> LLM (各4本)
# edge-006: '1000000003' -> '1000000007'
# edge-007: '1000000004' -> '1000000008'
# edge-008: '1000000005' -> '1000000009'
# edge-009: '1000000006' -> '1000000010'
# (sourceType: http-request, targetType: llm)

# LLM -> End (各4本)
# edge-010: '1000000007' -> '1000000011'
# edge-011: '1000000008' -> '1000000011'
# edge-012: '1000000009' -> '1000000011'
# edge-013: '1000000010' -> '1000000011'
# (sourceType: llm, targetType: end)
```

### C.3 チャットボット2: コスト改善提案アシスタント

#### C.3.1 ワークフロー構成

```
Start('2000000001')
  |
  v
HTTP Request('2000000002') ?mode=summary  -- 全体サマリー取得
  |
  v
HTTP Request('2000000003') ?mode=budget   -- 予実対比取得
  |
  v
HTTP Request('2000000004') ?mode=alerts   -- アラート取得
  |
  v
LLM('2000000005') -- 全データを統合して改善提案を生成
  |
  v
End('2000000006')
```

**ノード数**: 6ノード（Start 1 + HTTP Request 3 + LLM 1 + End 1）

**設計意図**: 改善提案は質問分類不要。常に全データを取得し、LLMが総合的に分析して提案する。

#### C.3.2 ノード仕様

**HTTP Request 3連続**（全てapi_keyを付与）:
- `'2000000002'`: `?mode=summary&api_key={{#env.gas_api_key#}}` -- 工事価格、利益率等
- `'2000000003'`: `?mode=budget&api_key={{#env.gas_api_key#}}` -- 経費コード別の予算消化率
- `'2000000004'`: `?mode=alerts&api_key={{#env.gas_api_key#}}` -- 予算超過アラート + 業者別支払上位

#### C.3.3 プロンプト設計

**LLM ノード（'2000000005'）**:

```yaml
prompt_template:
- id: 'sys-improve-001'
  role: system
  text: |
    あなたは建設工事のコスト管理コンサルタントです。
    工事の予実データを分析し、具体的な改善提案を行います。

    ## 対象工事
    - 工事名: 海潟漁港海岸海岸保全施設整備連携工事(R7-1工区)
    - 施工会社: (株)森組
    - 工事価格: 39,840,000円

    ## 提案のルール
    - 必ず「優先度: 高/中/低」を付けること
    - 各提案に「対象」「効果」「手順」の3要素を含めること
    - 効果は可能な限り金額で示すこと
    - 建設業の実務に即した実現可能な提案に限ること
    - 最大5件の提案に絞ること（優先度順）

    ## 分析の観点
    1. 予算超過費目の原因分析と対策
    2. 支払上位業者の単価適正性
    3. 相殺処理の効率化余地
    4. 季節変動・工期進捗との整合性
    5. キャッシュフロー改善余地

    ## 注意
    - データにない情報は推測しないこと
    - 推測する場合は「推測」と明記すること
    - 工期や契約条件を勝手に変更する提案はしないこと

    ## 建設業特有の配慮事項
    - 建設業の下請関係は長期的信頼に基づく。単純な価格比較や取引先分散の提案は避けること
    - 同一業者との単価推移や工事間の単価差に注目し、交渉材料となる分析を提供すること
    - 「安い業者に変える」ではなく「同じ業者との取引条件を最適化する」視点で提案すること

- id: 'user-improve-001'
  role: user
  text: |
    以下の工事データに基づいて、ユーザーの質問に回答してください。

    ## 工事サマリー
    {{#2000000002.body#}}

    ## 予実対比データ
    {{#2000000003.body#}}

    ## アラート情報
    {{#2000000004.body#}}

    ## ユーザーの質問
    {{#2000000001.sys.query#}}
```

### C.4 環境変数

Dify Cloudの環境変数設定:

| 変数名 | 値 | 用途 |
|--------|-----|------|
| `gas_webapp_url` | `https://script.google.com/macros/s/{DEPLOYMENT_ID}/exec` | GAS Web APIのベースURL |
| `gas_api_key` | GASのPropertiesServiceに格納したAPIキーと同一値 | API認証用（SEC-01） |

### C.5 Dify DSL 共通設定

```yaml
version: 0.1.2
kind: app
type: chatflow

# モデル設定
model_config:
  model:
    name: gpt-4o
    provider: openai
  # Question ClassifierのみコストモデルとしてGPT-4o-mini
```

### C.6 機密データの取り扱い方針

DifyチャットボットはDify Cloud（外部SaaS）にデータを送信する。以下の対策を講じる。

**1. Dify Cloudのデータ保持ポリシー確認**
- Dify Cloudのプライバシーポリシー・データ保持期間を確認し、提案時に顧客に明示する
- 会話ログの保存期間と削除方針を確認する

**2. 業者マスターのID化検討**
- Difyに送信するデータで業者名を伏せる場合、業者マスターIDで送信する
  - 例: 「川越建設」-> 「V001」、「(有)濱畑水道」-> 「V002」
- LLMのプロンプトにID-名称の対応表を含めることで、回答時は名称で表示可能
- ただし利便性とのトレードオフがあるため、顧客と協議して決定する

**3. 顧客への事前承認取得**
- 「社外クラウドサービス（Dify Cloud）へ工事データの一部が送信される」ことを提案書に明記する
- 送信されるデータの範囲（金額データ・業者名・費目名等）を具体的にリスト化する
- 顧客の情報セキュリティポリシーに抵触しないか事前確認を行う
- 書面での承認を取得してからDifyチャットボット機能を有効化する

### C.7 Google Sites への埋め込み

Dify CloudのチャットボットをGoogle Sitesに埋め込む方法:

```html
<!-- Google Sitesの「埋め込み」 > 「HTMLコード」で以下を挿入 -->
<iframe
  src="https://udify.app/chatbot/{APP_ID}"
  style="width: 100%; height: 600px; border: none;"
  allow="clipboard-write"
></iframe>
```

2つのチャットボットをGoogle Sitesの別ページまたはタブで提供:
- 「データ分析」ページ: チャットボット1を埋め込み
- 「改善提案」ページ: チャットボット2を埋め込み

---

## 付録D: 実装チェックリスト

### D.1 第1段階（入力シート + マスターデータ）

- [ ] Google Spreadsheet新規作成
- [ ] マスター層4シート作成（業者/経費コード/機械/労務単価）
- [ ] マスターデータ投入（業者約20社、経費コード28+4項目、機械11種、労務2職種）
- [ ] 入力層3シート作成（支払明細/予算/月次調整）
- [ ] ドロップダウンリスト設定（業者マスター連動、経費コード連動）
- [ ] セル書式設定（緑=入力、灰色=自動計算、数値書式カンマ区切り）
- [ ] セル保護設定（自動計算列の編集禁止）
- [ ] validation.gs実装（onEditトリガー）
- [ ] 自動計算列の実装（消費税、税込金額、登録日時）
- [ ] 既存82取引のデータ移行（JSON -> CSV -> Sheets）
- [ ] 検証: 10月10,933,337円 / 11月8,458,604円 / 12月4,332,077円

### D.2 第2段階（自動集計 + 予算チェック）

- [ ] aggregation.gs実装（経費コード別月別集計、業者別月別集計）
- [ ] offset.gs実装（相殺処理結果の自動生成）
- [ ] budget.gs実装（予実対比、消化率計算）
- [ ] 計算層4シート自動生成の動作確認
- [ ] 時刻トリガー設定（dailyAggregation: 毎日06:00）
- [ ] 予算超過アラート実装（80%/100%閾値）
- [ ] notification.gs実装（メール送信、Google Chat Webhook）
- [ ] 検証: 直接工事費10,789,631円 / 共通仮設費907,661円 / 現場管理費3,095,040円
- [ ] 検証: 相殺合計6,831,286円

### D.3 第3段階（AIチャットボット）

- [ ] api.gs実装（doGet関数、7つのmodeに対応）
- [ ] GAS Web Appデプロイ（全員アクセス許可）
- [ ] APIエンドポイントの動作テスト（各modeのJSONレスポンス確認）
- [ ] Dify Cloud環境変数設定（gas_webapp_url）
- [ ] チャットボット1（データ分析）のDSL作成・インポート
- [ ] チャットボット1の動作テスト（第4章の会話例6パターンで検証）
- [ ] チャットボット2（改善提案）のDSL作成・インポート
- [ ] チャットボット2の動作テスト
- [ ] プロンプトチューニング（回答精度の調整）

### D.4 第4段階（ダッシュボード + 通知）

- [ ] 出力層4シート作成（工事月報/支払明細/経営者/現場代理人ダッシュボード）
- [ ] dashboard.gs実装（グラフ自動更新）
- [ ] report.gs実装（PDF生成 + メール配信）
- [ ] 月次トリガー設定（monthlyReport: 毎月1日09:00）
- [ ] Google Sites作成（トップ/経営分析/現場管理/AIチャットの4ページ）
- [ ] Difyチャットボットの埋め込み（iframe）
- [ ] アクセス権限設定（組織内共有）
- [ ] スマートフォン表示の動作確認

### D.5 第5段階（テスト運用）

- [ ] 既存Excelとの並行運用開始
- [ ] 1ヶ月分の実データで全機能を通し検証
- [ ] 所長による入力テスト（操作性確認）
- [ ] 社長によるダッシュボード確認
- [ ] AIチャットボットの回答精度確認
- [ ] 自動通知の受信確認（メール、Google Chat）
- [ ] PDF月次報告書の内容確認
- [ ] 問題点の修正
- [ ] 既存Excelからの完全移行判定

---

**本設計書に関するご質問がございましたら、お気軽にお問い合わせください。**

---

## 付録E: マスタ体系・予実管理設計書（完全版）

**作成日**: 2026年2月18日
**改訂日**: 2026年2月19日（EVM→予実管理への全面転換）
**対象**: (株)森組 工事予実管理システム — インプット設計 v2.0

**設計方針の転換**: 当初はEVM（Earned Value Management: SPI/CPI/EAC/VAC）を採用予定だったが、4千万円規模の工事には過剰と判断し、**予実管理ベース（消化率 vs 出来高率）に転換**した。以下のE.3-E.6は転換後の設計を記載する。

---

### E.1 マスタ体系（ID管理で名称揺れ防止）

#### E.1.1 費目カテゴリマスタ（固定3項目）

工事原価を3区分で管理する。本システムの管理範囲は工事原価のみ（一般管理費はスコープ外）。

| カテゴリID | 名称 | 略称 | 管理方式 |
|-----------|------|------|---------|
| C01 | 直接工事費 | 直工 | 工種別管理（4階層） |
| C02 | 共通仮設費 | 共仮 | 費目項目のみ（工種なし） |
| C03 | 現場管理費 | 現管 | 費目項目のみ（工種なし） |

#### E.1.2 工事種別マスタ（大工種、W-コード — 12項目）

C01（直接工事費）にのみ適用。C02/C03は工事種別不要。管理者が随時追加可能。

| 工事種別ID | 名称 | 国交省区分との対応 | 森組での主な工事 |
|-----------|------|-------------------|----------------|
| W01 | 土工事 | 河川工事（土工部分）、道路改良工事 | 全工事 |
| W02 | コンクリート工事 | 河川・道路構造物工事 | 砂防, 港湾 |
| W03 | 仮設工事 | 共通仮設（直接仮設） | 全工事 |
| W04 | 護岸・海岸工事 | 海岸工事, 護岸工 | 港湾 |
| W05 | 砂防・治山工事 | 砂防・地すべり等工事 | 砂防 |
| W06 | 舗装工事 | 舗装工事 | 林道 |
| W07 | 法面工事 | 道路改良工事（法面部分） | 林道, 砂防 |
| W08 | 林道・農林道工事 | 治山林道工事 | 林道 |
| W09 | 基礎工事 | 構造物基礎, 地盤改良 | 砂防, 港湾 |
| W10 | 撤去工事 | 既設物撤去, 構造物撤去 | 全工事（一部） |
| W11 | 排水工事 | 函渠工, 側溝工, 排水工 | 全工事 |
| W99 | その他直接工事 | 上記に分類されない直接工事 | 適宜 |

#### E.1.3 工種マスタ（中工種、K-コード — 35項目）

有効フラグ付き。管理者が随時追加・無効化可能。

| 工種ID | 名称 | 親工事種別 | 使用可能費用要素 |
|--------|------|-----------|----------------|
| K0101 | 掘削工 | W01 | E11 E12 E13 E14 E15 |
| K0102 | 盛土工 | W01 | E11 E12 E13 E14 E15 |
| K0103 | 除石工 | W01 | E12 E13 E14 |
| K0104 | 浚渫工 | W01 | E12 E13 E14 |
| K0105 | 場内運搬工 | W01 | E12 E13 E14 |
| K0201 | コンクリート工 | W02 | E11 E12 E13 E14 E15 |
| K0202 | 型枠工 | W02 | E11 E14 E15 |
| K0203 | 鉄筋工 | W02 | E11 E14 E15 |
| K0204 | 均しコンクリート工 | W02 | E11 E14 E15 |
| K0205 | 基礎割栗石工 | W02 | E11 E12 E14 |
| K0301 | 足場工 | W03 | E11 E12 E14 |
| K0302 | 仮囲工 | W03 | E11 E14 |
| K0303 | 工事用道路工 | W03 | E11 E12 E14 |
| K0401 | 護岸工 | W04 | E11 E12 E14 |
| K0402 | 消波根固工 | W04 | E11 E14 |
| K0403 | 根固工 | W04 | E11 E14 |
| K0501 | 砂防ダム工（堰堤工） | W05 | E11 E12 E14 |
| K0502 | 流路工 | W05 | E11 E12 E14 |
| K0503 | 床止工 | W05 | E11 E12 E14 |
| K0504 | 山腹工 | W05 | E11 E14 E15 |
| K0505 | 落石防止工 | W05 | E11 E14 |
| K0601 | アスファルト舗装工 | W06 | E11 E12 E14 |
| K0602 | 路盤工 | W06 | E11 E12 E14 |
| K0701 | 法面保護工 | W07 | E11 E12 E14 E15 |
| K0702 | 法面整形工 | W07 | E12 E13 E14 |
| K0801 | 路体工 | W08 | E11 E12 E14 |
| K0802 | 路面工 | W08 | E11 E12 E14 |
| K0803 | 排水路工（林道） | W08 | E11 E14 |
| K0901 | 地盤改良工 | W09 | E11 E12 E14 |
| K0902 | 杭工 | W09 | E11 E12 E14 |
| K1001 | 構造物撤去工 | W10 | E12 E13 E14 |
| K1002 | 舗装撤去工 | W10 | E12 E14 |
| K1101 | 管渠工（排水工） | W11 | E11 E12 E14 |
| K1102 | 側溝工 | W11 | E11 E14 |
| K9901 | 測量丁張工 | W99 | E14 E15 |

#### E.1.4 費用要素マスタ（別軸、直接工事費のみ — 5項目固定）

工種とは独立した別軸。会計処理用の区分。

| 要素ID | 名称 | 説明 | 発注先の例 |
|--------|------|------|-----------|
| E11 | 材料費 | 構造物本体となる材料 | 商社、資材メーカー |
| E12 | 機械経費 | 機械賃借料（外部調達） | リース会社 |
| E13 | 機械経費（損料） | 自社保有機械の損料 | 自社機材 |
| E14 | 外注費 | 協力会社への一式発注 | 下請業者 |
| E15 | 労務費 | 直接雇用作業員の賃金 | 直用作業員 |

#### E.1.5 費目項目マスタ（共通仮設費・現場管理費 -- 26項目固定）

実行予算工種別体系（図2-2）準拠。工種とは独立した軸。

**共通仮設費（C02） -- 9項目（図2-2の7項目 + 森組独自2項目）:**

| 費目ID | 名称 | 図2-2対応 | 備考 |
|--------|------|----------|------|
| F31 | 運搬費 | 運搬工事 | |
| F32 | 調査・準備費 | 調査・準備工事 | |
| F33 | 仮設建物費 | 仮設建物工事 | 現場事務所・倉庫等の仮設建物 |
| F34 | 公害防止対策費 | 公害防止対策工事 | 騒音・振動・水質汚濁等の対策 |
| F35 | 安全対策費 | 安全対策工事 | |
| F36 | 水道光熱費 | 水道・光熱工事 | |
| F37 | 産業廃棄物処理費 | 産業廃棄物処理工 | |
| F38 | 役務費 | -- | 森組独自項目 |
| F39 | 営繕費 | -- | 森組独自項目 |

**現場管理費（C03） -- 17項目（図2-2準拠、森組実績なしの任意項目は除外）:**

| 費目ID | 名称 | 図2-2対応 | 備考 |
|--------|------|----------|------|
| F51 | 労務管理費 | 労務管理費 | |
| F52 | 法定福利費 | 法定福利費 | |
| F53 | 租税公課 | 租税公課 | |
| F54 | 地代家賃 | 地代家賃 | 事務所用地・駐車場 |
| F55 | 保険料 | 保険料 | |
| F56 | 従業員給料手当 | 従業員給料手当 | |
| F57 | 従業員賞与 | 従業員賞与 | |
| F58 | 従業員退職金 | 従業員退職金 | |
| F59 | 福利厚生費 | 福利厚生費 | |
| F60 | 事務用品費 | 事務用品費 | |
| F61 | 旅費・交通費・通信費 | 旅費・交通費・通信費 | |
| F62 | 補償費 | (補償費) | 森組実績あり（図2-2任意項目） |
| F63 | 設計費 | (設計費) | 図2-2任意項目（設計施工一体の場合のみ） |
| F64 | 交際費 | (交際費) | 森組実績あり（図2-2任意項目） |
| F65 | 保証料 | 保証料 | |
| F66 | 会議費・諸会費 | 会議費・諸会費 | |
| F67 | 雑費 | 雑費 | |

---

### E.2 予算箱ID体系（包含管理対応）

予算箱ID（BudgetBoxID）は複合キーで構成される。包含（パッケージ）登録に対応。

```
直接工事費（4要素の複合キー）:
  カテゴリID - 工事種別ID - 工種ID - 要素ID
  例: C01-W02-K0201-E14 = 直接工事費 > コンクリート工事 > コンクリート工 > 外注費

包含（工種省略）:
  C01-W02-E14 = コンクリート工事全体として外注費を管理

包含（工事種別も省略）:
  C01-E14 = 直接工事費の外注費全体でまとめて管理

共通仮設費（2要素の複合キー）:
  C02-F33 = 共通仮設費 > 仮設建物費

現場管理費（2要素の複合キー）:
  C03-F52 = 現場管理費 > 法定福利費
```

**包含管理のルール**:
- 工種を省略したパッケージ登録も可能（段階的な高度化に対応）
- GASが入力時に「詳細モード / パッケージモード」を判定して適切な箱に割り当て
- 将来的に詳細展開したい場合は、パッケージ箱を分割する設計変更を行う

---

### E.3 データモデル（テーブル定義）

#### E.3.1 実行予算テーブル（シート名「_実行予算」）

工事開始時に1回設定。承認後はセル保護でFIX。1行 = 1つの「予算の箱」。

| 列 | フィールド | 入力方式 | 例 |
|----|-----------|---------|-----|
| A | 予算箱ID | 自動生成 | C01-W02-K0201-E14 |
| B | カテゴリID | DD | C01 |
| C | カテゴリ名 | 自動 | 直接工事費 |
| D | 工事種別ID | DD（C02/C03は空） | W02 |
| E | 工事種別名 | 自動 | コンクリート工事 |
| F | 工種ID | DD（包含時は空可） | K0201 |
| G | 工種名 | 自動 | コンクリート工 |
| H | 費目/要素ID | DD | E14 |
| I | 費目/要素名 | 自動 | 外注費 |
| J | 予算額 | 手入力 | 8,500,000 |
| K | 官積算額 | 手入力 | 9,000,000 |
| L | 累計実績 | 自動集計 | 5,316,667 |
| M | 残額 | J-L | 3,183,333 |
| N | 消化率 | L/J | 62.5% |
| O | アラート | 自動 | （80%超:注意） |
| P | 承認日 | 手入力(FIX日) | 2025-09-15 |

#### E.3.2 月別配分テーブル（シート名「_実行予算_月別」）

工事開始時に設定。工期月数分を動的生成。

| 列 | フィールド | 説明 |
|----|-----------|------|
| A | 予算箱ID | 実行予算テーブルと結合 |
| B | 年月 | YYYY-MM形式（工期分を自動生成） |
| C | 計画配分額 | その月の計画支出（開始月/終了月から均等配分で自動算出） |
| D | 計画配分累計 | 月別配分の累計（自動） |
| E | 実績累計 | その月末時点の発生原価累計（支払明細から自動） |
| F | 消化率 | 実績累計 / 予算額（自動） |

#### E.3.3 支払明細入力テーブル（シート名「支払明細入力」）

所長が日常入力 + 事務員が請求書到着後に追記する**18列・2段階入力**構成。

**所長入力（緑セル A-K列）**:

| 列 | フィールド | 入力方式 | 例 |
|----|-----------|---------|-----|
| A | No. | 自動連番 | 1 |
| B | カテゴリ | DD（3択） | 直接工事費 |
| C | 工事種別 | DD（B列連動） | コンクリート工事 |
| D | 工種 | DD（C列連動、available_elementsフィルタ） | コンクリート工 |
| E | 費目 | DD（D列連動、使用可能要素のみ表示） | 外注費 |
| F | 支払先 | DD（_M取引先マスタ） | 川越建設 |
| G | 年月 | 手入力 | 2025-10 |
| H | 数量 | 手入力 | 1 |
| I | 単位 | DD（式/m3/t等） | 式 |
| J | 単価 | 手入力 | 5,316,667 |
| K | 金額 | H*J（自動 or 手入力） | 5,316,667 |

**事務員追記（青セル L-M列）**:

| 列 | フィールド | 入力方式 | 例 |
|----|-----------|---------|-----|
| L | 相殺額 | 手入力 | 0 |
| M | 相殺先 | DD（_M取引先マスタ） | （なし） |

**自動計算（灰セル N-R列）**:

| 列 | フィールド | 計算方式 | 例 |
|----|-----------|---------|-----|
| N | 課税区分 | 相殺額>0なら「相殺」、他は「課税」 | 課税 |
| O | 消費税 | 課税の場合: ROUND(K*0.1) | 531,667 |
| P | 税込合計 | K+O（相殺の場合は0） | 5,848,334 |
| Q | 予算箱ID | B+D+Eから自動解決 | C01-W02-K0201-E14 |
| R | 備考 | 相殺の場合は相殺先名を自動記入 | |

#### E.3.4 月次調整テーブル（シート名「_月次調整」）

所長が月末に入力。出来高率の入力元。

| 列 | フィールド | 説明 |
|----|-----------|------|
| A | 年月 | YYYY-MM |
| B | 全体出来高率（%） | 工事全体の進捗度合い（0-100） |
| C | 備考 | 所長のコメント（進捗に関する補足） |

#### E.3.5 予算健康度テーブル（シート名「_C_予算健康度」）

budget_health.gsが自動生成。予算箱ID単位で予実管理指標を格納。

| 列 | フィールド | 説明 |
|----|-----------|------|
| A | 予算箱ID | 予算の箱（例: C01-W02-K0201-E14） |
| B | 費目名 | 表示用名称（例: コンクリート工/外注費） |
| C | 実行予算額 | その予算箱の予算（固定値） |
| D | 累計支払額 | 支払明細からの集計（自動） |
| E | 消化率 | D/C（予算の使い具合、100%=ちょうど使い切り） |
| F | 出来高率 | 月次調整から取得（工事の進み具合） |
| G | 過不足見込み | C - (D / F * 100%)（正=余る、負=足りない） |
| H | 信号 | 消化率と出来高率の乖離に基づく3段階（青/黄/赤） |

---

### E.4 予実管理（予算健康度）設計

#### E.4.0 設計方針

当初はEVM（Earned Value Management: SPI/CPI/EAC/VAC）を採用予定だったが、以下の理由から**予実管理ベース（消化率 vs 出来高率）に転換**した:

- 4千万円規模の工事にはEVMの指標体系が過剰
- 所長がSPI/CPI/EAC/VACの意味を理解する学習コストが高い
- 予実管理（消化率と出来高率の比較）の方が直感的に理解できる
- 建設業の現場では「予算をどれだけ使ったか」「工事がどれだけ進んだか」の2軸で十分

**出来高率の入力方法**: 月次調整シートで所長が月末に全体の出来高率（%）を入力する。

**フォールバック**: 出来高率が未入力の月は、消化率のみで信号判定を行う（出来高率100%扱い）。これにより、入力漏れがあってもダッシュボードの表示が破綻しない。

**所長向け表示の簡素化**: 所長向けダッシュボードには**「過不足見込み」のみを表示**する。

- 過不足 > 0: 「予算に余り: +○○万円」（青色表示）
- 過不足 < 0: 「予算が不足: -○○万円」（赤色表示）
- 過不足 = 0: 「予算ちょうど」（灰色表示）

#### E.4.1 予実管理指標の定義

| 指標 | 名称 | 定義 | 計算式 |
|------|------|------|--------|
| 消化率 | 予算の使い具合 | 予算をどれだけ使ったか | 累計支払額 / 実行予算額 |
| 出来高率 | 工事の進み具合 | 工事がどれだけ進んだか | 所長が月末に入力（0-100%） |
| 過不足見込み | 最終的な余り/不足 | このペースで完成した場合の予算の余り/不足 | 実行予算額 - (累計支払額 / 出来高率) |
| 信号 | 状態判定 | 消化率と出来高率の乖離に基づく | 3段階（青/黄/赤） |

#### E.4.2 信号判定ロジック

| 信号 | 条件 | 所長向け表示 | 対応アクション |
|------|------|-----------|-------------|
| 青 | 消化率 <= 出来高率 + 10% | 「順調」 | 特になし |
| 黄 | 消化率 <= 出来高率 + 20% | 「注意が必要」 | 所長に注意喚起メール |
| 赤 | 消化率 > 出来高率 + 20% | 「予算超過の可能性」 | 所長+経営者に警告メール |

#### E.4.3 時間軸設計（最長3年以上対応）

- 工事期間は完全自由設定（工種ごとに開始月/終了月を設定）
- 月単位で管理（固定12ヶ月でなく、工種ごとの実工期月数で動的生成）
- 月別配分は開始月〜終了月の均等配分で自動算出（手入力不要）
- 例: 6ヶ月工事 → 6行、36ヶ月工事 → 36行

#### E.4.4 予実管理計算フロー

```
工事開始時:
  1. 実行予算テーブルで予算箱を定義（工種×費目、予算額、官積算額）
  2. 工種ごとに開始月/終了月を設定
  3. 月別配分テーブルが自動生成（均等配分）

月次処理（毎月末 or メニューから手動実行）:
  1. 所長が支払明細入力に取引を記録
  2. 所長が月次調整シートに出来高率を入力（5分/月）
  3. budget_health.gsが自動計算:
     - 消化率 = 累計支払額 / 実行予算額
     - 過不足見込み = 実行予算額 - (累計支払額 / 出来高率)
     - 信号判定（青/黄/赤）

ダッシュボード表示:
  - 信号の表示（赤/黄/青）
  - 費目別の消化率一覧
  - 過不足見込み（正=余り、負=不足）
  - 月次推移グラフ
```

#### E.4.5 海潟漁港R7-1 検証シナリオ

工期: 2025-09〜2026-03（7ヶ月）

| 指標 | 設定値 | 説明 |
|------|--------|------|
| 実行予算合計 | 34,427,409円 | 各予算箱の実行予算額を合算 |
| 工期 | 7ヶ月 | 2025-09〜2026-03 |
| 3ヶ月実績 | 16,356,671円 | 2025-10〜2025-12の累計支払 |
| 消化率 | 47.5% | 16,356,671 / 34,427,409 |

検証手順:
1. template.gsでテストスプレッドシートを生成
2. 実行予算テーブルに官積算額・実行予算額を入力
3. 支払明細入力にExcel月報の10-12月データを転記（約80件）
4. aggregation.gsで月次集計を実行
5. budget_health.gsで消化率/信号判定が妥当か確認
6. api.gsのmode=healthが正しいJSONを返すか確認

---

### E.5 Google Sheetsシート構成（Phase A実装版）

template.gsの`initProjectTemplate()`で自動生成されるシート一覧:

```
入力層（3シート）
  [支払明細入力]     18列・2段階入力（所長A-K列 + 事務員L-M列 + 自動N-R列）
  [_月次調整]        出来高率入力（月末に所長が入力、5分/月）
  [支払明細]         転記済み明細（支払明細入力からの確定データ）

予算層（2シート）
  [_実行予算テーブル] 予算箱定義（工種×費目、予算額、官積算額）、承認後FIX
  [_実行予算_月別]   月別配分（開始月/終了月から均等配分で自動生成）

マスター層（1シート）
  [_M取引先]         取引先マスタ（約20社）、DD用

計算層（3シート）
  [_C_予算健康度]    消化率/出来高率/過不足見込み/信号（budget_health.gsが生成）
  [_C_月次集計]      月別×費目別のピボット集計（aggregation.gsが生成）
  [_C_費目別集計]    費目別の予算/実績/消化率/残額（aggregation.gsが生成）

合計: 9シート（入力3 + 予算2 + マスター1 + 計算3）
```

**注**: マスタデータ（費目カテゴリC01-C03、工事種別W01-W99、工種K0101-K9901、費用要素E11-E15、費目項目F31-F67）はmaster_items_initial.csvからtemplate.gsが読み込み、カスケードDDの選択肢として展開する。独立シートとしては生成しない。

---

### E.6 Apps Script設計（Phase A実装版）

| スクリプトファイル | サイズ | 行数 | 役割 |
|-----------------|-------|------|------|
| config.gs | 10KB | 220 | シート保護/メニュー/定数/前行コピー/入力期限通知 |
| template.gs | 36KB | 850 | テンプレート自動生成（available_elements対応/2段階入力/18列） |
| validation_extended.gs | 17KB | 370 | カスケードDD（4段連鎖）/数量列制御/予算箱ID自動解決 |
| aggregation.gs | 18KB | 400 | スナップショット方式の月次集計/費目別集計/相殺処理 |
| budget_health.gs | 20KB | 450 | 消化率/出来高率/過不足見込み/信号判定（予実管理の中核） |
| api.gs | 24KB | 520 | Web App API（5モード: health/master/summary/project/aggregate） |
| hub.gs | 18KB | 400 | 本社管理台帳（複数現場横断、予算健康度連携は未対応） |

**合計**: 約145KB、約3,210行

**budget_health.gs の処理ステップ**:

1. 実行予算テーブルから全予算箱の予算額を取得
2. 支払明細テーブルから予算箱ID別の累計支払額を集計
3. 消化率 = 累計支払額 / 実行予算額
4. 月次調整シートから出来高率を取得
   - 出来高率が未入力の場合、消化率のみで判定（出来高率100%扱い）
5. 過不足見込み = 実行予算額 - (累計支払額 / 出来高率)
   - **ゼロ除算対策**: 出来高率 = 0 の場合、過不足見込みは算出不可（「--」表示）
6. 信号判定: 消化率と出来高率の乖離に基づく3段階（青/黄/赤）
7. _C_予算健康度シートに書き込み
8. 赤信号の予算箱がある場合、config.gsのALERT_EMAILにメール通知

---

### E.7 成果物リスト

| 成果物 | 出力先 | 内容 |
|--------|--------|------|
| 設計書（本付録） | output/system_design_proposal.md | マスタ体系・予実管理設計・テーブル定義の完全版 |
| マスタ初期値CSV | output/master_items_initial.csv | 工種35項目+費目26項目+費用要素5項目+工事種別12項目 |
| GAS実装（7ファイル） | gas_templates/ | 全7ファイル約145KB（Phase A実装完了） |
| Sitesモックアップ | output/mockup_sites.html | ダッシュボード7ページ |
| Sheetsモックアップ | output/mockup_sheets.html | スプレッドシート入力画面 |
