# 森組 工事管理システム 統合提案資料

**対象工事**: 海潟漁港海岸海岸保全施設整備連携工事(R7-1工区)
**施工会社**: (株)森組
**作成日**: 2026年2月17日
**データソース**: 3パイプライン抽出・クロスバリデーション済み実データ（Excel 2ファイル計32シート）+ 実行予算書6工事 + フィージビリティレポート

---

## 第1章: エグゼクティブサマリー

### 提案の全体像

(株)森組の建設工事予実管理を、現行のExcel手作業運用（32シート）から、Google Sheets + Apps Script + Google Sites + Difyによる自動化システムに移行する提案。

**現行の課題**:
- Excelファイル2本（計32シート）を手作業で運用。月末のたびに手集計、シートコピー
- 品質検査の結果、**11件の問題を検出**（うちcritical 4件）
- 累計金額の未更新、参照先の誤りによる約1,200万円の残額過大表示
- データ密度20.3% -- 約80%が空セルという非効率な構造

**解決策**:
- 入力シート32枚を3枚に圧縮（89%削減）
- 入力セル数を約3,255から約800に削減（75%削減）
- 集計・累計・相殺処理を全自動化
- 品質問題11件中8件を自動化で構造的に根絶
- 全社員がスマホからリアルタイム閲覧可能なダッシュボード
- AIチャットボットによる対話型データ分析

**主要KPI**:

| 指標 | 現行 | 導入後 |
|------|------|--------|
| 入力シート数 | 32枚 | 3枚 |
| 品質問題（critical） | 4件 | 0件（自動化で根絶） |
| 月末集計作業 | 数時間の手作業 | 全自動（ゼロ時間） |
| 予算超過の把握 | 月末に手で確認 | 80%超過で即時通知 |
| 情報共有 | Excelファイルの回覧 | 全社員リアルタイム閲覧 |

---

## 第2章: As-Is -- 現在のExcel運用の実態

### 2.1 工事月報ファイルの構造

**ファイル名**: 海潟漁港R7-1工事月報（12月度）.xlsm
**シート数**: 28シート
**総セル数**: 13,962
**非nullセル**: 2,841（データ密度20.3%）
**結合セル**: 109箇所

28シートは以下の5カテゴリに分類される:

| カテゴリ | シート数 | 構造的特徴 |
|---------|---------|-----------|
| メイン工事月報 | 1 | 33x19、セル結合23箇所、帳票形式 |
| 総括表（直工・純工事費） | 1 | 179x14、セル結合73箇所、3テーブル構成 |
| 直接工事費内訳 | 5 | 各25x28、月別展開テーブル（材料費/機械経費/機械経費損料/外注費/労務費） |
| 共通仮設費 | 10 | サマリー1枚+9費目別詳細（共31-39） |
| 現場管理費 | 18 | サマリー1枚+17費目別詳細（現51-67） |

直接工事費内訳5シートと、共通仮設費・現場管理費の詳細シート19枚は、全て共通のテーブル構造を持つ:

```
共通テーブル構造（24シート共通）:
行1: 実行予算額（月別配分）
行2-14: 業者名/費目別の実績データ（最大13行）
行15: 月度別計
行16: 月度別累計
列: 月度 | 4月 | 5月 | ... | 3月 | 合計
```

### 2.2 月度別支払い内訳ファイルの構造

**ファイル名**: 月度別支払い内訳.xlsm
**シート数**: 4シート（10月度/11月度/12月度/Sheet2マスター）

各月度シートは、1枚のシート内に2つのテーブルが左右に並列配置される構造。

**左テーブル（A-E列）-- 支払明細**:
- A列: 支払先（同一業者2行目以降は「〃」記号）
- B列: 経費項目（コード番号.費目名の形式）
- C列: 支払金額（税抜）
- D列: 相殺額
- E列: 相殺先業者名 or 小口購入品の内訳

**右テーブル（F-J列）-- 請求サマリー**:
- F列: 請求元
- G列: 金額
- H列: 相殺合計
- I列: 支払金額（税抜）= G - H
- J列: 支払金額（税込10%）= I x 1.1

**月度別実績**:

| 月度 | 明細件数 | 業者数 | 支払計（税抜） | 相殺計 |
|------|---------|--------|--------------|--------|
| 10月 | 31 | 18 | 10,933,337円 | 4,119,138円 |
| 11月 | 26 | 16 | 8,458,604円 | 2,712,148円 |
| 12月 | 25 | 17 | 4,332,077円 | 0円 |
| **合計** | **82** | -- | **23,724,018円** | **6,831,286円** |

Sheet2は経費項目コードマスター（10番台-60番台の28項目）。

### 2.3 2ファイル間の関係性

2つのファイルは**同一の支払データを異なる視点から集計**している。

| 視点 | 工事月報 | 月度別支払い内訳 |
|------|---------|----------------|
| 分類軸 | 費目別（何に使ったか） | 支払先別（誰に払ったか） |
| 構成 | 経費コード x 月度 | 業者名 x 経費コード x 月度 |
| 予算管理 | 実行予算 vs 実績 | なし |
| 相殺処理 | 費目内で純額表示 | 明細行に相殺額を記録 |
| 累計 | 月別累計を管理 | 月度別支払計を管理 |

**共通キー**: 経費項目コード（10番台=直接工事費、30番台=共通仮設費、50番台=現場管理費）

例: 10月度の川越建設への外注費5,316,667円は、工事月報「14.外注費」シートの10月列と、月度別支払い内訳「10月度」シートの左テーブルの両方に記録される。

### 2.4 品質監査結果

3パイプライン抽出 + 品質監査エージェントにより、**11件の品質問題**を検出した。

#### Critical（4件）-- 数値の信頼性に直接影響

| ID | 内容 | 影響額 |
|----|------|--------|
| CRT-001 | 累計支払金額が全シートで単月値のまま。11月累計が8,458,604円のまま（正: 19,391,941円） | 11月度で10,933,337円の過少表示 |
| CRT-002 | 共通仮設費の計列O10に実行予算額2,472,000円が混入。月別実績合計は907,661円 | 1,564,339円の差額 |
| CRT-003 | 工事原価の計列O12がCRT-002に連動して不正（16,356,671円 vs 正値14,792,332円） | CRT-002に連動 |
| CRT-004 | 純工事費の予算残額K18が28,283,829円と表示。正値は16,305,829円 | **約1,200万円の過大表示** |

#### Warning（4件）-- 集計精度・データ品質に影響

| ID | 内容 | 箇所 |
|----|------|------|
| WRN-001 | 11月度の小口購入9件（合計40,920円）に経費項目コード未付与 | 9件 |
| WRN-002 | 業者名の異体字混在（「濵畑水道」U+6FF5 vs「濱畑水道」U+6FF1） | 複数箇所 |
| WRN-003 | 工事月報の金額に浮動小数点端数（0.0909...パターン、11等分按分が原因） | 7箇所 |
| WRN-004 | 月度別支払い内訳J列の浮動小数点誤差（1,317,281.9000000001等） | 3箇所 |

#### Info（3件）-- 表示上の問題または正常な仕様

| ID | 内容 | 対応 |
|----|------|------|
| INF-001 | 10月度シートE2に「11月度」ラベル表示（シートコピー時の修正漏れ） | 表示のみ |
| INF-002 | 材料費が大幅マイナス（-3,862,901円）。桜島生コンの相殺が原因 | 正常な処理結果 |
| INF-003 | 予算超過3費目: 動力用水光熱費+13.0%、保険料+13.7%、法定福利費+26.2% | 監視継続 |

### 2.5 所長の日常作業フロー

現場代理人（上村和弘氏）の月次作業:

1. **日常入力**（月25-31件）: 各支払いを工事月報の該当シートに記入。同時に月度別支払い内訳にも転記（二重入力）
2. **月末集計**: 24シートの月度別計・月度別累計を手で合算
3. **相殺処理**: 川越建設向けの相殺額を手計算し、請求サマリーを作成
4. **予算チェック**: 費目別の消化率を電卓で計算
5. **報告書作成**: 工事月報シートを印刷用に整形

この手作業フローの中で、シートコピー時の更新漏れ（CRT-001）、セル参照の設定ミス（CRT-002/003/004）が発生している。

---

## 第3章: 実行予算書 全6工事の管理状況

実行予算書PDF（約480ページ）から抽出した、(株)森組が管理する全6工事の一覧。

### 3.1 工事一覧テーブル

| 工事名 | 所長 | 請負額 | 工事益率 | 工種 | 状態 |
|--------|------|--------|----------|------|------|
| 野尻川除石 | 池田豊 | 76,600,000円 | 25.6% | 砂防土工 | 進行中 |
| 境川R2-2工区 | 中村竜一 | 32,107,014円 | 16.6% | 砂防 | 完了 |
| 森林基幹道 海瀬麓線1工区 | 中村竜一 | 78,600,000円 | 24.1% | 林道開設 | 完了 |
| 境川2-1工区 | 中村竜一 | 31,296,970円 | 28.9% | 砂防 | 完了 |
| 海潟漁港R7-1 | 上村和弘 | 43,000,000円 | 14.0% | 港湾 | 進行中 |
| 持木川中流部 | 中原輝竜 | 160,380,000円 | 15.4% | 砂防 | 進行中 |

**全体指標**:
- 合計請負額: 421,983,984円（約4.2億円）
- 平均工事益率: 20.8%
- 最高益率: 中村竜一（境川2-1）28.9%
- 最低益率: 上村和弘（海潟漁港）14.0%

### 3.2 予算構造の分析

経費コードは21区分3階層の体系で全工事共通（実行予算工種別体系 図2-2準拠）:

```
10番台: 直接工事費（費用要素5項目）
  11 材料費 / 12 機械経費 / 13 機械経費(損料) / 14 外注費 / 15 労務費
30番台: 共通仮設費（9項目 = 図2-2の7項目 + 森組独自2項目）
  31 運搬費 / 32 調査・準備費 / 33 仮設建物費 / 34 公害防止対策費 / 35 安全対策費
  36 水道光熱費 / 37 産業廃棄物処理費 / 38 役務費 / 39 営繕費
50番台: 現場管理費（17項目 = 図2-2準拠）
  51 労務管理費 / 52 法定福利費 / 53 租税公課 / 54 地代家賃 / 55 保険料
  56 従業員給料手当 / 57 従業員賞与 / 58 従業員退職金 / 59 福利厚生費
  60 事務用品費 / 61 旅費・交通費・通信費 / 62 補償費 / 63 設計費
  64 交際費 / 65 保証料 / 66 会議費・諸会費 / 67 雑費
```

海潟漁港R7-1工区の予算配分:

| カテゴリ | 実行予算額 | 累計実績（12月度時点） | 消化率 |
|---------|----------|---------------------|--------|
| 直接工事費 | 27,095,460円 | 10,789,631円 | 39.8% |
| 共通仮設費 | 14,450,000円 | 907,661円（実績ベース） | 6.3% |
| 現場管理費 | 4,859,949円 | 3,095,040円 | 63.7% |
| **工事価格** | **34,427,409円** | **16,356,671円** | **47.5%** |

### 3.3 支払先データの横断分析

海潟漁港R7-1工区の主要支払先（3ヶ月累計）:

| 順位 | 業者名 | 累計支払額 | 主な費目 | 構成比 |
|------|--------|----------|---------|--------|
| 1 | 川越建設 | 9,667,000円 | 外注費 | 40.7% |
| 2 | 桜島生コンクリート | 5,205,650円 | 外注費+材料費+技術管理費 | 21.9% |
| 3 | (有)濱畑水道 | 4,839,554円 | 外注費 | 20.4% |
| 4 | 菱和コンクリート | 1,910,000円 | 外注費（型枠） | 8.1% |
| 5 | (株)グリーンクロス | 432,940円 | 材料費+安全費 | 1.8% |
| 6 | (株)ニシケン | 173,175円 | 営繕費+動力用水光熱費 | 0.7% |
| 7 | (有)大建測量設計 | 170,000円 | 準備費 | 0.7% |
| 8 | (株)デザインアーク | 150,000円 | 営繕費 | 0.6% |
| 9 | (株)コマロック | 145,440円 | 機械経費 | 0.6% |

上位3社で全体の83.0%を占める外注主体の工事構造。自社労務は未使用（全職種・全月未稼働）。

### 3.4 全社経営指標（経営診断レポートより）

| 指標 | 森組（R6） | 業界中央値 | 差異 |
|------|-----------|----------|------|
| 粗利率 | 6.7% | 19.1%（経審25社） | -12.4pt |
| 営業利益率 | 0.2% | 4.0% | -3.8pt |
| 外注費比率 | 42.4% | 32.0%（国交省調査） | +10.4pt |
| 売上高 | 1,147百万円 | -- | -- |
| 営業利益 | 2.4百万円 | -- | -- |

工事単位の益率は14.0%-28.9%で健全だが、全社の粗利率が6.7%と低い。この乖離は販管費の大きさと外注費比率の高さに起因する。本システムは工事単位の予実管理を精緻化し、全社経営への可視化を実現する。

---

## 第4章: Excel実データ vs モックアップの精度検証

### 4.1 工事月報データ照合

Excel抽出JSONのfinal_output.jsonと、mockup_sites.htmlのハードコード値を1対1で突き合わせた結果:

| 項目 | Excel実データ | モックアップ値 | 判定 |
|------|-------------|--------------|------|
| 工事価格 | 39,840,000 | 39,840,000（設計書に記載） | 一致 |
| 工事益率 | 58.9% | 58.9%（page1 KPIカード） | 一致 |
| 純工事益率 | 45.9% | 45.9%（page1 KPIカード） | 一致 |
| 予算消化率 | 47.51% | 47.5%（page1 KPIカード） | 一致（端数丸め） |
| 累計支出 | 16,356,671円 | 16,357千円（page1 KPIカード） | 一致（千円丸め） |
| 直接工事費合計 | 10,789,631円 | -- | モックアップに記載なし |
| 共通仮設費（実績） | 907,661円 | -- | モックアップに記載なし |
| 共通仮設費（表示値） | 2,472,000円 | -- | CRT-002: 参照誤り |
| 現場管理費合計 | 3,095,040円 | -- | モックアップに記載なし |

**KPIカード4枚は正確**。トップページの主要指標は実データと一致している。

### 4.2 予算超過アラートテーブル照合

**Sites mockup（page1）のアラートテーブル**:

| 費目 | モックアップ値 | Excel実データ | 判定 |
|------|-------------|-------------|------|
| 営繕費 113.3% | デモデータ | 営繕費: 316,512/539,588 = 58.7% | **不一致（デモデータ）** |
| 仮設材料費 80.2% | デモデータ | 該当費目なし（28コード体系に存在しない） | **不一致（架空費目）** |
| 土木一般世話役 76.2% | デモデータ | 該当費目なし | **不一致（架空費目）** |
| 機械損料 72.4% | デモデータ | 機械経費損料: 0/137,440 = 0% | **不一致（デモデータ）** |

**正しいアラートテーブル（Excel実データに基づく）**:

| 費目 | 予算額 | 実績額 | 消化率 | ステータス |
|------|--------|--------|--------|----------|
| 法定福利費（現55） | 690,039 | 870,940 | 126.2% | 超過 |
| 地代（現53） | 131,910 | 150,000 | 113.7% | 超過 |
| 安全費（共35） | 65,000 | 73,477 | 113.0% | 超過 |
| 現場管理費全体 | 4,859,949 | 3,095,040 | 63.7% | 監視 |

### 4.3 予実対比テーブル照合（page2）

**Sites mockup（page2）の予実対比テーブル**:

モックアップでは経費コードが「A-101」「B-201」「C-301」等の架空コードで、費目名も「営繕費」「仮設材料費」「土木一般世話役」「機械損料」等のデモデータ。**全行がExcel実データと不一致。**

**正しい予実対比テーブル（直接工事費内訳）**:

| 経費コード | 費目名 | 予算額 | 実績額 | 消化率 | 残額 |
|-----------|--------|--------|--------|--------|------|
| 11 | 材料費 | 5,201,260 | -3,862,901 | -- | 9,064,161 |
| 12 | 機械経費 | 137,440 | 145,978 | 106.2% | -8,538 |
| 13 | 機械経費(損料) | -- | 0 | -- | -- |
| 14 | 外注費 | 21,617,667 | 14,506,554 | 67.1% | 7,111,113 |
| 15 | 労務費 | -- | 0 | -- | -- |

**正しい予実対比テーブル（共通仮設費内訳）**:

| 経費コード | 費目名 | 予算額 | 実績額 | 消化率 | 残額 |
|-----------|--------|--------|--------|--------|------|
| 31 | 運搬費 | 170,000 | 170,000 | 100.0% | 0 |
| 32 | 準備費 | 80,000 | 0 | 0.0% | 80,000 |
| 33 | 仮設費 | 539,588 | 316,512 | 58.7% | 223,076 |
| 34 | 事業損失防止施設費 | 100,000 | 74,249 | 74.2% | 25,751 |
| 35 | 安全費 | 65,000 | 73,477 | 113.0% | -8,477 |
| 36 | 役務費 | 56,000 | 56,000 | 100.0% | 0 |
| 37 | 技術管理費 | 565,000 | 164,905 | 29.2% | 400,095 |
| 38 | 営繕費 | 250,000 | 0 | 0.0% | 250,000 |
| 39 | 設計費 | 101,000 | 52,518 | 52.0% | 48,482 |

**正しい予実対比テーブル（現場管理費内訳）**:

| 経費コード | 費目名 | 予算額 | 実績額 | 消化率 | 残額 |
|-----------|--------|--------|--------|--------|------|
| 51 | 労務管理費 | 60,000 | 18,265 | 30.4% | 41,735 |
| 52 | 租税公課 | 215,000 | 180,000 | 83.7% | 35,000 |
| 53 | 地代 | 131,910 | 150,000 | 113.7% | -18,090 |
| 54 | 保険料 | 3,100,000 | 1,750,000 | 56.5% | 1,350,000 |
| 55 | 従業員給料手当 | 690,039 | 870,940 | 126.2% | -180,901 |
| 56 | 法定福利費 | 35,000 | 4,450 | 12.7% | 30,550 |
| 57 | 福利厚生費 | 90,000 | 22,662 | 25.2% | 67,338 |
| 58 | 事務用品費 | 300,000 | 71,082 | 23.7% | 228,918 |
| 59 | 通信交通費 | 25,000 | 1,420 | 5.7% | 23,580 |
| 60 | 交際費 | 88,000 | 26,221 | 29.8% | 61,779 |

### 4.4 業者マスター照合

Excel実データの主要取引先約20社と、モックアップの業者名を照合:

| Excel実データの業者名 | モックアップに存在 | 備考 |
|---------------------|-----------------|------|
| 川越建設 | Sites: 存在、Sheets: 存在 | 金額が異なる（後述） |
| (有)濱畑水道 | Sites: 存在、Sheets: 存在 | 金額が異なる |
| 桜島生コンクリート | Sites: 存在、Sheets: 存在 | 名称が一部異なる |
| 菱和コンクリート | Sites: なし、Sheets: 存在 | -- |
| (株)グリーンクロス | Sites: なし、Sheets: 存在 | -- |

### 4.5 相殺処理照合

Excel実データの3ヶ月分の相殺フロー:

| 相殺元業者 | 相殺先 | 10月 | 11月 | 合計 |
|-----------|--------|------|------|------|
| 桜島生コンクリート | 川越建設 | 2,993,670 | 1,986,480 | 4,980,150 |
| 菱和コンクリート | 川越建設 | 1,000,000 | 690,200 | 1,690,200 |
| (株)コマロック | 川越建設 | 90,000 | -- | 90,000 |
| 鹿児島仮設 | 川越建設 | 35,468 | 35,468 | 70,936 |
| **合計** | | **4,119,138** | **2,712,148** | **6,831,286** |

12月度は相殺なし。菱和コンクリートの10月残690,200円は11月に消化済み。

モックアップ（Sheets）には相殺処理のデモデータがあるが、上記の実データとは対応していない。

### 4.6 不一致リスト（修正必要箇所）

#### Sites mockup（mockup_sites.html）

| 箇所 | 現状 | 修正内容 |
|------|------|---------|
| page1 予算超過アラートテーブル | 架空データ（営繕費113.3%等） | Excel実データに基づく3費目（法定福利費126.2%/保険料113.7%/動力用水光熱費113.0%）に差替 |
| page2 予実対比テーブル | 架空コード・架空データ | 28コード体系の実データに差替 |
| page2 予算vs実績グラフ | 架空データ | 実データに基づくグラフデータに差替 |
| page4 AIチャット応答 | 架空数値（外注費2,156,000円等） | Excel実データの数値を反映 |

#### Sheets mockup（mockup_sheets.html）

| 箇所 | 現状 | 修正内容 |
|------|------|---------|
| Tab1 支払明細入力 | デモデータ（川越建設3,200,000円等） | Excel実データ（川越建設5,316,667円等）に差替 |
| Tab2 予算設定 | 架空コード（A01/B01/C01等） | 28コード体系（11/12/.../60）に差替 |
| Tab2 費目名 | 架空名（土木一般外注費/コンクリート材料費等） | 正式名称（材料費/機械経費/外注費等）に差替 |

---

## 第5章: To-Be -- 新システムの全体像

### 5.1 5層アーキテクチャ

```
第1層: 入力層（Google Sheets 3シート）
  [支払明細入力] [予算設定] [月次調整]
      ↓ Apps Script自動処理
第2層: マスター層（Google Sheets 4シート）
  [業者マスター] [経費コードマスター] [機械マスター] [労務単価マスター]
      ↓
第3層: 計算層（Google Sheets 4シート + 経営診断データ4シート）
  [経費コード別月別集計] [業者別月別集計] [相殺処理結果] [予実対比]
  [全社損益] [今年度受注一覧] [工事別比較] [外注単価比較+改善効果試算]
      ↓
第4層: 表示層（Google Sites 7ページ）
  [トップページ] [経営分析] [現場管理] [AIチャット]
  [全社経営概況] [工事別パフォーマンス] [コスト改善]
      ↓
第5層: AI分析層（Dify Cloud 2チャットボット）
  [データ分析アシスタント] [コスト改善提案アシスタント]
```

### 5.2 データフロー図

```
現場所長 → [支払明細入力]（Sheets 18列、2段階入力）
              ↓ onEdit トリガー
           [validation_extended.gs]（カスケードDD + 入力チェック + 予算箱ID解決）
              ↓ メニュー実行 or 日次トリガー
           [aggregation.gs]（月次集計 + 費目別集計 + スナップショット保存）
           [budget_health.gs]（消化率 / 出来高率 / 信号判定）
              ↓
           [計算層シート群]（自動生成）
              ↓
     ┌───────────┴───────────┐
     ↓                       ↓
  [Google Sites]          [api.gs] ← HTTP ← [Dify Cloud]
  （ダッシュボード）        （Web API 5モード）  （AIチャット）
     ↓                       ↓
  経営者・所長が閲覧     AIが自然言語で分析
```

### 5.3 アクセス制御

| ビュー | 対象者 | 閲覧可能範囲 | 操作権限 |
|--------|--------|------------|---------|
| 経営者ビュー | 社長 | 全7ページ + AIチャット | 閲覧のみ |
| 所長ビュー | 現場代理人 | 工事予実管理4ページ + AIチャット | 入力層の編集権限あり |

---

## 第6章: GASの役割 -- 7スクリプトの詳細設計

### 6.1 ファイル構成表（Phase A実装済み）

| No. | ファイル名 | サイズ | 行数目安 | 役割 |
|-----|-----------|-------|---------|------|
| 1 | config.gs | 10KB | 220 | シート保護/メニュー/定数/前行コピー/入力期限通知 |
| 2 | template.gs | 36KB | 850 | テンプレート自動生成（available_elements対応/2段階入力/18列） |
| 3 | validation_extended.gs | 17KB | 370 | カスケードDD/数量列制御/予算箱ID解決 |
| 4 | aggregation.gs | 18KB | 400 | 月次集計/費目別集計/スナップショット方式 |
| 5 | budget_health.gs | 20KB | 450 | 予実管理計算（消化率/出来高率/過不足見込み/信号判定） |
| 6 | api.gs | 24KB | 520 | Web App API（5モード: health/master/summary/project/aggregate） |
| 7 | hub.gs | 18KB | 400 | 本社管理台帳（複数現場横断、予算健康度連携は未対応） |

**合計**: 約145KB、約3,210行

### 6.2 トリガー体系

| トリガー種別 | 関数名 | 発火条件 | 処理内容 |
|------------|--------|---------|---------|
| onEdit | onEditHandler | 支払明細入力シートの編集時 | カスケードDD更新 + 消費税/税込自動計算 + 予算箱ID解決 |
| メニュー | runAggregation | メニューから手動実行 | 月次集計 + 費目別集計 + スナップショット保存 |
| メニュー | runBudgetHealth | メニューから手動実行 | 消化率/出来高率/信号判定の全再計算 |
| HTTP | doGet | 外部からのリクエスト | データ取得API（5モード: health/master/summary/project/aggregate） |

### 6.3 各スクリプトの役割

#### config.gs -- 設定・メニュー・ユーティリティ

シート保護の自動設定、カスタムメニュー生成、定数管理（シート名・列番号・経費コード）、前行コピー機能、入力期限通知（毎月15日）を担当。

#### template.gs -- テンプレート自動生成

`initProjectTemplate('P004')` で工事別スプレッドシートの全シートを自動生成する。

**生成されるシート**: _実行予算テーブル / _実行予算_月別 / 支払明細入力 / 支払明細 / _C_予算健康度 / _C_月次集計 / _C_費目別集計 / _月次調整 / _M取引先

**支払明細入力の18列構成（2段階入力）**:
- A-K: 所長入力（緑）: No./カテゴリ/工事種別/工種/費目/支払先/年月/数量/単位/単価/金額
- L-M: 事務員追記（青）: 相殺額/相殺先
- N-R: 自動計算（灰）: 課税区分/消費税/税込合計/予算箱ID/備考

**available_elements機能**: 工種ごとに入力可能な費用要素を制限。例: K0103 除石工 → E12（機械経費）, E13（機械経費損料）, E14（外注費）の3行のみ生成。不要な行を排除し、入力ミスを構造的に防止。

#### validation_extended.gs -- カスケードDD + 入力チェック

**カスケードドロップダウン（DD）**: カテゴリ → 工事種別 → 工種 → 費目 の4段連鎖。上位を選ぶと下位の選択肢が自動で絞り込まれる。

**予算箱ID解決**: カテゴリ+工種+費目の組み合わせから予算箱IDを自動生成し、N列に記入。集計の紐付けキーとなる。

#### aggregation.gs -- 月次集計・費目別集計

**スナップショット方式**: 月次集計の実行時に、その時点の集計結果をスナップショットとして保存。月別の推移を追跡可能。

1. **月次集計**（_C_月次集計シート）: 支払明細を年月 x 費目でピボット集計
2. **費目別集計**（_C_費目別集計シート）: 費目別の予算/実績/消化率/残額を自動計算
3. **相殺処理**: 相殺額の集計・持ち越し管理を自動化

#### budget_health.gs -- 予算健康度（予実管理の中核）

**消化率**: 累計支払額 / 実行予算額。予算の使い具合を示す
**出来高率**: 工事の進捗度合い（月次調整シートで所長が入力）
**過不足見込み**: 実行予算額 - (累計支払額 / 出来高率)。このままのペースで完成時にいくら余るか/足りないか
**信号判定**: 消化率と出来高率の乖離に基づく3段階

| 信号 | 条件 | 所長向け表示 |
|------|------|-----------|
| 青 | 消化率 <= 出来高率 + 5pt | 「順調」 |
| 黄 | 消化率 <= 出来高率 + 15pt | 「注意が必要」 |
| 赤 | 消化率 > 出来高率 + 15pt | 「予算超過の可能性」 |

#### api.gs -- Web App API（5モード）

**エンドポイント**: doGet
**認証**: API_KEY（スクリプトプロパティで管理）

| mode | 内容 | レスポンス |
|------|------|----------|
| health | 予算健康度 | 費目別の消化率/出来高率/信号/過不足見込み |
| master | マスタデータ | 費目26項目+工種35項目 |
| summary | 工事サマリー | 工事価格/工事益率/予算消化率/累計支出 |
| project | 工事詳細 | 工事基本情報+予算健康度+月次推移 |
| aggregate | 集計データ | 月次集計+費目別集計の全データ |

#### hub.gs -- 本社管理台帳

複数工事のデータを横断集計する本社向けシート。現時点では骨格実装のみで、budget_health.gsとの連携（全工事の信号一覧表示）は未対応。Phase B（本社集計）で改修予定。

### 6.4 Excel品質問題の自動根絶マッピング

| 品質問題ID | 内容 | GASによる根絶方法 | 対応スクリプト |
|-----------|------|-----------------|-------------|
| CRT-001 | 累計金額の未更新 | 累計はaggregation.gsが自動計算 | aggregation.gs |
| CRT-002 | 共通仮設費O10の参照誤り | 入力データから自動集計。手動参照不要 | aggregation.gs |
| CRT-003 | 工事原価O12の連動不正 | CRT-002解消に連動 | aggregation.gs |
| CRT-004 | 純工事費残額の過大表示 | 残額=予算-累計をbudget_health.gsが計算 | budget_health.gs |
| WRN-001 | 経費コード未付与 | カスケードDDで費目必須選択 | validation_extended.gs |
| WRN-003 | 浮動小数点端数 | ROUND処理を全計算に適用 | aggregation.gs |
| WRN-004 | 税込計算の端数 | ROUND(金額*1.1, 0)を適用 | validation_extended.gs |
| INF-001 | シートコピー時のラベル漏れ | template.gsでシート自動生成 | template.gs |

**8件/11件を自動化で根絶**。残る3件:
- WRN-002（業者名の異体字）: _M取引先シートに正式名称を登録。以降はDD選択で発生しない
- INF-002（材料費マイナス）: 相殺の正常な結果。注記を自動付与
- INF-003（予算超過3費目）: budget_health.gsの信号判定で自動検知、対応判断は人間

---

## 第7章: Difyの役割 -- 2つのChatbot設計

### 7.1 Chatbot 1: データ分析アシスタント

**Chatflow構成**:

```
[Start] → [Question Classifier] → 分岐
  ├─ カテゴリ1: サマリー質問 → [HTTP Request: mode=summary] → [LLM] → [End]
  ├─ カテゴリ2: 予算質問 → [HTTP Request: mode=health] → [LLM] → [End]
  ├─ カテゴリ3: 詳細質問 → [HTTP Request: mode=project] → [LLM] → [End]
  └─ カテゴリ4: 集計質問 → [HTTP Request: mode=aggregate] → [LLM] → [End]
```

**4つの質問カテゴリ**:

| カテゴリ | 対象質問例 | GAS APIモード |
|---------|----------|-------------|
| サマリー | 「今月の利益率は?」「全体の状況は?」 | summary |
| 予算 | 「外注費の予算残は?」「超過している費目は?」 | health |
| 詳細 | 「工事の基本情報は?」「月次の推移は?」 | project |
| 集計 | 「費目別の集計は?」「月別支出は?」 | aggregate |

**LLMプロンプト設計**:

```
あなたは建設工事の予算管理の専門家です。
(株)森組の工事予実データに基づいて質問に回答してください。

# 対象工事
工事名: 海潟漁港海岸海岸保全施設整備連携工事(R7-1工区)
工事価格: 39,840,000円
工事益率: 58.9%

# データ
{api_response}

# 回答ルール
- 金額はカンマ区切りで表示
- 比率は小数1桁で表示
- テーブル形式で見やすく
- 異常値がある場合は注意喚起を含める
```

### 7.2 Chatbot 2: コスト改善提案アシスタント

**データ統合方式**:
3つのGAS APIモードを同時呼び出し、統合データをLLMに渡す。

1. `mode=summary` -- 工事全体の状況
2. `mode=health` -- 予算健康度データ（消化率/出来高率/信号）
3. `mode=aggregate` -- 費目別集計データ

**改善提案の生成ロジック**:

| トリガー | 提案内容 |
|---------|---------|
| 消化率100%超の費目あり | 予算超過の原因分析 + 対策提案 |
| 上位3社の構成比が80%超 | 同一業者の工事間単価比較（SITE-05対応: 分散提案ではなく単価差分析） |
| 月次支出が前月比+30%以上 | 急増原因の確認要請 |
| 材料費がマイナス | 相殺処理の説明 + 最適化提案 |

### 7.2.1 AIチャットボット初回体験設計（UX-03対応）

AIチャットボットに不慣れなユーザー（建設業の現場代理人）が、最初のアクセスで「何を聞けばいいかわからない」状態にならないための設計。

**サジェストボタン4個**:

| ボタンラベル | 送信される質問 | 想定利用場面 |
|------------|-------------|-----------|
| 月末レポートの下書き | 「今月の工事進捗と予算状況をまとめてください」 | 月末の報告書作成前 |
| 超過費目の詳細 | 「予算超過している費目の原因と対策を教えてください」 | 本社からの問い合わせ対応 |
| 先月との比較 | 「先月と今月の支出を比較して、変動が大きい項目を教えてください」 | 月次推移の把握 |
| 改善提案 | 「コスト削減できる可能性がある項目を提案してください」 | 利益率改善の検討 |

**Dify conversation_opener 設定値**:

```yaml
conversation_opener:
  enabled: true
  text: |
    工事予算管理AIアシスタントです。
    以下のボタンから質問を選ぶか、自由に質問してください。
  suggested_questions:
    - "今月の工事進捗と予算状況をまとめてください"
    - "予算超過している費目の原因と対策を教えてください"
    - "先月と今月の支出を比較して、変動が大きい項目を教えてください"
    - "コスト削減できる可能性がある項目を提案してください"
```

**ダッシュボード連携フロー**:

```
[Sitesダッシュボード page1]
  予算超過アラート「法定福利費 126.2%」
    └─ 「AIに詳しく聞く」リンク
         └─ [page4 AIチャット] にプリセット質問で遷移
              └─ 「法定福利費が126.2%超過しています。原因と対策を教えてください」
```

### 7.2.2 外注費比率AIプロンプト改善仕様（SITE-05対応）

建設業の下請関係は長年の信頼に基づくものであり、AIが「取引先を分散しましょう」と安易に提案することは現場の実態に合わない。プロンプトに以下の制約条件を追加する。

**プロンプト制約条件**:

```
# 改善提案のルール

1. 建設業の下請関係は長期的な信頼に基づく。単純な価格比較や取引先分散の提案は行わない
2. 「取引先集中リスク」という表現は使用しない。代わりに「同一業者の工事間単価比較」の切り口で分析する
3. 地域・工種の実態を考慮する。特定の工種（港湾工事の海上作業等）では技術を持つ業者が限られることを理解する
4. 改善提案は以下の形式で行う:
   - 「川越建設の外注費は工事Aでは@XX円/m3、工事Bでは@YY円/m3。差額の理由を確認する価値がある」
   - 「法定福利費が予算を26.2%超過。労務単価の見直しまたは次回予算の増額を検討」
5. 感情的・主観的な表現は避け、数値データに基づく客観的な分析を行う
```

**改善提案例（適切な表現）**:

| 状況 | 不適切な提案 | 適切な提案 |
|------|-----------|----------|
| 川越建設が40.7% | 「取引先を分散してリスクを低減しましょう」 | 「川越建設の外注費は工事Aでは@XX円/m3、工事Bでは@YY円/m3。差額ZZ円の要因を確認してください」 |
| 法定福利費126.2% | 「法定福利費を削減しましょう」 | 「法定福利費が予算690,039円に対し870,940円（+26.2%）。次回の実行予算で見直しを推奨」 |
| 材料費がマイナス | 「材料費に異常があります」 | 「材料費-3,862,901円は桜島生コンクリートの相殺（4,980,150円）が原因。会計処理として正常」 |

### 7.3 データ取扱方針（SEC-02対応）

本システムではGAS APIを経由してDify Cloud（外部SaaS）にデータを送信する。機密データの取扱いについて以下の方針を定める。

#### 7.3.1 Dify Cloudのデータ保持ポリシー

- Dify Cloudはユーザーデータを暗号化して保管し、会話データは設定された保持期間後に自動削除される
- LLM（GPT-4o等）への送信データはモデルの学習には使用されない（API利用規約に明記）
- ただし、会話ログはDify Cloud上に一定期間保持される点に注意

#### 7.3.2 匿名化APIオプション

GAS APIに`anonymize=true`パラメータを追加済み。有効化すると以下の匿名化が適用される:

| 対象 | 匿名化前 | 匿名化後 |
|------|---------|---------|
| 業者名 | 川越建設 | V001 |
| 工事名 | 海潟漁港R7-1 | P004 |
| 所長名 | 上村和弘 | 所長A |
| 金額データ | そのまま | そのまま（分析に必要） |

Dify側のHTTP RequestノードのURLに`&anonymize=true`を追加するだけで有効化可能。

#### 7.3.3 将来のSelf-hosted移行パス

データの外部送信を完全に排除するには、Dify Self-hosted版（Docker）を社内サーバーに構築する方法がある。

| 項目 | Dify Cloud（現在） | Dify Self-hosted（将来） |
|------|-------------------|------------------------|
| データ保管場所 | Dify Cloud（外部） | 社内サーバー |
| 初期構築コスト | 無料 | サーバー費用 + 構築工数 |
| 運用負荷 | なし | サーバー保守が必要 |
| セキュリティ | 匿名化APIで対応 | データが社外に出ない |

PoC段階では匿名化APIオプション付きのDify Cloudを使用し、本格運用時にSelf-hosted移行を検討する。

### 7.4 将来構想: RAG + 予実軌跡ドキュメント化

**Phase 1（現在の提案範囲）**: GAS API経由のリアルタイムデータ取得

**Phase 2（将来構想）**:
- 月次スナップショットをMarkdown化し、Dify Knowledge Baseに蓄積
- 時系列RAGにより「去年の同時期と比べてどうか」「前回の工事と比較」が可能に
- 全6工事のデータを横断検索し、所長別・工種別の傾向分析

---

## 第8章: モックアップ解説

### 8.1 Sitesモックアップ（7ページ）

mockup_sites.htmlは、Google Sitesで構築する経営ダッシュボードの完成イメージ。

| ページ | セクション | 内容 | ビュー |
|--------|-----------|------|--------|
| 1. トップページ | 工事予実管理 | KPIカード4枚 + 予算超過アラート + 月別推移グラフ | 経営者/所長 |
| 2. 経営分析 | 工事予実管理 | 予算vs実績グラフ + 予実対比テーブル | 経営者 |
| 3. 現場管理 | 工事予実管理 | 費目別円グラフ + 業者別棒グラフ + 月次推移 + 操作ボタン | 所長 |
| 4. AIチャット | 工事予実管理 | データ分析AI + 改善提案AI（Dify iframe） | 経営者/所長 |
| 5. 全社経営概況 | 経営診断 | 前年度vs今年度の損益比較 + 今年度受注工事の粗利率 | 経営者 |
| 6. 工事別パフォーマンス | 経営診断 | 粗利率ランキング + 原価構造比較 + 予算消化率 + 所長別まとめ | 経営者 |
| 7. コスト改善 | 経営診断 | 外注単価格差の可視化 + 改善効果試算 | 経営者 |

**経営者ビュー vs 所長ビュー**:
- サイドバーの「経営者ビュー/所長ビュー」切替で、表示KPIが変わる
- 経営者ビュー: 工事益率/純工事益率/予算消化率/累計支出
- 所長ビュー: 当月入力件数/累計入力件数/予算消化率/累計支出
- 経営診断セクション（ページ5-7）は経営者ビュー専用

### 8.2 Sheetsモックアップ（7タブ）

mockup_sheets.htmlは、Google Sheetsで構築する入力・計算システムの完成イメージ。

**入力層（緑タブ）**:

| タブ | 内容 | 入力セル色 | 自動計算セル色 |
|------|------|----------|-------------|
| 支払明細入力 | 1行1取引（82取引想定） | 緑(#E8F5E9) | 灰(#EEEEEE) |
| 予算設定 | 経費コード別の年間予算（26行） | 緑(#E8F5E9) | 灰(#EEEEEE) |
| 月次調整 | 機械稼働台数・労務人工数 | 緑(#E8F5E9) | 灰(#EEEEEE) |

**計算・出力層（青タブ）**:

| タブ | 内容 | 操作権限 |
|------|------|---------|
| 経費コード別月別集計 | 24シート相当を1シートに集約 | 閲覧のみ |
| 予実対比 | 予算vs実績+消化率+アラート | 閲覧のみ |
| 工事月報 | 現行工事月報シート相当の帳票 | 閲覧のみ |
| ダッシュボード | Sites埋め込み用のKPI・グラフ | 閲覧のみ |

**ファイル境界**:
- 工事別スプレッドシート: 各工事に1ファイル（入力層+マスター層+計算層+出力層）
- 全社管理スプレッドシート: 全工事を横断（経営診断データ層）

---

## 第9章: 導入計画

### 9.1 導入ロードマップ（Phase A実装済み → PoC → パイロット）

**Phase Aの実装状況**: GAS 7ファイル（約145KB）の開発は完了。以下はデプロイ以降の計画。

#### Step 1: PoC構築（1週間）-- 動くものを見せる

**目的**: テストスプレッドシートにGASをデプロイし、海潟漁港の実データで動作確認

**作業内容**:
- Google Spreadsheet新規作成 → GAS 7ファイルをコピー
- `initProjectTemplate('P004')` 実行でシート自動生成
- Excel月報から10月-1月の支払実績を手入力（20-30行程度）
- E2Eテスト: 所長入力→集計→予算健康度→API確認

**検証基準**:
- template.gsでシート自動生成が成功すること
- 支払明細入力のカスケードDDが正しく動作すること
- aggregation.gsの月次集計が既存Excel値と一致すること
- budget_health.gsの信号判定が妥当と確認できること
- api.gsのmode=health, mode=summaryが正しいJSONを返すこと

#### Step 2: 提案デモ（1週間）

**目的**: 動くPoCをベースに森組へ提案

**提案の構成（60分想定）**:
1. 課題の共有（10分）: 32シート、11件の品質問題を提示
2. ライブデモ（20分）: テストスプレッドシートで実際に操作
3. 導入効果の説明（10分）: Before/After（入力シート32→3、品質問題11→3）
4. 導入計画とコスト（10分）: パイロット→本番切替の流れ
5. 質疑応答（10分）

#### Step 3: パイロット導入（1ヶ月並行運用）

**目的**: 海潟漁港R7-1工区で既存Excel月報と新システムを1ヶ月並行運用

**作業内容**:
- 森組のGoogle Workspaceに本番スプレッドシートを作成
- 10月-2月の支払実績をExcel月報から転記
- 所長向けトレーニング: 支払明細入力（30分）
- 事務員向けトレーニング: 相殺入力（30分）
- 3月度の支払を新旧両方に入力

**移行判定基準**:
- 新システムの自動集計結果が既存Excelの正値と一致（差異0円）
- 所長が1人で支払入力を完了できること
- 事務員が相殺入力を完了できること
- 予算健康度の信号判定が妥当と所長が認めること

#### Step 4: Phase B/C展開（パイロット成功後）

- Phase B: hub.gsの予算健康度対応、Google Sitesダッシュボード本番化
- Phase C: Dify AIチャットボットの接続、全社横断分析

### 9.2 既存Excelとの並行運用方針

- 第5段階の2週間は、既存Excelでの月次業務と並行して新システムにもデータ入力
- 両方の集計結果を照合し、不一致があれば新システム側を修正
- 並行運用期間中に問題がなければ、翌月から新システムに完全移行
- 移行後も既存Excelはアーカイブとして保持（削除しない）

---

## 第10章: 従来の実行予算書との対比

### 10.1 紙/PDF時代の管理フロー（実行予算書480ページ）

(株)森組では、各工事の着工時に実行予算書（PDF）を作成していた。480ページに及ぶ実行予算書には、6工事分の以下の情報が含まれる:

- 工事概要（工事名、所長、工期、請負額）
- 経費コード別の予算配分
- 支払先（業者）別の予算配分
- 入札結果（発注機関、落札額、落札率）

この実行予算書は「予算の設定」にのみ使用され、月次の「実績管理」は別途Excelで行われていた。予算と実績が物理的に別ファイル・別フォーマットであるため、予実対比は月末の手作業に依存していた。

### 10.2 Excel移行後の現在の管理フロー（28シート+支払い内訳）

Excel化により「予算」と「実績」が同一ファイル内に格納されたが、28シートの構造が複雑で、以下の問題が残存:

- 予算消化率の確認に複数シートを行き来する必要
- 累計計算がシートコピー運用に依存（CRT-001）
- セル参照の手動設定ミス（CRT-002/003/004）
- 全社横断の比較が不可能（工事別に独立したExcelファイル）

### 10.3 新システム移行後の管理フロー（3入力シート+自動化）

新システムでは:

- 入力は3シートのみ。費目・業者はドロップダウンから選択
- 集計・累計・相殺は全自動。計算ミスが構造的に発生しない
- 予算超過は閾値（80%/100%）で自動通知
- 全社員がダッシュボードで即時確認可能
- AIチャットボットで対話型の分析が可能

### 10.4 変化の一覧表

| 観点 | 紙/PDF時代 | 現行Excel | 新システム |
|------|-----------|----------|----------|
| 予算設定 | 実行予算書（紙/PDF） | Excelシート内に記載 | 予算設定シート（3入力シートの1つ） |
| 予算消化確認 | 経理に問合せ | 月末に手集計 | リアルタイム自動（ダッシュボード） |
| 業者別支払把握 | 台帳手書き | シート手集計 | 自動集計 + AI分析 |
| 全社横断比較 | 不可能 | 困難（ファイル別管理） | ダッシュボード1画面（6工事横断） |
| 異常値検知 | 事後発覚 | 目視チェック | 80%超過で即時メール通知 |
| 月次報告書 | 手書き+捺印 | Excel手作成 | 自動PDF生成+メール配信 |
| データ密度 | -- | 20.3%（80%が空セル） | フラットテーブルで必要データのみ |
| 品質問題 | 不明（検査未実施） | 11件検出（critical 4件） | 8件を自動根絶 |
| 入力セル数 | -- | 約3,255 | 約800（75%削減） |
| 相殺処理 | 手計算 | 手計算 | 自動追跡+持ち越し管理 |
| AI分析 | なし | なし | 自然言語で質問→即回答 |

---

## 付録: 参照ファイル一覧

| ファイル | パス | 用途 |
|---------|------|------|
| 工事月報JSON | Excel分析/output/海潟漁港R7-1工事月報（12月度）/final_output.json | 第2-4章のデータソース |
| 支払い内訳JSON | Excel分析/output/月度別支払い内訳/final_output.json | 第2-4章のデータソース |
| 品質監査JSON | Excel分析/output/海潟漁港R7-1工事月報（12月度）/quality_audit_report.json | 第2章4節のデータソース |
| フィージビリティ | Excel分析/output/feasibility_report.md | 第2-5章の設計根拠 |
| 実行予算書分析 | .serena/memories/report_structure_analysis.md | 第3章のデータソース |
| Sitesモック | Dify_project/output/mockup_sites.html | 第8章1節のモックアップ |
| Sheetsモック | Dify_project/output/mockup_sheets.html | 第8章2節のモックアップ |
| 設計書 | Dify_project/output/system_design_proposal.md | 第5-7章の設計詳細 |

---

**文書バージョン**: 2.0（Phase A実装完了に伴う改訂: GAS構成更新、予算健康度追加、導入計画刷新）
**初版作成日**: 2026-02-17
**改訂日**: 2026-02-19
