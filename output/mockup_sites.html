<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>森組 経営ダッシュボード</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: 'Segoe UI', 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif; }
  .sidebar { transition: transform 0.3s ease; }
  .nav-item { cursor: pointer; transition: background-color 0.2s; }
  .nav-item:hover { background-color: rgba(255,255,255,0.1); }
  .nav-item.active { background-color: #1565C0; }
  .page-section { display: none; }
  .page-section.active { display: block; }
  .kpi-card { border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  .chat-bubble { max-width: 85%; border-radius: 12px; padding: 12px 16px; margin-bottom: 12px; line-height: 1.6; white-space: pre-line; }
  .chat-user { background-color: #1565C0; color: white; margin-left: auto; }
  .chat-ai { background-color: #F1F3F4; color: #333; margin-right: auto; }
  .view-toggle {
    display: flex;
    gap: 4px;
    background: rgba(255,255,255,0.15);
    border-radius: 20px;
    padding: 3px;
    margin-top: 10px;
  }
  .view-btn {
    flex: 1;
    text-align: center;
    font-size: 10px;
    padding: 4px 8px;
    border-radius: 16px;
    border: none;
    cursor: pointer;
    color: rgba(255,255,255,0.8);
    background: transparent;
    transition: background-color 0.2s, color 0.2s;
    font-weight: 600;
    white-space: nowrap;
  }
  .view-btn:hover {
    background: rgba(255,255,255,0.1);
  }
  .view-btn.active {
    background: #ffffff;
    color: #1565C0;
  }
  /* UX-02: 3秒ダッシュボード -- 信号表示 */
  .signal-large {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    color: #fff;
    border: 3px solid rgba(0,0,0,0.1);
  }
  .signal-red { background-color: #E53935; }
  .signal-yellow { background-color: #FDD835; color: #333; }
  .signal-green { background-color: #2E7D32; }
  /* UX-03: AIチャット サジェストボタン */
  .suggest-btn {
    display: inline-block;
    padding: 8px 16px;
    margin: 4px;
    border-radius: 20px;
    background: #E3F2FD;
    border: 1px solid #90CAF9;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.2s;
  }
  .suggest-btn:hover {
    background: #BBDEFB;
  }
  /* UX-04: 色覚多様性対応ラベル */
  .status-label {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 1px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
  }
  .status-over { background-color: #E53935; color: #fff; }
  .status-warn { background-color: #FDD835; color: #333; }
  .status-normal { background-color: #2E7D32; color: #fff; }
  .status-watch { background-color: #E0E0E0; color: #555; }
  /* 全現場サマリーカードのレスポンシブ */
  .site-cards-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 32px;
  }
  @media (max-width: 1023px) {
    .site-cards-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  @media (max-width: 639px) {
    .site-cards-grid {
      grid-template-columns: 1fr;
    }
  }
  @media (max-width: 767px) {
    .sidebar { transform: translateX(-100%); position: fixed; z-index: 50; height: 100vh; }
    .sidebar.open { transform: translateX(0); }
  }
  @media (min-width: 768px) {
    .sidebar { transform: translateX(0) !important; }
    .hamburger-btn { display: none !important; }
  }
  /* UX-04: 高コントラストモード（WCAG AA準拠） */
  .high-contrast .signal-red { background-color: #B71C1C; border-color: #000; }
  .high-contrast .signal-yellow { background-color: #E65100; color: #fff; border-color: #000; }
  .high-contrast .signal-green { background-color: #1B5E20; border-color: #000; }
  .high-contrast .status-over { background-color: #B71C1C; color: #fff; border: 2px solid #000; }
  .high-contrast .status-warn { background-color: #E65100; color: #fff; border: 2px solid #000; }
  .high-contrast .status-normal { background-color: #1B5E20; color: #fff; border: 2px solid #000; }
  .high-contrast .status-watch { background-color: #424242; color: #fff; border: 2px solid #000; }
  .high-contrast .kpi-card { border: 2px solid #333; }
  .high-contrast .bg-red-50 { background-color: #FFCDD2; }
  .high-contrast .bg-yellow-50 { background-color: #FFE0B2; }
  .high-contrast .text-gray-500 { color: #333; }
  .high-contrast .text-gray-400 { color: #555; }
  .hc-toggle {
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,0.4);
    background: transparent;
    color: rgba(255,255,255,0.8);
    cursor: pointer;
    transition: background 0.2s;
    white-space: nowrap;
  }
  .hc-toggle:hover { background: rgba(255,255,255,0.15); }
  .hc-toggle.active { background: #fff; color: #0D47A1; border-color: #fff; }
</style>
</head>
<body class="bg-white text-gray-800 m-0 p-0">

<!-- Hamburger Button (mobile) -->
<button class="hamburger-btn fixed top-3 left-3 z-50 bg-[#0D47A1] text-white p-2 rounded-md md:hidden" onclick="toggleSidebar()">
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <line x1="3" y1="6" x2="21" y2="6"></line>
    <line x1="3" y1="12" x2="21" y2="12"></line>
    <line x1="3" y1="18" x2="21" y2="18"></line>
  </svg>
</button>

<!-- Overlay (mobile) -->
<div id="overlay" class="fixed inset-0 bg-black bg-opacity-40 z-40 hidden" onclick="toggleSidebar()"></div>

<div class="flex min-h-screen">
  <!-- Sidebar -->
  <nav class="sidebar w-64 min-w-[256px] bg-[#0D47A1] text-white flex-shrink-0 flex flex-col fixed md:sticky top-0 h-screen overflow-y-auto" id="sidebar">
    <div class="p-5 border-b border-blue-800">
      <h1 class="text-lg font-bold tracking-wide">森組</h1>
      <p class="text-xs text-blue-200 mt-1">経営ダッシュボード</p>
      <div class="view-toggle">
        <button class="view-btn active" data-view="executive" onclick="switchView('executive')">経営者ビュー</button>
        <button class="view-btn" data-view="manager" onclick="switchView('manager')">所長ビュー</button>
      </div>
      <!-- UX-04: 高コントラストトグル -->
      <div class="mt-2 text-center">
        <button class="hc-toggle" id="hc-toggle-btn" onclick="toggleHighContrast()">高コントラスト</button>
      </div>
    </div>

    <!-- Section: 経営者ビュー -->
    <div id="nav-section-executive" class="nav-executive-section">
      <div class="px-4 pt-5 pb-2">
        <span class="text-[10px] uppercase tracking-widest text-blue-300 font-semibold">経営者ビュー</span>
      </div>
      <div class="nav-item active flex items-center gap-3 px-5 py-3 text-sm" data-page="page0" onclick="showPage('page0', this)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect></svg>
        全現場サマリー
      </div>

      <!-- 現場別（API動的生成対象） -->
      <div class="px-4 pt-4 pb-1">
        <span class="text-[10px] uppercase tracking-widest text-blue-300 font-semibold">現場別</span>
      </div>
      <div id="sidebar-sites">
        <!-- フォールバック: API失敗時にこのハードコード値を表示 -->
        <div class="nav-item flex items-center gap-3 px-5 py-2 text-xs" data-page="page1" onclick="showPage('page1', this)">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5" fill="#FDD835"/></svg>
          <span>海潟漁港R7-1<span class="text-blue-300 ml-1">(上村)</span></span>
        </div>
        <div class="nav-item flex items-center gap-3 px-5 py-2 text-xs nav-site-stub" data-page="page1" onclick="showPage('page1', this)">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5" fill="#FDD835"/></svg>
          <span>野尻川除石<span class="text-blue-300 ml-1">(池田)</span></span>
        </div>
        <div class="nav-item flex items-center gap-3 px-5 py-2 text-xs nav-site-stub" data-page="page1" onclick="showPage('page1', this)">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5" fill="#FDD835"/></svg>
          <span>持木川中流部<span class="text-blue-300 ml-1">(中原)</span></span>
        </div>
      </div>
    </div>

    <!-- Section: 工事予実管理（現場詳細） -->
    <div id="nav-section-site-detail">
      <div class="px-4 pt-4 pb-2 border-t border-blue-800 mt-2">
        <span class="text-[10px] uppercase tracking-widest text-blue-300 font-semibold">現場詳細</span>
      </div>
      <div class="nav-item flex items-center gap-3 px-5 py-3 text-sm" data-page="page1" onclick="showPage('page1', this)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect></svg>
        トップページ
      </div>
      <div class="nav-item flex items-center gap-3 px-5 py-3 text-sm" data-page="page2" onclick="showPage('page2', this)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10M12 20V4M6 20v-6"></path></svg>
        経営分析
      </div>
      <div class="nav-item flex items-center gap-3 px-5 py-3 text-sm" data-page="page3" onclick="showPage('page3', this)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"></circle><path d="M12 3v9l6 3"></path></svg>
        現場管理
      </div>
      <div id="nav-health-check" class="nav-item flex items-center gap-3 px-5 py-3 text-sm" data-page="page35" onclick="showPage('page35', this)" style="display:none;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
        予算ヘルスチェック
      </div>
      <div class="nav-item flex items-center gap-3 px-5 py-3 text-sm" data-page="page4" onclick="showPage('page4', this)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"></path></svg>
        AIチャット
      </div>
    </div>

    <!-- Section: 経営診断 -->
    <div id="nav-section-diagnosis">
      <div class="px-4 pt-5 pb-2 border-t border-blue-800 mt-2">
        <span class="text-[10px] uppercase tracking-widest text-blue-300 font-semibold">経営診断</span>
      </div>
      <div class="nav-item flex items-center gap-3 px-5 py-3 text-sm" data-page="page5" onclick="showPage('page5', this)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path></svg>
        全社経営概況
      </div>
      <div class="nav-item flex items-center gap-3 px-5 py-3 text-sm" data-page="page6" onclick="showPage('page6', this)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1"></rect></svg>
        工事別パフォーマンス
      </div>
      <div class="nav-item flex items-center gap-3 px-5 py-3 text-sm" data-page="page7" onclick="showPage('page7', this)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
        コスト改善
      </div>
    </div>

    <div class="mt-auto p-4 border-t border-blue-800">
      <p class="text-[10px] text-blue-300">(株)森組 v1.0</p>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="flex-1 p-4 md:p-8 min-w-0">

    <!-- ============================================================ -->
    <!-- PAGE 0: 全現場サマリー（経営者ビュー デフォルト） -->
    <!-- ============================================================ -->
    <div id="page0" class="page-section active">
      <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-1">全現場サマリー</h2>
      <p id="summary-subtitle" class="text-sm text-gray-500 mb-6">(株)森組 -- 全6工事の横断ビュー</p>

      <!-- 全体KPI（API動的更新対象） -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="kpi-card bg-white border border-gray-200 p-5">
          <p class="text-xs text-gray-500 mb-1">進行中工事</p>
          <p id="summary-active" class="text-3xl font-bold text-[#1565C0]">3<span class="text-base font-normal text-gray-500 ml-1">件</span></p>
        </div>
        <div class="kpi-card bg-white border border-gray-200 p-5">
          <p class="text-xs text-gray-500 mb-1">完了工事</p>
          <p id="summary-completed" class="text-3xl font-bold text-gray-500">3<span class="text-base font-normal text-gray-500 ml-1">件</span></p>
        </div>
        <div class="kpi-card bg-white border border-gray-200 p-5">
          <p class="text-xs text-gray-500 mb-1">合計請負額</p>
          <p id="summary-total-amount" class="text-3xl font-bold text-[#1565C0]">4.22<span class="text-base font-normal text-gray-500 ml-1">億円</span></p>
        </div>
        <div class="kpi-card bg-white border border-gray-200 p-5">
          <p class="text-xs text-gray-500 mb-1">平均工事益率</p>
          <p id="summary-avg-profit" class="text-3xl font-bold text-[#1565C0]">20.8<span class="text-base font-normal text-gray-500 ml-1">%</span></p>
        </div>
      </div>

      <!-- 全体信号表示（API動的更新対象） -->
      <div id="summary-signal-bar" class="flex items-center gap-5 mb-8 bg-white border border-gray-200 rounded-lg p-4">
        <div class="flex items-center gap-3">
          <div id="summary-signal-icon" class="signal-large signal-yellow">!</div>
          <div>
            <p id="summary-signal-text" class="text-lg font-bold text-gray-800">全社ステータス: 注意</p>
            <p id="summary-signal-detail" class="text-xs text-gray-500">予算超過アラート: 合計5件（超過3件 / 注意2件）</p>
          </div>
        </div>
      </div>

      <!-- 工事一覧カード（6工事） -->
      <h3 class="text-base font-bold text-gray-800 mb-4">工事一覧</h3>
      <div class="site-cards-grid" id="site-cards-grid">
        <!-- 進行中: 海潟漁港R7-1 -->
        <div style="background:white; border-radius:8px; padding:16px; box-shadow:0 2px 4px rgba(0,0,0,0.1); border-left:4px solid #FDD835; cursor:pointer;" onclick="showPage('page1', document.querySelector('.nav-item[data-page=&quot;page1&quot;]'))">
          <div style="font-weight:bold; font-size:15px; color:#333;">海潟漁港R7-1</div>
          <div style="color:#666; font-size:12px; margin-top:2px;">上村和弘 | 進行中</div>
          <div style="color:#888; font-size:11px; margin-top:4px;">請負額: 43,000,000円</div>
          <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:flex-end;">
            <div style="text-align:center;">
              <div style="font-size:11px; color:#888;">工事益率</div>
              <div style="font-weight:bold; font-size:16px; color:#E53935;">14.0%</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:11px; color:#888;">消化率</div>
              <div style="font-weight:bold; font-size:16px; color:#1565C0;">47.5%</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:11px; color:#888;">信号</div>
              <div><span class="status-label status-warn">&#x25B2; 注意</span></div>
            </div>
          </div>
        </div>
        <!-- 進行中: 野尻川除石 -->
        <div style="background:white; border-radius:8px; padding:16px; box-shadow:0 2px 4px rgba(0,0,0,0.1); border-left:4px solid #FDD835; cursor:pointer;">
          <div style="font-weight:bold; font-size:15px; color:#333;">野尻川除石</div>
          <div style="color:#666; font-size:12px; margin-top:2px;">池田豊 | 進行中</div>
          <div style="color:#888; font-size:11px; margin-top:4px;">請負額: 76,600,000円</div>
          <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:flex-end;">
            <div style="text-align:center;">
              <div style="font-size:11px; color:#888;">工事益率</div>
              <div style="font-weight:bold; font-size:16px; color:#1565C0;">25.6%</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:11px; color:#888;">消化率</div>
              <div style="font-weight:bold; font-size:16px; color:#1565C0;">62.3%</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:11px; color:#888;">信号</div>
              <div><span class="status-label status-warn">&#x25B2; 注意</span></div>
            </div>
          </div>
        </div>
        <!-- 進行中: 持木川中流部 -->
        <div style="background:white; border-radius:8px; padding:16px; box-shadow:0 2px 4px rgba(0,0,0,0.1); border-left:4px solid #2E7D32; cursor:pointer;">
          <div style="font-weight:bold; font-size:15px; color:#333;">持木川中流部</div>
          <div style="color:#666; font-size:12px; margin-top:2px;">中原輝竜 | 進行中</div>
          <div style="color:#888; font-size:11px; margin-top:4px;">請負額: 160,380,000円</div>
          <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:flex-end;">
            <div style="text-align:center;">
              <div style="font-size:11px; color:#888;">工事益率</div>
              <div style="font-weight:bold; font-size:16px; color:#EF6C00;">15.4%</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:11px; color:#888;">消化率</div>
              <div style="font-weight:bold; font-size:16px; color:#1565C0;">38.7%</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:11px; color:#888;">信号</div>
              <div><span class="status-label status-normal">&#x25CF; 正常</span></div>
            </div>
          </div>
        </div>
        <!-- 完了: 境川R2-2 -->
        <div style="background:#F5F5F5; border-radius:8px; padding:16px; box-shadow:0 2px 4px rgba(0,0,0,0.05); border-left:4px solid #9E9E9E; opacity:0.7;">
          <div style="font-weight:bold; font-size:15px; color:#666;">境川R2-2工区</div>
          <div style="color:#999; font-size:12px; margin-top:2px;">中村竜一 | 完了</div>
          <div style="color:#999; font-size:11px; margin-top:4px;">請負額: 32,107,014円</div>
          <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:flex-end;">
            <div style="text-align:center;">
              <div style="font-size:11px; color:#999;">工事益率</div>
              <div style="font-weight:bold; font-size:16px; color:#888;">16.6%</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:11px; color:#999;">消化率</div>
              <div style="font-weight:bold; font-size:16px; color:#888;">100%</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:11px; color:#999;">信号</div>
              <div><span class="status-label" style="background-color:#9E9E9E; color:#fff;">完了</span></div>
            </div>
          </div>
        </div>
        <!-- 完了: 森林基幹道 -->
        <div style="background:#F5F5F5; border-radius:8px; padding:16px; box-shadow:0 2px 4px rgba(0,0,0,0.05); border-left:4px solid #9E9E9E; opacity:0.7;">
          <div style="font-weight:bold; font-size:15px; color:#666;">森林基幹道 海瀬麓線1工区</div>
          <div style="color:#999; font-size:12px; margin-top:2px;">中村竜一 | 完了</div>
          <div style="color:#999; font-size:11px; margin-top:4px;">請負額: 78,600,000円</div>
          <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:flex-end;">
            <div style="text-align:center;">
              <div style="font-size:11px; color:#999;">工事益率</div>
              <div style="font-weight:bold; font-size:16px; color:#888;">24.1%</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:11px; color:#999;">消化率</div>
              <div style="font-weight:bold; font-size:16px; color:#888;">100%</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:11px; color:#999;">信号</div>
              <div><span class="status-label" style="background-color:#9E9E9E; color:#fff;">完了</span></div>
            </div>
          </div>
        </div>
        <!-- 完了: 境川2-1 -->
        <div style="background:#F5F5F5; border-radius:8px; padding:16px; box-shadow:0 2px 4px rgba(0,0,0,0.05); border-left:4px solid #9E9E9E; opacity:0.7;">
          <div style="font-weight:bold; font-size:15px; color:#666;">境川2-1工区</div>
          <div style="color:#999; font-size:12px; margin-top:2px;">中村竜一 | 完了</div>
          <div style="color:#999; font-size:11px; margin-top:4px;">請負額: 31,296,970円</div>
          <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:flex-end;">
            <div style="text-align:center;">
              <div style="font-size:11px; color:#999;">工事益率</div>
              <div style="font-weight:bold; font-size:16px; color:#888;">28.9%</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:11px; color:#999;">消化率</div>
              <div style="font-weight:bold; font-size:16px; color:#888;">100%</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:11px; color:#999;">信号</div>
              <div><span class="status-label" style="background-color:#9E9E9E; color:#fff;">完了</span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- 全現場横串アラートテーブル -->
      <div class="bg-white border border-gray-200 rounded-lg p-5 mb-8">
        <h3 class="text-base font-bold mb-3 text-gray-800">全現場 予算超過アラート一覧</h3>
        <div class="flex flex-wrap gap-4 mb-3">
          <span class="status-label status-over">&#x2716; 超過: 3件</span>
          <span class="status-label status-warn">&#x25B2; 注意: 2件</span>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b-2 border-gray-300">
                <th class="text-left py-2 px-3 text-gray-500 font-medium">工事名</th>
                <th class="text-left py-2 px-3 text-gray-500 font-medium">費目</th>
                <th class="text-right py-2 px-3 text-gray-500 font-medium">消化率</th>
                <th class="text-center py-2 px-3 text-gray-500 font-medium">ステータス</th>
              </tr>
            </thead>
            <tbody>
              <tr class="bg-red-50 border-b border-gray-100">
                <td class="py-2 px-3 font-medium">海潟漁港R7-1</td>
                <td class="py-2 px-3">法定福利費</td>
                <td class="py-2 px-3 text-right font-bold text-[#E53935]">126.2%</td>
                <td class="py-2 px-3 text-center"><span class="status-label status-over">&#x2716; 超過</span></td>
              </tr>
              <tr class="bg-red-50 border-b border-gray-100">
                <td class="py-2 px-3 font-medium">海潟漁港R7-1</td>
                <td class="py-2 px-3">地代家賃</td>
                <td class="py-2 px-3 text-right font-bold text-[#E53935]">113.7%</td>
                <td class="py-2 px-3 text-center"><span class="status-label status-over">&#x2716; 超過</span></td>
              </tr>
              <tr class="bg-red-50 border-b border-gray-100">
                <td class="py-2 px-3 font-medium">海潟漁港R7-1</td>
                <td class="py-2 px-3">水道光熱費</td>
                <td class="py-2 px-3 text-right font-bold text-[#E53935]">113.0%</td>
                <td class="py-2 px-3 text-center"><span class="status-label status-over">&#x2716; 超過</span></td>
              </tr>
              <tr class="bg-yellow-50 border-b border-gray-100">
                <td class="py-2 px-3 font-medium">野尻川除石</td>
                <td class="py-2 px-3">機械経費</td>
                <td class="py-2 px-3 text-right font-bold text-[#EF6C00]">95.2%</td>
                <td class="py-2 px-3 text-center"><span class="status-label status-warn">&#x25B2; 注意</span></td>
              </tr>
              <tr class="bg-yellow-50 border-b border-gray-100">
                <td class="py-2 px-3 font-medium">持木川中流部</td>
                <td class="py-2 px-3">外注費</td>
                <td class="py-2 px-3 text-right font-bold text-[#EF6C00]">88.5%</td>
                <td class="py-2 px-3 text-center"><span class="status-label status-warn">&#x25B2; 注意</span></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ============================================================ -->
    <!-- PAGE 1: トップページ（工事予実管理 KPI） -->
    <!-- ============================================================ -->
    <div id="page1" class="page-section">
      <!-- 現場名ヘッダー + 工事セレクタ -->
      <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-0">海潟漁港海岸保全施設整備連携工事(R7-1工区)</h2>
            <p class="text-sm text-gray-500 mt-1">現場代理人: 上村和弘 | (株)森組</p>
          </div>
          <div class="flex items-center gap-3">
            <select class="border border-gray-300 rounded-md px-3 py-2 text-sm bg-white" onchange="switchProject(this.value)">
              <option selected>海潟漁港R7-1（上村）</option>
              <option>野尻川除石（池田）</option>
              <option>持木川中流部（中原）</option>
              <option>境川R2-2（中村）[完了]</option>
              <option>森林基幹道（中村）[完了]</option>
              <option>境川2-1（中村）[完了]</option>
            </select>
          </div>
        </div>
        <div class="mt-2">
          <a href="#" onclick="showPage('page0', document.querySelector('.nav-item[data-page=&quot;page0&quot;]')); return false;" class="text-sm text-[#1565C0] hover:underline">&#x2190; 全現場サマリーに戻る</a>
        </div>
      </div>

      <!-- UX-02: 大型信号表示 -->
      <div class="flex items-center gap-5 mb-6 bg-white border border-gray-200 rounded-lg p-4">
        <div class="flex items-center gap-3">
          <div id="site-signal" class="signal-large signal-yellow">!</div>
          <div>
            <p id="site-status-text" class="text-lg font-bold text-gray-800">全体ステータス: 注意</p>
            <p class="text-xs text-gray-500">予算超過 3件 / 消化済 2件 / 監視 1件</p>
          </div>
        </div>
        <div class="flex items-center gap-2 ml-auto">
          <div class="signal-large signal-red" style="width:32px;height:32px;font-size:10px;" title="超過">&#x2716;</div>
          <div class="signal-large signal-yellow" style="width:32px;height:32px;font-size:10px;border:3px solid #EF6C00;" title="注意">!</div>
          <div class="signal-large signal-green" style="width:32px;height:32px;font-size:10px;opacity:0.3;" title="正常">&#x25CF;</div>
        </div>
      </div>

      <!-- KPI Cards: Executive View -->
      <div id="kpi-executive" class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="kpi-card bg-white border border-gray-200 p-5">
          <p class="text-xs text-gray-500 mb-1">工事益率</p>
          <p id="kpi-profit-rate" class="text-3xl font-bold text-[#1565C0]">58.9%</p>
        </div>
        <div class="kpi-card bg-white border border-gray-200 p-5">
          <p class="text-xs text-gray-500 mb-1">純工事益率</p>
          <p id="kpi-net-profit-rate" class="text-3xl font-bold text-[#1565C0]">45.9%</p>
        </div>
        <div class="kpi-card bg-white border border-gray-200 p-5">
          <p class="text-xs text-gray-500 mb-1">予算消化率</p>
          <p id="kpi-consumption-rate" class="text-3xl font-bold text-[#1565C0]">47.5%</p>
          <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
            <div id="kpi-consumption-bar" class="bg-[#1565C0] h-2 rounded-full" style="width:47.5%"></div>
          </div>
        </div>
        <div class="kpi-card bg-white border border-gray-200 p-5" style="background: linear-gradient(135deg, #E3F2FD 0%, #fff 100%);">
          <p class="text-xs text-gray-500 mb-1">予測残額</p>
          <p id="kpi-forecast-amount" class="text-3xl font-bold text-[#1565C0]">+1,507<span class="text-base font-normal text-gray-500 ml-1">千円</span></p>
          <p class="text-xs text-[#2E7D32] mt-1 font-semibold">正常 &#x25CF; 黒字見込み</p>
        </div>
      </div>

      <!-- KPI Cards: Manager View (粗利率3軸表示) -->
      <div id="kpi-manager" class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8" style="display:none">
        <div class="kpi-card bg-white border border-gray-200 p-5">
          <p class="text-xs text-gray-500 mb-1">目標粗利率</p>
          <p class="text-3xl font-bold text-[#1565C0]">15.0%</p>
          <p class="text-xs text-gray-400 mt-1">実行予算設定値</p>
        </div>
        <div class="kpi-card bg-white border border-[#E53935] p-5">
          <p class="text-xs text-gray-500 mb-1">このままの粗利率</p>
          <p class="text-3xl font-bold text-[#E53935]">12.8%</p>
          <p class="text-xs text-[#E53935] mt-1 font-semibold">▼ -2.2pt 目標割れ</p>
        </div>
        <div class="kpi-card bg-white border border-gray-200 p-5">
          <p class="text-xs text-gray-500 mb-1">現在の粗利率</p>
          <p class="text-3xl font-bold text-[#EF6C00]">13.5%</p>
          <p class="text-xs text-gray-400 mt-1">支払実績基準</p>
        </div>
        <div class="kpi-card bg-white border border-[#E53935] p-5">
          <p class="text-xs text-gray-500 mb-1">粗利予測</p>
          <p class="text-3xl font-bold text-[#E53935]">12.8%</p>
          <p class="text-xs text-[#E53935] mt-1 font-semibold">▼ -2.2pt</p>
          <p class="text-[10px] text-gray-400 mt-1">詳細は「予算ヘルスチェック」へ</p>
        </div>
      </div>

      <!-- Alert Summary (UX-02: 件数サマリー + accordion展開) -->
      <div class="bg-white border border-gray-200 rounded-lg p-5 mb-8">
        <h3 class="text-base font-bold mb-3 text-gray-800">予算超過アラート</h3>
        <div class="flex flex-wrap gap-4 mb-3">
          <span class="status-label status-over">&#x2716; 超過: 3件</span>
          <span class="status-label status-warn">&#x25B2; 消化済: 2件</span>
          <span class="status-label status-watch">&#x25CF; 監視: 1件</span>
        </div>
        <!-- UX-02: フィルタトグル（初期表示は赤信号のみ） -->
        <div class="flex gap-2 mb-3">
          <button class="alert-filter-btn text-xs px-3 py-1 rounded-full bg-[#E53935] text-white font-semibold" onclick="filterAlerts('over')" data-filter="over">超過のみ</button>
          <button class="alert-filter-btn text-xs px-3 py-1 rounded-full bg-gray-200 text-gray-600 font-semibold" onclick="filterAlerts('all')" data-filter="all">全て表示</button>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm" id="alert-table">
            <thead>
              <tr class="border-b border-gray-200">
                <th class="text-left py-2 px-3 text-gray-500 font-medium">工事名</th>
                <th class="text-left py-2 px-3 text-gray-500 font-medium">費目</th>
                <th class="text-right py-2 px-3 text-gray-500 font-medium">消化率</th>
                <th class="text-center py-2 px-3 text-gray-500 font-medium">ステータス</th>
              </tr>
            </thead>
            <tbody id="alerts-tbody">
              <tr class="bg-red-50 alert-row alert-over">
                <td class="py-2 px-3 font-medium text-gray-600">海潟漁港R7-1</td>
                <td class="py-2 px-3 font-medium">法定福利費（現52）</td>
                <td class="py-2 px-3 text-right font-bold text-[#E53935]">126.2%</td>
                <td class="py-2 px-3 text-center"><span class="status-label status-over">&#x2716; 超過</span></td>
              </tr>
              <tr class="bg-red-50 alert-row alert-over">
                <td class="py-2 px-3 font-medium text-gray-600">海潟漁港R7-1</td>
                <td class="py-2 px-3 font-medium">地代家賃（現54）</td>
                <td class="py-2 px-3 text-right font-bold text-[#E53935]">113.7%</td>
                <td class="py-2 px-3 text-center"><span class="status-label status-over">&#x2716; 超過</span></td>
              </tr>
              <tr class="bg-red-50 alert-row alert-over">
                <td class="py-2 px-3 font-medium text-gray-600">海潟漁港R7-1</td>
                <td class="py-2 px-3 font-medium">水道光熱費（共36）</td>
                <td class="py-2 px-3 text-right font-bold text-[#E53935]">113.0%</td>
                <td class="py-2 px-3 text-center"><span class="status-label status-over">&#x2716; 超過</span></td>
              </tr>
              <tr class="bg-yellow-50 alert-row alert-warn" style="display:none;">
                <td class="py-2 px-3 font-medium text-gray-600">海潟漁港R7-1</td>
                <td class="py-2 px-3 font-medium">運搬費（共31）</td>
                <td class="py-2 px-3 text-right font-bold text-[#EF6C00]">100.0%</td>
                <td class="py-2 px-3 text-center"><span class="status-label status-warn">&#x25B2; 消化済</span></td>
              </tr>
              <tr class="bg-yellow-50 alert-row alert-warn" style="display:none;">
                <td class="py-2 px-3 font-medium text-gray-600">海潟漁港R7-1</td>
                <td class="py-2 px-3 font-medium">役務費（共38）</td>
                <td class="py-2 px-3 text-right font-bold text-[#EF6C00]">100.0%</td>
                <td class="py-2 px-3 text-center"><span class="status-label status-warn">&#x25B2; 消化済</span></td>
              </tr>
              <tr class="alert-row alert-watch" style="display:none;">
                <td class="py-2 px-3 font-medium text-gray-600">海潟漁港R7-1</td>
                <td class="py-2 px-3 font-medium">租税公課（現53）</td>
                <td class="py-2 px-3 text-right font-bold text-gray-700">83.7%</td>
                <td class="py-2 px-3 text-center"><span class="status-label status-watch">&#x25CF; 監視</span></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- 月別支出推移グラフはpage2に移動済み -->

      <!-- UX-02: アクションボタン（入力画面への動線） -->
      <div class="flex flex-wrap gap-4">
        <button class="bg-[#0f9d58] text-white rounded-lg px-8 py-4 text-base font-bold hover:bg-[#0b8043] transition shadow-md" onclick="window.open('https://docs.google.com/spreadsheets/', '_blank')">
          支払明細を入力する
        </button>
        <button class="bg-white border-2 border-[#1565C0] text-[#1565C0] rounded-lg px-6 py-4 text-sm font-semibold hover:bg-[#E3F2FD] transition" onclick="showPage('page2', document.querySelector('.nav-item[data-page=&quot;page2&quot;]'))">
          詳細分析を見る
        </button>
        <button class="bg-white border-2 border-[#1565C0] text-[#1565C0] rounded-lg px-6 py-4 text-sm font-semibold hover:bg-[#E3F2FD] transition" onclick="showPage('page4', document.querySelector('.nav-item[data-page=&quot;page4&quot;]'))">
          AIに質問する
        </button>
      </div>
    </div>

    <!-- ============================================================ -->
    <!-- PAGE 2: 経営分析（予算vs実績） -->
    <!-- ============================================================ -->
    <div id="page2" class="page-section">
      <!-- 現場名ヘッダー + 工事セレクタ -->
      <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <p class="text-xs text-gray-400 mb-1">海潟漁港海岸保全施設整備連携工事(R7-1工区) | 現場代理人: 上村和弘</p>
            <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-0">経営分析（予算 vs 実績）</h2>
          </div>
          <select class="border border-gray-300 rounded-md px-3 py-2 text-sm bg-white" onchange="switchProject(this.value)">
            <option selected>海潟漁港R7-1（上村）</option>
            <option>野尻川除石（池田）</option>
            <option>持木川中流部（中原）</option>
            <option>境川R2-2（中村）[完了]</option>
            <option>森林基幹道（中村）[完了]</option>
            <option>境川2-1（中村）[完了]</option>
          </select>
        </div>
        <div class="mt-2">
          <a href="#" onclick="showPage('page0', document.querySelector('.nav-item[data-page=&quot;page0&quot;]')); return false;" class="text-sm text-[#1565C0] hover:underline">&#x2190; 全現場サマリーに戻る</a>
        </div>
      </div>

      <!-- Monthly Expenditure Chart (page1から移動) -->
      <div class="bg-white border border-gray-200 rounded-lg p-5 mb-8">
        <h3 class="text-base font-bold mb-4 text-gray-800">月別支出推移</h3>
        <div class="relative" style="height:300px;">
          <canvas id="chart-page2-line"></canvas>
        </div>
      </div>

      <!-- Grouped Horizontal Bar Chart -->
      <div class="bg-white border border-gray-200 rounded-lg p-5 mb-8">
        <h3 class="text-base font-bold mb-4 text-gray-800">予算 vs 実績</h3>
        <div class="relative" style="height:320px;">
          <canvas id="chart-page2-bar"></canvas>
        </div>
      </div>

      <!-- Budget vs Actual Table: 4階層表示 -->
      <div class="bg-white border border-gray-200 rounded-lg p-5">
        <h3 class="text-base font-bold mb-4 text-gray-800">予実対比テーブル（費目4階層）</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b-2 border-gray-300">
                <th class="text-left py-2 px-3 text-gray-500 font-medium">費目グループ / 費目名</th>
                <th class="text-right py-2 px-3 text-gray-500 font-medium">予算額（BAC）</th>
                <th class="text-right py-2 px-3 text-gray-500 font-medium">実績額（AC）</th>
                <th class="text-right py-2 px-3 text-gray-500 font-medium">消化率</th>
                <th class="text-right py-2 px-3 text-gray-500 font-medium">残額</th>
              </tr>
            </thead>
            <tbody>
              <!-- C01: 直接工事費 合計行 -->
              <tr class="border-b border-gray-200 bg-[#E3F2FD]">
                <td class="py-2 px-3 font-bold text-[#0D47A1]">▼ C01 直接工事費（合計）</td>
                <td class="py-2 px-3 text-right font-bold">28,500,000</td>
                <td class="py-2 px-3 text-right font-bold">19,115,000</td>
                <td class="py-2 px-3 text-right font-bold text-[#1565C0]">67.1%</td>
                <td class="py-2 px-3 text-right font-bold">9,385,000</td>
              </tr>
              <!-- C01 明細行 -->
              <tr class="border-b border-gray-100">
                <td class="py-2 px-3 pl-8 text-gray-700">W04-K0401-E14 外注費（護岸工 / 護岸工事）</td>
                <td class="py-2 px-3 text-right">9,800,000</td>
                <td class="py-2 px-3 text-right">6,577,000</td>
                <td class="py-2 px-3 text-right font-bold">67.1%</td>
                <td class="py-2 px-3 text-right">3,223,000</td>
              </tr>
              <tr class="border-b border-gray-100">
                <td class="py-2 px-3 pl-8 text-gray-700">W11-K1101-E14 外注費（排水工 / 排水工事）</td>
                <td class="py-2 px-3 text-right">5,555,000</td>
                <td class="py-2 px-3 text-right">4,606,000</td>
                <td class="py-2 px-3 text-right font-bold">82.9%</td>
                <td class="py-2 px-3 text-right">949,000</td>
              </tr>
              <tr class="border-b border-gray-100">
                <td class="py-2 px-3 pl-8 text-gray-700">W02-K0201-E14 外注費（コンクリート工 / コンクリート工事）</td>
                <td class="py-2 px-3 text-right">7,228,000</td>
                <td class="py-2 px-3 text-right">5,317,000</td>
                <td class="py-2 px-3 text-right font-bold">73.6%</td>
                <td class="py-2 px-3 text-right">1,911,000</td>
              </tr>
              <tr class="border-b border-gray-100">
                <td class="py-2 px-3 pl-8 text-gray-700">W02-K0201-E11 材料費（コンクリート工 / コンクリート工事）</td>
                <td class="py-2 px-3 text-right">4,034,667</td>
                <td class="py-2 px-3 text-right">2,615,000</td>
                <td class="py-2 px-3 text-right font-bold">64.8%</td>
                <td class="py-2 px-3 text-right">1,419,667</td>
              </tr>
              <tr class="border-b border-gray-100">
                <td class="py-2 px-3 pl-8 text-gray-700">W04-K0401-E11 材料費（護岸工 / 護岸工事）</td>
                <td class="py-2 px-3 text-right">1,882,333</td>
                <td class="py-2 px-3 text-right">-</td>
                <td class="py-2 px-3 text-right font-bold text-gray-400">-</td>
                <td class="py-2 px-3 text-right">1,882,333</td>
              </tr>
              <!-- C02: 共通仮設費 合計行 -->
              <tr class="border-b border-gray-200 bg-[#E8F5E9]">
                <td class="py-2 px-3 font-bold text-[#1B5E20]">▼ C02 共通仮設費（合計）</td>
                <td class="py-2 px-3 text-right font-bold">2,150,000</td>
                <td class="py-2 px-3 text-right font-bold">1,140,000</td>
                <td class="py-2 px-3 text-right font-bold text-[#2E7D32]">53.0%</td>
                <td class="py-2 px-3 text-right font-bold">1,010,000</td>
              </tr>
              <!-- C02 明細行 -->
              <tr class="border-b border-gray-100 bg-yellow-50">
                <td class="py-2 px-3 pl-8 text-gray-700">F31 運搬費</td>
                <td class="py-2 px-3 text-right">170,000</td>
                <td class="py-2 px-3 text-right">170,000</td>
                <td class="py-2 px-3 text-right font-bold text-[#EF6C00]">100.0%</td>
                <td class="py-2 px-3 text-right">0</td>
              </tr>
              <tr class="border-b border-gray-100">
                <td class="py-2 px-3 pl-8 text-gray-700">F35 安全対策費</td>
                <td class="py-2 px-3 text-right">340,000</td>
                <td class="py-2 px-3 text-right">325,000</td>
                <td class="py-2 px-3 text-right font-bold">95.6%</td>
                <td class="py-2 px-3 text-right">15,000</td>
              </tr>
              <tr class="border-b border-gray-100 bg-red-50">
                <td class="py-2 px-3 pl-8 text-gray-700">F36 水道光熱費</td>
                <td class="py-2 px-3 text-right">65,000</td>
                <td class="py-2 px-3 text-right">73,477</td>
                <td class="py-2 px-3 text-right font-bold text-[#E53935]">113.0%</td>
                <td class="py-2 px-3 text-right text-[#E53935]">-8,477</td>
              </tr>
              <tr class="border-b border-gray-100 bg-yellow-50">
                <td class="py-2 px-3 pl-8 text-gray-700">F38 役務費</td>
                <td class="py-2 px-3 text-right">56,000</td>
                <td class="py-2 px-3 text-right">56,000</td>
                <td class="py-2 px-3 text-right font-bold text-[#EF6C00]">100.0%</td>
                <td class="py-2 px-3 text-right">0</td>
              </tr>
              <tr class="border-b border-gray-100">
                <td class="py-2 px-3 pl-8 text-gray-700">F37 産業廃棄物処理費</td>
                <td class="py-2 px-3 text-right">565,000</td>
                <td class="py-2 px-3 text-right">164,905</td>
                <td class="py-2 px-3 text-right font-bold">29.2%</td>
                <td class="py-2 px-3 text-right">400,095</td>
              </tr>
              <tr class="border-b border-gray-100">
                <td class="py-2 px-3 pl-8 text-gray-700">F39 営繕費</td>
                <td class="py-2 px-3 text-right">539,588</td>
                <td class="py-2 px-3 text-right">316,512</td>
                <td class="py-2 px-3 text-right font-bold">58.7%</td>
                <td class="py-2 px-3 text-right">223,076</td>
              </tr>
              <tr class="border-b border-gray-100">
                <td class="py-2 px-3 pl-8 text-gray-700">F33 仮設建物費</td>
                <td class="py-2 px-3 text-right">101,000</td>
                <td class="py-2 px-3 text-right">52,518</td>
                <td class="py-2 px-3 text-right font-bold">52.0%</td>
                <td class="py-2 px-3 text-right">48,482</td>
              </tr>
              <!-- C03: 現場管理費 合計行 -->
              <tr class="border-b border-gray-200 bg-[#FFF3E0]">
                <td class="py-2 px-3 font-bold text-[#E65100]">▼ C03 現場管理費（合計）</td>
                <td class="py-2 px-3 text-right font-bold">2,655,039</td>
                <td class="py-2 px-3 text-right font-bold text-[#E53935]">2,840,940</td>
                <td class="py-2 px-3 text-right font-bold text-[#E53935]">107.0%</td>
                <td class="py-2 px-3 text-right font-bold text-[#E53935]">-185,901</td>
              </tr>
              <!-- C03 明細行 -->
              <tr class="border-b border-gray-100 bg-red-50">
                <td class="py-2 px-3 pl-8 text-gray-700">F52 法定福利費</td>
                <td class="py-2 px-3 text-right">690,039</td>
                <td class="py-2 px-3 text-right">870,940</td>
                <td class="py-2 px-3 text-right font-bold text-[#E53935]">126.2%</td>
                <td class="py-2 px-3 text-right text-[#E53935]">-180,901</td>
              </tr>
              <tr class="border-b border-gray-100 bg-red-50">
                <td class="py-2 px-3 pl-8 text-gray-700">F54 地代家賃</td>
                <td class="py-2 px-3 text-right">131,910</td>
                <td class="py-2 px-3 text-right">150,000</td>
                <td class="py-2 px-3 text-right font-bold text-[#E53935]">113.7%</td>
                <td class="py-2 px-3 text-right text-[#E53935]">-18,090</td>
              </tr>
              <tr class="border-b border-gray-100 bg-yellow-50">
                <td class="py-2 px-3 pl-8 text-gray-700">F53 租税公課</td>
                <td class="py-2 px-3 text-right">215,000</td>
                <td class="py-2 px-3 text-right">180,000</td>
                <td class="py-2 px-3 text-right font-bold text-[#EF6C00]">83.7%</td>
                <td class="py-2 px-3 text-right">35,000</td>
              </tr>
              <tr class="border-b border-gray-100">
                <td class="py-2 px-3 pl-8 text-gray-700">F56 従業員給料手当</td>
                <td class="py-2 px-3 text-right">3,100,000</td>
                <td class="py-2 px-3 text-right">1,750,000</td>
                <td class="py-2 px-3 text-right font-bold">56.5%</td>
                <td class="py-2 px-3 text-right">1,350,000</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ============================================================ -->
    <!-- PAGE 3: 現場管理（費目・業者・推移） -->
    <!-- ============================================================ -->
    <div id="page3" class="page-section">
      <!-- 現場名ヘッダー + 工事セレクタ -->
      <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <p class="text-xs text-gray-400 mb-1">海潟漁港海岸保全施設整備連携工事(R7-1工区) | 現場代理人: 上村和弘</p>
            <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-0">現場管理</h2>
          </div>
          <select class="border border-gray-300 rounded-md px-3 py-2 text-sm bg-white" onchange="switchProject(this.value)">
            <option selected>海潟漁港R7-1（上村）</option>
            <option>野尻川除石（池田）</option>
            <option>持木川中流部（中原）</option>
            <option>境川R2-2（中村）[完了]</option>
            <option>森林基幹道（中村）[完了]</option>
            <option>境川2-1（中村）[完了]</option>
          </select>
        </div>
        <div class="mt-2">
          <a href="#" onclick="showPage('page0', document.querySelector('.nav-item[data-page=&quot;page0&quot;]')); return false;" class="text-sm text-[#1565C0] hover:underline">&#x2190; 全現場サマリーに戻る</a>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Doughnut Chart -->
        <div class="bg-white border border-gray-200 rounded-lg p-5">
          <h3 class="text-base font-bold mb-4 text-gray-800">費目別構成</h3>
          <div class="relative mx-auto" style="max-width:320px; height:280px;">
            <canvas id="chart-page3-doughnut"></canvas>
          </div>
        </div>

        <!-- Stacked Bar Chart -->
        <div class="bg-white border border-gray-200 rounded-lg p-5">
          <h3 class="text-base font-bold mb-4 text-gray-800">月次推移</h3>
          <div class="relative" style="height:280px;">
            <canvas id="chart-page3-stacked"></canvas>
          </div>
        </div>
      </div>

      <!-- Horizontal Bar: Top 10 Vendors -->
      <div class="bg-white border border-gray-200 rounded-lg p-5">
        <h3 class="text-base font-bold mb-4 text-gray-800">業者別支払 TOP10</h3>
        <div class="relative" style="height:400px;">
          <canvas id="chart-page3-vendors"></canvas>
        </div>
      </div>

      <!-- 法定4分類ビュー（完成工事原価） -->
      <div class="mt-10">
        <div class="flex items-center gap-3 mb-1">
          <h3 class="text-lg font-bold text-gray-800">完成工事原価 — 法定4分類ビュー</h3>
          <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-medium">建設業法様式第16号準拠</span>
        </div>
        <p class="text-xs text-gray-400 mb-5">積算軸（C01/C02/C03）の金額を法定4分類に再集計したビューです（同一データの別軸集計）</p>

        <!-- 4枚のKPIカード -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="kpi-card bg-white border border-gray-200 p-4 text-center">
            <p class="text-xs text-gray-500 mb-1">材料費</p>
            <p class="text-2xl font-bold text-[#1565C0]">4,200千円</p>
            <p class="text-xs text-gray-400 mt-1">28.4%</p>
            <p class="text-[10px] text-gray-300 mt-2">E11の合計</p>
          </div>
          <div class="kpi-card bg-white border border-gray-200 p-4 text-center">
            <p class="text-xs text-gray-500 mb-1">労務費</p>
            <p class="text-2xl font-bold text-[#2E7D32]">1,034千円</p>
            <p class="text-xs text-gray-400 mt-1">7.0%</p>
            <p class="text-[10px] text-gray-300 mt-2">E15の合計</p>
          </div>
          <div class="kpi-card bg-white border border-gray-200 p-4 text-center">
            <p class="text-xs text-gray-500 mb-1">外注費</p>
            <p class="text-2xl font-bold text-[#EF6C00]">5,562千円</p>
            <p class="text-xs text-gray-400 mt-1">37.6%</p>
            <p class="text-[10px] text-gray-300 mt-2">E14の合計</p>
          </div>
          <div class="kpi-card bg-white border border-gray-200 p-4 text-center">
            <p class="text-xs text-gray-500 mb-1">経費</p>
            <p class="text-2xl font-bold text-[#6A1B9A]">3,996千円</p>
            <p class="text-xs text-gray-400 mt-1">27.0%</p>
            <p class="text-[10px] text-gray-300 mt-2">E12/E13 + F31〜F39 + F51〜F67</p>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- 法定4分類ドーナツ -->
          <div class="bg-white border border-gray-200 rounded-lg p-5">
            <h4 class="text-sm font-bold mb-4 text-gray-700">法定4分類 構成比</h4>
            <div class="relative mx-auto" style="max-width:280px; height:240px;">
              <canvas id="chart-page3-legal4"></canvas>
            </div>
          </div>

          <!-- 変換ルール説明 -->
          <div class="bg-white border border-gray-200 rounded-lg p-5">
            <h4 class="text-sm font-bold mb-4 text-gray-700">費目コード → 法定4分類 変換ルール</h4>
            <table class="w-full text-xs text-gray-600">
              <thead>
                <tr class="border-b border-gray-200">
                  <th class="text-left py-1.5 font-semibold text-gray-700 w-1/4">分類</th>
                  <th class="text-left py-1.5 font-semibold text-gray-700">対応する費目コード</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                <tr>
                  <td class="py-1.5 font-medium text-[#1565C0]">材料費</td>
                  <td class="py-1.5">E11（材料費）</td>
                </tr>
                <tr>
                  <td class="py-1.5 font-medium text-[#2E7D32]">労務費</td>
                  <td class="py-1.5">E15（労務費）</td>
                </tr>
                <tr>
                  <td class="py-1.5 font-medium text-[#EF6C00]">外注費</td>
                  <td class="py-1.5">E14（外注費）</td>
                </tr>
                <tr>
                  <td class="py-1.5 font-medium text-[#6A1B9A]">経費</td>
                  <td class="py-1.5">
                    E12（機械損料）、E13（機械燃料費）<br>
                    F31〜F39（共通仮設費の各費目）<br>
                    F51〜F67（現場管理費の各費目）
                  </td>
                </tr>
              </tbody>
            </table>
            <p class="text-[10px] text-gray-400 mt-4 leading-relaxed">
              ※ 建設業法施行規則第17条の様式第16号（完成工事原価報告書）の4分類に基づきます。<br>
              積算軸（C01/C02/C03）とは独立したビューであり、同一の支払データを異なる軸で集計しています。
            </p>
          </div>
        </div>
      </div>

      <!-- P3 Operation Buttons (Manager View only) -->
      <div id="p3-operation-buttons" class="mt-8" style="display:none;">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <button class="bg-[#0f9d58] text-white rounded-lg px-6 py-4 text-sm font-semibold hover:bg-[#0b8043] transition" onclick="alert('Sheets入力画面へのリンク（実装時はSpreadsheet URLに遷移）')">
            入力画面を開く（Sheets）
          </button>
          <button class="bg-[#1565C0] text-white rounded-lg px-6 py-4 text-sm font-semibold hover:bg-[#0D47A1] transition" onclick="alert('GAS月報生成トリガー（実装時はGAS関数を呼び出し）')">
            月次報告書を出力
          </button>
        </div>
        <p class="text-xs text-gray-400 mt-2 text-center">※ 実際のシステムではSpreadsheetまたはGAS関数に接続されます</p>
      </div>
    </div>

    <!-- ============================================================ -->
    <!-- PAGE 3.5: 予算ヘルスチェック（所長ビュー専用） -->
    <!-- ============================================================ -->
    <div id="page35" class="page-section">
      <!-- 現場名ヘッダー + 工事セレクタ -->
      <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <p class="text-xs text-gray-400 mb-1">海潟漁港海岸保全施設整備連携工事(R7-1工区) | 現場代理人: 上村和弘</p>
            <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-0">粗利を守る -- 予算ヘルスチェック</h2>
            <p class="text-sm text-gray-500 mt-1">2025年12月時点</p>
          </div>
          <select class="border border-gray-300 rounded-md px-3 py-2 text-sm bg-white" onchange="switchProject(this.value)">
            <option selected>海潟漁港R7-1（上村）</option>
            <option>野尻川除石（池田）</option>
            <option>持木川中流部（中原）</option>
            <option>境川R2-2（中村）[完了]</option>
            <option>森林基幹道（中村）[完了]</option>
            <option>境川2-1（中村）[完了]</option>
          </select>
        </div>
        <div class="mt-2">
          <a href="#" onclick="showPage('page0', document.querySelector('.nav-item[data-page=&quot;page0&quot;]')); return false;" class="text-sm text-[#1565C0] hover:underline">&#x2190; 全現場サマリーに戻る</a>
        </div>
      </div>

      <!-- 粗利率KPIバナー -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="kpi-card bg-white border-2 border-[#1565C0] p-5 text-center">
          <p class="text-xs text-gray-500 mb-1">目標粗利率</p>
          <p class="text-4xl font-bold text-[#1565C0]">15.0%</p>
          <p class="text-xs text-gray-400 mt-2">実行予算から設定</p>
        </div>
        <div class="kpi-card bg-white border-2 border-[#E53935] p-5 text-center">
          <p class="text-xs text-gray-500 mb-1">このままの粗利率</p>
          <p class="text-4xl font-bold text-[#E53935]">12.8%</p>
          <p class="text-xs text-[#E53935] mt-2 font-semibold">▼ -2.2pt &#x2716;超過</p>
          <p class="text-xs text-gray-500 mt-1">約90万円の粗利が失われる見込み</p>
        </div>
        <div class="kpi-card bg-white border-2 border-[#EF6C00] p-5 text-center">
          <p class="text-xs text-gray-500 mb-1">予算の使い方</p>
          <p class="text-4xl font-bold text-[#EF6C00]">92<span class="text-lg font-normal">点</span></p>
          <p class="text-xs text-[#EF6C00] mt-2 font-semibold">100点=予算ピッタリ</p>
          <p class="text-xs text-gray-400 mt-1">92点=8%超過ペース</p>
        </div>
        <!-- SITE-04: 予測残額カード追加 -->
        <div class="kpi-card bg-white border-2 border-[#1565C0] p-5 text-center" style="background: linear-gradient(135deg, #E3F2FD 0%, #fff 100%);">
          <p class="text-xs text-gray-500 mb-1">予測残額</p>
          <p class="text-4xl font-bold text-[#1565C0]">+150<span class="text-lg font-normal">万円</span></p>
          <p class="text-xs text-[#2E7D32] mt-2 font-semibold">&#x25CF; 正常 黒字見込み</p>
          <p class="text-xs text-gray-400 mt-1">予算-予測総額</p>
        </div>
      </div>

      <!-- 予算ヘルスチェック テーブル -->
      <div class="bg-white border border-gray-200 rounded-lg p-5 mb-8">
        <h3 class="text-base font-bold mb-4 text-gray-800">費目別 予算ヘルスチェック</h3>
        <p class="text-xs text-gray-400 mb-3">凡例: <span class="status-label status-over">&#x2716; 超過</span> 予算効率90%未満 / <span class="status-label status-warn">&#x25B2; 注意</span> 90-99% / <span class="status-label status-normal">&#x25CF; 正常</span> 100%以上</p>
        <div class="overflow-x-auto">
          <table class="w-full text-xs">
            <thead>
              <tr class="border-b-2 border-gray-300">
                <th class="text-left py-2 px-2 text-gray-500 font-medium whitespace-nowrap">費目名</th>
                <th class="text-right py-2 px-2 text-gray-500 font-medium whitespace-nowrap">実行予算</th>
                <th class="text-right py-2 px-2 text-gray-500 font-medium whitespace-nowrap">支払実績</th>
                <th class="text-right py-2 px-2 text-gray-500 font-medium whitespace-nowrap">予算効率</th>
                <th class="text-right py-2 px-2 text-gray-500 font-medium whitespace-nowrap">出来高率</th>
                <th class="text-right py-2 px-2 text-gray-500 font-medium whitespace-nowrap">工程進捗</th>
                <th class="text-right py-2 px-2 text-gray-500 font-medium whitespace-nowrap">過不足見込み</th>
                <th class="text-right py-2 px-2 text-gray-500 font-medium whitespace-nowrap">粗利への影響</th>
                <th class="text-left py-2 px-2 text-gray-500 font-medium whitespace-nowrap">対策</th>
              </tr>
            </thead>
            <tbody>
              <!-- 直接工事費グループ -->
              <tr class="bg-[#E3F2FD] border-b border-gray-200">
                <td colspan="9" class="py-1 px-2 font-bold text-[#0D47A1] text-xs">直接工事費</td>
              </tr>
              <!-- 護岸工 外注費: 予算効率92% 注意 -->
              <tr class="border-b border-gray-100 bg-yellow-50">
                <td class="py-2 px-2 text-gray-700">護岸工 / 外注費</td>
                <td class="py-2 px-2 text-right">9,800,000</td>
                <td class="py-2 px-2 text-right">7,425,000</td>
                <td class="py-2 px-2 text-right font-bold text-[#EF6C00]">92% <span class="text-[10px]">&#x25B2;注意</span></td>
                <td class="py-2 px-2 text-right text-gray-700">75%</td>
                <td class="py-2 px-2 text-right font-bold text-[#EF6C00]">95%</td>
                <td class="py-2 px-2 text-right font-bold text-[#E53935]">-85万円</td>
                <td class="py-2 px-2 text-right text-[#E53935]">粗利 -2.1pt</td>
                <td class="py-2 px-2 text-gray-600">注意して監視</td>
              </tr>
              <!-- 排水工 外注費: 予算効率88% 超過 -->
              <tr class="border-b border-gray-100 bg-red-50">
                <td class="py-2 px-2 text-gray-700">排水工 / 外注費</td>
                <td class="py-2 px-2 text-right">5,555,000</td>
                <td class="py-2 px-2 text-right">5,213,000</td>
                <td class="py-2 px-2 text-right font-bold text-[#E53935]">88% <span class="text-[10px]">&#x2716;超過</span></td>
                <td class="py-2 px-2 text-right text-gray-700">100%</td>
                <td class="py-2 px-2 text-right font-bold text-[#2E7D32]">100%</td>
                <td class="py-2 px-2 text-right font-bold text-[#E53935]">-76万円</td>
                <td class="py-2 px-2 text-right text-[#E53935]">粗利 -1.9pt</td>
                <td class="py-2 px-2 text-[#E53935] font-semibold">単価交渉を検討</td>
              </tr>
              <!-- コンクリート工 外注費: 予算効率102% 正常 -->
              <tr class="border-b border-gray-100">
                <td class="py-2 px-2 text-gray-700">コンクリート工 / 外注費</td>
                <td class="py-2 px-2 text-right">7,228,000</td>
                <td class="py-2 px-2 text-right">5,207,000</td>
                <td class="py-2 px-2 text-right font-bold text-[#2E7D32]">102% <span class="text-[10px]">&#x25CF;正常</span></td>
                <td class="py-2 px-2 text-right text-gray-700">72%</td>
                <td class="py-2 px-2 text-right font-bold text-[#2E7D32]">100%</td>
                <td class="py-2 px-2 text-right text-[#1565C0]">+14万円</td>
                <td class="py-2 px-2 text-right text-[#2E7D32]">粗利 +0.4pt</td>
                <td class="py-2 px-2 text-gray-400">--</td>
              </tr>
              <!-- 共通仮設費グループ -->
              <tr class="bg-[#E8F5E9] border-b border-gray-200">
                <td colspan="9" class="py-1 px-2 font-bold text-[#1B5E20] text-xs">共通仮設費</td>
              </tr>
              <!-- 安全対策費: 予算効率105% 正常 -->
              <tr class="border-b border-gray-100">
                <td class="py-2 px-2 text-gray-700">安全対策費</td>
                <td class="py-2 px-2 text-right">340,000</td>
                <td class="py-2 px-2 text-right">325,000</td>
                <td class="py-2 px-2 text-right font-bold text-[#2E7D32]">105% <span class="text-[10px]">&#x25CF;正常</span></td>
                <td class="py-2 px-2 text-right text-gray-400">--</td>
                <td class="py-2 px-2 text-right font-bold text-[#2E7D32]">100%</td>
                <td class="py-2 px-2 text-right text-[#1565C0]">+2万円</td>
                <td class="py-2 px-2 text-right text-[#2E7D32]">--</td>
                <td class="py-2 px-2 text-gray-400">--</td>
              </tr>
              <!-- 水道光熱費: 予算効率88% 超過 -->
              <tr class="border-b border-gray-100 bg-red-50">
                <td class="py-2 px-2 text-gray-700">水道光熱費</td>
                <td class="py-2 px-2 text-right">65,000</td>
                <td class="py-2 px-2 text-right">73,477</td>
                <td class="py-2 px-2 text-right font-bold text-[#E53935]">88% <span class="text-[10px]">&#x2716;超過</span></td>
                <td class="py-2 px-2 text-right text-gray-400">--</td>
                <td class="py-2 px-2 text-right font-bold text-[#2E7D32]">100%</td>
                <td class="py-2 px-2 text-right font-bold text-[#E53935]">-1万円</td>
                <td class="py-2 px-2 text-right text-[#E53935]">粗利 -0.0pt</td>
                <td class="py-2 px-2 text-[#E53935] font-semibold">使用量の見直し</td>
              </tr>
              <!-- 現場管理費グループ -->
              <tr class="bg-[#FFF3E0] border-b border-gray-200">
                <td colspan="9" class="py-1 px-2 font-bold text-[#E65100] text-xs">現場管理費</td>
              </tr>
              <!-- 法定福利費: 予算効率79% 超過 -->
              <tr class="border-b border-gray-100 bg-red-50">
                <td class="py-2 px-2 text-gray-700">法定福利費</td>
                <td class="py-2 px-2 text-right">690,039</td>
                <td class="py-2 px-2 text-right">870,940</td>
                <td class="py-2 px-2 text-right font-bold text-[#E53935]">79% <span class="text-[10px]">&#x2716;超過</span></td>
                <td class="py-2 px-2 text-right text-gray-400">--</td>
                <td class="py-2 px-2 text-right font-bold text-[#2E7D32]">100%</td>
                <td class="py-2 px-2 text-right font-bold text-[#E53935]">-18万円</td>
                <td class="py-2 px-2 text-right text-[#E53935]">粗利 -0.5pt</td>
                <td class="py-2 px-2 text-[#E53935] font-semibold">保険料の見積り見直し</td>
              </tr>
              <!-- 地代家賃: 予算効率88% 超過 -->
              <tr class="border-b border-gray-100 bg-red-50">
                <td class="py-2 px-2 text-gray-700">地代家賃</td>
                <td class="py-2 px-2 text-right">131,910</td>
                <td class="py-2 px-2 text-right">150,000</td>
                <td class="py-2 px-2 text-right font-bold text-[#E53935]">88% <span class="text-[10px]">&#x2716;超過</span></td>
                <td class="py-2 px-2 text-right text-gray-400">--</td>
                <td class="py-2 px-2 text-right font-bold text-[#2E7D32]">100%</td>
                <td class="py-2 px-2 text-right font-bold text-[#E53935]">-2万円</td>
                <td class="py-2 px-2 text-right text-[#E53935]">粗利 -0.0pt</td>
                <td class="py-2 px-2 text-[#E53935] font-semibold">契約条件の確認</td>
              </tr>
              <!-- 従業員給料手当: 予算効率177% 正常 -->
              <tr class="border-b border-gray-100">
                <td class="py-2 px-2 text-gray-700">従業員給料手当</td>
                <td class="py-2 px-2 text-right">3,100,000</td>
                <td class="py-2 px-2 text-right">1,750,000</td>
                <td class="py-2 px-2 text-right font-bold text-[#2E7D32]">177% <span class="text-[10px]">&#x25CF;正常</span></td>
                <td class="py-2 px-2 text-right text-gray-400">--</td>
                <td class="py-2 px-2 text-right font-bold text-[#2E7D32]">100%</td>
                <td class="py-2 px-2 text-right text-[#1565C0]">+135万円</td>
                <td class="py-2 px-2 text-right text-[#2E7D32]">粗利 +3.4pt</td>
                <td class="py-2 px-2 text-gray-400">--</td>
              </tr>
            </tbody>
          </table>
        </div>
        <p class="text-xs text-gray-400 mt-3">※ 出来高率は月次調整シートからの入力値です。出来高率未入力時はEV=AC（予算効率100%）として計算されます。</p>
      </div>

      <!-- 常用費用サマリ -->
      <div class="bg-white border border-gray-200 rounded-lg p-5 mb-8">
        <h3 class="text-base font-bold mb-4 text-gray-800">常用費用サマリ</h3>
        <!-- KPIカード 2枚 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div class="kpi-card bg-white border-2 border-[#1565C0] p-5 text-center">
            <p class="text-xs text-gray-500 mb-1">常用費用 合計</p>
            <p class="text-3xl font-bold text-[#1565C0]">1,240<span class="text-base font-normal text-gray-500 ml-1">千円</span></p>
            <p class="text-xs text-gray-400 mt-2">3ヶ月累計（税抜）</p>
          </div>
          <div class="kpi-card bg-white border-2 border-[#EF6C00] p-5 text-center">
            <p class="text-xs text-gray-500 mb-1">常用比率</p>
            <p class="text-3xl font-bold text-[#EF6C00]">5.2<span class="text-base font-normal text-gray-500 ml-1">%</span></p>
            <p class="text-xs text-gray-400 mt-2">直接工事費に占める割合</p>
          </div>
        </div>
        <!-- 月別推移テーブル -->
        <div class="overflow-x-auto">
          <table class="w-full text-xs">
            <thead>
              <tr class="border-b-2 border-gray-300">
                <th class="text-left py-2 px-2 text-gray-500 font-medium">月</th>
                <th class="text-right py-2 px-2 text-gray-500 font-medium">常用費用</th>
                <th class="text-right py-2 px-2 text-gray-500 font-medium">直接工事費</th>
                <th class="text-right py-2 px-2 text-gray-500 font-medium">常用比率</th>
                <th class="text-left py-2 px-2 text-gray-500 font-medium">備考</th>
              </tr>
            </thead>
            <tbody>
              <tr class="border-b border-gray-100 bg-red-50">
                <td class="py-2 px-2 text-gray-700">10月</td>
                <td class="py-2 px-2 text-right">520,000</td>
                <td class="py-2 px-2 text-right">3,162,969</td>
                <td class="py-2 px-2 text-right font-bold text-[#E53935]">16.4%</td>
                <td class="py-2 px-2 text-gray-600">護岸工の追加人工</td>
              </tr>
              <tr class="border-b border-gray-100 bg-yellow-50">
                <td class="py-2 px-2 text-gray-700">11月</td>
                <td class="py-2 px-2 text-right">430,000</td>
                <td class="py-2 px-2 text-right">3,481,347</td>
                <td class="py-2 px-2 text-right font-bold text-[#EF6C00]">12.4%</td>
                <td class="py-2 px-2 text-gray-400">--</td>
              </tr>
              <tr class="border-b border-gray-100">
                <td class="py-2 px-2 text-gray-700">12月</td>
                <td class="py-2 px-2 text-right">290,000</td>
                <td class="py-2 px-2 text-right">4,145,315</td>
                <td class="py-2 px-2 text-right font-bold text-[#2E7D32]">7.0%</td>
                <td class="py-2 px-2 text-gray-600">減少傾向</td>
              </tr>
              <tr class="border-t-2 border-gray-300 font-bold">
                <td class="py-2 px-2 text-gray-800">合計</td>
                <td class="py-2 px-2 text-right text-gray-800">1,240,000</td>
                <td class="py-2 px-2 text-right text-gray-800">10,789,631</td>
                <td class="py-2 px-2 text-right text-[#1565C0]">5.2%</td>
                <td class="py-2 px-2 text-gray-400">--</td>
              </tr>
            </tbody>
          </table>
        </div>
        <p class="text-xs text-gray-400 mt-3">常用費用が多い月は、請負に切り替えることで利益率を改善できる可能性があります。逸失利益の具体的な算出基準は、複数プロジェクトの実績が蓄積された段階で設定します。</p>
      </div>

      <!-- 予算効率の判定基準 -->
      <div class="bg-[#F3F4F6] border border-gray-200 rounded-lg p-5">
        <h3 class="text-base font-bold mb-4 text-gray-800">予算効率の判定基準</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="bg-white rounded-lg p-4 border-l-4 border-[#E53935]">
            <p class="text-sm font-bold text-[#E53935] mb-2">超過（予算効率 90%未満）</p>
            <p class="text-xs text-gray-600">超過確定。今すぐ対策が必要です。</p>
            <p class="text-xs text-gray-500 mt-2">この費目は予算を超過するペースで進んでいます。最終的に不足額が発生します。単価交渉・仕様見直し・代替業者の検討を。</p>
          </div>
          <div class="bg-white rounded-lg p-4 border-l-4 border-[#EF6C00]">
            <p class="text-sm font-bold text-[#EF6C00] mb-2">注意（予算効率 90-99%）</p>
            <p class="text-xs text-gray-600">超過の兆候あり。注意して監視してください。</p>
            <p class="text-xs text-gray-500 mt-2">やや超過ペースです。来月までに改善しなければ超過に変わります。前払いや一時的な先行支出の場合もあるので、翌月の状況で判断を。</p>
          </div>
          <div class="bg-white rounded-lg p-4 border-l-4 border-[#2E7D32]">
            <p class="text-sm font-bold text-[#2E7D32] mb-2">正常（予算効率 100%以上）</p>
            <p class="text-xs text-gray-600">正常。予算内で推移しています。</p>
            <p class="text-xs text-gray-500 mt-2">予算を上手く使えています。余裕がある費目は他の超過費目の補填に回せる可能性があります。</p>
          </div>
          <div class="bg-white rounded-lg p-4 border-l-4 border-[#1565C0]">
            <p class="text-sm font-bold text-[#1565C0] mb-2">工程進捗について</p>
            <p class="text-xs text-gray-600">工程の進み具合を%で表示。</p>
            <p class="text-xs text-gray-500 mt-2">90%未満 = 遅延あり。追加費用に注意。90-99% = やや遅れ。工程表を確認。100%以上 = 予定通りまたは前倒し。</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================================ -->
    <!-- PAGE 4: AIチャット -->
    <!-- ============================================================ -->
    <div id="page4" class="page-section">
      <!-- 現場名ヘッダー + 工事セレクタ -->
      <div class="bg-white border border-gray-200 rounded-lg p-4 mb-6">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <p class="text-xs text-gray-400 mb-1">海潟漁港海岸保全施設整備連携工事(R7-1工区) | 現場代理人: 上村和弘</p>
            <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-0">AIチャット</h2>
          </div>
          <select class="border border-gray-300 rounded-md px-3 py-2 text-sm bg-white" onchange="switchProject(this.value)">
            <option selected>海潟漁港R7-1（上村）</option>
            <option>野尻川除石（池田）</option>
            <option>持木川中流部（中原）</option>
            <option>境川R2-2（中村）[完了]</option>
            <option>森林基幹道（中村）[完了]</option>
            <option>境川2-1（中村）[完了]</option>
          </select>
        </div>
        <div class="mt-2">
          <a href="#" onclick="showPage('page0', document.querySelector('.nav-item[data-page=&quot;page0&quot;]')); return false;" class="text-sm text-[#1565C0] hover:underline">&#x2190; 全現場サマリーに戻る</a>
        </div>
      </div>

      <!-- UX-03: サジェストボタン -->
      <div class="mb-4">
        <p class="text-xs text-gray-500 mb-2">よくある質問:</p>
        <div class="flex flex-wrap">
          <span class="suggest-btn" onclick="alert('今月の利益率は?')">今月の利益率は?</span>
          <span class="suggest-btn" onclick="alert('予算超過している費目は?')">予算超過している費目は?</span>
          <span class="suggest-btn" onclick="alert('支払いが多い業者は?')">支払いが多い業者は?</span>
          <span class="suggest-btn" onclick="alert('コスト削減の提案')">コスト削減の提案</span>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Left: Data Analysis AI -->
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
          <div class="bg-[#1565C0] text-white px-5 py-3 font-semibold text-sm">データ分析AI</div>
          <div class="p-5 flex flex-col gap-3" style="min-height:420px;">
            <div class="flex justify-end">
              <div class="chat-bubble chat-user text-sm">今月の支出はいくらですか？</div>
            </div>
            <div class="flex justify-start">
              <div class="chat-bubble chat-ai text-sm">12月度の支出（税抜）は合計 4,332,077円です。内訳は以下の通りです：
- (有)濱畑水道: 3,036,365円（外注費+常用分）
- (株)加根又本店: 504,649円（材料費）
- (株)グリーンクロス: 347,440円（材料費+安全対策費）
- 桜島生コンクリート: 167,500円（材料費+産業廃棄物処理費）
12月度は相殺なしです。</div>
            </div>
            <div class="flex justify-end">
              <div class="chat-bubble chat-user text-sm">支払いが多い業者はどこ？</div>
            </div>
            <div class="flex justify-start">
              <div class="chat-bubble chat-ai text-sm">3ヶ月間の支払額上位3社です。
1. 川越建設: 9,667,000円（40.7%）
2. 桜島生コンクリート: 5,205,650円（21.9%）
3. (有)濱畑水道: 4,839,554円（20.4%）
上位3社で全体の83%を占めています。</div>
            </div>
          </div>
        </div>

        <!-- Right: Improvement AI -->
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
          <div class="bg-[#2E7D32] text-white px-5 py-3">
            <span class="font-semibold text-sm">改善提案AI</span>
            <p class="text-xs text-green-100 mt-1">提案は建設業の実態（長期下請関係等）を考慮しています</p>
          </div>
          <div class="p-5 flex flex-col gap-3" style="min-height:420px;">
            <div class="flex justify-end">
              <div class="chat-bubble chat-user text-sm">コスト削減の余地はありますか？</div>
            </div>
            <div class="flex justify-start">
              <div class="chat-bubble chat-ai text-sm">分析の結果、以下の改善余地があります：
1. 法定福利費：消化率126.2%で予算超過中（+180,901円）。社会保険料の見積り見直しを推奨
2. 地代家賃：消化率113.7%で予算超過中（+18,090円）。地代家賃の見直しを検討
3. 外注費：川越建設1社に40.7%集中。取引先分散でリスク低減と交渉力向上の余地あり</div>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-gray-100 rounded-lg p-4 text-center text-sm text-gray-500">
        ※ 実際のシステムではDify AIワークフローが応答します
      </div>
    </div>

    <!-- ============================================================ -->
    <!-- PAGE 5: 全社経営概況 -->
    <!-- ============================================================ -->
    <div id="page5" class="page-section">
      <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-6">全社経営概況（前年度 vs 今年度）</h2>

      <!-- KPI Cards with arrows -->
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="kpi-card bg-white border border-gray-200 p-5">
          <p class="text-xs text-gray-500 mb-1">売上高</p>
          <p class="text-2xl font-bold text-gray-800">1,147<span class="text-sm font-normal text-gray-500 ml-1">M</span></p>
          <p class="text-xs mt-1 text-[#1565C0] font-semibold">
            <svg class="inline w-3 h-3 mr-0.5" viewBox="0 0 12 12" fill="#1565C0"><polygon points="6,1 11,8 1,8"/></svg>
            前年比 +27.7%
          </p>
        </div>
        <div class="kpi-card bg-white border border-gray-200 p-5">
          <p class="text-xs text-gray-500 mb-1">粗利率</p>
          <p class="text-2xl font-bold text-gray-800">6.7%</p>
          <p class="text-xs mt-1 text-[#E53935] font-semibold">
            <svg class="inline w-3 h-3 mr-0.5" viewBox="0 0 12 12" fill="#E53935"><polygon points="6,11 11,4 1,4"/></svg>
            前年比 -1.7pt
          </p>
        </div>
        <div class="kpi-card bg-white border border-gray-200 p-5">
          <p class="text-xs text-gray-500 mb-1">営業利益</p>
          <p class="text-2xl font-bold text-[#E53935]">-20.9<span class="text-sm font-normal text-gray-500 ml-1">M</span></p>
          <p class="text-xs mt-1 text-[#E53935] font-semibold">
            <svg class="inline w-3 h-3 mr-0.5" viewBox="0 0 12 12" fill="#E53935"><polygon points="6,11 11,4 1,4"/></svg>
            前年比 -7.7%
          </p>
        </div>
        <div class="kpi-card bg-white border border-gray-200 p-5">
          <p class="text-xs text-gray-500 mb-1">受注工事</p>
          <p class="text-2xl font-bold text-gray-800">6<span class="text-sm font-normal text-gray-500 ml-1">件</span></p>
          <p class="text-xs mt-1 text-[#1565C0] font-semibold">
            <svg class="inline w-3 h-3 mr-0.5" viewBox="0 0 12 12" fill="#1565C0"><polygon points="6,1 11,8 1,8"/></svg>
            前年比 +2件
          </p>
        </div>
      </div>

      <!-- Sales / COGS / Gross Profit Comparison -->
      <div class="bg-white border border-gray-200 rounded-lg p-5 mb-8">
        <h3 class="text-base font-bold mb-4 text-gray-800">売上高・粗利比較</h3>
        <div class="relative" style="height:320px;">
          <canvas id="chart-page5-sales"></canvas>
        </div>
      </div>

      <!-- Gross Profit by Project -->
      <div class="bg-white border border-gray-200 rounded-lg p-5">
        <h3 class="text-base font-bold mb-4 text-gray-800">工事別粗利率</h3>
        <div class="relative" style="height:240px;">
          <canvas id="chart-page5-profit"></canvas>
        </div>
      </div>
    </div>

    <!-- ============================================================ -->
    <!-- PAGE 6: 工事別パフォーマンス -->
    <!-- ============================================================ -->
    <div id="page6" class="page-section">
      <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-6">工事別パフォーマンス</h2>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Gross Profit Ranking -->
        <div class="bg-white border border-gray-200 rounded-lg p-5">
          <h3 class="text-base font-bold mb-4 text-gray-800">粗利率ランキング</h3>
          <div class="relative" style="height:260px;">
            <canvas id="chart-page6-ranking"></canvas>
          </div>
        </div>

        <!-- Cost Structure (100% stacked) -->
        <div class="bg-white border border-gray-200 rounded-lg p-5">
          <h3 class="text-base font-bold mb-4 text-gray-800">原価構造比較</h3>
          <div class="relative" style="height:260px;">
            <canvas id="chart-page6-structure"></canvas>
          </div>
        </div>
      </div>

      <!-- Summary Table -->
      <div class="bg-white border border-gray-200 rounded-lg p-5">
        <h3 class="text-base font-bold mb-4 text-gray-800">所長別まとめ</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b-2 border-gray-300">
                <th class="text-left py-2 px-3 text-gray-500 font-medium">所長名</th>
                <th class="text-left py-2 px-3 text-gray-500 font-medium">担当工事</th>
                <th class="text-right py-2 px-3 text-gray-500 font-medium">契約額</th>
                <th class="text-right py-2 px-3 text-gray-500 font-medium">粗利率</th>
                <th class="text-left py-2 px-3 text-gray-500 font-medium">特徴</th>
              </tr>
            </thead>
            <tbody>
              <tr class="border-b border-gray-100">
                <td class="py-3 px-3 font-medium">中村竜一</td>
                <td class="py-3 px-3">境川河川改修</td>
                <td class="py-3 px-3 text-right">185,000千円</td>
                <td class="py-3 px-3 text-right"><span class="font-bold text-[#1565C0]">28.9%</span></td>
                <td class="py-3 px-3 text-gray-600">材料調達力が高い。外注と材料のバランス型</td>
              </tr>
              <tr class="border-b border-gray-100">
                <td class="py-3 px-3 font-medium">池田豊</td>
                <td class="py-3 px-3">野尻川砂防</td>
                <td class="py-3 px-3 text-right">220,000千円</td>
                <td class="py-3 px-3 text-right"><span class="font-bold text-[#1565C0]">25.6%</span></td>
                <td class="py-3 px-3 text-gray-600">外注主体で効率的。単価交渉力が強み</td>
              </tr>
              <tr class="border-b border-gray-100">
                <td class="py-3 px-3 font-medium">中原輝竜</td>
                <td class="py-3 px-3">持木川護岸</td>
                <td class="py-3 px-3 text-right">156,000千円</td>
                <td class="py-3 px-3 text-right"><span class="font-bold text-[#EF6C00]">15.4%</span></td>
                <td class="py-3 px-3 text-gray-600">外注単価が割高。材料費比率も高め</td>
              </tr>
              <tr class="border-b border-gray-100">
                <td class="py-3 px-3 font-medium">上村和弘</td>
                <td class="py-3 px-3">海潟漁港海岸保全</td>
                <td class="py-3 px-3 text-right">39,700千円</td>
                <td class="py-3 px-3 text-right"><span class="font-bold text-[#E53935]">14.0%</span></td>
                <td class="py-3 px-3 text-gray-600">現場管理費比率が高い。小規模工事のため割高</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- 費目別 予算効率の現場比較 -->
      <div class="bg-white border border-gray-200 rounded-lg p-5 mt-8">
        <h3 class="text-base font-bold mb-4 text-gray-800">費目別 予算効率の現場比較</h3>
        <p class="text-xs text-gray-400 mb-3">凡例: <span class="status-label status-over">&#x2716; 超過</span> 予算効率90%未満 / <span class="status-label status-warn">&#x25B2; 注意</span> 90-99% / <span class="status-label status-normal">&#x25CF; 正常</span> 100%以上</p>
        <div class="overflow-x-auto">
          <table class="w-full text-xs">
            <thead>
              <tr class="border-b-2 border-gray-300">
                <th class="text-left py-2 px-2 text-gray-500 font-medium whitespace-nowrap">費目カテゴリ / 費目名</th>
                <th class="text-right py-2 px-2 text-gray-500 font-medium whitespace-nowrap">境川河川<br><span class="font-normal text-gray-400">(中村)</span></th>
                <th class="text-right py-2 px-2 text-gray-500 font-medium whitespace-nowrap">野尻川砂防<br><span class="font-normal text-gray-400">(池田)</span></th>
                <th class="text-right py-2 px-2 text-gray-500 font-medium whitespace-nowrap">持木川護岸<br><span class="font-normal text-gray-400">(中原)</span></th>
                <th class="text-right py-2 px-2 text-gray-500 font-medium whitespace-nowrap">海潟漁港<br><span class="font-normal text-gray-400">(上村)</span></th>
                <th class="text-right py-2 px-2 text-gray-500 font-medium whitespace-nowrap">全社平均</th>
              </tr>
            </thead>
            <tbody>
              <!-- 直接工事費グループ -->
              <tr class="bg-[#E3F2FD] border-b border-gray-200">
                <td colspan="6" class="py-1 px-2 font-bold text-[#0D47A1] text-xs">直接工事費</td>
              </tr>
              <tr class="border-b border-gray-100">
                <td class="py-2 px-2 text-gray-700 pl-4">外注費</td>
                <td class="py-2 px-2 text-right font-bold text-[#2E7D32]">105%</td>
                <td class="py-2 px-2 text-right font-bold text-[#2E7D32]">108%</td>
                <td class="py-2 px-2 text-right font-bold text-[#EF6C00] bg-yellow-50">94%</td>
                <td class="py-2 px-2 text-right font-bold text-[#EF6C00] bg-yellow-50">92%</td>
                <td class="py-2 px-2 text-right font-bold text-[#2E7D32]">100%</td>
              </tr>
              <tr class="border-b border-gray-100">
                <td class="py-2 px-2 text-gray-700 pl-4">材料費</td>
                <td class="py-2 px-2 text-right font-bold text-[#EF6C00] bg-yellow-50">98%</td>
                <td class="py-2 px-2 text-right text-gray-400">--</td>
                <td class="py-2 px-2 text-right font-bold text-[#EF6C00] bg-yellow-50">91%</td>
                <td class="py-2 px-2 text-right font-bold text-[#2E7D32]">102%</td>
                <td class="py-2 px-2 text-right font-bold text-[#EF6C00]">97%</td>
              </tr>
              <!-- 共通仮設費グループ -->
              <tr class="bg-[#E8F5E9] border-b border-gray-200">
                <td colspan="6" class="py-1 px-2 font-bold text-[#1B5E20] text-xs">共通仮設費</td>
              </tr>
              <tr class="border-b border-gray-100">
                <td class="py-2 px-2 text-gray-700 pl-4">安全対策費</td>
                <td class="py-2 px-2 text-right font-bold text-[#2E7D32]">110%</td>
                <td class="py-2 px-2 text-right font-bold text-[#2E7D32]">102%</td>
                <td class="py-2 px-2 text-right font-bold text-[#EF6C00] bg-yellow-50">95%</td>
                <td class="py-2 px-2 text-right font-bold text-[#2E7D32]">105%</td>
                <td class="py-2 px-2 text-right font-bold text-[#2E7D32]">103%</td>
              </tr>
              <tr class="border-b border-gray-100">
                <td class="py-2 px-2 text-gray-700 pl-4">水道光熱費</td>
                <td class="py-2 px-2 text-right font-bold text-[#EF6C00] bg-yellow-50">97%</td>
                <td class="py-2 px-2 text-right font-bold text-[#2E7D32]">103%</td>
                <td class="py-2 px-2 text-right font-bold text-[#E53935] bg-red-50">85%</td>
                <td class="py-2 px-2 text-right font-bold text-[#E53935] bg-red-50">88%</td>
                <td class="py-2 px-2 text-right font-bold text-[#EF6C00]">93%</td>
              </tr>
              <!-- 現場管理費グループ -->
              <tr class="bg-[#FFF3E0] border-b border-gray-200">
                <td colspan="6" class="py-1 px-2 font-bold text-[#E65100] text-xs">現場管理費</td>
              </tr>
              <tr class="border-b border-gray-100">
                <td class="py-2 px-2 text-gray-700 pl-4">法定福利費</td>
                <td class="py-2 px-2 text-right font-bold text-[#EF6C00] bg-yellow-50">95%</td>
                <td class="py-2 px-2 text-right font-bold text-[#2E7D32]">101%</td>
                <td class="py-2 px-2 text-right font-bold text-[#E53935] bg-red-50">88%</td>
                <td class="py-2 px-2 text-right font-bold text-[#E53935] bg-red-50">79%</td>
                <td class="py-2 px-2 text-right font-bold text-[#EF6C00]">91%</td>
              </tr>
              <tr class="border-b border-gray-100">
                <td class="py-2 px-2 text-gray-700 pl-4">従業員給料手当</td>
                <td class="py-2 px-2 text-right font-bold text-[#2E7D32]">112%</td>
                <td class="py-2 px-2 text-right font-bold text-[#2E7D32]">105%</td>
                <td class="py-2 px-2 text-right font-bold text-[#EF6C00] bg-yellow-50">98%</td>
                <td class="py-2 px-2 text-right font-bold text-[#2E7D32]">177%</td>
                <td class="py-2 px-2 text-right font-bold text-[#2E7D32]">123%</td>
              </tr>
              <tr class="border-b border-gray-100">
                <td class="py-2 px-2 text-gray-700 pl-4">地代家賃</td>
                <td class="py-2 px-2 text-right font-bold text-[#2E7D32]">100%</td>
                <td class="py-2 px-2 text-right font-bold text-[#2E7D32]">100%</td>
                <td class="py-2 px-2 text-right font-bold text-[#EF6C00] bg-yellow-50">95%</td>
                <td class="py-2 px-2 text-right font-bold text-[#E53935] bg-red-50">88%</td>
                <td class="py-2 px-2 text-right font-bold text-[#EF6C00]">96%</td>
              </tr>
            </tbody>
          </table>
        </div>
        <p class="text-xs text-gray-400 mt-3">同じ費目でも予算効率に差がある場合、効率の良い現場のやり方を横展開することでコスト改善が見込めます。</p>
      </div>
    </div>

    <!-- ============================================================ -->
    <!-- PAGE 7: コスト改善の見える化 -->
    <!-- ============================================================ -->
    <div id="page7" class="page-section">
      <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-6">コスト改善の見える化</h2>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Unit Price Gap -->
        <div class="bg-white border border-gray-200 rounded-lg p-5">
          <h3 class="text-base font-bold mb-4 text-gray-800">外注単価格差</h3>
          <div class="relative" style="height:300px;">
            <canvas id="chart-page7-gap"></canvas>
          </div>
        </div>

        <!-- Annual Improvement Estimate -->
        <div class="bg-white border border-gray-200 rounded-lg p-5">
          <h3 class="text-base font-bold mb-4 text-gray-800">年間改善効果見込み</h3>
          <div class="relative" style="height:300px;">
            <canvas id="chart-page7-improvement"></canvas>
          </div>
        </div>
      </div>

      <!-- Summary Card -->
      <div class="bg-[#E3F2FD] border border-[#90CAF9] rounded-lg p-6">
        <h3 class="text-base font-bold mb-4 text-[#0D47A1]">改善ポイントまとめ</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-white rounded-lg p-4 shadow-sm">
            <p class="text-sm font-bold text-[#1565C0] mb-2">1. 外注単価の標準化</p>
            <p class="text-sm text-gray-700">掘削工（ICT）で1.68倍、土砂運搬で1.78倍の格差あり。最安単価を基準に標準化することで年間5,000〜9,000万円の改善が見込まれる。</p>
          </div>
          <div class="bg-white rounded-lg p-4 shadow-sm">
            <p class="text-sm font-bold text-[#1565C0] mb-2">2. 工事特性の考慮</p>
            <p class="text-sm text-gray-700">工事規模・距離・地質条件を加味した適正単価テーブルを整備。年間700〜1,200万円の追加改善が可能。</p>
          </div>
          <div class="bg-white rounded-lg p-4 shadow-sm">
            <p class="text-sm font-bold text-[#1565C0] mb-2">3. 所長間のナレッジ共有</p>
            <p class="text-sm text-gray-700">池田所長の単価交渉力（最安実績）を他所長に横展開。月次での単価ベンチマーク会議を推奨。</p>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>

<script>
/* ===================================================================
 * Phase G: GAS API連携
 * hub.gs から全工事の予実データを取得し、ダッシュボードをリアルデータで更新する
 * フェイルセーフ: fetchエラー時は既存のハードコード値をそのまま表示する
 * =================================================================== */

const GAS_HUB_URL = 'https://script.google.com/macros/s/AKfycbygy0ZX_cTbzxMgB8D-reGtIsGkQelzf_3M1iKgZM-rkPLPss2g_d4VpG0W9frGE-xs/exec';
const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyMhtCFlRxe6T_qtAzKbllaq99uHdvgHfqwyKmJs_6vgs5wlNWXxRkSZESMw6SW2fRYcg/exec';
const DEMO_MONTH  = '2025-12';

// プロジェクトデータキャッシュ: { project_id: healthオブジェクト }
var _allProjectsData = {};

/** GAS応答の文字列をHTMLエスケープする（XSS対策） */
function _esc(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

/**
 * ダッシュボード初期化
 * DOMContentLoaded 時に呼び出す。hub.gs から全工事の予実データを取得してpage0/page1を更新する
 */
async function initDashboard() {
  try {
    var resp = await fetch(GAS_HUB_URL + '?mode=cross_health&month=' + DEMO_MONTH);
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    var data = await resp.json();
    if (!data.success) throw new Error(data.error || 'cross_health APIエラー');

    var projects = (data.data && data.data.projects) ? data.data.projects : [];
    projects.forEach(function(p) { _allProjectsData[p.project_id] = p; });

    renderSidebar(projects);
    renderSummaryCards(projects);
    renderProjectCards(projects);
    renderAlertsTable(projects);

    if (_allProjectsData['P001']) {
      updateSiteKpi(_allProjectsData['P001']);
    }
  } catch (e) {
    console.log('initDashboard エラー（ハードコード値で表示継続）: ' + e.message);
  }
}

/**
 * サイドバーの現場別リストをAPIデータで動的生成
 * @param {Array} projects - hub.gs cross_health から取得した工事配列
 */
function renderSidebar(projects) {
  var container = document.getElementById('sidebar-sites');
  if (!container || projects.length === 0) return;

  var fragment = document.createDocumentFragment();

  // active工事を先に、completed工事を後に表示
  var sorted = projects.slice().sort(function(a, b) {
    var sa = (a.status === 'completed' || a.status === '完了') ? 1 : 0;
    var sb = (b.status === 'completed' || b.status === '完了') ? 1 : 0;
    return sa - sb;
  });

  sorted.forEach(function(p) {
    var isCompleted = (p.status === 'completed' || p.status === '完了');
    var sig = p.signal || '';
    var fillColor = isCompleted ? '#9E9E9E'
      : sig === '超過' ? '#E53935'
      : sig === '注意' ? '#FDD835'
      : '#2E7D32';

    var item = document.createElement('div');
    item.className = 'nav-item flex items-center gap-3 px-5 py-2 text-xs' + (isCompleted ? '' : ' nav-site-stub');
    item.setAttribute('data-page', 'page1');
    if (isCompleted) item.style.opacity = '0.5';
    item.addEventListener('click', (function(pid, el) {
      return function() {
        switchProject(pid);
        showPage('page1', el);
      };
    })(p.project_id, item));

    // 信号ドットSVG
    var svgNS = 'http://www.w3.org/2000/svg';
    var svg = document.createElementNS(svgNS, 'svg');
    svg.setAttribute('width', '14');
    svg.setAttribute('height', '14');
    svg.setAttribute('viewBox', '0 0 24 24');
    svg.setAttribute('fill', 'none');
    svg.setAttribute('stroke', 'currentColor');
    svg.setAttribute('stroke-width', '2');
    var circle = document.createElementNS(svgNS, 'circle');
    circle.setAttribute('cx', '12');
    circle.setAttribute('cy', '12');
    circle.setAttribute('r', '5');
    circle.setAttribute('fill', fillColor);
    svg.appendChild(circle);
    item.appendChild(svg);

    // 工事名 + 所長名
    var nameSpan = document.createElement('span');
    var nameText = document.createTextNode(p.project_name || p.project_id);
    nameSpan.appendChild(nameText);
    if (p.manager) {
      var mgrSpan = document.createElement('span');
      mgrSpan.className = 'text-blue-300 ml-1';
      mgrSpan.textContent = '(' + p.manager + ')';
      nameSpan.appendChild(mgrSpan);
    }
    if (isCompleted) {
      var compSpan = document.createElement('span');
      compSpan.className = 'text-blue-400 text-[9px] ml-1';
      compSpan.textContent = '[完了]';
      nameSpan.appendChild(compSpan);
    }
    item.appendChild(nameSpan);
    fragment.appendChild(item);
  });

  while (container.firstChild) container.removeChild(container.firstChild);
  container.appendChild(fragment);
}

/**
 * page0 のサマリーカード（KPI 4枚 + 信号バー）をAPIデータで動的更新
 * @param {Array} projects - hub.gs cross_health から取得した工事配列
 */
function renderSummaryCards(projects) {
  if (projects.length === 0) return;

  var activeProjects = projects.filter(function(p) {
    return p.status !== 'completed' && p.status !== '完了';
  });
  var completedProjects = projects.filter(function(p) {
    return p.status === 'completed' || p.status === '完了';
  });

  // 進行中工事数
  var elActive = document.getElementById('summary-active');
  if (elActive) {
    elActive.textContent = '';
    elActive.appendChild(document.createTextNode(activeProjects.length));
    var unitA = document.createElement('span');
    unitA.className = 'text-base font-normal text-gray-500 ml-1';
    unitA.textContent = '件';
    elActive.appendChild(unitA);
  }

  // 完了工事数
  var elCompleted = document.getElementById('summary-completed');
  if (elCompleted) {
    elCompleted.textContent = '';
    elCompleted.appendChild(document.createTextNode(completedProjects.length));
    var unitC = document.createElement('span');
    unitC.className = 'text-base font-normal text-gray-500 ml-1';
    unitC.textContent = '件';
    elCompleted.appendChild(unitC);
  }

  // 合計請負額（BAC合計、億円表示）
  var totalBac = 0;
  activeProjects.forEach(function(p) { totalBac += parseFloat(p.bac || 0); });
  completedProjects.forEach(function(p) { totalBac += parseFloat(p.bac || 0); });
  var elAmount = document.getElementById('summary-total-amount');
  if (elAmount) {
    var okuEn = (totalBac / 100000000).toFixed(2);
    elAmount.textContent = '';
    elAmount.appendChild(document.createTextNode(okuEn));
    var unitM = document.createElement('span');
    unitM.className = 'text-base font-normal text-gray-500 ml-1';
    unitM.textContent = '億円';
    elAmount.appendChild(unitM);
  }

  // 平均工事益率 = mean of (1 - ac/bac) for active projects
  var profitRates = [];
  activeProjects.forEach(function(p) {
    var bac = parseFloat(p.bac || 0);
    var ac  = parseFloat(p.ac  || 0);
    if (bac > 0) profitRates.push((bac - ac) / bac * 100);
  });
  var avgProfit = profitRates.length > 0
    ? (profitRates.reduce(function(a, b) { return a + b; }, 0) / profitRates.length).toFixed(1)
    : '---';
  var elProfit = document.getElementById('summary-avg-profit');
  if (elProfit) {
    elProfit.textContent = '';
    elProfit.appendChild(document.createTextNode(avgProfit));
    var unitP = document.createElement('span');
    unitP.className = 'text-base font-normal text-gray-500 ml-1';
    unitP.textContent = '%';
    elProfit.appendChild(unitP);
  }

  // サブタイトル更新
  var elSubtitle = document.getElementById('summary-subtitle');
  if (elSubtitle) {
    elSubtitle.textContent = '(株)森組 -- 全' + projects.length + '工事の横断ビュー';
  }

  // 全社信号ステータス更新
  var overCount = 0;
  var warnCount = 0;
  projects.forEach(function(p) {
    if (p.signal === '超過') overCount++;
    else if (p.signal === '注意') warnCount++;
  });
  var totalAlerts = overCount + warnCount;

  var sigIcon = document.getElementById('summary-signal-icon');
  var sigText = document.getElementById('summary-signal-text');
  var sigDetail = document.getElementById('summary-signal-detail');

  if (sigIcon) {
    sigIcon.className = 'signal-large';
    if (overCount > 0)      { sigIcon.classList.add('signal-red');    sigIcon.textContent = '!'; }
    else if (warnCount > 0) { sigIcon.classList.add('signal-yellow'); sigIcon.textContent = '!'; }
    else                    { sigIcon.classList.add('signal-green');  sigIcon.textContent = 'OK'; }
  }
  if (sigText) {
    var statusLabel = overCount > 0 ? '超過' : warnCount > 0 ? '注意' : '正常';
    sigText.textContent = '全社ステータス: ' + statusLabel;
  }
  if (sigDetail) {
    if (totalAlerts > 0) {
      sigDetail.textContent = '予算超過アラート: 合計' + totalAlerts + '件（超過' + overCount + '件 / 注意' + warnCount + '件）';
    } else {
      sigDetail.textContent = '全工事が正常範囲内';
    }
  }
}

/**
 * page0 の工事カードをリアルデータで動的生成
 * @param {Array} projects - hub.gs cross_health から取得した工事配列
 */
function renderProjectCards(projects) {
  var grid = document.getElementById('site-cards-grid');
  if (!grid) return;

  var active = projects.filter(function(p) {
    return p.status !== '完了' && p.consumption_rate != null && p.consumption_rate > 0;
  });
  if (active.length === 0) return;

  var fragment = document.createDocumentFragment();
  active.forEach(function(p) {
    var sig = p.signal || '';
    var borderColor = sig === '超過' ? '#E53935' : sig === '注意' ? '#FDD835' : '#2E7D32';
    var cr  = p.consumption_rate != null ? parseFloat(p.consumption_rate).toFixed(1) : '---';
    var bac = parseFloat(p.bac || 0);
    var ac  = parseFloat(p.ac  || 0);
    var profitPct = bac > 0 ? ((bac - ac) / bac * 100).toFixed(1) : '---';

    var card = document.createElement('div');
    card.style.cssText = 'background:white;border-radius:8px;padding:16px;box-shadow:0 2px 4px rgba(0,0,0,0.1);border-left:4px solid ' + borderColor + ';cursor:pointer;';
    card.addEventListener('click', (function(pid) { return function() { switchProject(pid); }; })(p.project_id));

    var titleDiv = document.createElement('div');
    titleDiv.style.cssText = 'font-weight:bold;font-size:15px;color:#333;';
    titleDiv.textContent = p.project_name || p.project_id;
    card.appendChild(titleDiv);

    var mgrDiv = document.createElement('div');
    mgrDiv.style.cssText = 'color:#666;font-size:12px;margin-top:2px;';
    mgrDiv.textContent = (p.manager || '') + ' | 進行中';
    card.appendChild(mgrDiv);

    var bacDiv = document.createElement('div');
    bacDiv.style.cssText = 'color:#888;font-size:11px;margin-top:4px;';
    bacDiv.textContent = '請負額: ' + (bac > 0 ? bac.toLocaleString() : '---') + '円';
    card.appendChild(bacDiv);

    var metricsDiv = document.createElement('div');
    metricsDiv.style.cssText = 'margin-top:10px;display:flex;justify-content:space-between;align-items:flex-end;';

    function makeMetric(label, value) {
      var d = document.createElement('div');
      d.style.textAlign = 'center';
      var lbl = document.createElement('div');
      lbl.style.cssText = 'font-size:11px;color:#888;';
      lbl.textContent = label;
      var val = document.createElement('div');
      val.style.cssText = 'font-weight:bold;font-size:16px;color:#1565C0;';
      val.textContent = value;
      d.appendChild(lbl);
      d.appendChild(val);
      return d;
    }

    var sigSpan = document.createElement('span');
    sigSpan.className = sig === '超過' ? 'status-label status-over' : sig === '注意' ? 'status-label status-warn' : 'status-label status-normal';
    sigSpan.textContent = sig === '超過' ? '超過' : sig === '注意' ? '注意' : '正常';
    var sigWrap = document.createElement('div');
    sigWrap.style.textAlign = 'center';
    var sigLbl = document.createElement('div');
    sigLbl.style.cssText = 'font-size:11px;color:#888;';
    sigLbl.textContent = '信号';
    sigWrap.appendChild(sigLbl);
    sigWrap.appendChild(sigSpan);

    metricsDiv.appendChild(makeMetric('工事益率', profitPct + '%'));
    metricsDiv.appendChild(makeMetric('消化率', cr + '%'));
    metricsDiv.appendChild(sigWrap);
    card.appendChild(metricsDiv);
    fragment.appendChild(card);
  });
  while (grid.firstChild) grid.removeChild(grid.firstChild);
  grid.appendChild(fragment);
}

/**
 * page0 の全現場アラートテーブルをリアルデータで更新
 * @param {Array} projects - hub.gs cross_health から取得した工事配列
 */
function renderAlertsTable(projects) {
  var tbody = document.getElementById('alerts-tbody');
  if (!tbody) return;

  var alerts = projects.filter(function(p) {
    return p.signal && p.signal !== '正常' && p.signal !== '';
  });
  if (alerts.length === 0) return;

  var fragment = document.createDocumentFragment();
  alerts.forEach(function(p) {
    var isOver = p.signal === '超過';
    var tr = document.createElement('tr');
    tr.className = isOver ? 'bg-red-50 alert-row alert-over' : 'bg-yellow-50 alert-row alert-warn';

    var cr = p.consumption_rate != null ? parseFloat(p.consumption_rate).toFixed(1) : '---';

    var td1 = document.createElement('td');
    td1.className = 'py-2 px-3 font-medium text-gray-600';
    td1.textContent = p.project_name || p.project_id;

    var td2 = document.createElement('td');
    td2.className = 'py-2 px-3 font-medium';
    td2.textContent = '予算消化率';

    var td3 = document.createElement('td');
    td3.className = 'py-2 px-3 text-right font-bold';
    td3.style.color = isOver ? '#E53935' : '#EF6C00';
    td3.textContent = cr + '%';

    var sigSpan = document.createElement('span');
    sigSpan.className = isOver ? 'status-label status-over' : 'status-label status-warn';
    sigSpan.textContent = isOver ? '超過' : '注意';
    var td4 = document.createElement('td');
    td4.className = 'py-2 px-3 text-center';
    td4.appendChild(sigSpan);

    tr.appendChild(td1);
    tr.appendChild(td2);
    tr.appendChild(td3);
    tr.appendChild(td4);
    fragment.appendChild(tr);
  });
  while (tbody.firstChild) tbody.removeChild(tbody.firstChild);
  tbody.appendChild(fragment);
}

/**
 * page1 の KPIカード・信号をリアルデータで更新
 * @param {Object} p - 1工事分の health オブジェクト
 */
function updateSiteKpi(p) {
  if (!p) return;
  var cr  = parseFloat(p.consumption_rate || 0);
  var bac = parseFloat(p.bac || 0);
  var ac  = parseFloat(p.ac  || 0);
  var sh  = parseFloat(p.shortage || 0);
  var sig = p.signal || '';
  var profitPct    = bac > 0 ? ((bac - ac) / bac * 100).toFixed(1) : '---';
  var netProfitPct = bac > 0 ? ((bac - ac) / bac * 100 - 5).toFixed(1) : '---';

  var el;
  el = document.getElementById('kpi-profit-rate');
  if (el) el.textContent = profitPct + '%';

  el = document.getElementById('kpi-net-profit-rate');
  if (el) el.textContent = netProfitPct + '%';

  el = document.getElementById('kpi-consumption-rate');
  if (el) el.textContent = cr.toFixed(1) + '%';

  el = document.getElementById('kpi-consumption-bar');
  if (el) el.style.width = Math.min(cr, 100) + '%';

  el = document.getElementById('kpi-forecast-amount');
  if (el) {
    el.textContent = '';
    var shK  = Math.round(sh / 1000);
    var sign = shK >= 0 ? '+' : '';
    var amtText = document.createTextNode(sign + shK.toLocaleString());
    var unitSpan = document.createElement('span');
    unitSpan.className = 'text-base font-normal text-gray-500 ml-1';
    unitSpan.textContent = '千円';
    el.appendChild(amtText);
    el.appendChild(unitSpan);
  }

  var sigEl = document.getElementById('site-signal');
  if (sigEl) {
    sigEl.className = 'signal-large';
    if (sig === '超過')      { sigEl.classList.add('signal-red');    sigEl.textContent = '!'; }
    else if (sig === '注意') { sigEl.classList.add('signal-yellow'); sigEl.textContent = '!'; }
    else                     { sigEl.classList.add('signal-green');  sigEl.textContent = 'OK'; }
  }

  var stEl = document.getElementById('site-status-text');
  if (stEl) stEl.textContent = '全体ステータス: ' + (sig || '---');
}

/**
 * page1 のKPIを指定工事IDのデータで更新する
 * キャッシュ優先。キャッシュになければ hub から再取得
 * @param {string} projectId - 工事ID（例: 'P001'）
 */
function loadSiteData(projectId) {
  var cached = _allProjectsData[projectId];
  if (cached) {
    updateSiteKpi(cached);
    return;
  }
  fetch(GAS_HUB_URL + '?mode=cross_health&month=' + DEMO_MONTH)
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.success && data.data && data.data.projects) {
        data.data.projects.forEach(function(p) { _allProjectsData[p.project_id] = p; });
        if (_allProjectsData[projectId]) updateSiteKpi(_allProjectsData[projectId]);
      }
    })
    .catch(function(e) { console.log('loadSiteData 再取得エラー: ' + e.message); });
}

/**
 * 工事切替ドロップダウンのハンドラ
 * @param {string} projectId - 工事IDまたは工事名テキスト
 */
function switchProject(projectId) {
  if (!projectId) return;

  var page1 = document.getElementById('page1');
  if (page1 && !page1.classList.contains('active')) {
    var navItem = document.querySelector('.nav-item[data-page="page1"]');
    showPage('page1', navItem);
  }

  loadSiteData(projectId);

  document.querySelectorAll('select').forEach(function(sel) {
    for (var i = 0; i < sel.options.length; i++) {
      var opt = sel.options[i];
      if (opt.value === projectId || opt.text.indexOf(projectId) >= 0) {
        sel.selectedIndex = i;
        break;
      }
    }
  });
}

// ===== View Toggle =====
let currentView = 'executive'; // 'executive' or 'manager'

function switchView(view) {
  currentView = view;
  // Update toggle buttons
  document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
  document.querySelector('.view-btn[data-view="' + view + '"]').classList.add('active');

  // Section visibility by view
  const execSection = document.getElementById('nav-section-executive');
  const siteDetailSection = document.getElementById('nav-section-site-detail');
  const diagSection = document.getElementById('nav-section-diagnosis');
  const navHealthCheck = document.getElementById('nav-health-check');

  if (view === 'manager') {
    // 所長ビュー: 経営者ビューセクション非表示、経営診断非表示、予算ヘルスチェック表示
    if (execSection) execSection.style.display = 'none';
    if (siteDetailSection) siteDetailSection.style.display = 'block';
    if (diagSection) diagSection.style.display = 'none';
    if (navHealthCheck) navHealthCheck.style.display = 'flex';
    // 現場詳細内のナビアイテム: AIチャット/経営診断系は非表示
    document.querySelectorAll('#nav-section-site-detail .nav-item').forEach(item => {
      const page = item.getAttribute('data-page');
      if (['page4','page5','page6','page7'].includes(page)) {
        item.style.display = 'none';
      } else {
        item.style.display = 'flex';
      }
    });
  } else {
    // 経営者ビュー: 全表示、予算ヘルスチェック非表示
    if (execSection) execSection.style.display = 'block';
    if (siteDetailSection) siteDetailSection.style.display = 'block';
    if (diagSection) diagSection.style.display = 'block';
    if (navHealthCheck) navHealthCheck.style.display = 'none';
    // page0非表示のナビアイテム制御不要（経営者ビューでは全表示）
    document.querySelectorAll('#nav-section-site-detail .nav-item').forEach(item => {
      const page = item.getAttribute('data-page');
      if (page === 'page35') {
        item.style.display = 'none';
      } else {
        item.style.display = 'flex';
      }
    });
  }

  // Switch P1 KPI cards
  const execKPI = document.getElementById('kpi-executive');
  const mgrKPI = document.getElementById('kpi-manager');
  if (execKPI && mgrKPI) {
    execKPI.style.display = (view === 'executive') ? 'grid' : 'none';
    mgrKPI.style.display = (view === 'manager') ? 'grid' : 'none';
  }

  // Show/hide P3 operation buttons
  const p3Buttons = document.getElementById('p3-operation-buttons');
  if (p3Buttons) {
    p3Buttons.style.display = (view === 'manager') ? 'block' : 'none';
  }

  // If current page is hidden, switch to appropriate default
  const currentPage = document.querySelector('.page-section.active');
  if (currentPage) {
    const pageId = currentPage.id;
    if (view === 'manager') {
      // 所長ビュー: page0/page4-7は非表示 -> page1に移動
      if (['page0','page4','page5','page6','page7'].includes(pageId)) {
        showPage('page1', document.querySelector('#nav-section-site-detail .nav-item[data-page="page1"]'));
      }
    }
    if (view === 'executive') {
      if (pageId === 'page35') {
        showPage('page0', document.querySelector('.nav-item[data-page="page0"]'));
      }
    }
  }
}

// ===== Navigation =====
function showPage(pageId, navElement) {
  // Prevent switching to a page hidden in current view
  if (currentView === 'manager' && ['page0','page4','page5','page6','page7'].includes(pageId)) {
    return;
  }
  if (currentView === 'executive' && pageId === 'page35') {
    return;
  }
  document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  var pageEl = document.getElementById(pageId);
  if (pageEl) pageEl.classList.add('active');
  if (navElement) navElement.classList.add('active');
  // Close sidebar on mobile
  if (window.innerWidth < 768) {
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('overlay').classList.add('hidden');
  }
  // Initialize charts for the page
  initCharts(pageId);
}

function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('overlay');
  sidebar.classList.toggle('open');
  overlay.classList.toggle('hidden');
}

// ===== Chart Initialization =====
const chartInstances = {};

function destroyChart(id) {
  if (chartInstances[id]) {
    chartInstances[id].destroy();
    delete chartInstances[id];
  }
}

function initCharts(pageId) {
  switch(pageId) {
    case 'page2': initPage2Charts(); break;
    case 'page3': initPage3Charts(); break;
    case 'page5': initPage5Charts(); break;
    case 'page6': initPage6Charts(); break;
    case 'page7': initPage7Charts(); break;
  }
}

// ----- Page 2 Charts -----
function initPage2Charts() {
  // Monthly Expenditure Line Chart (page1から移動)
  destroyChart('chart-page2-line');
  const ctxLine = document.getElementById('chart-page2-line').getContext('2d');
  chartInstances['chart-page2-line'] = new Chart(ctxLine, {
    type: 'line',
    data: {
      labels: ['10月', '11月', '12月'],
      datasets: [{
        label: '月別支出（円）',
        data: [10933337, 8458604, 4332077],
        borderColor: '#1565C0',
        backgroundColor: 'rgba(21,101,192,0.12)',
        fill: true,
        tension: 0.3,
        pointRadius: 5,
        pointBackgroundColor: '#1565C0'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(ctx) {
              return ctx.parsed.y.toLocaleString() + '円';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(v) { return (v / 1000000).toFixed(0) + 'M'; }
          },
          title: { display: true, text: '支出額' }
        }
      }
    }
  });

  destroyChart('chart-page2-bar');
  const ctx = document.getElementById('chart-page2-bar').getContext('2d');
  chartInstances['chart-page2-bar'] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['直接工事費', '共通仮設費', '現場管理費'],
      datasets: [
        {
          label: '予算',
          data: [27095460, 1926588, 4859949],
          backgroundColor: '#1565C0'
        },
        {
          label: '実績',
          data: [10789631, 907661, 3095040],
          backgroundColor: '#9E9E9E'
        }
      ]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        tooltip: {
          callbacks: {
            label: function(ctx) {
              return ctx.dataset.label + ': ' + ctx.parsed.x.toLocaleString() + '円';
            }
          }
        }
      },
      scales: {
        x: {
          ticks: {
            callback: function(v) { return (v / 1000000).toFixed(1) + 'M'; }
          }
        }
      }
    }
  });
}

// ----- Page 3 Charts -----
function initPage3Charts() {
  // Doughnut
  destroyChart('chart-page3-doughnut');
  const ctx1 = document.getElementById('chart-page3-doughnut').getContext('2d');
  chartInstances['chart-page3-doughnut'] = new Chart(ctx1, {
    type: 'doughnut',
    data: {
      labels: ['直接工事費', '現場管理費', '共通仮設費'],
      datasets: [{
        data: [73, 21, 6],
        backgroundColor: ['#1565C0', '#EF6C00', '#2E7D32'],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        tooltip: {
          callbacks: {
            label: function(ctx) {
              return ctx.label + ': ' + ctx.parsed + '%';
            }
          }
        }
      }
    }
  });

  // Vendors
  destroyChart('chart-page3-vendors');
  const ctx2 = document.getElementById('chart-page3-vendors').getContext('2d');
  chartInstances['chart-page3-vendors'] = new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: [
        '川越建設', '桜島生コンクリート', '(有)濱畑水道', '菱和コンクリート',
        '(株)グリーンクロス', '(株)ニシケン', '(有)大建測量設計', '(株)デザインアーク',
        '(株)コマロック', 'その他'
      ],
      datasets: [{
        label: '支払額（円）',
        data: [9667000, 5205650, 4839554, 1910000, 432940, 173175, 170000, 150000, 145440, 230259],
        backgroundColor: '#1565C0'
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(ctx) {
              return ctx.parsed.x.toLocaleString() + '円';
            }
          }
        }
      },
      scales: {
        x: {
          ticks: {
            callback: function(v) { return (v / 1000000).toFixed(1) + 'M'; }
          }
        }
      }
    }
  });

  // Stacked monthly
  destroyChart('chart-page3-stacked');
  const ctx3 = document.getElementById('chart-page3-stacked').getContext('2d');
  chartInstances['chart-page3-stacked'] = new Chart(ctx3, {
    type: 'bar',
    data: {
      labels: ['10月', '11月', '12月'],
      datasets: [
        {
          label: '直接工事費',
          data: [3162969, 3481347, 4145315],
          backgroundColor: '#1565C0'
        },
        {
          label: '現場管理費',
          data: [1705863, 502357, 886821],
          backgroundColor: '#EF6C00'
        },
        {
          label: '共通仮設費',
          data: [489566, 268154, 149941],
          backgroundColor: '#2E7D32'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        tooltip: {
          callbacks: {
            label: function(ctx) {
              return ctx.dataset.label + ': ' + ctx.parsed.y.toLocaleString() + '円';
            }
          }
        }
      },
      scales: {
        x: { stacked: true },
        y: {
          stacked: true,
          ticks: {
            callback: function(v) { return (v / 1000000).toFixed(0) + 'M'; }
          }
        }
      }
    }
  });

  // Legal 4 categories doughnut
  destroyChart('chart-page3-legal4');
  const ctx4 = document.getElementById('chart-page3-legal4').getContext('2d');
  chartInstances['chart-page3-legal4'] = new Chart(ctx4, {
    type: 'doughnut',
    data: {
      labels: ['材料費', '労務費', '外注費', '経費'],
      datasets: [{
        data: [28.4, 7.0, 37.6, 27.0],
        backgroundColor: ['#1565C0', '#2E7D32', '#EF6C00', '#6A1B9A'],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { font: { size: 11 } }
        },
        tooltip: {
          callbacks: {
            label: function(ctx) {
              return ctx.label + ': ' + ctx.parsed + '%';
            }
          }
        }
      }
    }
  });
}

// ----- Page 5 Charts -----
function initPage5Charts() {
  // Sales comparison
  destroyChart('chart-page5-sales');
  const ctx1 = document.getElementById('chart-page5-sales').getContext('2d');
  chartInstances['chart-page5-sales'] = new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: ['売上高', '売上原価', '粗利'],
      datasets: [
        {
          label: '前年度',
          data: [897900000, 821900000, 76000000],
          backgroundColor: '#9E9E9E'
        },
        {
          label: '今年度',
          data: [1146800000, 1069500000, 77300000],
          backgroundColor: '#1565C0'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        tooltip: {
          callbacks: {
            label: function(ctx) {
              return ctx.dataset.label + ': ' + (ctx.parsed.y / 1000000).toFixed(1) + 'M円';
            }
          }
        }
      },
      scales: {
        y: {
          ticks: {
            callback: function(v) { return (v / 1000000).toFixed(0) + 'M'; }
          }
        }
      }
    }
  });

  // Profit by project
  destroyChart('chart-page5-profit');
  const ctx2 = document.getElementById('chart-page5-profit').getContext('2d');
  chartInstances['chart-page5-profit'] = new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: ['中村', '池田', '中原', '上村'],
      datasets: [{
        label: '粗利率（%）',
        data: [28.9, 25.6, 15.4, 14.0],
        backgroundColor: ['#1565C0', '#1565C0', '#EF6C00', '#E53935']
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(ctx) {
              return ctx.parsed.x + '%';
            }
          }
        }
      },
      scales: {
        x: {
          max: 35,
          ticks: {
            callback: function(v) { return v + '%'; }
          }
        }
      }
    }
  });
}

// ----- Page 6 Charts -----
function initPage6Charts() {
  // Ranking
  destroyChart('chart-page6-ranking');
  const ctx1 = document.getElementById('chart-page6-ranking').getContext('2d');
  chartInstances['chart-page6-ranking'] = new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: ['中村竜一(境川)', '池田豊(野尻川)', '中原輝竜(持木川)', '上村和弘(海潟漁港)'],
      datasets: [{
        label: '粗利率（%）',
        data: [28.9, 25.6, 15.4, 14.0],
        backgroundColor: ['#1565C0', '#1565C0', '#EF6C00', '#E53935']
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(ctx) {
              return ctx.parsed.x + '%';
            }
          }
        }
      },
      scales: {
        x: {
          max: 35,
          ticks: { callback: function(v) { return v + '%'; } }
        }
      }
    }
  });

  // Cost Structure (100% stacked)
  destroyChart('chart-page6-structure');
  const ctx2 = document.getElementById('chart-page6-structure').getContext('2d');
  chartInstances['chart-page6-structure'] = new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: ['池田', '中村', '上村', '中原'],
      datasets: [
        {
          label: '外注',
          data: [99.6, 58.3, 37.5, 61.9],
          backgroundColor: '#1565C0'
        },
        {
          label: '材料',
          data: [0.0, 34.5, 30.3, 37.9],
          backgroundColor: '#2E7D32'
        },
        {
          label: '労務',
          data: [0.0, 0.0, 12.0, 0.0],
          backgroundColor: '#FDD835'
        },
        {
          label: 'その他',
          data: [0.4, 7.2, 20.2, 0.2],
          backgroundColor: '#9E9E9E'
        }
      ]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        tooltip: {
          callbacks: {
            label: function(ctx) {
              return ctx.dataset.label + ': ' + ctx.parsed.x + '%';
            }
          }
        }
      },
      scales: {
        x: {
          stacked: true,
          max: 100,
          ticks: { callback: function(v) { return v + '%'; } }
        },
        y: { stacked: true }
      }
    }
  });
}

// ----- Page 7 Charts -----
function initPage7Charts() {
  // Unit Price Gap
  destroyChart('chart-page7-gap');
  const ctx1 = document.getElementById('chart-page7-gap').getContext('2d');
  chartInstances['chart-page7-gap'] = new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: ['掘削工(ICT)', '土砂運搬'],
      datasets: [
        {
          label: '最安（池田）',
          data: [505, 844],
          backgroundColor: '#1565C0'
        },
        {
          label: '最高（中原）',
          data: [850, 1500],
          backgroundColor: '#E53935'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        tooltip: {
          callbacks: {
            label: function(ctx) {
              return ctx.dataset.label + ': ' + ctx.parsed.y.toLocaleString() + '円';
            }
          }
        },
        annotation: undefined
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { callback: function(v) { return v.toLocaleString() + '円'; } },
          title: { display: true, text: '単価（円）' }
        }
      }
    },
    plugins: [{
      afterDraw: function(chart) {
        const ctx = chart.ctx;
        const meta0 = chart.getDatasetMeta(0);
        const meta1 = chart.getDatasetMeta(1);
        ctx.save();
        ctx.font = 'bold 13px sans-serif';
        ctx.fillStyle = '#E53935';
        ctx.textAlign = 'center';
        // Gap labels
        const gaps = ['1.68倍', '1.78倍'];
        for (let i = 0; i < 2; i++) {
          const bar1 = meta1.data[i];
          const x = bar1.x;
          const y = bar1.y - 8;
          ctx.fillText(gaps[i], x, y);
        }
        ctx.restore();
      }
    }]
  });

  // Annual Improvement
  destroyChart('chart-page7-improvement');
  const ctx2 = document.getElementById('chart-page7-improvement').getContext('2d');
  chartInstances['chart-page7-improvement'] = new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: ['外注単価標準化', '工事特性考慮'],
      datasets: [
        {
          label: '最小見込み',
          data: [5000, 700],
          backgroundColor: 'rgba(21,101,192,0.4)',
          borderColor: '#1565C0',
          borderWidth: 1
        },
        {
          label: '最大見込み',
          data: [4000, 500],
          backgroundColor: 'rgba(21,101,192,0.8)',
          borderColor: '#1565C0',
          borderWidth: 1
        }
      ]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        tooltip: {
          callbacks: {
            label: function(ctx) {
              if (ctx.datasetIndex === 0) {
                const mins = [5000, 700];
                return '最小: ' + mins[ctx.dataIndex].toLocaleString() + '万円/年';
              } else {
                const maxs = [9000, 1200];
                return '最大: ' + maxs[ctx.dataIndex].toLocaleString() + '万円/年';
              }
            }
          }
        }
      },
      scales: {
        x: {
          stacked: true,
          ticks: { callback: function(v) { return v.toLocaleString() + '万円'; } },
          title: { display: true, text: '年間改善効果（万円/年）' }
        },
        y: { stacked: true }
      }
    }
  });
}

// ===== UX-02: アラートフィルタ =====
function filterAlerts(filter) {
  var rows = document.querySelectorAll('.alert-row');
  rows.forEach(function(row) {
    if (filter === 'all') {
      row.style.display = '';
    } else if (filter === 'over') {
      row.style.display = row.classList.contains('alert-over') ? '' : 'none';
    }
  });
  // ボタンのアクティブ状態
  document.querySelectorAll('.alert-filter-btn').forEach(function(btn) {
    if (btn.dataset.filter === filter) {
      btn.classList.remove('bg-gray-200', 'text-gray-600');
      btn.classList.add(filter === 'over' ? 'bg-[#E53935]' : 'bg-[#1565C0]', 'text-white');
    } else {
      btn.classList.remove('bg-[#E53935]', 'bg-[#1565C0]', 'text-white');
      btn.classList.add('bg-gray-200', 'text-gray-600');
    }
  });
}

// ===== UX-04: 高コントラストモード =====
function toggleHighContrast() {
  var body = document.body;
  var btn = document.getElementById('hc-toggle-btn');
  body.classList.toggle('high-contrast');
  btn.classList.toggle('active');
}

// ===== Initialize on load =====
document.addEventListener('DOMContentLoaded', function() {
  // page1にはグラフがなくなったため、Chart.js初期化不要
  // Phase G: GAS APIからリアルデータを取得
  initDashboard();
});
</script>
</body>
</html>
