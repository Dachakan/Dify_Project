# PoC実行プレイブック -- 海潟漁港R7-1

| 項目 | 内容 |
|------|------|
| 目的 | PoC環境構築から提案デモリハーサルまでを1日で完了する |
| 対象工事 | 海潟漁港R7-1工区 |
| 所要時間 | 5.5時間（Phase A-F） |
| 前提 | GAS 6ファイル + TSVテストデータ3種が手元にあること |
| 作成日 | 2026-02-20 |

---

## 所要時間サマリ

| Phase | 作業 | 所要時間 |
|-------|------|---------|
| A | 環境構築（SS作成+GASコピー+テンプレート生成+トリガー設定） | 1h |
| B | データ投入（予算13行+取引先29行+明細82行+出来高率） | 1.5h |
| C | E2Eテスト（DD+集計+健康度+API+前行コピー） | 1h |
| D | スクリーンショット取得と差し替え | 30min |
| E | プレゼン資料完成 | 30min |
| F | デモリハーサル（通し60分+調整） | 1h |
| **合計** | | **5.5h** |

---

## 前提条件

- [ ] Googleアカウント（Google Workspace推奨）
- [ ] `gas_templates/budget_management/` 配下の6ファイルにアクセスできること
- [ ] `output/` 配下のTSVファイル3種にアクセスできること
- [ ] Chrome ブラウザ（最新版）

---

## Phase A: 環境構築（1h）

### A-1. スプレッドシート新規作成

- [ ] 1. Google Driveで新規スプレッドシートを作成
  - 名前: `海潟漁港_PoC_YYYYMMDD`（例: 海潟漁港_PoC_20260301）
  - 成功時: 空のスプレッドシートが開く

### A-2. GASプロジェクトにコードをコピー

- [ ] 2. メニュー「拡張機能」->「Apps Script」でエディタを開く
  - 成功時: Apps Scriptエディタが新しいタブで開く

- [ ] 3. 以下の6ファイルをApps Scriptエディタにコピー

エディタ左上の「+」->「スクリプト」で新ファイル追加。各ファイルの内容を全てコピー&ペースト。

| 順序 | ファイル名 | コピー元パス | 備考 |
|------|-----------|-------------|------|
| 1 | config.gs | gas_templates/budget_management/config.gs | 最初にコピー（定数定義） |
| 2 | template.gs | gas_templates/budget_management/template.gs | テンプレート生成 |
| 3 | validation_extended.gs | gas_templates/budget_management/validation_extended.gs | カスケードDD |
| 4 | aggregation.gs | gas_templates/budget_management/aggregation.gs | 月次集計 |
| 5 | budget_health.gs | gas_templates/budget_management/budget_health.gs | 予算健康度 |
| 6 | api.gs | gas_templates/budget_management/api.gs | Web App API |

**hub.gsを入れない理由**: hub.gsは本社横断管理用。api.gsとdoGet()が衝突するため同一GASプロジェクトに配置できない。PoCでは現場単体テストを6ファイルで実施し、hub.gsの横断テストはパイロット導入時に別スプレッドシートで実施する。

- 成功時: エディタ左側に6つのファイルが表示される

### A-3. スクリプトプロパティの設定

- [ ] 4. Apps Scriptエディタ -> 歯車アイコン（プロジェクトの設定） -> スクリプトプロパティ

| プロパティ名 | 値 | 説明 |
|------------|---|------|
| API_KEY | 任意の文字列（例: poc_key_20260301） | API認証キー |
| ALERT_EMAIL | テスト用メールアドレス | 予算超過時の通知先 |
| SPREADSHEET_ID | スプレッドシートのID（URLの /d/ と /edit の間の文字列） | **Phase B方法1（setup_project_data.gs方式）を使う場合のみ必要** |

- 成功時: 「プロパティが正常に保存されました」と表示される

### A-4. テンプレート生成

**Phase B方法1（setup_project_data.gs方式）を選択する場合、A-4はスキップ可能。** setup_project_data.gsのstep 13でtestInit()を実行する。

**方法2（TSV手動貼り付け）を選択する場合のみ実施。**

- [ ] 5. Apps Scriptエディタに以下のテストスクリプトを一時的に追加:

```javascript
// テスト用（動作確認後に削除）
function testInit() {
  initProjectTemplate('P004');
}
```

- [ ] 6. 実行する関数として「testInit」を選択し、実行
  - 初回実行時: Googleアカウントの認証許可が求められる -> 「許可」をクリック
  - 成功時: スプレッドシートに9シートが自動生成される

### A-5. 生成シートの確認

- [ ] 7. 以下の9シートが全て生成されていることを確認

| シート名 | 役割 | 確認ポイント |
|---------|------|-----------|
| _実行予算テーブル | 予算の箱定義 | 工種x費用要素の行が生成されている |
| _実行予算_月別 | 月別配分 | 開始月/終了月の列がある |
| 支払明細入力 | メイン入力画面 | 18列のヘッダーが正しい（A:No. - R:備考） |
| 支払明細 | 転記済み明細 | 空のシート |
| _C_予算健康度 | 予算健康度 | ヘッダー行がある |
| _C_月次集計 | 月次集計 | ヘッダー行がある |
| _C_費目別集計 | 費目別集計 | ヘッダー行がある |
| _月次調整 | 出来高率入力 | 年月と出来高率の列がある |
| _M取引先 | 取引先マスタ | 空 or サンプルデータ |

- 成功時: タブバーに9つのシートが並ぶ

### A-6. onEditトリガーの設定

カスケードDDの自動連動にはトリガー設定が必須。Phase Cで「DDが動かない」典型問題を防ぐため、この段階で設定しておく。

- [ ] 8. Apps Scriptエディタ -> 左サイドバーの時計アイコン（トリガー）をクリック
- [ ] 9. 「トリガーを追加」をクリックし、以下の設定を行う:

| 項目 | 設定値 |
|------|--------|
| 実行する関数 | onEditHandler |
| イベントのソース | スプレッドシートから |
| イベントの種類 | 編集時 |

- [ ] 10. 「保存」をクリック
  - 成功時: トリガー一覧に「onEditHandler - 編集時」が表示される

---

## Phase B: データ投入

### B-0. 方法選択

| 方法 | 所要時間 | 手順 | 備考 |
|------|---------|------|------|
| 方法1: setup_project_data.gs方式 | 約10分 | GASスクリプト5関数を順に実行 | 推奨。A-3でSPREADSHEET_IDを設定済みであること |
| 方法2: TSV手動貼り付け方式 | 約30分 | TSV 3ファイルをコピー&ペースト | 方法1が使えない場合の代替 |

**どちらを選んでもPhase Cは同じ手順。** setup_project_data.gsはPoC専用ファイルなので、完了後は削除すること。

---

### B方法1: setup_project_data.gs方式（推奨）

**前提**: A-3のスクリプトプロパティに`SPREADSHEET_ID`が設定済みであること。
`SPREADSHEET_ID`の値: スプレッドシートのURL `https://docs.google.com/spreadsheets/d/{ここがID}/edit` の中の文字列。

- [ ] 11. Apps Scriptエディタで「+」->「スクリプト」を選択し、ファイル名を「setup_project_data」にして作成
  - コピー元: gas_templates/budget_management/setup_project_data.gs の全内容
  - 全コードをコピー&ペーストして保存
  - 成功時: エディタ左側に7番目のファイル「setup_project_data.gs」が表示される

- [ ] 12. setupProjectData()を実行（_M工事シートにP004データ作成）
  - エディタ上部の関数選択ドロップダウンで「setupProjectData」を選択し、実行ボタン（▶）をクリック
  - 成功時: ログに「_M工事シート作成完了: P004 海潟漁港R7-1工区」と表示される

- [ ] 13. testInit()を実行（9シート生成）
  - 関数選択を「testInit」に切り替えて実行（Phase A-4のtestInit関数）
  - 初回実行時: Googleアカウントの認証許可が求められる -> 「許可」をクリック
  - 成功時: スプレッドシートに9シートが自動生成される
  - **A-5の9シート確認チェックリストで生成結果を照合すること**

- [ ] 14. setupBudget()を実行（実行予算13行投入）
  - 関数選択を「setupBudget」に切り替えて実行
  - 成功時: ログに「_実行予算テーブル投入完了: 13行」と表示される

- [ ] 15. setupVendors()を実行（取引先マスタ29行投入）
  - 関数選択を「setupVendors」に切り替えて実行
  - 成功時: ログに「_M取引先投入完了: 29行」と表示される

- [ ] 16. setupPaymentDetails()を実行（支払明細82行投入）
  - 関数選択を「setupPaymentDetails」に切り替えて実行
  - 処理時間: 10秒程度かかる場合がある
  - 成功時: ログに「支払明細入力投入完了: 82行」と表示される

- [ ] 17. setupProgressRate()を実行（出来高率投入）
  - 関数選択を「setupProgressRate」に切り替えて実行
  - 成功時: ログに「_月次調整 出来高率投入完了: 3行」と表示される

- [ ] 18. setup_project_data.gsを削除（PoC専用ファイルは本番環境に残さない）
  - エディタ左側のファイル一覧で「setup_project_data」を右クリック -> 「削除」
  - 確認ダイアログで「削除」を選択
  - 成功時: エディタに6ファイルのみ残る

**方法1完了。Phase Cへ進む（以下のB-1〜B-4は不要）。**

---

### B方法2: TSV手動貼り付け方式（代替）

方法1を使えない場合のみ実施。Phase A-4のtestInit()が完了していること。

TSV一括投入方式を採用。82件の手入力は非効率なため、コピー&ペーストで一括投入する。

### B-1. 実行予算の投入（poc_budget.tsv -> _実行予算テーブル、13行）

- [ ] 11. `output/poc_budget.tsv` をテキストエディタで開く

- [ ] 12. _実行予算テーブルシートを開き、ヘッダー行の列構成を確認

TSVとシートの列対応表:

| TSV列名 | 列位置 | 説明 |
|---------|--------|------|
| budget_box_id | A | 予算箱ID（例: C01-W04-K9901-E11） |
| category_id | B | カテゴリID（C01/C02/C03） |
| category_name | C | カテゴリ名（直接工事費/共通仮設費/現場管理費） |
| work_type_id | D | 工事種別ID（W04等、共通仮設費/現場管理費は空） |
| work_type_name | E | 工事種別名 |
| koushus_id | F | 工種ID（K9901等） |
| koushus_name | G | 工種名 |
| expense_id | H | 費目ID（E11/E12/E14/F32等） |
| expense_name | I | 費目名 |
| budget_amount | J | 実行予算額 |
| official_amount | K | 官積算額（空欄可） |
| start_month | L | 開始月（2025-10） |
| end_month | M | 終了月（2026-03） |
| note | N | 備考 |

- [ ] 13. TSVのデータ行（ヘッダー除く13行）を選択してコピー
- [ ] 14. _実行予算テーブルシートのA2セルを選択し、貼り付け

投入後の照合チェック:

| 確認項目 | 期待値 |
|---------|--------|
| データ行数 | 13行（A2:A14にデータ） |
| 直接工事費の予算箱 | 3行（C01-W04-K9901-E11/E12/E14） |
| 共通仮設費の予算箱 | 5行（C02-F32/F35/F36/F38/F39） |
| 現場管理費の予算箱 | 5行（C03-F51/F59/F60/F61/F67） |
| 直接工事費合計 | 45,520,000円 |

- 成功時: 13行のデータが正しく表示される

### B-2. 取引先マスタの投入（poc_vendors.tsv -> _M取引先、29行）

- [ ] 15. `output/poc_vendors.tsv` をテキストエディタで開く

- [ ] 16. _M取引先シートを開く

TSVとシートの列対応表:

| TSV列名 | 列位置 | 説明 |
|---------|--------|------|
| vendor_id | A | 取引先ID（V001-V029） |
| vendor_name | B | 取引先名 |
| vendor_type | C | 業種区分（subcontractor/supplier/service/retail） |
| active | D | 有効フラグ（TRUE） |

- [ ] 17. TSVのデータ行（ヘッダー除く29行）を選択してコピー
- [ ] 18. _M取引先シートのA2セルを選択し、貼り付け

投入後の照合チェック:

| 確認項目 | 期待値 |
|---------|--------|
| データ行数 | 29行（V001-V029） |
| 主要下請業者 | 川越建設(株), (有)濱畑水道, 菱和コンクリート(株) |
| 主要材料業者 | 桜島生コンクリート(株), (株)グリーンクロス |

- 成功時: 支払明細入力シートのF列DDに業者名が表示される

### B-3. 支払明細の一括投入（poc_test_data.tsv -> 支払明細入力、82行）

- [ ] 19. `output/poc_test_data.tsv` をテキストエディタで開く

TSVとシートの列対応表（18列）:

| TSV列名 | 列 | 色分け | 説明 |
|---------|-----|--------|------|
| No. | A | 緑（所長入力） | 連番 |
| カテゴリ | B | 緑 | 直接工事費/共通仮設費/現場管理費 |
| 工事種別 | C | 緑 | W04等（共通仮設費/現場管理費は空） |
| 工種 | D | 緑 | K9901等 |
| 費目 | E | 緑 | E11/E12/E14/F32等 |
| 支払先 | F | 緑 | 業者名 |
| 支払年月 | G | 緑 | 2025-10/2025-11/2025-12 |
| 数量 | H | 緑 | 1 |
| 単位 | I | 緑 | 式 |
| 単価 | J | 緑 | 金額 |
| 金額 | K | 緑 | =数量x単価 |
| 相殺額 | L | 青（事務員追記） | 相殺がある場合のみ |
| 相殺先 | M | 青 | 相殺先業者名 |
| 課税区分 | N | 灰（自動計算） | 課税/非課税 |
| 消費税 | O | 灰 | 自動計算 |
| 税込合計 | P | 灰 | 自動計算 |
| 予算箱ID | Q | 灰 | 自動解決 |
| 備考 | R | 灰 | メモ |

- [ ] 20. TSVのデータ行（ヘッダー除く82行）を全て選択してコピー
- [ ] 21. 支払明細入力シートのA2セルを選択し、貼り付け

**注意**: ペーストではonEditが発火しないため、カスケードDDの自動絞り込みは発動しない。ただしTSVデータには正しい値が入っているので、集計テストには支障なし。DD動作の確認はPhase Cで手動入力して行う。

投入後の照合チェック:

| 確認項目 | 期待値 |
|---------|--------|
| データ行数 | 82行（No.1-82） |
| 10月度件数 | 31件（No.1-31） |
| 11月度件数 | 26件（No.32-57） |
| 12月度件数 | 25件（No.58-82） |
| 10月支払計（税抜・K列合計） | 10,933,337円 |
| 11月支払計（税抜・K列合計） | 8,458,604円 |
| 12月支払計（税抜・K列合計） | 4,332,077円 |

- 成功時: 82件のデータが支払明細入力シートに表示される

### B-4. 出来高率の入力（_月次調整シート）

- [ ] 22. _月次調整シートを開く
- [ ] 23. 以下の出来高率を入力（デモ用の仮値）:

| 年月 | 出来高率 |
|------|---------|
| 2025-10 | 30% |
| 2025-11 | 50% |
| 2025-12 | 70% |

- 成功時: 3行の出来高率データが入力される

---

## Phase C: E2Eテスト（1h）

### C-1. カスケードDD動作テスト

ペースト投入したデータとは別に、手動で新規入力してDDの連動を確認する。

- [ ] 24. 支払明細入力シートの83行目（最終データの次の行）に移動
- [ ] 25. B列（カテゴリ）をクリック ->「直接工事費」を選択
- [ ] 26. C列（工事種別）をクリック -> DDが連動し、直接工事費に関係する工事種別だけ表示されることを確認
- [ ] 27. C列で「護岸・海岸工事」を選択
- [ ] 28. D列（工種）をクリック -> DDが連動し、護岸・海岸工事の工種だけ表示されることを確認
- [ ] 29. D列で「測量丁張工」を選択
- [ ] 30. E列（費目）をクリック -> DDが連動し、測量丁張工のavailable_elements（E12, E14等）だけ表示されることを確認
- [ ] 31. E列で「外注費」を選択

**>>> [スクリーンショット SS2: DD連動中の画面] <<<**
この瞬間にスクリーンショットを取得する。DD選択肢が展開された状態を撮る。

- [ ] 32. F列で「川越建設(株)」を選択、G列に「2026-01」、J列に「500000」を入力
- [ ] 33. 自動計算列（N-R列）に値が入ることを確認
  - 期待値: 消費税50,000円、税込合計550,000円、予算箱ID: C01-W04-K9901-E14

DDが動かない場合: Phase A-6のonEditトリガー設定を再確認する。

### C-2. 月次集計テスト

- [ ] 34. メニュー「工事管理」->「月次集計を実行」をクリック
  - 処理中スピナーが表示される。3秒程度待つ
  - 成功時: _C_月次集計シートと_C_費目別集計シートにデータが表示される

- [ ] 35. _C_費目別集計シートに切り替え、以下の値を照合

| カテゴリ | 実行予算額 | 集計結果（期待値） | 照合 |
|---------|----------|----------------|------|
| 直接工事費 | 45,520,000円 | poc_test_data集計値 | [ ] |
| 共通仮設費 | 1,653,000円 | poc_test_data集計値 | [ ] |
| 現場管理費 | 282,000円 | poc_test_data集計値 | [ ] |

**>>> [スクリーンショット SS3: _C_費目別集計シート] <<<**

集計結果が0の場合: 支払明細のQ列（予算箱ID）が空でないか確認。空の場合、validation_extended.gsの予算箱ID解決ロジックを確認する。

### C-3. 予算健康度テスト

- [ ] 36. メニュー「工事管理」->「予算健康度を更新」をクリック
  - 成功時: _C_予算健康度シートに消化率/信号が表示される

- [ ] 37. _C_予算健康度シートに切り替え、信号判定を確認

消化率がNaNの場合: _実行予算テーブルの予算額が空でないか確認する。

**>>> [スクリーンショット SS4: _C_予算健康度シート+信号表示] <<<**

### C-4. APIデプロイテスト

- [ ] 38. Apps Scriptエディタ -> 「デプロイ」->「新しいデプロイ」
  - 種類: ウェブアプリ
  - 実行するユーザー: 自分
  - アクセスできるユーザー: 「自分のみ」（テスト時）
- [ ] 39. デプロイURL をメモする

- [ ] 40. mode=health のテスト

```
{デプロイURL}?mode=health&key={API_KEY}
```

期待: 費目別の消化率/信号を含むJSON

- [ ] 41. mode=summary のテスト

```
{デプロイURL}?mode=summary&key={API_KEY}
```

期待: 工事価格/消化率/累計支出を含むJSON

API認証エラーの場合: スクリプトプロパティのAPI_KEYと一致しているか確認する。

### C-5. 前行コピーテスト

- [ ] 42. 支払明細入力シートのC-1で入力した行のすぐ下のセルを選択
- [ ] 43. メニュー「工事管理」->「前行コピー」をクリック
  - 成功時: カテゴリ、工事種別、工種、費目、支払先が前行からコピーされる
- [ ] 44. テスト用に入力した行（83行目以降）を削除して元に戻す

---

## Phase D: スクリーンショット取得と差し替え（30min）

### D-1. 取得するスクリーンショット一覧

Phase Cで取得した3枚に加え、追加で撮影する。

| No. | 対象画面 | 取得タイミング | 差し替え先 |
|-----|---------|--------------|----------|
| SS1 | 支払明細入力シート全体（A-R列が見える状態） | Phase D | presentation_slides.md スライド7, manual_director.html（4箇所） |
| SS2 | カスケードDD連動中（E列の選択肢展開中） | Phase C-1 手順31 | presentation_slides.md スライド8, manual_director.html（2箇所） |
| SS3 | _C_費目別集計シート | Phase C-2 手順35 | presentation_slides.md スライド9, manual_office_staff.html（1箇所） |
| SS4 | _C_予算健康度+信号表示 | Phase C-3 手順37 | presentation_slides.md スライド10, manual_director.html（1箇所） |
| SS5 | mockup_sites.html トップページ（4枚のKPIカード表示） | Phase D | presentation_slides.md スライド12 |
| SS6 | 相殺入力画面（L-M列にマーキング） | Phase D | manual_office_staff.html（3箇所） |

### D-2. 追加スクリーンショットの撮影

- [ ] 45. **SS1取得**: 支払明細入力シートを開き、A1セルを選択した状態で全体をスクリーンショット
  - 18列のヘッダーが見える状態にする
  - 数行分のデータが見えるよう表示倍率を調整（90-100%推奨）

- [ ] 46. **SS5取得**: mockup_sites.htmlをブラウザで開き、トップページのKPIカード4枚が表示された状態をスクリーンショット

- [ ] 47. **SS6取得**: 支払明細入力シートで、相殺がある行（例: No.6, L列=90000, M列=川越建設(株)）のL-M列付近をスクリーンショット

### D-3. presentation_slides.mdへの差し替え

presentation_slides.mdをGoogle SlidesまたはPowerPointに変換後、以下のスクリーンショットを貼り付ける:

| スライド | 現在の記載 | 差し替え画像 |
|---------|----------|------------|
| スライド7 | `[スクリーンショット: テストSS 支払明細入力シート]` | SS1 |
| スライド8 | （セリフのみ、画像なし） | SS2を追加 |
| スライド9 | `[スクリーンショット: テストSS 費目別集計シート]` | SS3 |
| スライド10 | （表のみ、画像なし） | SS4を追加 |
| スライド12 | `[スクリーンショット: mockup_sites.html トップページ]` | SS5 |

### D-4. HTMLマニュアルへの差し替え

manual_director.html / manual_office_staff.html の `[図: ...]` プレースホルダーをimgタグで差し替える。

**manual_director.html（8箇所）:**

| 行付近 | プレースホルダー | 使用画像 |
|--------|----------------|---------|
| 219行 | [図: スプレッドシートを開いた直後の画面] | SS1 |
| 302行 | [図: B列のドロップダウンでカテゴリを選択している画面] | SS2 |
| 316行 | [図: カスケードドロップダウンの4段階絞り込みの様子] | SS2 |
| 372行 | [図: 1行入力が完了した状態の支払明細入力シート] | SS1 |
| 404行 | [図: メニュー「工事管理」->「前行コピー」の操作画面] | SS1（メニュー展開状態を別途撮影してもよい） |
| 436行 | [図: 「工事管理」->「月次集計を実行」をクリックする画面] | SS3 |
| 438行 | [図: _C_月次集計シートの集計結果の画面] | SS3 |
| 483行 | [図: _C_予算健康度シートの信号表示画面] | SS4 |

**manual_office_staff.html（4箇所）:**

| 行付近 | プレースホルダー | 使用画像 |
|--------|----------------|---------|
| 234行 | [図: 支払明細入力シートの全体画面（L列・M列にマーキング）] | SS6 |
| 297行 | [図: 所長が入力済みの行を確認している画面] | SS1 |
| 328行 | [図: L列に相殺額、M列に相殺先を入力した状態] | SS6 |
| 361行 | [図: _C_費目別集計シートで相殺反映を確認している画面] | SS3 |

差し替え方法:

```html
<!-- 変更前 -->
<div class="fig-placeholder">[図: ...]</div>

<!-- 変更後 -->
<div class="fig-placeholder"><img src="screenshots/ss1_payment_input.png" alt="支払明細入力シート" style="max-width:100%;"></div>
```

---

## Phase E: プレゼン資料完成（30min）

### E-1. スライド変換

- [ ] 48. presentation_slides.mdをGoogle SlidesまたはPowerPointに変換
  - 手動コピー or Markdown->Slides変換ツールを使用

### E-2. スクリーンショット貼り付け

- [ ] 49. Phase D-3の対応表に従い、スクリーンショット5枚を該当スライドに貼り付け

### E-3. 最終調整

- [ ] 50. スライド1: 日付を提案実施日に変更（「2026年X月」-> 実際の日付）
- [ ] 51. スライド14: コンサル費用を記入（`[要記入 -- 提案時に確定]` を実際の金額に差し替え）
- [ ] 52. 全スライドを通し読みし、以下を確認:
  - [ ] 数値に誤りがないこと
  - [ ] スクリーンショットが正しいスライドに入っていること
  - [ ] フォントサイズがプロジェクター投影に十分であること（24pt以上推奨）
  - [ ] 全15スライドが揃っていること

---

## Phase F: デモリハーサル（1h）

### F-1. 開始前チェックリスト

demo_scenario.mdの「開始前チェックリスト」に従い、全項目を確認する。

**準備物:**

- [ ] 53. テストスプレッドシート（GAS 6ファイルデプロイ済み、テストデータ82件入力済み）
- [ ] 54. mockup_sites.html（ダッシュボードモックアップ）
- [ ] 55. presentation_slides.md に基づくスライド15枚
- [ ] 56. プロジェクター接続確認済みのPC
- [ ] 57. バックアップ用にスライドのPDFをUSBメモリに保存
- [ ] 58. テストスプレッドシートのURLをブラウザのブックマークバーに登録
- [ ] 59. mockup_sites.htmlのURLをブラウザのブックマークバーに登録

**動作確認（提案30分前を想定して実施）:**

- [ ] 60. テストスプレッドシートを開き、支払明細入力シートが表示されることを確認
- [ ] 61. B列のDDをクリックし、3つのカテゴリが選択肢に出ることを確認
- [ ] 62. メニューバーに「工事管理」メニューが表示されていることを確認
- [ ] 63. 工事管理メニュー内に「月次集計を実行」「予算健康度を更新」「前行コピー」が表示されることを確認
- [ ] 64. mockup_sites.htmlをブラウザで開き、4枚のKPIカードが表示されることを確認
- [ ] 65. デモ用の入力行（新規1行）として、最終行の次の行が空欄であることを確認

**環境設定:**

- [ ] 66. PCの通知をオフにする（メール、チャット、OSの通知）
- [ ] 67. 不要なブラウザタブを全て閉じる
- [ ] 68. ブラウザの拡大率を125%に設定
- [ ] 69. スプレッドシートのタブ一覧が画面下部に収まるよう、ウィンドウ幅を調整

### F-2. 通しリハーサル（60分計測）

demo_scenario.mdの台本に沿って、ストップウォッチで計測しながら通し実行する。

| パート | 内容 | 目標時間 | 実績時間 | 調整メモ |
|--------|------|---------|---------|---------|
| 1 | 現場の痛み共有（スライド3-4） | 10分 | ____分 | |
| 2 | ライブデモ（テストSS+mockup） | 25分 | ____分 | |
| 3 | 導入の話（スライド6,13,14,15） | 15分 | ____分 | |
| 4 | 質疑応答 | 10分 | ____分 | |
| **合計** | | **60分** | **____分** | |

### F-3. 時間調整

- 合計60分を超過した場合: パート2のライブデモから削る項目を決める（候補: 2-6のスマホ表示、2-5の月報自動化説明を短縮）
- 合計50分未満の場合: パート4の質疑応答を厚くする余裕がある

### F-4. 想定質問のアドリブ練習

demo_scenario.mdのQ1-Q8を声に出して回答する練習。特に以下は出る確率が高い:

- **Q1. Excelと結果が合わなかったらどうする？** -> 「Excelが正。システムを合わせる」
- **Q2. 操作が難しくないか？** -> 「選ぶだけ。文字を打つのは金額だけ」
- **Q4. セキュリティは大丈夫か？** -> 「Googleのセキュリティ基盤の上で動く」

### F-5. バックアップ対策の確認

| リスク | 対策 | 確認 |
|--------|------|------|
| Wi-Fi断 | スマホのテザリングを準備 | [ ] |
| GAS処理遅延（5秒超） | 「データ量に応じて処理時間は変わります」と説明 | [ ] |
| GASエラー | スライドのスクリーンショットで代用して説明を続行 | [ ] |
| プロジェクター不調 | PDFバックアップをUSBで用意 | [ ] |

---

## バグ発生時のClaude Code連携フロー

Phase CのE2Eテスト中にバグが発生した場合、以下の手順でClaude Codeに報告・修正する。

### 報告手順

1. エラー内容を記録する
   - Apps Scriptの「実行ログ」画面のエラーメッセージをコピー
   - または、スプレッドシート上で発生した症状をスクリーンショットで記録

2. Claude Codeに報告する（以下の形式）

```
xxx.gsのyyy関数でzzzエラーが出た。

【エラーメッセージ】
（ここにエラーメッセージをペースト）

【再現手順】
1. ...
2. ...

【期待する動作】
...
```

3. Claude Codeがコード修正を提供

4. Apps Scriptエディタで該当ファイルの修正箇所を差し替え
   - ファイル全体の差し替えではなく、修正箇所のみ置換するのが安全

5. 再テスト（Phase Cの該当ステップを再実行）

### よくある問題と対処

| 問題 | 原因 | 対処 |
|------|------|------|
| カスケードDDが動かない | onEditトリガーが未設定 | Phase A-6を再確認 |
| 集計結果が0 | Q列（予算箱ID）が空 | validation_extended.gsの予算箱ID解決ロジックを確認 |
| 消化率がNaN | 実行予算テーブルの予算額が未入力 | B-1を再確認 |
| API認証エラー | API_KEYの不一致 | スクリプトプロパティを再確認 |
| 相殺計算がおかしい | L列の入力形式 | 数値のみ（カンマなし）で入力 |
| テンプレート生成でエラー | GASファイルのコピー漏れ | 6ファイル全て揃っているか確認 |

---

## 参照ファイル一覧

| ファイル | パス | 用途 |
|---------|------|------|
| config.gs | gas_templates/budget_management/config.gs | 定数/メニュー/シート保護 |
| template.gs | gas_templates/budget_management/template.gs | テンプレート生成 |
| validation_extended.gs | gas_templates/budget_management/validation_extended.gs | カスケードDD |
| aggregation.gs | gas_templates/budget_management/aggregation.gs | 月次集計 |
| budget_health.gs | gas_templates/budget_management/budget_health.gs | 予算健康度 |
| api.gs | gas_templates/budget_management/api.gs | Web App API |
| poc_budget.tsv | output/poc_budget.tsv | 実行予算13行 |
| poc_vendors.tsv | output/poc_vendors.tsv | 取引先マスタ29行 |
| poc_test_data.tsv | output/poc_test_data.tsv | 支払明細82行 |
| poc_deployment_guide.md | output/poc_deployment_guide.md | 本プレイブックの元ネタ |
| presentation_slides.md | output/presentation_slides.md | スクショ差し替え先 |
| demo_scenario.md | output/demo_scenario.md | Phase Fリハーサル用 |
| manual_director.html | output/manual_director.html | スクショ差し替え先 |
| manual_office_staff.html | output/manual_office_staff.html | スクショ差し替え先 |

---

## 最終チェックリスト

全Phase完了後、以下を確認して完了とする。

**環境:**

- [ ] テストスプレッドシートが動作する（URL共有可能）
- [ ] 9シート全て生成済み
- [ ] 82件のテストデータ投入済み
- [ ] onEditトリガー設定済み

**テスト:**

- [ ] カスケードDD（4段連鎖）の動作確認済み
- [ ] 月次集計の実行・照合完了
- [ ] 予算健康度の信号判定確認済み
- [ ] API（mode=health, mode=summary）のレスポンス確認済み
- [ ] 前行コピーの動作確認済み

**資料:**

- [ ] スクリーンショット6枚取得済み
- [ ] スライド15枚完成（スクショ貼付、日付・費用記入済み）
- [ ] HTMLマニュアル2種のスクショ差し替え済み
- [ ] スライドPDFをUSBバックアップ済み

**リハーサル:**

- [ ] 通しリハーサル60分完了
- [ ] 時間超過パートの調整済み
- [ ] 想定質問の回答練習済み
- [ ] バックアップ対策確認済み

---

## 追加手順: GASプロジェクト分離（Phase 1-A）

hub.gsは本社横断管理用であり、api.gsとdoGet()が衝突するため同一GASプロジェクトに配置できない。
PoC環境では現場SS（6ファイル）と本社台帳SS（hub.gs）を分離してデプロイする。

### 分離手順

- [ ] 1. 現場SS（P004）のGASエディタを開く
  - メニュー「拡張機能」->「Apps Script」
- [ ] 2. hub.gsが含まれている場合は削除する
  - hub.gsファイルを開く -> ファイルメニュー -> 「削除」をクリック
  - 確認ダイアログで「削除」を選択
  - 成功時: エディタ左側のファイル一覧からhub.gsが消える
- [ ] 3. 新規Google Spreadsheetを作成
  - Google Driveで「新規」->「Google スプレッドシート」
  - 名前: 「森組_本社管理台帳」
  - 成功時: 空のスプレッドシートが開く
- [ ] 4. hub.gsのコードを新SSのGASエディタに貼り付け
  - 新SSでメニュー「拡張機能」->「Apps Script」
  - gas_templates/budget_management/hub.gs の全コードをコピー&ペースト
  - 成功時: エディタにhub.gsのコードが表示される
- [ ] 5. スクリプトプロパティにHUB_SPREADSHEET_IDを設定
  - 歯車アイコン（プロジェクトの設定）-> スクリプトプロパティ
  - プロパティ名: HUB_SPREADSHEET_ID
  - 値: 本社管理台帳スプレッドシートのID（URLの /d/ と /edit の間の文字列）
- [ ] 6. WebアプリとしてデプロイしてURLを記録
  - 「デプロイ」->「新しいデプロイ」
  - 種類: ウェブアプリ
  - 実行するユーザー: 自分
  - アクセスできるユーザー: 「自分のみ」（テスト時）/ 「全員（組織内）」（本番時）
  - デプロイURLをメモする（以降、{HUB_URL}として参照）
- [ ] 7. 動作確認

```powershell
Invoke-WebRequest -Uri '{HUB_URL}?mode=list' | Select-Object -ExpandProperty Content
```

期待値: 工事一覧が空配列またはJSON形式で返ること（_M工事台帳が空の場合は `{"projects":[]}` 等）

---

## 追加手順: _M工事台帳へのspreadsheet_id登録（Phase 1-C）

hub.gsが全工事のデータを横断集計するには、各現場SSのspreadsheet_idが_M工事台帳に登録されている必要がある。

### 登録手順

- [ ] 1. 本社管理台帳SS（前セクションで作成した「森組_本社管理台帳」）を開く
- [ ] 2. _M工事台帳シートに移動（シートタブ下部）
- [ ] 3. 以下の4工事について、各行にデータを入力:

| project_id | project_name | spreadsheet_id | 備考 |
|-----------|-------------|----------------|------|
| P001 | 境川河川改修 | （P001用SSを作成後、そのIDを入力） | 新規SS作成が必要 |
| P002 | 野尻川砂防 | （P002用SSを作成後、そのIDを入力） | 新規SS作成が必要 |
| P003 | 持木川護岸 | （P003用SSを作成後、そのIDを入力） | 新規SS作成が必要 |
| P004 | 海潟漁港R7-1 | （既存PoC SSのIDを確認して入力） | Phase AのSSを使用 |

spreadsheet_idの確認方法: スプレッドシートのURL `https://docs.google.com/spreadsheets/d/{ここがID}/edit` の{ここがID}部分

- [ ] 4. 各行に budget_total, start_date, end_date, active=TRUE も入力
- [ ] 5. 横断集計の動作確認（PowerShell）:

```powershell
Invoke-WebRequest -Uri '{HUB_URL}?mode=cross_health' | Select-Object -ExpandProperty Content
```

期待値: budget_total > 0 が全4件に表示されること

確認ポイント:

| 項目 | 期待値 |
|------|--------|
| レスポンス形式 | JSON |
| 工事件数 | 4件（P001-P004） |
| 各工事のbudget_total | 0より大きい値 |
| エラー | なし |

cross_healthが空の場合: _M工事台帳のspreadsheet_idが正しいか、各現場SSにapi.gsがデプロイ済みか確認する。

---

## 追加手順: Dify DSL インポート（Phase 2）

GAS API基盤が動作している状態で、Dify Cloudに予実照会チャットボットをインポートする。

### インポート手順

- [ ] 1. Dify Cloud（cloud.dify.ai）にログイン
  - 成功時: ダッシュボード画面が表示される

- [ ] 2. 「スタジオ」タブをクリック
  - 画面上部のナビゲーションバーにある「スタジオ」
  - 成功時: アプリ一覧画面が表示される

- [ ] 3. 「DSLファイルからインポート」を実行
  - 「アプリを作成」ボタン -> 「DSLファイルからインポート」
  - または、画面右上の「インポート」ボタン
  - アップロードするファイル: `dsl/generated/budget_inquiry_chatbot.dsl`
  - 成功時: ワークフローエディタが開き、ノード構成が表示される

- [ ] 4. 環境変数を設定
  - 画面右上の「設定」（歯車アイコン）をクリック
  - 左メニューから「環境変数」を選択
  - 以下の2つの環境変数を追加:

| 変数名 | 値 | 説明 |
|--------|-----|------|
| GAS_HUB_URL | hub.gsのWebアプリURL | 前セクションでメモしたデプロイURL |
| GAS_ENDPOINT_URL | api.gsのWebアプリURL | Phase C-4でメモしたデプロイURL |

  - 成功時: 環境変数一覧に2件が表示される

- [ ] 5. 動作確認
  - ワークフローエディタの「テスト実行」をクリック
  - 入力欄に以下を入力:

```
P004の今月の状況を教えてください
```

期待値:

| 項目 | 確認内容 |
|------|---------|
| レスポンス言語 | 日本語 |
| 消化率 | 数値が含まれること（例: 52.3%） |
| 出来高率 | 数値が含まれること（例: 70%） |
| 信号 | 正常/注意/超過 のいずれかが含まれること |
| エラー | なし |

- [ ] 6. 追加テスト（任意）

```
全工事の予算状況をまとめてください
```

期待値: P001-P004の横断サマリが返ること（hub.gsのcross_healthモードを使用）

### トラブルシューティング

| 問題 | 原因 | 対処 |
|------|------|------|
| 「環境変数が未設定」エラー | GAS_HUB_URL/GAS_ENDPOINT_URLが空 | 手順4を再確認 |
| GASからのレスポンスがない | デプロイURLが誤っている | api.gs/hub.gsのデプロイURLを再確認 |
| 認証エラー | API_KEYの不一致 | GAS側のスクリプトプロパティとDify側の変数を照合 |
| 「工事が見つからない」 | _M工事台帳にデータがない | Phase 1-Cの登録手順を確認 |

---

**文書バージョン**: 1.2
**作成日**: 2026-02-20
**更新日**: 2026-02-22
**更新内容**:
- v1.2: A-3にSPREADSHEET_IDプロパティを追加、Phase BにB-0方法選択セクションとB方法1（setup_project_data.gs方式）手順を追加
- v1.1: GASプロジェクト分離手順（Phase 1-A）、_M工事台帳登録手順（Phase 1-C）、Dify DSLインポート手順（Phase 2）を追記
**関連文書**: poc_deployment_guide.md（v1.0）、demo_scenario.md、presentation_slides.md
