# GAS 再デプロイ チェックリスト

hub.gs のローカル最新版をデプロイ済み環境に反映する手順。
バージョン管理方式（URL変更なし）を推奨。

---

## 前提条件

- 対象: 森組_工事管理台帳（hub用スプレッドシート）
- GAS プロジェクト: hub.gs がバインドされたプロジェクト
- ローカル最新: `gas_templates/budget_management/hub.gs`
- 変更点: `getFallbackRegistry_()` の工事名が旧版 → 新版（実害なし、コード整合性のため）

---

## 手順

### Step 1: GAS エディタを開く

[ ] 1. 森組_工事管理台帳 スプレッドシートを開く
     成功時: スプレッドシートが表示される

[ ] 2. 拡張機能 > Apps Script を開く
     成功時: GAS エディタが表示される（hub.gs が見える）

### Step 2: hub.gs のコード差し替え

[ ] 3. GAS エディタで `hub.gs` ファイルを選択する
     成功時: 右ペインに hub.gs のコードが表示される

[ ] 4. Ctrl+A で全選択 → Delete で既存コードを削除
     成功時: エディタが空になる

[ ] 5. ローカルの `gas_templates/budget_management/hub.gs` の内容を全てコピーする
     -- Claude Code で `hub.gs` を開いてコピーするか、テキストエディタで開く

[ ] 6. GAS エディタに貼り付け → Ctrl+S で保存
     成功時: 「プロジェクトを保存しました」と表示される

### Step 3: バージョン管理でデプロイ更新（URL変更なし）

[ ] 7. GAS エディタ右上の「デプロイ」ボタン > 「デプロイを管理」を選択
     成功時: デプロイ管理ダイアログが表示される

[ ] 8. 既存のデプロイの右側にある「鉛筆アイコン（編集）」をクリック
     成功時: バージョン選択ドロップダウンが表示される

[ ] 9. バージョンのドロップダウンで「新しいバージョン」を選択
     成功時: 「新しいバージョン」が選択状態になる

[ ] 10. 説明欄に「Phase H: hub.gs コード同期」と入力
     成功時: 説明が入力される

[ ] 11. 「デプロイ」ボタンをクリック
     成功時: 「デプロイが更新されました」と表示される
     注意: Web App URL は変更されない（既存URLのまま）

### Step 4: 疎通テスト

[ ] 12. ブラウザで以下の URL にアクセスする:
     ```
     https://script.google.com/macros/s/AKfycbygy0ZX_cTbzxMgB8D-reGtIsGkQelzf_3M1iKgZM-rkPLPss2g_d4VpG0W9frGE-xs/exec?mode=cross_health&month=2025-12
     ```
     成功時: JSON が返る。`"success":true` かつ `"projects"` 配列に4工事が含まれる

[ ] 13. 返却された JSON の `projects[0].project_name` が正しい工事名であることを確認
     成功時: 「境川河川改修」「持木川中流部」「野尻川除石」「海潟漁港海岸保全R7-1工区」の4工事が返る

### Step 5: Dify アプリ動作確認

URL が変わらないため、Dify 側の設定変更は不要。

[ ] 14. Dify Cloud で「予実照会チャットボット」を開き、「P001の予実を教えて」と入力
     成功時: P001（境川河川改修）の消化率/出来高率/信号が返る

[ ] 15. Dify Cloud で「月次予算管理レポート」を実行（year_month=2025-12）
     成功時: 4工事の月次レポートが生成される

---

## 注意事項

- 「新しいデプロイ」を作成すると新 URL が発行され、Dify 環境変数の GAS_HUB_URL を更新する必要がある
  → バージョン管理方式（Step 3）なら URL 変更なし
- setup_hub_registry.gs は hub用 GAS プロジェクトに既に追加済みのはず。未追加の場合は別ファイルとして追加する
- _M工事台帳シートが正本。getFallbackRegistry_() は _M工事台帳が存在しない場合のフォールバック
