# 複数現場ダッシュボード セットアップチェックリスト

森組 工事予算管理システム - Phase H デモ環境セットアップ手順

- 対象: P001（境川河川改修）/ P002（持木川中流部）/ P003（野尻川除石）/ P004（海潟漁港）
- 所要時間: 約15〜20分
- 前提: Google アカウントにログイン済み、GAS プロジェクト（hub.gs バインド）へのアクセス権あり

---

## 事前確認

- [ ] 「森組_工事管理台帳」スプレッドシートにアクセスできる
- [ ] hub.gs がバインドされた GAS プロジェクト（tab 485003258）を開ける
- [ ] site 用 GAS プロジェクト（tab 485003370）を開ける

---

## Step 1: setup_demo_sites.gs の実行（P001/P002/P003 デモ SS 作成）

### 1-1. GAS エディタを開く

- [ ] site 用 GAS プロジェクト（tab 485003370）を開く
  - 成功時: GAS エディタが表示される

### 1-2. setup_demo_sites.gs を追加する（未追加の場合）

- [ ] GAS エディタ左側のファイル一覧で「+」ボタンをクリック
- [ ] 「スクリプト」を選択し、ファイル名に `setup_demo_sites` と入力して Enter
  - 成功時: エディタに空のファイルが作成される

- [ ] `gas_templates/budget_management/setup_demo_sites.gs` の内容を全てコピーして貼り付ける

### 1-3. 関数を実行する

- [ ] GAS エディタ上部の関数選択ドロップダウンで `setupDemoSites` を選択
  - 位置: エディタ上部中央、「実行」ボタンの左隣にあるドロップダウン
- [ ] 「実行」ボタン（三角マーク）をクリック
  - 成功時: 「実行ログ」パネルが画面下部に表示される

- [ ] 初回実行時は権限承認が求められる場合がある
  - 「権限を確認」→「詳細」→「（安全でないページ）に移動」→「許可」

- [ ] 実行ログに P001/P002/P003 の SS ID が3行分表示されることを確認

```
=== デモSS作成開始 ===
P001 境川河川改修 SS ID: 1xxxxxxxxxxx...
P002 持木川中流部 SS ID: 1xxxxxxxxxxx...
P003 野尻川除石 SS ID: 1xxxxxxxxxxx...
=== デモSS作成完了 ===
```

---

## Step 2: setup_hub_registry.gs の実行（_M工事台帳 作成）

### 2-1. GAS エディタを開く

- [ ] hub 用 GAS プロジェクト（tab 485003258）を開く
  - 成功時: hub.gs 等が含まれる GAS エディタが表示される

### 2-2. setup_hub_registry.gs を追加する

- [ ] GAS エディタ左側のファイル一覧で「+」ボタンをクリック
- [ ] 「スクリプト」を選択し、ファイル名に `setup_hub_registry` と入力して Enter
  - 成功時: エディタに空のファイルが作成される

- [ ] `gas_templates/budget_management/setup_hub_registry.gs` の内容を全てコピーして貼り付ける

### 2-3. SS ID を確認・修正する（必要な場合のみ）

setup_hub_registry.gs にはデフォルトの SS ID がハードコードされています。
Step 1 でデモ SS を再作成した場合、SS ID が変わるため修正が必要です。

- [ ] Step 1 の実行ログに表示された SS ID と、setup_hub_registry.gs 内の SS ID を照合する
- [ ] 異なる場合: スクリプト内の該当 SS ID を書き換える（P001/P002/P003 の3箇所）
  - P004 は既存 SS のため変更不要

### 2-4. 関数を実行する

- [ ] GAS エディタ上部の関数選択ドロップダウンで `setupHubRegistry` を選択
- [ ] 「実行」ボタン（三角マーク）をクリック
  - 成功時: 実行ログに以下のような出力が表示される

```
対象SS: 森組_工事管理台帳 (id=...)
_M工事台帳 シートを作成
=== _M工事台帳 セットアップ完了 ===
ヘッダー: 13列
データ: 4工事
投入データ:
  P001 境川河川改修 → SS ID: 1hkeW97...
  P002 持木川中流部 → SS ID: 1D7f4Rk...
  P003 野尻川除石 → SS ID: 1K0Doek...
  P004 海潟漁港海岸保全R7-1工区 → SS ID: 1EO9ZSI...
```

- [ ] バインド先 SS に `_M工事台帳` シートが作成されていることを確認
  - 成功時: 4行のデータ + ヘッダー行（13列）が表示される
  - J列に各現場の SS ID が入力されている

---

## Step 3: hub.gs 疎通確認（cross_health API）

- [ ] ブラウザの新しいタブで以下の URL にアクセスする

```
{GAS_HUB_URL}?mode=cross_health&month=2025-12
```

`{GAS_HUB_URL}` は hub.gs のデプロイ URL に置き換える
（`https://script.google.com/macros/s/...../exec` 形式）

- 成功時: 以下のような JSON が返却される

```json
{
  "success": true,
  "mode": "cross_health",
  "data": {
    "yearMonth": "2025-12",
    "projects": [
      { "project_id": "P001", "project_name": "境川河川改修", "signal": "正常", "consumption_rate": 70.0 },
      { "project_id": "P002", "project_name": "持木川中流部", "signal": "注意", "consumption_rate": 86.0 },
      { "project_id": "P003", "project_name": "野尻川除石", "signal": "超過", "consumption_rate": 110.0 },
      { "project_id": "P004", "project_name": "海潟漁港海岸保全R7-1工区", ... }
    ]
  }
}
```

- 「未接続」が表示される工事がある場合: Step 2-3 の SS ID 確認をやり直す
- `status: "エラー"` が出る場合: トラブルシューティングを参照

---

## Step 4: mockup_sites.html 動作確認

- [ ] プロジェクトディレクトリの `output/mockup_sites.html` をブラウザで開く
  - ファイルをダブルクリック、または `file://` パスでブラウザに直接ドラッグ

- [ ] ブラウザの開発者ツール（F12）のコンソールを開く

- [ ] ページ右上の「データ取得」ボタンをクリック（またはページロード時に自動実行）
  - 成功時: ダッシュボードに4工事のカードが表示される
  - 各カードに「信号」「消化率」「出来高率」が表示される

- [ ] 各工事カードの信号を確認する

| 工事名 | 期待する信号 | 消化率 |
|--------|------------|--------|
| 境川河川改修 | 正常（緑） | 70% |
| 持木川中流部 | 注意（黄） | 86% |
| 野尻川除石 | 超過（赤） | 110% |
| 海潟漁港海岸保全R7-1工区 | データ表示 | - |

- 成功時: 超過1件・注意1件・正常2件のサマリーカードが上部に表示される

---

## トラブルシューティング

### SS ID 転記後も「未接続」が表示される

原因: _M工事台帳 の J列に SS ID が正しく入力されていない可能性

対処:
1. `_M工事台帳` シートを開き、J列の値をコピーして確認
2. SS ID は44文字の英数字（例: `1BxR2ABC...`）
3. 先頭/末尾の空白が入っていないか確認（セルをクリックして数式バーで確認）
4. SS ID が異なる場合: `updateSiteId('P001', '新しいSSID')` を GAS エディタで実行

### `status: "エラー"` が返却される

原因: hub.gs が対象 SS にアクセスできない権限エラーの可能性

対処:
1. デモ SS を作成したアカウントと hub.gs を実行するアカウントが同一か確認
2. 別アカウントの場合: デモ SS を hub.gs 実行アカウントと共有する（編集者権限）

### mockup_sites.html でデータが表示されない

原因: GAS_HUB_URL の設定ミスまたは CORS の問題

対処:
1. mockup_sites.html 内の `GAS_HUB_URL` 変数が正しい URL になっているか確認
2. Step 3 の直接アクセスで JSON が返ることを先に確認する
3. ブラウザコンソール（F12）のエラーメッセージを確認する

### setup_hub_registry.gs の実行でエラーが出る

対処:
1. 「シートを削除する権限がありません」→ スプレッドシートのオーナー権限を確認
2. 既存の _M工事台帳 にデータが入っている場合: 削除して再作成される（意図通り）

### setup_demo_sites.gs の実行でエラーが出る

対処:
1. 「スプレッドシートを作成する権限がありません」→ Google ドライブの容量確認
2. 「実行時間超過」→ P001/P002/P003 を個別の関数（`createDemoSite_P001_()` 等）で1つずつ実行する

---

## 完了確認

全ステップ完了後、以下の状態になっていることを確認する:

- [ ] Google ドライブに「森組_境川河川改修_デモ」「森組_持木川中流部_デモ」「森組_野尻川除石_デモ」の3つのSSが作成されている
- [ ] 各デモ SS に `_C_予算健康度` シートが存在し、3行のデータが入っている
- [ ] バインド先 SS に `_M工事台帳` シートが存在し、13列ヘッダー + 4行のデータが入っている
- [ ] `_M工事台帳` J列に P001〜P004 の SS ID が全て入力されている
- [ ] `cross_health?month=2025-12` API が4工事のデータを返す（「未接続」なし）
- [ ] `mockup_sites.html` で4工事カードが信号付きで表示される

以上のチェックが全て完了したら、Phase H のデモ環境セットアップは完了です。
